<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìºë¦­í„° ì¥ë¹„ ê´€ë¦¬</title>
    <style>
        body {
            font-family: sans-serif;
            background: #0f1222;
            color: #e6e9ff;
        }

        h1 {
            margin-bottom: 10px;
        }

        /* íˆ´ë°” ì˜ì—­ */
        .toolbar {
            margin: 15px 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .action-btn, .file-label {
            min-width: 140px;
            text-align: center;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        .action-btn {
            background: linear-gradient(135deg, #25c2a0, #1a8c7d);
            border: none;
            color: #fff;
        }

        .action-btn:hover {
            background: linear-gradient(135deg, #1a8c7d, #25c2a0);
        }

        .file-label {
            background: #4a3f7a;
            color: #fff;
            border: none;
        }

        .file-label:hover {
            background: #5a4f8a;
        }

        .file-label input {
            display: none;
        }

        /* ìºë¦­í„° ì¶”ê°€ í¼ */
        .form-box {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .form-box input {
            width: 20ch;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #2a3158;
            background: #181c33;
            color: #e6e9ff;
        }

        .add-btn {
            background: linear-gradient(135deg, #ffd700, #e6b800);
            border: none;
            color: #000;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        .add-btn:hover {
            background: linear-gradient(135deg, #e6b800, #ffd700);
        }

        /* ìºë¦­í„° ë²„íŠ¼ */
        .char-btn {
            margin: 5px;
            padding: 10px 16px;
            background: #2a3158;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .char-btn:hover {
            background: #3a4270;
        }

        /* ì„¸íŠ¸ ë²„íŠ¼ */
        .set-btn {
            margin: 5px;
            padding: 8px 14px;
            min-width: 180px;
            background: #181c33;
            /* ğŸš¨ ì´ ë¶€ë¶„ì„ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤: 1px -> 3px solid transparentë¡œ ë³€ê²½í•˜ì—¬ ê³µê°„ í™•ë³´ */
            border: 3px solid transparent;
            border-radius: 6px;
            color: #e6e9ff;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            text-align: center;
            white-space: nowrap;
        }

        .set-btn:hover {
            background: #2a3158;
            /* í˜¸ë²„ ì‹œ í…Œë‘ë¦¬ ìƒ‰ìƒë§Œ ì‚´ì§ ë³€ê²½ (ì›€ì§ì„ ë°©ì§€) */
            border-color: #3a4270;
        }

        .set-btn.set3 {
            background-color: #25c2a0;
            color: #fff;
        }

        .set-btn.set5 {
            background-color: #ffd700;
            color: #000;
        }

        /* ì„¸íŠ¸ ë²„íŠ¼ ì„ íƒ ì‹œ */
        .set-btn.selected {
            /* 3px ë‘ê»˜ê°€ ìœ ì§€ë˜ë¯€ë¡œ ì›€ì§ì„ ì—†ìŒ */
            border: 3px solid #ffffff; /* í°ìƒ‰ í…Œë‘ë¦¬ ê°•ì¡° */
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.7); /* ì€ì€í•œ í°ìƒ‰ ê·¸ë¦¼ì */
        }

        h2 {
            margin: 24px 0 8px;
        }

        table {
            border-collapse: collapse;
            margin-top: 6px;
            table-layout: fixed;
        }

        th, td {
            border: 1px solid #2a3158;
            padding: 6px;
            text-align: center;
            white-space: nowrap;
        }

        th {
            background: #181c33;
        }

        tr.set3 {
            background-color: rgba(37, 194, 160, 0.35);
        }

        tr.set5 {
            background-color: rgba(255, 215, 0, 0.45);
        }

        /* ìˆ«ì ë²„íŠ¼ */
        .num-btn {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #2a3158;
            background: #181c33;
            color: #e6e9ff;
            cursor: pointer;
        }

        .num-btn.positive {
            background: linear-gradient(135deg, #3399cc, #2a6f9e);
            color: #fff;
            font-weight: bold;
            border: 1px solid #3399cc;
        }

        .character-wrapper {
            display: inline-flex;
            align-items: center;
            margin: 5px;
        }

        .delete-btn {
            padding: 4px 8px;
            background: linear-gradient(135deg, #8c1a1a, #b22222);
            border: none;
            border-radius: 4px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .delete-btn:hover {
            background: linear-gradient(135deg, #b22222, #8c1a1a);
            transform: scale(1.05);
        }

        .char-btn.active {
            background: #b8860b; /* ì€ì€í•œ ê¸ˆë¹› ê³„ì—´ (DarkGoldenrod) */
            color: #fff;
            border: 1px solid #daa520; /* ì¡°ê¸ˆ ë” ë°ì€ ê¸ˆë¹› í…Œë‘ë¦¬ */
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.6); /* ì€ì€í•œ ê¸ˆë¹› ê·¸ë¦¼ì */
        }

        /* ì„¸íŠ¸ ë²„íŠ¼ ì•ˆì— ì‚¬ìš©í•  ìˆ«ì ìƒ‰ìƒ */
        .set-btn .count-3 {
            color: #000000; /* ë°ì€ íŒŒë€ìƒ‰ */
            font-weight: bold;
        }

        .set-btn .count-5 {
            color: #ff4d4f; /* ë°ì€ ë¹¨ê°„ìƒ‰ */
            font-weight: bold;
        }

        /* CSS ì„¹ì…˜ì— ì¶”ê°€ (ì„ íƒ ì‚¬í•­) */
        .exceed-tag {
            color: #25c2a0; /* ì´ˆë¡ìƒ‰ */
            font-weight: bold;
        }

        .prefix-tag {
            color: #e6b800; /* ì—°í•œ ë…¸ë€ìƒ‰ */
            font-weight: bold;
        }

        /* ========================= */
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        /* ========================= */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: #181c33;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            text-align: center;
            min-width: 300px;
        }

        .modal-content h3 {
            margin-top: 0;
            color: #ffd700;
        }

        .modal-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .modal-delete-btn {
            background: #b22222;
            color: #fff;
        }

        .modal-delete-btn:hover {
            background: #8c1a1a;
        }

        .modal-reset-btn {
            background: #3399cc;
            color: #fff;
        }

        .modal-reset-btn:hover {
            background: #2a6f9e;
        }

        .modal-cancel-btn {
            background: #4a3f7a;
            color: #fff;
        }

        .modal-cancel-btn:hover {
            background: #5a4f8a;
        }

        /* ì„¤ì • ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .settings-btn {
            background: #4a3f7a;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 5px;
            transition: background 0.2s;
        }

        .settings-btn:hover {
            background: #6254a8;
        }

        /* ì •ë³´ ìˆ˜ì • ì „ìš© ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .modal-edit-btn {
            background: #25c2a0 !important;
            color: white;
        }

        /* ë¬´ê¸° ê´€ë¦¬ ë²„íŠ¼ì˜ í™œì„±í™” ìƒíƒœì™€ ë™ì¼í•˜ê²Œ ì„¤ì • */
        .char-btn.active {
            border-color: #ffd700 !important;
            color: #ffd700 !important;
            background: rgba(255, 215, 0, 0.1) !important; /* ì‚´ì§ ë…¸ë€ ë°°ê²½ê´‘ */
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.4); /* ì™¸ë¶€ ê´‘ì±„ */
            font-weight: bold;
        }
    </style>
</head>
<body>

<h1>ìºë¦­í„° ì¥ë¹„ ê´€ë¦¬</h1>

<div class="toolbar" style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; padding: 10px 0;">
    <button class="action-btn" style="background: linear-gradient(135deg, #6a5acd, #483d8b);" onclick="exportJSON()">
        ğŸ’ JSON ì €ì¥ (ë°±ì—…)
    </button>
    <label class="file-label" style="background: #2c3e50; margin: 0; cursor: pointer;">
        ğŸ“¥ JSON ë¶ˆëŸ¬ì˜¤ê¸°
        <input type="file" id="jsonFile" accept=".json" onchange="importJSON(event)" style="display:none;">
    </label>

    <span style="display: inline-block; width: 1px; height: 30px; background: rgba(255,255,255,0.3); margin: 0 10px;"></span>

    <button class="action-btn" style="background: linear-gradient(135deg, #2ecc71, #27ae60);"
            onclick="showEquipmentSummary('NORMAL')">ğŸ” ì¼ë°˜ì¥ë¹„
    </button>
    <button class="action-btn" style="background: linear-gradient(135deg, #e67e22, #d35400);"
            onclick="showEquipmentSummary('PREFIX')">ğŸ” ì ‘ë‘ì–´ì¥ë¹„
    </button>
    <button class="action-btn" style="background: linear-gradient(135deg, #e74c3c, #c0392b);"
            onclick="showEquipmentSummary('EXCEED')">ğŸ” ìµì‹œë“œì¥ë¹„
    </button>

    <button class="modal-btn" style="background: #6c5ce7; color: #fff;" onclick="showEquipmentDetail('ALL')">ëª¨ë‘</button>
    <button class="modal-btn" style="background: #2ecc71; color: #fff;" onclick="showEquipmentDetail('NORMAL')">ì¼ë°˜
    </button>
    <button class="modal-btn" style="background: #f1c40f; color: #fff;" onclick="showEquipmentDetail('PREFIX')">ì ‘ë‘ì–´
    </button>
    <button class="modal-btn" style="background: #e74c3c; color: #fff;" onclick="showEquipmentDetail('EXCEED')">ìµì‹œë“œ
    </button>

    <div style="width: 1px; height: 25px; background: #444; margin: 0 5px;"></div>

    <button id="tab-char" class="modal-btn"
            style="background: #4a33cc; color: #ffffff; border: 1px solid #fff; font-weight: bold;"
            onclick="switchTo('char')">ìºë¦­í„° ê´€ë¦¬
    </button>
    <button id="tab-weapon" class="modal-btn"
            style="background: #2a3158; color: #ffffff; border: 1px solid transparent;" onclick="switchTo('weapon')">ë¬´ê¸°
        ê´€ë¦¬
    </button>
    <button id="tab-equipment" class="modal-btn"
            style="background: #2a3158; color: #ffffff; border: 1px solid transparent;" onclick="switchTo('equipment')">
        ì¥ë¹„ ê´€ë¦¬
    </button>
</div>

<button class="action-btn" onclick="showRecentUpdates()">ğŸŒŸ ìµœê·¼ ì—…ë°ì´íŠ¸</button>

<div id="section-equipment-view" style="display:none; padding: 20px;">
    <div class="toolbar"
         style="margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; align-items: flex-start;">

        <div class="equipment-button-row"
             style="display: flex; flex-direction: row; flex-wrap: nowrap; gap: 8px; overflow-x: auto; width: 100%;">
            <button class="char-btn active" style="white-space: nowrap; min-width: 100px;"
                    onclick="renderEquipmentTab('ALL'); setActiveEquipmentButton(this)">ëª¨ë‘
            </button>
            <button class="char-btn" style="white-space: nowrap; min-width: 100px;"
                    onclick="renderEquipmentTab('NORMAL'); setActiveEquipmentButton(this)">ì¼ë°˜
            </button>
            <button class="char-btn" style="white-space: nowrap; min-width: 100px;"
                    onclick="renderEquipmentTab('PREFIX'); setActiveEquipmentButton(this)">ì ‘ë‘ì–´
            </button>
            <button class="char-btn" style="white-space: nowrap; min-width: 100px;"
                    onclick="renderEquipmentTab('EXCEED'); setActiveEquipmentButton(this)">ìµì‹œë“œ
            </button>
        </div>

        <div class="equipment-button-row"
             style="display: flex; flex-direction: row; flex-wrap: nowrap; gap: 8px; overflow-x: auto; width: 100%;">
            <button class="char-btn" style="white-space: nowrap; min-width: 100px; border-color: #ffd700;"
                    onclick="renderFullEquipmentTab('NORMAL'); setActiveEquipmentButton(this)">ì¼ë°˜ì¥ë¹„
            </button>
            <button class="char-btn" style="white-space: nowrap; min-width: 100px; border-color: #ffd700;"
                    onclick="renderFullEquipmentTab('PREFIX'); setActiveEquipmentButton(this)">ì ‘ë‘ì–´ì¥ë¹„
            </button>
            <button class="char-btn" style="white-space: nowrap; min-width: 100px; border-color: #ffd700;"
                    onclick="renderFullEquipmentTab('EXCEED'); setActiveEquipmentButton(this)">ìµì‹œë“œì¥ë¹„
            </button>
        </div>
    </div>

    <div id="equipment-display-area"
         style="overflow-x: auto; background: #0f1222; padding: 15px; border-radius: 8px; border: 1px solid #2a3158;">
    </div>
</div>


<div id="updateModal" class="modal-overlay">
    <div class="modal-content" style="min-width: 90vw; max-height: 85vh; overflow-y: auto;">
        <h3>ğŸŒŸ ìµœê·¼ ì¥ë¹„ ì—…ë°ì´íŠ¸ (TOP 10)</h3>

        <div id="updateModalContent"></div>

        <div class="modal-options" style="margin-top: 30px;">
            <button class="modal-btn modal-cancel-btn" onclick="closeUpdateModal()">ë‹«ê¸°</button>
        </div>
    </div>
</div>


<div id="section-character-view">
    <h2>[ìºë¦­í„°]</h2>
    <div class="form-box">
        <input type="text" id="newCharName" placeholder="ì´ë¦„ ì…ë ¥">
        <input type="text" id="newCharJob" placeholder="ì§ì—… ì…ë ¥">
        <button class="add-btn" onclick="addCharacter()">â• ì¶”ê°€</button>
    </div>

    <div id="characterList" class="char-grid"></div>
    <div id="characterDetail" class="detail-container" style="display:none;"></div>

    <div id="setList"></div>
    <div id="panel"></div>
</div>

<div id="section-weapon-view" style="display: none; padding-top: 0;">
    <h2>[ë¬´ê¸°]</h2>
    <div class="toolbar" id="weaponJobButtons">
        <button class="char-btn" onclick="selectWeaponJob('ê·€ê²€ì‚¬')">ê·€ê²€ì‚¬</button>
        <button class="char-btn" onclick="selectWeaponJob('ê²©íˆ¬ê°€')">ê²©íˆ¬ê°€</button>
        <button class="char-btn" onclick="selectWeaponJob('ê±°ë„ˆ')">ê±°ë„ˆ</button>
        <button class="char-btn" onclick="selectWeaponJob('ë§ˆë²•ì‚¬')">ë§ˆë²•ì‚¬</button>
        <button class="char-btn" onclick="selectWeaponJob('í”„ë¦¬ìŠ¤íŠ¸')">í”„ë¦¬ìŠ¤íŠ¸</button>
        <button class="char-btn" onclick="selectWeaponJob('ì›Œë¦¬ì–´')">ì›Œë¦¬ì–´</button>
        <button class="char-btn" onclick="selectWeaponJob('ë§ˆì°½ì‚¬')">ë§ˆì°½ì‚¬</button>
        <button class="char-btn" onclick="selectWeaponJob('ë„ì ')">ë„ì </button>
    </div>
    <div id="weaponPanel"></div>
</div>

<script>
    // =======================================================
    // [ë¡œì»¬ ìŠ¤í† ë¦¬ì§€] ë°ì´í„° ì˜ì†ì„± í•¨ìˆ˜
    // =======================================================

    let activeCharacterId = null; // í˜„ì¬ ì–´ë–¤ ìºë¦­í„°ê°€ ì„ íƒë˜ì—ˆëŠ”ì§€ ê¸°ì–µ
    let activeWeaponJob = null;

    // ë°ì´í„° ì €ì¥ ì‹œ
    function saveLocalData() {
        localStorage.setItem("dnfm_eq", JSON.stringify(characters));
    }

    // ë°ì´í„° ë¡œë“œ ì‹œ (ì´ˆê¸°í™” ë¡œì§ í¬í•¨)
    function loadLocalData() {
        const saved = localStorage.getItem("dnfm_eq");
        if (saved) {
            try {
                characters = JSON.parse(saved);
            } catch (e) {
                console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", e);
                characters = [];
            }
        }
    }

    // ===== ì„¸íŠ¸ ì •ì˜ =====
    const ARMOR_SETS = {
        "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "í¬ì´ì¦ˆë‹ í€¸ ìŠ¤íŒŒì´ë”": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ê±°ì¸ì˜ ìŠ¤í™ì¿¨ë£¸ ì•„ì´ì–¸": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ì–´ë‘ ì„ ì˜ì•„ ë‚´ë¦¬ëŠ” ì": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ìˆ˜í˜¸ìì˜ ì´ˆí•©ê¸ˆ": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ìŠ¤í‹±í‚¤ ì• ì‹œë“œ ì›¨í€": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ì„¬ëœ©í•œ ê°•ì²  ìš©": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ìµìŠ¤í”Œë¡œì‹œë¸Œ ë²„ë‹ ìŠ¤í†¤": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ë¹›ì˜ í—Œì‹ ì": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ì—¬ëª…ì„ ì˜ì•„ ì˜¬ë¦¬ëŠ” ì": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ì½°íŠ¸ë¡œ ì¹´ì‹œí…Œì›€": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ê·¸ë€í…Œ ì „íˆ¬ê¸°ê°‘ íŒŒì¸ ": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ë ˆê±°ì‹œ: ë§ˆë ¥ì˜ ì†Œìš©ëŒì´": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ë ˆê±°ì‹œ: ìì—°ì˜ ìˆ˜í˜¸ì": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"]
    };
    const ARMOR_PREFIX = {
        "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ": ["ì „ê²©", "í—ˆìƒ"],
        "í¬ì´ì¦ˆë‹ í€¸ ìŠ¤íŒŒì´ë”": ["ì‘ì—´", "ì¹¨ì‹"],
        "ê±°ì¸ì˜ ìŠ¤í™ì¿¨ë£¸ ì•„ì´ì–¸": ["ìˆ˜í˜¸", "ì™œê³¡"],
        "ì–´ë‘ ì„ ì˜ì•„ ë‚´ë¦¬ëŠ” ì": ["ììƒ", "ë§¹ë…"],
        "ìˆ˜í˜¸ìì˜ ì´ˆí•©ê¸ˆ": ["í—ˆìƒ", "ë³´í˜¸"],
        "ìŠ¤í‹±í‚¤ ì• ì‹œë“œ ì›¨í€": ["ë§¹ë…", "ì™œê³¡"],
        "ì„¬ëœ©í•œ ê°•ì²  ìš©": ["ì‡„ë„", "ì¹¨ì‹"],
        "ìµìŠ¤í”Œë¡œì‹œë¸Œ ë²„ë‹ ìŠ¤í†¤": ["ì‹ ì†", "ì—°ê²©"],
        "ë¹›ì˜ í—Œì‹ ì": ["ìˆ˜í˜¸", "ì—°ê²©"],
        "ì—¬ëª…ì„ ì˜ì•„ ì˜¬ë¦¬ëŠ” ì": ["ììƒ", "ì‡„ë„"],
        "ì½°íŠ¸ë¡œ ì¹´ì‹œí…Œì›€": ["ì‘ì—´", "ë³´í˜¸"],
        "ê·¸ë€í…Œ ì „íˆ¬ê¸°ê°‘ íŒŒì¸ ": ["ì‹ ì†", "ì „ê²©"],
        "ë ˆê±°ì‹œ: ë§ˆë ¥ì˜ ì†Œìš©ëŒì´": [],
        "ë ˆê±°ì‹œ: ìì—°ì˜ ìˆ˜í˜¸ì": []
    };

    const ACCESSORY_SETS = {
        "ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ": ["íŒ”ì°Œ", "ëª©ê±¸ì´", "ë°˜ì§€"],
        "ì„¬ëœ©í•œ ë¹›ì˜ ê´€ë¦¬ì": ["íŒ”ì°Œ", "ëª©ê±¸ì´", "ë°˜ì§€"],
        "ë¶€ì‹ëœ ë©”íƒˆê¸°ì–´": ["íŒ”ì°Œ", "ëª©ê±¸ì´", "ë°˜ì§€"],
        "í™”ë ¥ ê°œì¡° íƒ„ë ": ["íŒ”ì°Œ", "ëª©ê±¸ì´", "ë°˜ì§€"],
        "ì‹ ë¹„ë¡œìš´ ë¹›ì˜ ì†Œìš©ëŒì´": ["íŒ”ì°Œ", "ëª©ê±¸ì´", "ë°˜ì§€"],
        "ì½°íŠ¸ë¡œ ë§ˆëˆ„ìŠ¤ ì—°ì‚°ì¥ì¹˜": ["íŒ”ì°Œ", "ëª©ê±¸ì´", "ë°˜ì§€"],
        "ë ˆê±°ì‹œ: ì—í…Œë¦¬ì–¼ ë¦¬ë² ë„ŒíŠ¸": ["íŒ”ì°Œ", "ëª©ê±¸ì´", "ë°˜ì§€"],
        "ë ˆê±°ì‹œ: ì§€ë‚˜ì˜¨ ì˜ê´‘ì˜ ì‹œëŒ€": ["íŒ”ì°Œ", "ëª©ê±¸ì´", "ë°˜ì§€"]
    };
    const ACCESSORY_PREFIX = {
        "ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ": ["ê²¬ê³ ", "í˜ˆë…"],
        "ì„¬ëœ©í•œ ë¹›ì˜ ê´€ë¦¬ì": ["ì´ˆì„", "ê°ì˜¤"],
        "ë¶€ì‹ëœ ë©”íƒˆê¸°ì–´": ["ê°ì˜¤", "ê°€ì†"],
        "í™”ë ¥ ê°œì¡° íƒ„ë ": ["í˜ˆë…", "ê²¬ê³ "],
        "ì‹ ë¹„ë¡œìš´ ë¹›ì˜ ì†Œìš©ëŒì´": ["ì¡°í™”", "ì´ˆì„"],
        "ì½°íŠ¸ë¡œ ë§ˆëˆ„ìŠ¤ ì—°ì‚°ì¥ì¹˜": ["ê°€ì†", "ì¡°í™”"],
        "ë ˆê±°ì‹œ: ì—í…Œë¦¬ì–¼ ë¦¬ë² ë„ŒíŠ¸": [],
        "ë ˆê±°ì‹œ: ì§€ë‚˜ì˜¨ ì˜ê´‘ì˜ ì‹œëŒ€": []
    };

    const SPECIAL_SETS = {
        "ê°œêµ¬ìŸì´ í˜¸ë¬¸ì¿¨ë£¨ìŠ¤": ["ê·€ê±¸ì´", "ë§ˆë²•ì„", "ë³´ì¥"],
        "ë¼ì´íŠ¸ë‹ ì—ë„ˆì§€ ì½”ì–´": ["ê·€ê±¸ì´", "ë§ˆë²•ì„", "ë³´ì¥"],
        "ì² ê°‘ì„ ë‘ë¥¸ íƒ‘ì˜ ìˆ˜í˜¸ê¾¼": ["ê·€ê±¸ì´", "ë§ˆë²•ì„", "ë³´ì¥"],
        "ê¹Šì€ ë¶ˆêµ¬ë©ì´ì˜ ì„¬ë©¸ì": ["ê·€ê±¸ì´", "ë§ˆë²•ì„", "ë³´ì¥"],
        "í—ˆì˜ ì† ì–´ë‘ ì˜ í”¼ì¡°ë¬¼": ["ê·€ê±¸ì´", "ë§ˆë²•ì„", "ë³´ì¥"],
        "ë¶€ì •í•œ ë¹›ì˜ ìš°ìƒ": ["ê·€ê±¸ì´", "ë§ˆë²•ì„", "ë³´ì¥"]
    };
    const SPECIAL_PREFIX = {
        "ê°œêµ¬ìŸì´ í˜¸ë¬¸ì¿¨ë£¨ìŠ¤": ["ë¶ˆêµ´", "ìˆ™ë ¨"],
        "ë¼ì´íŠ¸ë‹ ì—ë„ˆì§€ ì½”ì–´": ["ìˆ™ë ¨", "ê²°ì˜"],
        "ì² ê°‘ì„ ë‘ë¥¸ íƒ‘ì˜ ìˆ˜í˜¸ê¾¼": ["ê²©ë³€", "ì´‰ì§„"],
        "ê¹Šì€ ë¶ˆêµ¬ë©ì´ì˜ ì„¬ë©¸ì": ["ë¶ˆêµ´", "ì´‰ì§„"],
        "í—ˆì˜ ì† ì–´ë‘ ì˜ í”¼ì¡°ë¬¼": ["ì§ˆì£¼", "ê²°ì˜"],
        "ë¶€ì •í•œ ë¹›ì˜ ìš°ìƒ": ["ì§ˆì£¼", "ê²©ë³€"]
    };

    const ALL_SETS = {...ARMOR_SETS, ...ACCESSORY_SETS, ...SPECIAL_SETS};
    const ALL_PREFIX = {...ARMOR_PREFIX, ...ACCESSORY_PREFIX, ...SPECIAL_PREFIX};
    const EXCEED_TAGS = ["ì„ ë´‰", "ì˜ì§€", "ì´ìƒ"];
    const EXCEED_SLOTS = {"ARMOR": ["ìƒì˜"], "ACCESSORY": ["íŒ”ì°Œ"], "SPECIAL": ["ê·€ê±¸ì´"]};


    const WEAPON_DATA_SLAYER = {
        "ì†Œê²€": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ì†Œê²€", "ì•”í‘ì˜ ë³„", "ì™•ìœ„ ê³„ìŠ¹ì"],
        "ë„": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë„", "ìš”ë„ : ë¬´ë¼ë§ˆì‚¬", "íŠ¸ë¦¬ë‹ˆí‹° ì´í„°ë‹ˆì•„"],
        "ë‘”ê¸°": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë‘”ê¸°", "ì„¸ê³„ì˜ ë¬´ê²Œì¶”", "ì‹ ê²€ì˜ ë‚˜ë­‡ê°€ì§€"],
        "ëŒ€ê²€": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ëŒ€ê²€", "ì„±ê²€ : ì—‘ìŠ¤ì¹¼ë¦¬ë²„", "ë°ë¹Œ ì˜¤ë¸Œ í”Œë ˆì–´"],
        "ê´‘ê²€": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ê´‘ê²€", "ì•„ë§ˆ ê²Ÿ ëˆ", "ë‡Œê²€ : ê³ ë£¬"]
    };

    const WEAPON_DATA_FIGHTER = {
        "ë„ˆí´": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë„ˆí´", "ë¼ì˜¤ ë°ì†”", "ë² ë¥´ì„¸ë¥´í¬"],
        "ê±´í‹€ë¦¿": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ê±´í‹€ë¦¿", "ë°˜ê²©ì˜ ì„œë§‰", "ë£°ë ›ëŸ¬ì‹œì•ˆ"],
        "í´ë¡œ": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - í´ë¡œ", "í‘ì›”ë‘ì•„", "ì•…ë§ˆì˜ ê°ˆí€´ : ì´ê·¸ë…¸ì–´"],
        "ê¶Œíˆ¬ê¸€ëŸ¬ë¸Œ": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ê¶Œíˆ¬ê¸€ëŸ¬ë¸Œ", "í‹°ì¥¬ ì— í”Œë¦¬íŒŒì´ì–´", "íŒŒìš¸ í‚¤ë“œë‹ˆë¸”ë¡œ"],
        "í†µíŒŒ": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - í†µíŒŒ", "í‚¬ ì•„ë¥´ë‹ˆìŠ¤ ë µê³¡", "ìŠµê²©ì˜ ë“œë¼ìš°í”„ë‹ˆë¥´"]
    };

    const WEAPON_DATA_GUNNER = {
        "ë¦¬ë³¼ë²„": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë¦¬ë³¼ë²„", "ì´ìŠ¤ ë¯¸ í„°ë„ˆ", "ì‹¤ë²„ ë¶ˆë ›"],
        "ìë™ê¶Œì´": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ìë™ê¶Œì´", "ì´ì˜¨ ë¦¬í•„ì„œ", "ë§ˆì´ìŠ¤í„°ì˜ ë¶„ë…¸"],
        "ë¨¸ìŠ¤ì¼“": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë¨¸ìŠ¤ì¼“", "Code N : ì˜¤ë¼í´", "ë¸”ë¼ì¸ë“œ ìŠ¤íŒŸ"],
        "í•¸ë“œìºë„Œ": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - í•¸ë“œìºë„Œ", "ê±°í¬ ìš°ë¥´ë°˜", "í•´ë¥¼ ë¨¹ëŠ” ì"],
        "ë³´ìš°ê±´": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë³´ìš°ê±´", "ë°ìŠ¤ ë¦¬ë·°ì €", "ì œë„ˆëŸ´ ë³´ìš°ê±´"]
    };

    const WEAPON_DATA_MAGE = {
        "ì°½": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ì°½", "ì¥¬ë¹ŒëŸ°ìŠ¤ í˜¼", "ì „ì¥ì˜ ì—¬ì‹ ì˜ ì°½"],
        "ë´‰": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë´‰", "ì¼€ì„¸ë¼ì„¸ë¼ : í•´í”¼ ~!", "ìš”ì •ì™•ì˜ ë¹„ë°€"],
        "ë¡œë“œ": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë¡œë“œ", "íˆì–´ë¡œ ì˜¤ë¸Œ ë” ë¬¸", "ì–‘ì¹˜ê¸°ì˜ ë¡œë“œ"],
        "ìŠ¤íƒœí”„": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ìŠ¤íƒœí”„", "ì›¨ë¦¬ : ë¦¬ë¯¸íŠ¸ ë¸Œë ˆì´ì»¤", "ì°½ë§ˆí™”ì˜ ì—°"],
        "ë¹—ìë£¨": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë¹—ìë£¨", "ë³´ë°° - íŒŒì´ˆì„ ", "ìŠ¤ë…¸ìš° í”„ë¦°ì„¸ìŠ¤"]
    };

    const WEAPON_DATA_PRIEST = {
        "ì‹­ìê°€": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ì‹­ìê°€", "í—¤ì´ë  - êµë§Œì˜ ë¹›", "ì €ì£¼ ë°›ì€ ì‹­ìê°€ : í† ë£¨ì•„"],
        "ì—¼ì£¼": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ì—¼ì£¼", "ìŒì–‘ì‚¬ì²œ", "ëª…ì¸ì˜ ìˆ˜"],
        "í† í…œ": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - í† í…œ", "ì”° ë” ë¦¬ë°”ì´ì–´ë˜", "í’ìš´ë‡Œìš°"],
        "ë‚«": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë‚«", "ì†Œìš¸ ë””ë°”ìš°ë§", "ì„ ê³  : ì‚¬ì‹ ì˜ ë‚«"],
        "ë°°í‹€ì—‘ìŠ¤": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë°°í‹€ì—‘ìŠ¤", "í–‰ì„±íŒŒê´´ì", "ì˜¤ë§Œì˜ ë"]
    };

    const WEAPON_DATA_WARRIOR = {
        "ë½ì†Œë“œ": [
            "ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë½ì†Œë“œ",
            "ìš°ì£¼ì  ê¸°ìš´ì˜ ë½ì†Œë“œ",
            "ë¼ì´í”„ íŒŒì¸ë”"
        ],
        "ìœ™ë¸”ë ˆì´ë“œ": [
            "ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ìœ™ë¸”ë ˆì´ë“œ",
            "í”„ë¡œìŠ¤íŠ¸ ìœ™ ë¸”ë ˆì´ë“œ",
            "ì½”ì¹´íŠ¸ë¦¬ìŠ¤"
        ]
    };

    const WEAPON_DATA_LANCER = {
        "ë¯¸ëŠ˜ì°½": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë¯¸ëŠ˜ì°½", "í¬ë¦¼ìŠ¨ ë¡œë“œ", "ê´‘ì—¼ì˜ ê·¹"],
        "íˆ¬ì°½": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - íˆ¬ì°½", "í—¬ ì˜¤ë¸Œ ë°ë¹Œë¡œë“œ", "ë¯¸ë¼í´ ëŸ°ì¹˜"]
    };

    const WEAPON_DATA_THIEF = {
        "ë‹¨ê²€": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë‹¨ê²€", "ì‹¤ë²„ ìŠ¤í”¼ë¦¿", "ì›”ê´‘ê²€"],
        "ìŒê²€": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ìŒê²€", "í‘ë¯¸ìŒê²€", "íˆê²Œ-íˆìí‚¤ë¦¬"],
        "ì°¨í¬ë¼ì›¨í€": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ì°¨í¬ë¼ì›¨í€", "í¬ë¦¬ë“œ ì˜¤ë¸Œ ë‹Œì", "ë¬´ì—¼í™”"]
    };

    const WEAPON_PREFIXES = [
        {tag: "[ê´‘ì±„]", color: "#3399cc"}, // íŒŒë€ìƒ‰
        {tag: "[ë¶„ì‡„]", color: "#ff4d4f"}, // ë¹¨ê°„ìƒ‰
        {tag: "[ì„ ëª…]", color: "#25c2a0"}, // ì´ˆë¡ìƒ‰
        {tag: "[ê°•íƒ€]", color: "#ffd700"}  // ë…¸ë€ìƒ‰
    ];

    // ì§ì—…ë³„ ë¬´ê¸° ë°ì´í„° ë§¤í•‘ ê°ì²´
    const WEAPON_DATA_MAP = {
        'ê·€ê²€ì‚¬': WEAPON_DATA_SLAYER,
        'ê²©íˆ¬ê°€': WEAPON_DATA_FIGHTER,
        'ê±°ë„ˆ': WEAPON_DATA_GUNNER,
        'ë§ˆë²•ì‚¬': WEAPON_DATA_MAGE,
        'í”„ë¦¬ìŠ¤íŠ¸': WEAPON_DATA_PRIEST,
        'ì›Œë¦¬ì–´': WEAPON_DATA_WARRIOR,
        'ë§ˆì°½ì‚¬': WEAPON_DATA_LANCER,
        'ë„ì ': WEAPON_DATA_THIEF
    };

    // ê´€ë¦¬ ì¤‘ì¸ ì§ì—… ëª©ë¡ ë°°ì—´
    const JOB_LIST = Object.keys(WEAPON_DATA_MAP);

    // ìµì‹œë“œ íƒœê·¸ë³„ ìƒ‰ìƒ ì •ì˜
    const EXCEED_COLOR_MAP = {
        "ì„ ë´‰": "#ff4d4d",
        "ì˜ì§€": "#4d94ff",
        "ì´ìƒ": "#2ecc71"
    };

    // ===== ìºë¦­í„° ë°°ì—´ =====
    let characters = [
        {
            id: "c1", job: "ê²€ê·€", name: "ê°•ì˜", armorCounts: {
                "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ ìƒì˜": 1,
                "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ í•˜ì˜": 1,
                "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ ì–´ê¹¨": 1,
                "ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ íŒ”ì°Œ": 1,
                "[ì˜ì§€] ê²¬ê³ : ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ íŒ”ì°Œ": 1,
                "ê°œêµ¬ìŸì´ í˜¸ë¬¸ì¿¨ë£¨ìŠ¤ ê·€ê±¸ì´": 1
            }, updateTimes: { // ğŸ’¡ ì¶”ê°€ëœ í•„ë“œ: ì•„ì´í…œë³„ ì—…ë°ì´íŠ¸ ì‹œê°„ ì €ì¥
                "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ ìƒì˜": Date.now() - 50000,
                "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ í•˜ì˜": Date.now() - 40000,
                "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ ì–´ê¹¨": Date.now() - 30000,
                "ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ íŒ”ì°Œ": Date.now() - 20000,
                "[ì˜ì§€] ê²¬ê³ : ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ íŒ”ì°Œ": Date.now() - 10000,
                "ê°œêµ¬ìŸì´ í˜¸ë¬¸ì¿¨ë£¨ìŠ¤ ê·€ê±¸ì´": Date.now()
            }
        }
    ];

    // ===== ì „ì—­ ìµœëŒ€ ê¸¸ì´ ê³„ì‚° =====
    let globalSetNameWidth = 200, globalSlotWidth = 100;

    function calculateGlobalWidths() {
        const allNames = [], allSlots = [];
        [{sets: ARMOR_SETS, pref: ARMOR_PREFIX},
            {sets: ACCESSORY_SETS, pref: ACCESSORY_PREFIX},
            {sets: SPECIAL_SETS, pref: SPECIAL_PREFIX}].forEach(({sets, pref}) => {
            Object.keys(sets).forEach(setName => {
                allNames.push(setName);
                const prefixes = pref[setName] || [];
                prefixes.forEach(p => {
                    allNames.push(`${p}: ${setName}`);
                    EXCEED_TAGS.forEach(ex => allNames.push(`[${ex}] ${p}: ${setName}`));
                });
                sets[setName].forEach(slot => allSlots.push(slot));
            });
        });
        globalSetNameWidth = Math.max(...allNames.map(n => n.length)) * 12;
        globalSlotWidth = Math.max(...allSlots.map(s => s.length)) * 12;
    }

    calculateGlobalWidths();

    // ===== ìœ í‹¸ =====
    function isExceedName(name) {
        return /^\[(ì„ ë´‰|ì˜ì§€|ì´ìƒ)\]\s/.test(name);
    }

    function getGroupKey(name) {
        return name.replace(/^\[.*?\]\s*/, "");
    }

    function getSetType(setName) {
        if (ARMOR_SETS[setName]) return "ARMOR";
        if (ACCESSORY_SETS[setName]) return "ACCESSORY";
        if (SPECIAL_SETS[setName]) return "SPECIAL";

        // ì ‘ë‘ì–´ë‚˜ ìµì‹œë“œê°€ ë¶™ì€ ì´ë¦„ì—ì„œ ê¸°ë³¸ ì„¸íŠ¸ëª…ì„ ì¶”ì¶œí•˜ì—¬ íŒë³„
        const baseName = setName.includes(':') ? setName.split(':').pop().trim() : setName;
        if (ARMOR_SETS[baseName]) return "ARMOR";
        if (ACCESSORY_SETS[baseName]) return "ACCESSORY";
        if (SPECIAL_SETS[baseName]) return "SPECIAL";

        return "ARMOR"; // ê¸°ë³¸ê°’
    }

    function calcTotalDistinctParts(char, baseSetName) {
        const slots = ALL_SETS[baseSetName] || [];
        const prefixes = ALL_PREFIX[baseSetName] || [];
        const setType = getSetType(baseSetName);
        const exceedSlots = EXCEED_SLOTS[setType] || [];

        // ê²€ìƒ‰í•  ëª¨ë“  ê·¸ë£¹ ì´ë¦„ (ê¸°ë³¸, ì ‘ë‘ì–´, ìµì‹œë“œ) ìƒì„±
        const namesToSearch = [baseSetName];
        prefixes.forEach(pref => {
            const prefixedName = `${pref}: ${baseSetName}`;
            namesToSearch.push(prefixedName);
            EXCEED_TAGS.forEach(tag => {
                namesToSearch.push(`[${tag}] ${prefixedName}`);
            });
        });

        let totalDistinct = 0;

        slots.forEach(slot => {
            let hasPartInSlot = false;
            const slotSuffix = ` ${slot}`;

            namesToSearch.forEach(nameComponent => {
                const isExceedKey = nameComponent.startsWith('[');

                // ìµì‹œë“œ í‚¤ëŠ” íŠ¹ì • ìŠ¬ë¡¯ì—ë§Œ ì¡´ì¬í•˜ë¯€ë¡œ, ì•„ë‹Œ ê²½ìš°ëŠ” ê±´ë„ˆëœë‹ˆë‹¤.
                if (isExceedKey && !exceedSlots.includes(slot)) {
                    return;
                }

                const fullKey = `${nameComponent}${slotSuffix}`;
                if ((char.armorCounts[fullKey] || 0) > 0) {
                    hasPartInSlot = true;
                }
            });

            if (hasPartInSlot) {
                totalDistinct++;
            }
        });

        return totalDistinct;
    }

    // =======================================================
    // [ëª¨ë‹¬] ì œì–´ ë° ì•¡ì…˜ í•¨ìˆ˜ (ìˆ˜ì • ë° ì¶”ê°€ë¨)
    // =======================================================
    let currentActionCharId = null;
    let pendingActionType = null; // í˜„ì¬ 2ì°¨ í™•ì¸ ëŒ€ê¸° ì¤‘ì¸ ì‘ì—…: 'delete' ë˜ëŠ” 'reset'

    function openActionModal(charId, name, job) {
        // 1. í˜„ì¬ ì‘ì—… ëŒ€ìƒ IDë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
        currentActionCharId = charId;

        const modal = document.getElementById("actionModal");
        // ğŸ’¡ ìˆ˜ì • í¬ì¸íŠ¸: modal ìì²´ê°€ nullì¸ì§€ í™•ì¸í•˜ê³ , ë‚´ë¶€ content ì˜ì—­ì„ ì•ˆì „í•˜ê²Œ ì°¸ì¡°í•©ë‹ˆë‹¤.
        if (!modal) return;

        // ì‚¬ìš©ìë‹˜ì˜ HTML êµ¬ì¡°ì— ë§ì¶° í´ë˜ìŠ¤ëª…ì´ modal-contentì¸ ìš”ì†Œë¥¼ ì°¾ìŠµë‹ˆë‹¤.
        const content = modal.querySelector(".modal-content");
        if (!content) return;

        // 2. ëª¨ë‹¬ ë‚´ë¶€ UI ìƒì„± (ì‚¬ìš©ìë‹˜ ì½”ë“œ ìœ ì§€ + ì˜¤íƒ€ ë°©ì§€)
        content.innerHTML = `
      <h2 style="margin-bottom:25px; color:#fff;">ìºë¦­í„° ì„¤ì • ìˆ˜ì •</h2>

      <div style="margin-bottom:15px; display:flex; align-items:center;">
          <label style="width:60px; font-weight:bold; color:#ccc;">ì´ë¦„ :</label>
          <input type="text" id="edit-charName" value="${name}"
                 style="flex:1; padding:8px; background:#181c33; color:#fff; border:1px solid #2a3158; border-radius:4px;">
      </div>

      <div style="margin-bottom:25px; display:flex; align-items:center;">
          <label style="width:60px; font-weight:bold; color:#ccc;">ì§ì—… :</label>
          <input type="text" id="edit-charJob" value="${job}"
                 style="flex:1; padding:8px; background:#181c33; color:#fff; border:1px solid #2a3158; border-radius:4px;">
      </div>

      <div class="modal-options" style="display:flex; flex-direction:column; gap:10px;">
          <button type="button" class="modal-btn" style="background:#25c2a0; font-weight:bold; color:#fff;"
                  onclick="updateCharacterInfo('${charId}')">ì •ë³´ ìˆ˜ì • ì™„ë£Œ</button>
          <div style="display:flex; gap:8px;">
              <button type="button" class="modal-btn" style="flex:1; background:#f39c12; font-size:0.9em; color:#fff;"
                      onclick="resetCharacterStatsConfirmed()">ìˆ˜ì¹˜ ì´ˆê¸°í™”</button>
              <button type="button" class="modal-btn" style="flex:1; background:#e74c3c; font-size:0.9em; color:#fff;"
                      onclick="deleteCharacterConfirmed()">ìºë¦­í„° ì‚­ì œ</button>
          </div>
          <button type="button" class="modal-btn" style="background:#444; color:#fff;" onclick="closeActionModal()">ì·¨ì†Œ</button>
      </div>
  `;
        modal.style.display = "flex";
    }

    // ì¸ì ìˆœì„œê°€ ì¤‘ìš”í•©ë‹ˆë‹¤: (ìºë¦­í„°ID, ìˆ˜ì •ëœì´ë¦„, ìˆ˜ì •ëœì§ì—…)
    function updateCharacterInfo(charId) {
        // ğŸš¨ 787ë²ˆ ì¤„ ìˆ˜ì •: charName ëŒ€ì‹  edit-charNameì„ ì°¾ìŠµë‹ˆë‹¤.
        const nameInput = document.getElementById("edit-charName");
        const jobInput = document.getElementById("edit-charJob");

        // ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ì—¬ null ì—ëŸ¬ ë°©ì§€
        if (!nameInput || !jobInput) {
            alert("ìˆ˜ì • ì…ë ¥ì°½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const newName = nameInput.value.trim();
        const newJob = jobInput.value.trim();

        if (!newName || !newJob) {
            alert("ì´ë¦„ê³¼ ì§ì—…ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            return;
        }

        const char = characters.find(c => c.id === charId);
        if (char) {
            char.name = newName;
            char.job = newJob;

            saveLocalData();
            renderCharacterList(); // ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
            closeActionModal();    // ëª¨ë‹¬ ë‹«ê¸°
            alert("ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    }

    // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜ê°€ ì—†ë‹¤ë©´ ì•„ë˜ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.
    function closeActionModal() {
        const modal = document.getElementById("actionModal");
        if (modal) modal.style.display = "none";
    }

    // ëª¨ë‹¬ ë‹«ê¸° (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
    function closeConfirmModal() {
        const modal = document.getElementById("confirmModal");
        if (modal) modal.style.display = 'none';
    }

    // 2. í™•ì¸ ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜ (ì—ëŸ¬ ë°©ì§€ìš© ë³´ì™„)
    function openConfirmModal(title, message, onConfirm) {
        const modal = document.getElementById("confirmModal");
        const titleEl = document.getElementById("confirmTitle");
        const messageEl = document.getElementById("confirmMessage");
        const confirmBtn = document.getElementById("confirmYes");

        if (!modal || !titleEl || !messageEl || !confirmBtn) return;

        titleEl.textContent = title;
        messageEl.textContent = message;

        // ğŸ’¡ í•µì‹¬ ìˆ˜ì •: onclickì— í•¨ìˆ˜ë¥¼ ì§ì ‘ í• ë‹¹í•©ë‹ˆë‹¤.
        confirmBtn.onclick = function () {
            if (typeof onConfirm === "function") {
                onConfirm(); // ì—¬ê¸°ì„œ ì „ë‹¬ë°›ì€ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
            }
            closeConfirmModal();
        };

        modal.style.display = 'flex';
    }

    // ğŸ’¡ ìƒˆë¡œ ì¶”ê°€: ì—…ë°ì´íŠ¸ ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
    function closeUpdateModal() {
        document.getElementById("updateModal").style.display = 'none';
    }


    function deleteCharacterConfirmed() {
        openConfirmModal(
            "ìºë¦­í„° ì‚­ì œ",
            "ì •ë§ë¡œ ì´ ìºë¦­í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
            function () {
                // 1. ì „ì—­ ë°°ì—´ì—ì„œ í•´ë‹¹ ìºë¦­í„° ì œì™¸ (í•„í„°ë§)
                characters = characters.filter(c => String(c.id) !== String(currentActionCharId));

                // 2. ğŸ’¡ ìˆ˜ì • í¬ì¸íŠ¸: saveData ëŒ€ì‹  ì‹¤ì œ ì¡´ì¬í•˜ëŠ” saveLocalData í˜¸ì¶œ
                saveLocalData();

                // 3. í™”ë©´ UI ê°±ì‹  (ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ê·¸ë¦¬ê¸°)
                renderCharacterList();

                // 4. ì‚­ì œí•œ ìºë¦­í„°ê°€ í˜„ì¬ ì„ íƒëœ ìºë¦­í„°ì˜€ë‹¤ë©´ ìƒì„¸ í™”ë©´ë„ ë¹„ìš°ê¸°
                if (activeCharacterId === currentActionCharId) {
                    const setListEl = document.getElementById("setList");
                    const panelEl = document.getElementById("panel");
                    if (setListEl) setListEl.innerHTML = "";
                    if (panelEl) panelEl.innerHTML = "";
                    activeCharacterId = null;
                }

                // 5. ë§ˆë¬´ë¦¬
                closeActionModal();
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        );
    }

    function resetCharacterStatsConfirmed() {
        const targetId = currentActionCharId;

        if (!targetId) {
            alert("ëŒ€ìƒ ìºë¦­í„°ë¥¼ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        openConfirmModal(
            "ìˆ˜ì¹˜ ì´ˆê¸°í™”",
            "ì´ ìºë¦­í„°ì˜ ëª¨ë“  ì¥ë¹„ ë³´ìœ  í˜„í™© ë° ì—…ë°ì´íŠ¸ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
            function () {
                // 1. ìºë¦­í„° ë°ì´í„° ì°¾ê¸°
                const char = characters.find(c => String(c.id) === String(targetId));

                if (char) {
                    // 2. ğŸ’¡ í•µì‹¬: ì‚¬ìš©ìë‹˜ì˜ ë°ì´í„° í•„ë“œëª…(armorCounts, updateTimes)ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
                    char.armorCounts = {};
                    char.updateTimes = {};

                    // ë¬´ê¸° ì •ë³´ê°€ ìˆë‹¤ë©´ í•¨ê»˜ ì´ˆê¸°í™”
                    if (char.weaponCounts) char.weaponCounts = {};

                    // 3. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì¦‰ì‹œ ì €ì¥
                    saveLocalData();

                    // 4. í™”ë©´ UI ê°±ì‹ 
                    if (typeof renderCharacterList === "function") renderCharacterList();

                    // 5. ìƒì„¸ ë³´ê¸° ì˜ì—­ ë¹„ìš°ê¸° (ì´ˆê¸°í™”ë˜ì—ˆìœ¼ë¯€ë¡œ ì´ì „ ì •ë³´ë¥¼ ì§€ì›ë‹ˆë‹¤)
                    const setListEl = document.getElementById("setList");
                    const panelEl = document.getElementById("panel");
                    if (setListEl) setListEl.innerHTML = "";
                    if (panelEl) panelEl.innerHTML = "";

                    activeCharacterId = null; // ì„ íƒ ìƒíƒœ í•´ì œ

                    alert("ëª¨ë“  ìˆ˜ì¹˜ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    closeActionModal(); // ì„¤ì • ì°½ ë‹«ê¸°
                } else {
                    alert("ìºë¦­í„° ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            }
        );
    }

    // 2ì°¨ ëª¨ë‹¬ì—ì„œ 'í™•ì¸' ë²„íŠ¼ í´ë¦­ ì‹œ (ì‹¤ì œ ì‘ì—… ìˆ˜í–‰)
    function handleConfirmedAction() {
        const charId = currentActionCharId; // openActionModalì—ì„œ ì €ì¥í–ˆë˜ ID ì‚¬ìš©
        const action = pendingActionType;   // 'delete' ë˜ëŠ” 'reset'

        closeConfirmModal(); // 2ì°¨ í™•ì¸ ëª¨ë‹¬ ë‹«ê¸°

        if (!charId || !action) {
            currentActionCharId = null;
            pendingActionType = null;
            return;
        }

        const charIndex = characters.findIndex(c => c.id === charId);
        const char = characters[charIndex];

        if (action === 'delete') {
            // [ìºë¦­í„° ì‚­ì œ ë¡œì§]
            if (charIndex !== -1) {
                characters.splice(charIndex, 1); // ë°°ì—´ì—ì„œ ì œê±°
                saveLocalData();
                renderCharacterList();

                // ì‚­ì œ í›„ í™”ë©´ ì´ˆê¸°í™”
                document.getElementById("setList").innerHTML = "";
                document.getElementById("panel").innerHTML = "";
                activeCharacterId = null;
                alert("ìºë¦­í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        } else if (action === 'reset') {
            // [ìˆ˜ì¹˜ ì´ˆê¸°í™” ë¡œì§]
            if (char) {
                char.armorCounts = {}; // ëª¨ë“  ì¥ë¹„ ìˆ˜ì¹˜ 0
                char.updateTimes = {}; // ì—…ë°ì´íŠ¸ ì‹œê°„ ê¸°ë¡ ì‚­ì œ
                // ë¬´ê¸° ìˆ˜ì¹˜ë„ ì´ˆê¸°í™”í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì£¼ì„ í•´ì œ
                // if (char.weaponCounts) char.weaponCounts = {};

                saveLocalData();
                renderCharacterList();

                // ì´ˆê¸°í™” í›„ ìƒì„¸ í™”ë©´ ê°±ì‹ ì„ ìœ„í•´ ë¹„ì›€
                document.getElementById("setList").innerHTML = "";
                document.getElementById("panel").innerHTML = "";
                activeCharacterId = null;

                alert(`${char.name} ìºë¦­í„°ì˜ ëª¨ë“  ìˆ˜ì¹˜ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }
        }

        // ì‘ì—… ì™„ë£Œ í›„ ì „ì—­ ìƒíƒœ ì´ˆê¸°í™”
        currentActionCharId = null;
        pendingActionType = null;
        closeActionModal(); // 1ì°¨ ì„¤ì • ëª¨ë‹¬ë„ í•¨ê»˜ ë‹«ê¸°
    }


    function renderCharacterList() {
        const listEl = document.getElementById("characterList");
        if (!listEl) return; // ìš”ì†Œê°€ ì—†ìœ¼ë©´ ì¤‘ë‹¨

        listEl.innerHTML = "";

        characters.forEach((c) => {
            const wrapper = document.createElement("div");
            wrapper.className = "character-wrapper";
            wrapper.style.display = "inline-flex"; // ë²„íŠ¼ë“¤ì´ ë‚˜ë€íˆ ë¶™ë„ë¡ ì„¤ì •
            wrapper.style.alignItems = "center";
            wrapper.style.marginRight = "10px";
            wrapper.style.marginBottom = "10px";

            // âš™ï¸ ì„¤ì •(í†±ë‹ˆë°”í€´) ë²„íŠ¼
            const settingsBtn = document.createElement("button");
            settingsBtn.textContent = "âš™ï¸";
            settingsBtn.className = "settings-btn";
            settingsBtn.style.cursor = "pointer";
            settingsBtn.onclick = (e) => {
                e.stopPropagation(); // ë¶€ëª¨ í´ë¦­ ì´ë²¤íŠ¸ ì „íŒŒ ë°©ì§€
                openActionModal(c.id, c.name, c.job);
            };

            // ìºë¦­í„° ë²„íŠ¼
            const btn = document.createElement("button");
            btn.className = "char-btn" + (c.id === (typeof activeCharacterId !== 'undefined' ? activeCharacterId : null) ? " active" : "");
            btn.textContent = `${c.job} (${c.name})`;
            btn.onclick = () => {
                if (typeof showSetButtons === "function") showSetButtons(c);
            };

            wrapper.appendChild(settingsBtn);
            wrapper.appendChild(btn);
            listEl.appendChild(wrapper);
        });
    }


    // [ë¡œì»¬ ìŠ¤í† ë¦¬ì§€] ì´ˆê¸° ë¡œë“œ ë° ë Œë”ë§
    loadLocalData();
    renderCharacterList();

    // ===== ìºë¦­í„° ì¶”ê°€ =====
    function addCharacter() {
        const name = document.getElementById("newCharName").value.trim();
        const job = document.getElementById("newCharJob").value.trim();
        if (!name || !job) {
            alert("ì´ë¦„ê³¼ ì§ì—…ì„ ì…ë ¥í•˜ì„¸ìš”!");
            return;
        }
        // ğŸ’¡ updateTimes: {} ì¶”ê°€
        const newChar = {id: "c" + Date.now(), job: job, name: name, armorCounts: {}, updateTimes: {}};
        characters.push(newChar);
        saveLocalData(); // [ë¡œì»¬ ìŠ¤í† ë¦¬ì§€] ë°ì´í„° ë³€ê²½ í›„ ì €ì¥
        renderCharacterList();
        document.getElementById("newCharName").value = "";
        document.getElementById("newCharJob").value = "";
    }

    // ===== ì„¸íŠ¸ ë²„íŠ¼ í‘œì‹œ =====
    function showSetButtons(char, isRefresh = false) {
        const setList = document.getElementById("setList");
        const panel = document.getElementById("panel");

        // 1. [í† ê¸€ ë¡œì§]
        // ìƒˆë¡œê³ ì¹¨(isRefresh=true)ì´ ì•„ë‹ ë•Œë§Œ 'ì´ë¯¸ ì—´ë¦° ìºë¦­í„°'ë¥¼ ëˆ„ë¥´ë©´ ë‹«íˆê²Œ í•©ë‹ˆë‹¤.
        if (!isRefresh && activeCharacterId === char.id) {
            activeCharacterId = null;
            setList.innerHTML = "";
            panel.innerHTML = "";
            renderCharacterList(); // ì„ íƒ í‘œì‹œ(ë…¸ë€ë¶ˆ) í•´ì œ
            return;
        }

        // ìºë¦­í„° ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ë…¸ë€ìƒ‰ ë¶ˆ ì¼œê¸°
        activeCharacterId = char.id;
        renderCharacterList();

        setList.innerHTML = "";

        // ----------------------------------------------------
        // 1. ê° ì¹´í…Œê³ ë¦¬ë³„ ì•„ì´í…œ ì´ ê°œìˆ˜ ê³„ì‚°
        // ----------------------------------------------------
        let totalArmor = 0;
        let totalAccessory = 0;
        let totalSpecial = 0;

        Object.entries(char.armorCounts).forEach(([fullKey, count]) => {
            if (count <= 0) return;

            const parts = fullKey.split(' ');
            const slot = parts.pop();
            const name = parts.join(' ');

            const groupKey = getGroupKey(name);
            const setType = getSetType(groupKey);

            if (setType === "ARMOR") totalArmor += count;
            else if (setType === "ACCESSORY") totalAccessory += count;
            else if (setType === "SPECIAL") totalSpecial += count;
        });

        // ----------------------------------------------------
        // 2. ì œëª©ì— ì´ ê°œìˆ˜ë¥¼ í¬í•¨í•˜ì—¬ í‘œì‹œ
        // ----------------------------------------------------

        // ë°©ì–´êµ¬
        const armorTitle = document.createElement("h2");
        armorTitle.textContent = `[ë°©ì–´êµ¬ (${totalArmor}ê°œ)]`;
        setList.appendChild(armorTitle);
        Object.keys(ARMOR_SETS).forEach(setName => {
            setList.appendChild(makeSetButton(setName, char));
        });

        // ì•…ì„¸
        const accTitle = document.createElement("h2");
        accTitle.textContent = `[ì•…ì„¸ (${totalAccessory}ê°œ)]`;
        setList.appendChild(accTitle);
        Object.keys(ACCESSORY_SETS).forEach(setName => {
            setList.appendChild(makeSetButton(setName, char));
        });

        // íŠ¹ì¥
        const spTitle = document.createElement("h2");
        spTitle.textContent = `[íŠ¹ì¥ (${totalSpecial}ê°œ)]`;
        setList.appendChild(spTitle);
        Object.keys(SPECIAL_SETS).forEach(setName => {
            setList.appendChild(makeSetButton(setName, char));
        });

        document.getElementById("panel").innerHTML = "";
    }

    // ===== ì„¸íŠ¸ ë²„íŠ¼ ìƒì„± =====
    function makeSetButton(setName, char) {
        let count3 = 0, count5 = 0;
        let totalParts = 0; // x ê°’ (ì´ ê°œìˆ˜) ì´ˆê¸°í™”

        const slots = ALL_SETS[setName] || [];
        const prefixes = ALL_PREFIX[setName] || [];
        const setType = getSetType(setName);
        const exceedSlots = EXCEED_SLOTS[setType] || [];

        // 1. ì „ì²´ ê³ ìœ  ë¶€ìœ„ ê°œìˆ˜ ê³„ì‚° (ì ‘ë‘ì–´/ìµì‹œë“œ ë¬´ì‹œ)
        const distinctParts = calcTotalDistinctParts(char, setName);

        // 2. ì´ ë¶€ìœ„ ê°œìˆ˜ (totalParts, x ê°’) ê³„ì‚°
        const allGroupKeys = [setName];
        prefixes.forEach(pref => {
            const prefixedName = `${pref}: ${setName}`;
            allGroupKeys.push(prefixedName);
            EXCEED_TAGS.forEach(tag => {
                allGroupKeys.push(`[${tag}] ${prefixedName}`);
            });
        });

        allGroupKeys.forEach(groupKey => {
            const isExceedKey = groupKey.startsWith('[');
            slots.forEach(slot => {
                let key = `${groupKey} ${slot}`;

                if (isExceedKey && !exceedSlots.includes(slot)) {
                    return;
                }

                totalParts += char.armorCounts[key] || 0;
            });
        });
        // ì´í•© ê³„ì‚° ë

        // 3. ë‹¨ì¼ distinctPartsë¥¼ ì‚¬ìš©í•œ ìµœì¢… ì„¸íŠ¸ íŒì •
        const fullSize = slots.length;

        if (fullSize === 5) { // ë°©ì–´êµ¬
            if (distinctParts === fullSize) count5 = 1; // 5ì„¸íŠ¸ ë‹¬ì„±
            else if (distinctParts >= 3) count3 = 1; // 3ì„¸íŠ¸ ë‹¬ì„± (3 ë˜ëŠ” 4)
        } else { // ì•…ì„¸/íŠ¹ì¥ (3ë¶€ìœ„)
            if (distinctParts === 3) count3 = 1; // 3ì„¸íŠ¸ ë‹¬ì„±
        }

        const btn = document.createElement("button");
        btn.className = "set-btn";

        // í™”ë©´ í‘œì‹œë¥¼ ìœ„í•œ 0 ë˜ëŠ” 1 ê°’ ì„¤ì •
        const final_count3 = count3 > 0 ? 1 : 0;
        const final_count5 = count5 > 0 ? 1 : 0;

        // ë°°ê²½ìƒ‰ ì ìš©
        if (final_count5 > 0) btn.classList.add("set5");
        else if (final_count3 > 0) btn.classList.add("set3");

        // [ì„ íƒ ìƒíƒœ ìœ ì§€ ë¡œì§ ì¶”ê°€]: í˜„ì¬ ì„ íƒëœ ì„¸íŠ¸ì™€ ì´ë¦„ì´ ê°™ìœ¼ë©´ selected í´ë˜ìŠ¤ ìœ ì§€
        if (currentSetName === setName && currentChar && currentChar.id === char.id) {
            btn.classList.add("selected");
        }


        // ğŸš¨ ìˆ˜ì •ëœ ë¶€ë¶„: "ì„¸íŠ¸ëª… (ì¥ë¹„ìˆ˜)" í˜•íƒœë¡œ ë‚´ìš© êµ¬ì„±
        const buttonContent = `${setName} (${totalParts})`;


        btn.innerHTML = buttonContent; // innerHTMLë¡œ ë‚´ìš© ì„¤ì •

        btn.onclick = (event) => {
            // [ì„ íƒ ë¡œì§ ì¶”ê°€]: ëª¨ë“  ì„¸íŠ¸ ë²„íŠ¼ì—ì„œ 'selected' í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll(".set-btn").forEach(b => b.classList.remove("selected"));
            // [ì„ íƒ ë¡œì§ ì¶”ê°€]: í˜„ì¬ í´ë¦­ëœ ë²„íŠ¼ì— 'selected' í´ë˜ìŠ¤ ì¶”ê°€
            event.currentTarget.classList.add("selected");

            openSet(setName, char);
        };

        return btn;
    }

    // ===== í‘œ í–‰ ìƒì„± =====
    function makeRow(name, setName, char) {
        const slots = ALL_SETS[setName] || [];
        const groupKey = getGroupKey(name);
        const isExceed = isExceedName(name);
        const setType = getSetType(setName);
        const exceedSlots = EXCEED_SLOTS[setType];

        // calcTotalDistinctPartsë¡œ ê¸°ë³¸ ì„¸íŠ¸ì˜ ì „ì²´ ê³ ìœ  ë¶€ìœ„ ê°œìˆ˜ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const totalDistinct = calcTotalDistinctParts(char, setName);
        const fullSize = slots.length;

        const tr = document.createElement("tr");
        let hasAnyPartInRow = false; // ğŸš¨ ì´ í–‰(ì•„ì´í…œ)ì— ë¶€ìœ„ê°€ ì¥ì°©ë˜ì—ˆëŠ”ì§€ í™•ì¸

        // 1. ì¥ì°© ì—¬ë¶€ í™•ì¸
        slots.forEach(slot => {
            let key = `${name} ${slot}`;
            if ((char.armorCounts[key] || 0) > 0) {
                hasAnyPartInRow = true;
            }
        });

        // 2. ì „ì²´ ì„¸íŠ¸ ë‹¬ì„± ì¡°ê±´ê³¼ ì¥ì°© ì—¬ë¶€ë¥¼ ëª¨ë‘ ë§Œì¡±í•  ë•Œë§Œ ìƒ‰ìƒ ê²°ì •
        if (hasAnyPartInRow) {
            if (setType === "ARMOR") {
                if (totalDistinct === fullSize) tr.className = "set5";
                else if (totalDistinct >= 3) tr.className = "set3";
            } else {
                if (totalDistinct === 3) tr.className = "set3";
            }
        }


        // =========================================================
        // ğŸ’¡ [ìµœì¢… ìˆ˜ì •] ì•„ì´í…œ ì´ë¦„ ìŠ¤íƒ€ì¼ë§ ë¡œì§ ì‹œì‘ (HTML ë¬¸ìì—´ ì¡°ë¦½)
        // =========================================================
        let itemName = name;
        let finalHtmlName = itemName;

        // 1. ìµì‹œë“œ íƒœê·¸ ([Tag]) ì²˜ë¦¬ (íƒœê·¸ ì œê±° ë° ìŠ¤íƒ€ì¼ë§ëœ íƒœê·¸ ìƒì„±)
        const exceedMatch = itemName.match(/^(\[.*?\])\s*(.*)/);
        let exceedTagHtml = '';
        let nameWithoutTag = itemName;

        if (exceedMatch) {
            const tag = exceedMatch[1]; // ì˜ˆ: [ì´ìƒ]
            nameWithoutTag = exceedMatch[2]; // ì˜ˆ: ì „ê²©: ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ
            let color = '';

            if (tag === '[ì„ ë´‰]') {
                color = '#ff4d4f'; // ë¹¨ê°„ìƒ‰
            } else if (tag === '[ì´ìƒ]') {
                color = '#25c2a0'; // ì´ˆë¡ìƒ‰
            } else if (tag === '[ì˜ì§€]') {
                color = '#3399cc'; // íŒŒë€ìƒ‰
            }

            exceedTagHtml = `<span style="color:${color}; font-weight:bold;">${tag}</span> `;
        }

        // 2. ì ‘ë‘ì–´ (Prefix:) ì²˜ë¦¬ (ë…¸ë€ìƒ‰ ì ìš©)
        let baseNameHtml = nameWithoutTag; // ìµì‹œë“œ íƒœê·¸ê°€ ìˆì—ˆë“  ì—†ì—ˆë“ , ë‚˜ë¨¸ì§€ ì´ë¦„

        const prefixMatch = nameWithoutTag.match(/(.+?):\s*(.+)/);

        if (prefixMatch) {
            const prefix = prefixMatch[1]; // ì˜ˆ: ì „ê²©
            const baseSet = prefixMatch[2]; // ì˜ˆ: ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ

            const styledPrefix = `<span style="color:#e6b800; font-weight:bold;">${prefix}</span>`;

            baseNameHtml = `${styledPrefix}: ${baseSet}`;
        }

        // 3. ìµœì¢… HTML ë¬¸ìì—´ ì¡°ë¦½
        finalHtmlName = exceedTagHtml + baseNameHtml;
        // =========================================================
        // ğŸ’¡ [ìµœì¢… ìˆ˜ì •] ì•„ì´í…œ ì´ë¦„ ìŠ¤íƒ€ì¼ë§ ë¡œì§ ë
        // =========================================================

        let html = `<td style="text-align:left;">${finalHtmlName}</td>`; // ìµœì¢… HTMLì„ ì‚½ì…

        slots.forEach(slot => {
            let key = `${name} ${slot}`;
            const val = char.armorCounts[key] || 0;
            if (isExceed) {
                if (exceedSlots.includes(slot)) {
                    html += `<td>${makeNumberButton(char.id, key, val)}</td>`;
                } else {
                    html += `<td></td>`;
                }
            } else {
                html += `<td>${makeNumberButton(char.id, key, val)}</td>`;
            }
        });
        tr.innerHTML = html;
        return tr;
    }

    // ===== ì „ì—­ ìƒíƒœ ë³€ìˆ˜ =====
    let currentSetName = null;
    let currentChar = null;
    let currentFilter = 'ALL'; // ğŸ’¡ í˜„ì¬ ì„ íƒëœ í•„í„° ('ALL', 'BASE', 'PREFIX', 'EXCEED')

    // ===== ì„¸íŠ¸ í‘œ ì—´ê¸° =====
    function openSet(setName, char) {
        // ì„¸íŠ¸ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ê¸°ë³¸ í•„í„°ë¥¼ 'ALL'ë¡œ ì´ˆê¸°í™”í•˜ê³  UI ì—…ë°ì´íŠ¸
        if (currentSetName !== setName || currentChar?.id !== char.id) {
            currentFilter = 'ALL';
        }

        currentSetName = setName;
        currentChar = char;

        const panel = document.getElementById("panel");
        panel.innerHTML = `<h2>[${setName} ì„¸íŠ¸]</h2>`;

        const slots = ALL_SETS[setName] || [];
        const table = document.createElement("table");
        table.innerHTML = `<thead>
 <tr><th>ì„¸íŠ¸ ì´ë¦„</th>${slots.map(s => `<th>${s}</th>`).join("")}</tr>
</thead><tbody></tbody>`;
        const tbody = table.querySelector("tbody");

        tbody.appendChild(makeRow(setName, setName, char));
        const prefixes = ALL_PREFIX[setName] || [];
        prefixes.forEach(pref => {
            tbody.appendChild(makeRow(`${pref}: ${setName}`, setName, char));
        });
        prefixes.forEach(pref => {
            EXCEED_TAGS.forEach(ex => {
                tbody.appendChild(makeRow(`[${ex}] ${pref}: ${setName}`, setName, char));
            });
        });

        panel.appendChild(table);

        table.querySelectorAll("th:first-child, td:first-child").forEach(cell => {
            cell.style.width = globalSetNameWidth + "px";
        });
        table.querySelectorAll("th:not(:first-child), td:not(:first-child)").forEach(cell => {
            cell.style.width = globalSlotWidth + "px";
        });


        // [ìºë¦­í„°ë³„ ìŠ¬ë¡¯ í˜„í™©]
        // âœ… ìš”ì•½ íŒ¨ë„ ì˜ì—­ì— í•„í„° ë²„íŠ¼ ì¶”ê°€
        //   const summaryHeader = document.createElement("div");
        //   summaryHeader.innerHTML = `<h2>[${setName} ì„¸íŠ¸ ìºë¦­í„°ë³„ ìŠ¬ë¡¯ í˜„í™©]</h2>`;
        //
        //   const filterContainer = document.createElement("div");
        //   filterContainer.className = "toolbar"; // ê¸°ì¡´ toolbar ìŠ¤íƒ€ì¼ ì¬í™œìš©
        //   filterContainer.style.marginBottom = "20px";
        //   filterContainer.style.marginTop = "10px";
        //
        // // openSet í•¨ìˆ˜ ë‚´ í•„í„° ë²„íŠ¼ ì •ì˜ ë¶€ë¶„ (ìˆ˜ì •/ì¶”ê°€)
        // const filters = [
        //   { id: 'ALL', text: 'ëª¨ë‘' },
        //   { id: 'BASE', text: 'ì¼ë°˜' },
        //   { id: 'PREFIX', text: 'ì ‘ë‘ì–´' },
        //   { id: 'EXCEED', text: 'ìµì‹œë“œ' },
        //   { id: 'BASE_CHAR', text: 'ì¼ë°˜(ìºë¦­)' },
        //   { id: 'PREFIX_CHAR', text: 'ì ‘ë‘ì–´(ìºë¦­)' }, // ì¶”ê°€
        //   { id: 'EXCEED_CHAR', text: 'ìµì‹œë“œ(ìºë¦­)' }  // ì¶”ê°€
        // ];
        //
        //   filters.forEach(filter => {
        //       const btn = document.createElement("button");
        //       btn.textContent = filter.text;
        //       btn.className = "action-btn set-btn"; // set-btn ìŠ¤íƒ€ì¼ì„ ì¬í™œìš©í•˜ì—¬ ë²„íŠ¼ ëª¨ì–‘ ìƒì„±
        //       btn.style.minWidth = 'unset'; // ë„ˆë¹„ ì œí•œ í•´ì œ
        //       btn.style.background = '#4a3f7a'; // ë°°ê²½ìƒ‰ í†µì¼ (file-label ìƒ‰ìƒ ì¬í™œìš©)
        //       // btn.style.borderColor = 'transparent'; // ê¸°ë³¸ í…Œë‘ë¦¬ ì œê±°
        //
        //       // í˜„ì¬ í•„í„°ì™€ ì¼ì¹˜í•˜ë©´ 'selected' í´ë˜ìŠ¤ ì¶”ê°€ (í°ìƒ‰ í…Œë‘ë¦¬)
        //       if (currentFilter === filter.id) {
        //           btn.classList.add('selected');
        //       }
        //
        //       btn.onclick = () => {
        //           currentFilter = filter.id;
        //           // ëª¨ë“  ë²„íŠ¼ì—ì„œ selected ì œê±°
        //           filterContainer.querySelectorAll('.set-btn').forEach(b => b.classList.remove('selected'));
        //           // í˜„ì¬ í´ë¦­ëœ ë²„íŠ¼ì— selected ì¶”ê°€
        //           btn.classList.add('selected');
        //
        //           // í•„í„°ë§ëœ ë‚´ìš©ì„ ë‹¤ì‹œ ë Œë”ë§
        //           showSetSlotSummary(setName);
        //       };
        //       filterContainer.appendChild(btn);
        //   });
        //
        //   panel.appendChild(summaryHeader);
        //   panel.appendChild(filterContainer);
        //
        //   // âœ… í•„í„°ì— ë§ê²Œ ìš”ì•½ íŒ¨ë„ ë Œë”ë§
        //   showSetSlotSummary(setName);
    }

    // ===== ìºë¦­í„°ë³„ ìŠ¬ë¡¯ ìš”ì•½ (ìˆ˜ì •ë¨) =====
    function showSetSlotSummary(setName) {
        // ê¸°ì¡´ showSetSlotSummaryê°€ ë Œë”ë§í•˜ë˜ ì˜ì—­ì„ ì°¾ì•„ì„œ ë¹„ìš°ê±°ë‚˜ ìƒˆë¡œ ë§Œë“­ë‹ˆë‹¤.
        // openSetì—ì„œ 'summaryHeader'ì™€ 'filterContainer'ë¥¼ ì´ë¯¸ ì¶”ê°€í–ˆìœ¼ë¯€ë¡œ,
        // ì—¬ê¸°ì„œëŠ” ì‹¤ì œ í…Œì´ë¸”ë§Œ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
        let tableContainer = document.getElementById("summaryTableContainer");
        if (!tableContainer) {
            tableContainer = document.createElement("div");
            tableContainer.id = "summaryTableContainer";
            document.getElementById("panel").appendChild(tableContainer);
        }
        tableContainer.innerHTML = '';

        const slots = ALL_SETS[setName] || [];
        const table = document.createElement("table");
        const prefixes = ALL_PREFIX[setName] || [];

        // --- [ìºë¦­í„° ìƒì„¸ ëª¨ë“œ: ì¼ë°˜(ìºë¦­), ì ‘ë‘ì–´(ìºë¦­), ìµì‹œë“œ(ìºë¦­)] ---
        if (currentFilter === 'BASE_CHAR' || currentFilter === 'PREFIX_CHAR' || currentFilter === 'EXCEED_CHAR') {
            table.innerHTML = `<thead><tr><th style="width:250px;">ì„¸íŠ¸ ì´ë¦„</th>${slots.map(s => `<th>${s}</th>`).join("")}</tr></thead><tbody></tbody>`;
            const tbody = table.querySelector("tbody");

            let targetGroupNames = [];
            if (currentFilter === 'BASE_CHAR') {
                targetGroupNames = [setName];
            } else if (currentFilter === 'PREFIX_CHAR') {
                targetGroupNames = prefixes.map(p => `${p}: ${setName}`);
            } else if (currentFilter === 'EXCEED_CHAR') {
                prefixes.forEach(p => {
                    EXCEED_TAGS.forEach(tag => targetGroupNames.push(`[${tag}] ${p}: ${setName}`));
                });
            }

            targetGroupNames.forEach(groupName => {
                // ğŸ’¡ 1. ì„¸íŠ¸ ì´ë¦„ ìŠ¤íƒ€ì¼ë§ (ìƒ‰ìƒ ì ìš©)
                let styledName = groupName;

                // ìµì‹œë“œ íƒœê·¸ ìƒ‰ìƒ ì²˜ë¦¬
                const exceedMatch = styledName.match(/^(\[.*?\])\s*(.*)/);
                if (exceedMatch) {
                    const tag = exceedMatch[1];
                    const rest = exceedMatch[2];
                    let tagColor = '#25c2a0'; // ê¸°ë³¸ ì´ˆë¡
                    if (tag === '[ì„ ë´‰]') tagColor = '#ff4d4f';
                    else if (tag === '[ì˜ì§€]') tagColor = '#3399cc';
                    else if (tag === '[ì´ìƒ]') tagColor = '#25c2a0';

                    // ë‚˜ë¨¸ì§€ ë¶€ë¶„ì—ì„œ ì ‘ë‘ì–´ ìƒ‰ìƒ ì²˜ë¦¬
                    let restStyled = rest;
                    if (rest.includes(':')) {
                        const pMatch = rest.match(/(.+?):\s*(.+)/);
                        if (pMatch) restStyled = `<span style="color:#e6b800; font-weight:bold;">${pMatch[1]}</span>: ${pMatch[2]}`;
                    }
                    styledName = `<span style="color:${tagColor}; font-weight:bold;">${tag}</span> ${restStyled}`;
                } else if (styledName.includes(':')) {
                    // ì¼ë°˜ ì ‘ë‘ì–´ ìƒ‰ìƒ ì²˜ë¦¬
                    const pMatch = styledName.match(/(.+?):\s*(.+)/);
                    if (pMatch) styledName = `<span style="color:#e6b800; font-weight:bold;">${pMatch[1]}</span>: ${pMatch[2]}`;
                }

                const tr = document.createElement("tr");
                let rowHtml = `<td style="text-align:left; font-weight:bold;">${styledName}</td>`;

                slots.forEach(slot => {
                    const holders = [];
                    characters.forEach(char => {
                        const count = char.armorCounts[`${groupName} ${slot}`] || 0;
                        if (count > 0) {
                            holders.push(`${char.job}(${char.name}) <span style="color: #ffcc00; font-weight: bold;">[${count}]</span>`);
                        }
                    });
                    rowHtml += `<td style="font-size:0.85em; text-align:left;">${holders.length > 0 ? holders.join("<br>") : "0"}</td>`;
                });

                // ğŸ’¡ 2. ë°ì´í„° ìœ ë¬´ì™€ ìƒê´€ì—†ì´ í–‰ì„ ì¶”ê°€ (rowHasData ì²´í¬ ì œê±°)
                tr.innerHTML = rowHtml;
                tbody.appendChild(tr);
            });

            tableContainer.appendChild(table);
            return;
        }

        // --- [ê¸°ì¡´ ìš”ì•½ ëª¨ë“œ (ALL, BASE, PREFIX, EXCEED) - ì½”ë“œ ë™ì¼] ---
        const isFiltered = currentFilter !== 'ALL';
        let headerHtml = `<tr><th>ìºë¦­í„°</th><th>ì§ì—…</th>${slots.map(s => `<th>${s}</th>`).join("")}`;
        headerHtml += !isFiltered ? `<th>ì„¸íŠ¸ ë‹¬ì„±</th></tr>` : `</tr>`;
        table.innerHTML = `<thead>${headerHtml}</thead><tbody></tbody>`;
        const tbody = table.querySelector("tbody");

        characters.forEach(char => {
            let hasAny = false;
            let html = `<td>${char.name}</td><td>${char.job}</td>`;

            // ìŠ¬ë¡¯ë³„ í•©ê³„ ê³„ì‚° (í˜„ì¬ í•„í„°ì— ë§ê²Œ)
            slots.forEach(slot => {
                let total = calculateSlotCountByFilter(char, setName, slot, currentFilter);

                if (total > 0) hasAny = true;
                html += `<td>${total}</td>`;
            });

            if (!hasAny) return; // í•˜ë‚˜ë„ ì¥ì°© ì•ˆ í–ˆìœ¼ë©´ ê±´ë„ˆëœë‹ˆë‹¤.

            // 'ëª¨ë‘' í•„í„°ì¼ ê²½ìš°ì—ë§Œ 'ì„¸íŠ¸ ë‹¬ì„±' ì—´ ì¶”ê°€
            if (!isFiltered) {
                // ğŸš¨ ë‹¬ì„± ì—¬ë¶€: ì ‘ë‘ì–´/ìµì‹œë“œ ë¬´ì‹œí•˜ê³  ì „ì²´ ê³ ìœ  ë¶€ìœ„ ê°œìˆ˜ë¡œ íŒì •
                const totalDistinct = calcTotalDistinctParts(char, setName);

                let status = "-";
                const setType = getSetType(setName);
                if (setType === "ARMOR") {
                    if (totalDistinct === slots.length) status = "5ì„¸íŠ¸ ë‹¬ì„±";
                    else if (totalDistinct >= 3) status = "3ì„¸íŠ¸ ë‹¬ì„±";
                } else {
                    if (totalDistinct === 3) status = "3ì„¸íŠ¸ ë‹¬ì„±";
                }

                html += `<td>${status}</td>`;
            }

            const tr = document.createElement("tr");

            // 'ëª¨ë‘' í•„í„°ì¼ ê²½ìš°ì—ë§Œ ì‹œê° ê°•ì¡° (ì´ ê³ ìœ  ë¶€ìœ„ ê°œìˆ˜ ê¸°ì¤€)
            if (!isFiltered) {
                const totalDistinct = calcTotalDistinctParts(char, setName);
                const setType = getSetType(setName);
                if (setType === "ARMOR") {
                    if (totalDistinct === slots.length) tr.className = "set5";
                    else if (totalDistinct >= 3) tr.className = "set3";
                } else {
                    if (totalDistinct === 3) tr.className = "set3";
                }
            }


            tr.innerHTML = html;
            tbody.appendChild(tr);
        });

        tableContainer.appendChild(table);
    }

    // ===== [ì‹ ê·œ í•¨ìˆ˜] í•„í„°ë³„ ìŠ¬ë¡¯ ê°œìˆ˜ ê³„ì‚° =====
    function calculateSlotCountByFilter(char, setName, slot, filter) {
        const prefixes = ALL_PREFIX[setName] || [];

        let total = 0;

        // ê²€ìƒ‰ ëŒ€ìƒ ê·¸ë£¹ ëª©ë¡ ì •ì˜
        const baseGroup = setName;
        const prefixedGroups = prefixes.map(p => `${p}: ${setName}`);
        const exceedGroups = prefixes.flatMap(p =>
            EXCEED_TAGS.map(tag => `[${tag}] ${p}: ${setName}`)
        );

        let groupsToSearch = [];

        if (filter === 'ALL') {
            // 'ëª¨ë‘': ì¼ë°˜, ì ‘ë‘ì–´, ìµì‹œë“œ ëª¨ë‘ í•©ì‚°
            groupsToSearch = [baseGroup, ...prefixedGroups, ...exceedGroups];
        } else if (filter === 'BASE') {
            // 'ì¼ë°˜': ìˆœìˆ˜ ì„¸íŠ¸ ì´ë¦„ë§Œ
            groupsToSearch = [baseGroup];
        } else if (filter === 'PREFIX') {
            // 'ì ‘ë‘ì–´': ì ‘ë‘ì–´ ë¶™ì€ ì„¸íŠ¸ë§Œ (ìµì‹œë“œ ì œì™¸)
            groupsToSearch = prefixedGroups;
        } else if (filter === 'EXCEED') {
            // 'ìµì‹œë“œ': ìµì‹œë“œ ë¶™ì€ ì„¸íŠ¸ë§Œ
            groupsToSearch = exceedGroups;
        }

        groupsToSearch.forEach(group => {
            const fullKey = `${group} ${slot}`;
            // ì£¼ì˜: 'BASE'ì™€ 'PREFIX' í•„í„°ì—ì„œëŠ” ìµì‹œë“œê°€ ë¶™ì€ í‚¤ëŠ” ì œì™¸ë©ë‹ˆë‹¤.
            // 'ALL' í•„í„°ì—ì„œëŠ” ìµì‹œë“œê°€ ë¶™ì€ í‚¤ë„ í¬í•¨ë©ë‹ˆë‹¤. (ìœ„ì˜ groupsToSearch ì •ì˜ì— ë”°ë¦„)
            total += char.armorCounts[fullKey] || 0;
        });

        return total;
    }

    // ===== ìˆ«ì ë²„íŠ¼ (ìš°í´ë¦­ ê°ì†Œ ê¸°ëŠ¥ í¬í•¨) =====
    function makeNumberButton(charId, key, val) {
        const extraClass = val > 0 ? " positive" : "";
        return `<button class="num-btn${extraClass}"
      oncontextmenu="decrement('${charId}','${key}'); return false;"
      onclick="increment('${charId}','${key}')">${val}</button>`;
    }


    // ===== ì¦ê°€/ê°ì†Œ =====
    function increment(charId, key) {
        const char = characters.find(c => c.id === charId);
        char.armorCounts[key] = (char.armorCounts[key] || 0) + 1;
        // ğŸ’¡ ì—…ë°ì´íŠ¸ ì‹œê°„ ì¶”ê°€/ê°±ì‹ 
        char.updateTimes[key] = Date.now();
        saveLocalData(); // [ë¡œì»¬ ìŠ¤í† ë¦¬ì§€] ë°ì´í„° ë³€ê²½ í›„ ì €ì¥
        showSetButtons(char, true);
        if (currentSetName && currentChar) {
            openSet(currentSetName, currentChar); // âœ… ì €ì¥ëœ ê°’ìœ¼ë¡œ ë‹¤ì‹œ ì—´ê¸°
        }
    }

    // ğŸš¨ ê°ì†Œ í•¨ìˆ˜ (ìš°í´ë¦­ ì‹œ í˜¸ì¶œ)
    function decrement(charId, key) {
        const char = characters.find(c => c.id === charId);
        const cur = char.armorCounts[key] || 0;
        char.armorCounts[key] = Math.max(0, cur - 1); // 0ë³´ë‹¤ ì‘ì•„ì§€ì§€ ì•Šê²Œ
        // ğŸ’¡ ì—…ë°ì´íŠ¸ ì‹œê°„ ì¶”ê°€/ê°±ì‹  (0ì´ ë˜ì–´ë„ ë§ˆì§€ë§‰ ìˆ˜ì • ì‹œê°„ì€ ë‚¨ê¹€)
        char.updateTimes[key] = Date.now();
        saveLocalData(); // [ë¡œì»¬ ìŠ¤í† ë¦¬ì§€] ë°ì´í„° ë³€ê²½ í›„ ì €ì¥
        showSetButtons(char, true);
        if (currentSetName && currentChar) {
            openSet(currentSetName, currentChar); // âœ… ì €ì¥ëœ ê°’ìœ¼ë¡œ ë‹¤ì‹œ ì—´ê¸°
        }
    }

    // =======================================================
    // [ë¦¬íŒ©í† ë§] ìµœê·¼ ì—…ë°ì´íŠ¸ ë‚´ì—­ í‘œì‹œ
    // =======================================================
    function showRecentUpdates() {
        const allUpdates = [];

        characters.forEach(char => {
            // 1 & 2 í†µí•© ìˆ˜ì§‘ ë¡œì§
            Object.entries(char.updateTimes).forEach(([fullKey, timestamp]) => {
                if (!timestamp || timestamp <= 0) return;

                // ë°©ì–´êµ¬/ì•…ì„¸/íŠ¹ì¥ ì²´í¬
                if (char.armorCounts && char.armorCounts[fullKey] !== undefined) {
                    const parts = fullKey.split(' ');
                    const slot = parts.pop();
                    const itemName = parts.join(' ');

                    let category = "ë°©ì–´êµ¬";
                    const baseName = itemName.split(':').pop().trim();
                    const setType = getSetType(baseName);
                    if (setType === "ACCESSORY") category = "ì•…ì„¸";
                    else if (setType === "SPECIAL") category = "íŠ¹ì¥";

                    allUpdates.push({
                        name: char.name, job: char.job, itemName: itemName,
                        category: category, slot: slot, count: char.armorCounts[fullKey], timestamp: timestamp
                    });
                }
                // ë¬´ê¸° ì²´í¬
                else if (char.weaponCounts && char.weaponCounts[fullKey] !== undefined) {
                    let weaponSubCategory = "-";
                    outerLoop:
                        for (const jobData of Object.values(WEAPON_DATA_MAP)) {
                            for (const [catName, list] of Object.entries(jobData)) {
                                // fullKeyì— ë¬´ê¸° ì´ë¦„ì´ í¬í•¨ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
                                if (list.some(name => fullKey.includes(name))) {
                                    weaponSubCategory = catName;
                                    break outerLoop;
                                }
                            }
                        }
                    allUpdates.push({
                        name: char.name, job: char.job, itemName: fullKey,
                        category: "ë¬´ê¸°", slot: weaponSubCategory, count: char.weaponCounts[fullKey], timestamp: timestamp
                    });
                }
            });
        });

        allUpdates.sort((a, b) => b.timestamp - a.timestamp);

        const modalContent = document.getElementById("updateModalContent");
        if (allUpdates.length === 0) {
            modalContent.innerHTML = "<p>ìµœê·¼ ì—…ë°ì´íŠ¸ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
            document.getElementById("updateModal").style.display = 'flex';
            return;
        }

        const table = document.createElement("table");
        table.style.width = '100%';
        table.innerHTML = `<thead><tr>
        <th style="width:20%;">ì§ì—… / ì´ë¦„</th>
        <th style="width:15%;">ì¢…ë¥˜ (ë¶€ìœ„)</th>
        <th style="width:35%;">ì•„ì´í…œ</th>
        <th style="width:10%;">ë³´ìœ  ê°œìˆ˜</th>
        <th style="width:20%;">ì—…ë°ì´íŠ¸ ì‹œê°„</th>
    </tr></thead><tbody></tbody>`;

        const tbody = table.querySelector("tbody");

        allUpdates.slice(0, 10).forEach(item => {
            const date = new Date(item.timestamp);
            const formatTime = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;

            // ğŸ’¡ ê°•í™”ëœ ìŠ¤íƒ€ì¼ë§ ë¡œì§
            let styledItemName = item.itemName;
            const tagMatch = styledItemName.match(/^(\[.*?\])\s*(.*)/);

            if (tagMatch) {
                const tag = tagMatch[1];
                const restName = tagMatch[2];
                // EXCEED_COLOR_MAP ë˜ëŠ” ì»¤ìŠ¤í…€ ë§µ í™œìš©
                let tagColor = '#ffd700';
                if (tag.includes('ì„ ë´‰') || tag.includes('ë¶„ì‡„')) tagColor = '#ff4d4f';
                else if (tag.includes('ì˜ì§€') || tag.includes('ê´‘ì±„')) tagColor = '#3399cc';
                else if (tag.includes('ì´ìƒ')) tagColor = '#25c2a0';
                else if (tag.includes('ê°•íƒ€')) tagColor = '#ffd700';

                let baseNamePart = restName;
                if (restName.includes(':')) {
                    const pMatch = restName.match(/(.+?):\s*(.+)/);
                    if (pMatch) baseNamePart = `<span style="color:#e6b800; font-weight:bold;">${pMatch[1]}</span>: ${pMatch[2]}`;
                }
                styledItemName = `<span style="color:${tagColor}; font-weight:bold;">${tag}</span> ${baseNamePart}`;
            } else if (styledItemName.includes(':')) {
                const pMatch = styledItemName.match(/(.+?):\s*(.+)/);
                if (pMatch) styledItemName = `<span style="color:#e6b800; font-weight:bold;">${pMatch[1]}</span>: ${pMatch[2]}`;
            }

            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td style="white-space:nowrap;">${item.job} / ${item.name}</td>
            <td>[${item.category}] ${item.slot}</td>
            <td style="text-align:left;">${styledItemName}</td>
            <td style="font-weight:bold; color:${item.count > 0 ? '#ffcc00' : '#888'};">${item.count}</td>
            <td style="font-size:0.9em;">${formatTime}</td>
        `;
            tbody.appendChild(tr);
        });

        modalContent.innerHTML = "";
        modalContent.appendChild(table);
        document.getElementById("updateModal").style.display = 'flex';
    }


    function exportJSON() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');

        // ë³€ê²½ëœ íŒŒì¼ëª… í˜•ì‹: dnfm_eq_YYYY-MM-DD_HH-MM.json
        const fileName = `dnfm_eq_${year}-${month}-${day}_${hours}-${minutes}.json`;

        const dataStr = JSON.stringify(characters, null, 2);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function importJSON(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
            try {
                const imported = JSON.parse(e.target.result);

                if (!Array.isArray(imported)) {
                    throw new Error("ë°ì´í„°ê°€ ë°°ì—´ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
                }

                // 1. ì „ì—­ ë°ì´í„° êµì²´ ë° í•„ìˆ˜ í•„ë“œ ë³´ì •
                characters = imported.map(char => {
                    if (!char.name || !char.job) throw new Error("ìºë¦­í„° ì´ë¦„ ë˜ëŠ” ì§ì—… ì •ë³´ê°€ ëˆ„ë½ëœ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤.");
                    return {
                        id: char.id || "c" + Date.now() + Math.random().toString(36).substr(2, 5),
                        name: char.name,
                        job: char.job,
                        armorCounts: char.armorCounts || {},
                        weaponCounts: char.weaponCounts || {},
                        updateTimes: char.updateTimes || {}
                    };
                });

                // 2. ìƒíƒœ ì´ˆê¸°í™” (UI ê¼¬ì„ ë°©ì§€)
                activeCharacterId = null;
                currentSetName = null;
                currentChar = null;

                // 3. ë¡œì»¬ ì €ì¥ ë° í™”ë©´ ê°±ì‹ 
                saveLocalData();

                // 4. í˜„ì¬ ë·°ì— ë”°ë¥¸ ë¦¬ë Œë”ë§
                renderCharacterList();
                document.getElementById("setList").innerHTML = "";
                document.getElementById("panel").innerHTML = "";

                // ë§Œì•½ ë¬´ê¸° íƒ­ì´ ì—´ë ¤ìˆë‹¤ë©´ ê°±ì‹ 
                if (document.getElementById("section-weapon-view").style.display !== "none") {
                    selectWeaponJob(activeWeaponJob || 'ê·€ê²€ì‚¬', true);
                }

                alert(`ë°ì´í„° ë³µêµ¬ ì™„ë£Œ! ì´ ${characters.length}ëª…ì˜ ë°ì´í„°ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                event.target.value = '';

            } catch (err) {
                console.error(err);
                alert("íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
            }
        };
        reader.readAsText(file);
    }

    // ë¬´ê¸° ì „ìš© ìˆ«ì ë²„íŠ¼ ìƒì„± í•¨ìˆ˜ (ê¸°ì¡´ makeNumberButton ë³µì‚¬ ë° ìˆ˜ì •)
    function makeWeaponNumberButton(charId, key, val, jobName) {
        const extraClass = val > 0 ? " positive" : "";
        return `<button class="num-btn${extraClass}"
      oncontextmenu="decrementWeapon('${charId}','${key}', '${jobName}'); return false;"
      onclick="incrementWeapon('${charId}','${key}', '${jobName}')">${val}</button>`;
    }

    // ë¬´ê¸° ì „ìš© ì¦ê°€ í•¨ìˆ˜
    function incrementWeapon(charId, key, jobName) {
        const char = characters.find(c => c.id === charId);
        if (!char) return;
        if (!char.weaponCounts) char.weaponCounts = {};

        char.weaponCounts[key] = (char.weaponCounts[key] || 0) + 1;
        char.updateTimes[key] = Date.now(); // ì—…ë°ì´íŠ¸ ì‹œê°„ ê¸°ë¡

        saveLocalData();    // ğŸ”¥ ì—¬ê¸°ì„œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥!
        selectWeaponJob(jobName, true); // í™”ë©´ ê°±ì‹ 
    }

    // ë¬´ê¸° ì „ìš© ê°ì†Œ í•¨ìˆ˜
    function decrementWeapon(charId, key, jobName) {
        const char = characters.find(c => c.id === charId);
        if (!char) return;
        if (!char.weaponCounts) char.weaponCounts = {};

        const cur = char.weaponCounts[key] || 0;
        char.weaponCounts[key] = Math.max(0, cur - 1);
        char.updateTimes[key] = Date.now();

        saveLocalData();    // ğŸ”¥ ì—¬ê¸°ì„œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥!
        selectWeaponJob(jobName, true); // í™”ë©´ ê°±ì‹ 
    }

    // ===== ë¬´ê¸° ì§ì—… ì„ íƒ ë° ë²„íŠ¼ ê°±ì‹  (ì¢…ë¥˜ ì—´ ë„ˆë¹„ ê³ ì • ë° ì •ì¤‘ì•™ ì •ë ¬) =====
    function selectWeaponJob(jobName, keepOpen = false) {
        const weaponPanel = document.getElementById("weaponPanel");
        const container = document.getElementById("weaponJobButtons");

        if (!keepOpen && activeWeaponJob === jobName) {
            activeWeaponJob = null;
            weaponPanel.innerHTML = "";
            selectWeaponJob(null);
            return;
        }

        activeWeaponJob = jobName;

        // 1. ìƒë‹¨ ì§ì—… ë²„íŠ¼ ìƒì„± ë° ì‹¤ì‹œê°„ í•©ì‚°
        container.innerHTML = "";
        JOB_LIST.forEach(j => {
            let totalCount = 0;
            const jobData = WEAPON_DATA_MAP[j];
            if (jobData) {
                characters.forEach(char => {
                    if (char.weaponCounts) {
                        Object.values(jobData).forEach(weaponList => {
                            weaponList.forEach(weaponName => {
                                WEAPON_PREFIXES.forEach(pref => {
                                    const weaponKey = `${pref.tag} ${weaponName}`;
                                    totalCount += (char.weaponCounts[weaponKey] || 0);
                                });
                            });
                        });
                    }
                });
            }
            const btn = document.createElement("button");
            btn.className = "char-btn" + (j === activeWeaponJob ? " active" : "");
            btn.textContent = `${j} (${totalCount})`;
            btn.onclick = () => selectWeaponJob(j);
            container.appendChild(btn);
        });

        if (!jobName) return;

        const currentData = WEAPON_DATA_MAP[jobName];
        if (!currentData) {
            weaponPanel.innerHTML = `<h3 style="margin-top:20px;">${jobName} ë°ì´í„°ëŠ” ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</h3>`;
            return;
        }

        let html = `<div style="overflow-x: auto; margin-top: 20px; border: 1px solid #2a3158;">`;
        html += `<table id="weaponDetailTable" style="table-layout: fixed; border-collapse: collapse; width: max-content;">`; // fixed ë ˆì´ì•„ì›ƒ ê¶Œì¥
        html += `<thead><tr style="background: #181c33;">`;

        // ğŸ’¡ 1. ì¢…ë¥˜ ì—´ì˜ ë„ˆë¹„ë¥¼ 120pxë¡œ ê³ ì • (ê°€ì¥ ê¸´ ê¸€ìì¸ 'ìë™ê¶Œì´' ë“±ì„ ê³ ë ¤)
        html += `<th style="width: 120px; padding: 12px; border: 1px solid #2a3158; white-space: nowrap;">ì¢…ë¥˜</th>`;
        html += `<th style="width: 300px; padding: 12px; border: 1px solid #2a3158; white-space: nowrap;">ë¬´ê¸° ì´ë¦„</th>`;

        characters.forEach((char, idx) => {
            const colIdx = idx + 2;
            html += `<th onclick="toggleColumnHighlight(${colIdx})" style="width: 100px; padding: 12px; border: 1px solid #2a3158; white-space: nowrap; text-align: center; cursor: pointer; user-select: none;">${char.job}<br>${char.name}</th>`;
        });
        html += `</tr></thead><tbody>`;

        // ---------------------------------------------------------
        // ğŸ’¡ ì¢…ë¥˜ë³„ ë£¨í”„ (ì •ì¤‘ì•™ ì •ë ¬ ë° ê³ ì • ë„ˆë¹„ ì ìš©)
        // ---------------------------------------------------------
        const categories = Object.keys(currentData);

        categories.forEach((category, cIdx) => {
            const weaponList = currentData[category];
            const rowSpanCount = weaponList.length * WEAPON_PREFIXES.length;

            weaponList.forEach((weaponName, wIdx) => {
                WEAPON_PREFIXES.forEach((pref, pIdx) => {
                    html += `<tr>`;

                    // ğŸ’¡ ì¢…ë¥˜ ì…€: ê°€ë¡œ/ì„¸ë¡œ ì •ì¤‘ì•™ + ë„ˆë¹„ ê³ ì • ì ìš©
                    if (wIdx === 0 && pIdx === 0) {
                        html += `<td rowspan="${rowSpanCount}" style="background:#181c33; font-weight:bold; width: 120px; border: 1px solid #2a3158; text-align:center; vertical-align: middle; color: #fff; padding: 10px;">${category}</td>`;
                    }

                    const styledName = `<span style="color:${pref.color}; font-weight:bold;">${pref.tag}</span>&nbsp;${weaponName}`;
                    html += `<td style="text-align:left; padding: 8px 15px; white-space: nowrap; border: 1px solid #2a3158;">${styledName}</td>`;

                    characters.forEach(char => {
                        const weaponKey = `${pref.tag} ${weaponName}`;
                        const val = (char.weaponCounts && char.weaponCounts[weaponKey]) || 0;
                        html += `<td style="padding: 5px; border: 1px solid #2a3158; text-align:center;">${makeWeaponNumberButton(char.id, weaponKey, val, jobName)}</td>`;
                    });
                    html += `</tr>`;
                });
            });

            // ì¹´í…Œê³ ë¦¬ ê°„ êµ¬ë¶„ ê³µë°± (íˆ¬ëª…)
            if (cIdx < categories.length - 1) {
                html += `<tr style="height: 20px;">`;
                html += `<td colspan="${characters.length + 2}" style="border: none; border-bottom: 1px solid #2a3158; background: transparent;"></td>`;
                html += `</tr>`;
            }
        });

        html += `</tbody></table></div>`;
        weaponPanel.innerHTML = html;

        if (typeof applyStoredHighlights === "function") {
            applyStoredHighlights();
        }
    }

    // ğŸ’¡ ê°•ì¡° ìƒíƒœë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ì „ì—­ ë³€ìˆ˜ (ê¸°ì¡´ Setì—ì„œ ë‹¨ì¼ ë³€ìˆ˜ë¡œ ë³€ê²½)
    let highlightedColumnIndex = null;

    function toggleColumnHighlight(colIdx) {
        // ğŸ’¡ ì´ë¯¸ ì„ íƒëœ ì—´ì„ ë‹¤ì‹œ ëˆ„ë¥´ë©´ í•´ì œ, ì•„ë‹ˆë©´ í•´ë‹¹ ì—´ ë²ˆí˜¸ ì €ì¥
        if (highlightedColumnIndex === colIdx) {
            highlightedColumnIndex = null;
        } else {
            highlightedColumnIndex = colIdx;
        }
        applyStoredHighlights();
    }

    function applyStoredHighlights() {
        const table = document.getElementById("weaponDetailTable");
        if (!table) return;

        const rows = table.rows;
        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].cells;

            // ì¢…ë¥˜/ë¬´ê¸°ì´ë¦„ ì…€ì„ ì œì™¸í•œ ì‹¤ì œ ìºë¦­í„° ë°ì´í„° ì…€ë“¤ì˜ ì‹œì‘ ìœ„ì¹˜ ê³„ì‚°
            const charStartIdx = cells.length - characters.length;

            characters.forEach((_, charIdx) => {
                const currentCellIdx = charStartIdx + charIdx;
                const absoluteColIdx = charIdx + 2; // ìºë¦­í„°ì˜ ê³ ìœ  ìˆœë²ˆ(2ë²ˆë¶€í„° ì‹œì‘)

                if (cells[currentCellIdx]) {
                    // ğŸ’¡ í˜„ì¬ ìˆœë²ˆì´ ì €ì¥ëœ ë‹¨ì¼ ì„ íƒ ì¸ë±ìŠ¤ì™€ ì¼ì¹˜í•  ë•Œë§Œ ê°•ì¡°
                    if (highlightedColumnIndex === absoluteColIdx) {
                        cells[currentCellIdx].style.backgroundColor = "rgba(255, 255, 200, 0.15)";
                    } else {
                        // ê°•ì¡°ë˜ì§€ ì•Šì€ ì…€ì€ ì›ë˜ ìƒ‰ìƒìœ¼ë¡œ ë³µêµ¬
                        cells[currentCellIdx].style.backgroundColor = i === 0 ? "#181c33" : "";
                    }
                }
            });
        }
    }

    // ëª¨ë°”ì¼ í™˜ê²½ì„ ìœ„í•œ í„°ì¹˜ ì´ë²¤íŠ¸ ëŒ€ì‘
    window.ontouchstart = function (event) {
        const modal = document.getElementById("updateModal");
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    };

    selectWeaponJob('ê·€ê²€ì‚¬');


    function closePrefixFullModal() {
        document.getElementById("prefixFullModal").style.display = 'none';
    }

    function showEquipmentDetail(mode) {
        const modal = document.getElementById("prefixFullModal");
        const content = document.getElementById("prefixFullContent");
        const mainTitle = modal.querySelector("h2");

        const TITLE_MAP = {
            'ALL': "ğŸŒŸ ëª¨ë“  ì¥ë¹„ ìºë¦­í„°ë³„ ìŠ¬ë¡¯ í˜„í™©",
            'NORMAL': "ğŸŒŸ ì¼ë°˜ ì¥ë¹„ ìºë¦­í„°ë³„ ìŠ¬ë¡¯ í˜„í™©",
            'PREFIX': "ğŸŒŸ ì ‘ë‘ì–´ ì¥ë¹„ ìºë¦­í„°ë³„ ìŠ¬ë¡¯ í˜„í™©",
            'EXCEED': "ğŸŒŸ ìµì‹œë“œ ì¥ë¹„ ìºë¦­í„°ë³„ ìŠ¬ë¡¯ í˜„í™©"
        };
        mainTitle.textContent = TITLE_MAP[mode] || "ğŸŒŸ ì¥ë¹„ í˜„í™©";

        const modalContent = modal.querySelector(".modal-content");
        if (modalContent) {
            modalContent.style.width = "max-content";
            modalContent.style.maxWidth = "95vw";
            modalContent.style.minWidth = "600px";
            modalContent.style.margin = "50px auto";
        }

        const CATEGORIES = [
            {name: "ë°©ì–´êµ¬", sets: ARMOR_SETS, prefix: ARMOR_PREFIX},
            {name: "ì•…ì„¸", sets: ACCESSORY_SETS, prefix: ACCESSORY_PREFIX},
            {name: "íŠ¹ì¥", sets: SPECIAL_SETS, prefix: SPECIAL_PREFIX}
        ];

        let fullHtml = "";

        CATEGORIES.forEach(cat => {
            Object.keys(cat.sets).forEach(baseSetName => {
                const prefixes = cat.prefix[baseSetName] || [];
                const slots = cat.sets[baseSetName];

                let targetGroupKeys = [];
                if (mode === 'NORMAL' || mode === 'ALL') {
                    targetGroupKeys.push({full: baseSetName, display: "ì¼ë°˜", type: 'NORMAL'});
                }
                if (mode === 'PREFIX' || mode === 'ALL') {
                    prefixes.forEach(p => targetGroupKeys.push({
                        full: `${p}: ${baseSetName}`,
                        display: p,
                        type: 'PREFIX'
                    }));
                }
                if (mode === 'EXCEED' || mode === 'ALL') {
                    prefixes.forEach(p => {
                        EXCEED_TAGS.forEach(tag => {
                            targetGroupKeys.push({
                                full: `[${tag}] ${p}: ${baseSetName}`,
                                display: p,
                                tag: tag,
                                type: 'EXCEED'
                            });
                        });
                    });
                }

                if (targetGroupKeys.length === 0) return;

                fullHtml += `<h3 style="margin: 40px 0 15px 0; color: #fff; text-align: left;">[${baseSetName} ì„¸íŠ¸ ìºë¦­í„°ë³„ ìŠ¬ë¡¯ í˜„í™©]</h3>`;

                let headerHtml = `<thead style="background:#181c33;"><tr>
          <th style="padding:12px; border:1px solid #2a3158; text-align:center;">ì§ì—…</th>
          <th style="padding:12px; border:1px solid #2a3158; text-align:center;">ìºë¦­í„°</th>`;

                if (mode === 'ALL' || mode === 'EXCEED') {
                    headerHtml += `<th style="padding:12px; border:1px solid #2a3158; text-align:center;">ìµì‹œë“œ</th>
                       <th style="padding:12px; border:1px solid #2a3158; text-align:center;">ì ‘ë‘ì–´</th>`;
                } else if (mode === 'PREFIX') {
                    headerHtml += `<th style="padding:12px; border:1px solid #2a3158; text-align:center;">ì ‘ë‘ì–´</th>`;
                }

                slots.forEach(s => {
                    headerHtml += `<th style="padding:12px; border:1px solid #2a3158; text-align:center;">${s}</th>`;
                });
                headerHtml += `<th style="padding:12px; border:1px solid #2a3158; text-align:center;">ì„¸íŠ¸ë‹¬ì„±</th></tr></thead>`;

                fullHtml += `<table style="width: max-content; border-collapse: collapse; margin-bottom: 30px; border: 1px solid #2a3158;">
              ${headerHtml}
              <tbody>`;

                let currentJobInTable = "";

                characters.forEach((char) => {
                    let charRows = [];
                    targetGroupKeys.forEach(group => {
                        let hasAny = false;
                        slots.forEach(slot => {
                            if ((char.armorCounts?.[`${group.full} ${slot}`] || 0) > 0) hasAny = true;
                        });
                        if (hasAny) charRows.push(group);
                    });

                    charRows.forEach((group, idx) => {
                        const isNewJobBlock = (currentJobInTable !== "" && currentJobInTable !== char.job && idx === 0);
                        if (idx === 0) currentJobInTable = char.job;

                        const borderStyle = isNewJobBlock ? "border-top: 2px solid #5560a0;" : "";

                        let rowSlotsHtml = "";
                        let setTotal = 0;
                        slots.forEach(slot => {
                            const count = (char.armorCounts?.[`${group.full} ${slot}`] || 0);
                            if (count > 0) {
                                setTotal++;
                                // ğŸ’¡ ë¶€ìœ„ë³„ ë³´ìœ  ìˆ«ìë¥¼ í°ìƒ‰(#fff)ìœ¼ë¡œ ë³€ê²½
                                rowSlotsHtml += `<td style="padding:10px; border:1px solid #2a3158; ${borderStyle} text-align:center; color:#fff; font-weight:bold;">${count}</td>`;
                            } else {
                                rowSlotsHtml += `<td style="padding:10px; border:1px solid #2a3158; ${borderStyle} text-align:center; color:#444;">0</td>`;
                            }
                        });

                        let rowInfoHtml = "";
                        if (mode === 'ALL' || mode === 'EXCEED') {
                            if (group.type === 'NORMAL') {
                                rowInfoHtml = `<td style="border:1px solid #2a3158; ${borderStyle}"></td><td style="border:1px solid #2a3158; ${borderStyle}"></td>`;
                            } else if (group.type === 'PREFIX') {
                                rowInfoHtml = `<td style="border:1px solid #2a3158; ${borderStyle}"></td>
                             <td style="padding:10px; border:1px solid #2a3158; ${borderStyle} text-align:center; color:#ffd700; font-weight:bold; background:#181c33;">${group.display}</td>`;
                            } else if (group.type === 'EXCEED') {
                                const TAG_COLORS = {"ì´ìƒ": "#2ecc71", "ì„ ë´‰": "#ff4d4d", "ì˜ì§€": "#4d94ff"};
                                const tagColor = TAG_COLORS[group.tag] || "#ffd700";
                                rowInfoHtml = `<td style="padding:10px; border:1px solid #2a3158; ${borderStyle} text-align:center; color:${tagColor}; font-weight:bold; background:#181c33;">[${group.tag}]</td>
                             <td style="padding:10px; border:1px solid #2a3158; ${borderStyle} text-align:center; color:#ffd700; font-weight:bold; background:#181c33;">${group.display}</td>`;
                            }
                        } else if (mode === 'PREFIX') {
                            rowInfoHtml = `<td style="padding:10px; border:1px solid #2a3158; ${borderStyle} text-align:center; color:#ffd700; font-weight:bold; background:#181c33;">${group.display}</td>`;
                        }

                        // ğŸ’¡ ì„¸íŠ¸ë‹¬ì„± ìƒ‰ìƒ ê·œì¹™ ì ìš©
                        let setTotalColor = '#fff'; // ê¸°ë³¸ í°ìƒ‰
                        if (setTotal === 5) {
                            setTotalColor = '#ffd700'; // 5ì„¸íŠ¸: ë…¸ë€ìƒ‰
                        } else if (setTotal >= 3) {
                            setTotalColor = '#2ecc71'; // 3, 4ì„¸íŠ¸: ì´ˆë¡ìƒ‰
                        }

                        fullHtml += `<tr>
                    <td style="padding:10px; border:1px solid #2a3158; ${borderStyle} text-align:center; background:#181c33; color:#fff; font-size:15px; font-weight:800; font-family:'Malgun Gothic', sans-serif; white-space:nowrap;">${char.job}</td>

                    <td style="padding:10px; border:1px solid #2a3158; ${borderStyle} text-align:center; background:#181c33; color:#ccc; font-size:12px; font-family:'Malgun Gothic', sans-serif; white-space:nowrap;">${char.name}</td>

                    ${rowInfoHtml}
                    ${rowSlotsHtml}
                    <td style="padding:10px; border:1px solid #2a3158; ${borderStyle} text-align:center; font-weight:bold; color:${setTotalColor};">${setTotal}</td>
                  </tr>`;
                    });
                });
                fullHtml += `</tbody></table>`;
            });
        });

        content.innerHTML = fullHtml || "<p style='color:#888; text-align:center; padding:50px;'>í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
        modal.style.display = "flex";
        if (modalContent) modalContent.scrollTop = 0;
    }

    function showEquipmentSummary(mode) {
        const modal = document.getElementById("prefixFullModal");
        const content = document.getElementById("prefixFullContent");
        const mainTitle = modal.querySelector("h2");

        // 1. íƒ€ì´í‹€ ì„¤ì •
        const TITLE_MAP = {
            'NORMAL': "ğŸŒŸ ì¼ë°˜ ì¥ë¹„ ìºë¦­í„°ë³„ ìŠ¬ë¡¯ í˜„í™© (ì „ì²´)",
            'PREFIX': "ğŸŒŸ ì ‘ë‘ì–´ ì¥ë¹„ ìºë¦­í„°ë³„ ìŠ¬ë¡¯ í˜„í™© (ì „ì²´)",
            'EXCEED': "ğŸŒŸ ìµì‹œë“œ ì¥ë¹„ ìºë¦­í„°ë³„ ìŠ¬ë¡¯ í˜„í™© (ì „ì²´)"
        };
        mainTitle.textContent = TITLE_MAP[mode] || "ğŸŒŸ ì¥ë¹„ í˜„í™©";

        // 2. ì¹´í…Œê³ ë¦¬ ì„¤ì •
        const CATEGORIES = [
            {name: "ë°©ì–´êµ¬", sets: ARMOR_SETS, prefix: ARMOR_PREFIX},
            {name: "ì•…ì„¸", sets: ACCESSORY_SETS, prefix: ACCESSORY_PREFIX},
            {name: "íŠ¹ì¥", sets: SPECIAL_SETS, prefix: SPECIAL_PREFIX}
        ];

        let fullHtml = "";

        CATEGORIES.forEach(cat => {
            Object.keys(cat.sets).forEach(baseSetName => {
                const prefixes = cat.prefix[baseSetName] || [];
                const slots = cat.sets[baseSetName];

                let targetGroups = [];
                if (mode === 'NORMAL') {
                    targetGroups.push({display: baseSetName, full: baseSetName, isPrefix: false});
                } else if (mode === 'PREFIX') {
                    prefixes.forEach(p => targetGroups.push({
                        display: p,
                        full: `${p}: ${baseSetName}`,
                        isPrefix: true
                    }));
                } else if (mode === 'EXCEED') {
                    prefixes.forEach(p => {
                        EXCEED_TAGS.forEach(tag => {
                            targetGroups.push({
                                display: p,
                                full: `[${tag}] ${p}: ${baseSetName}`,
                                isPrefix: true,
                                tag: tag
                            });
                        });
                    });
                }

                if (targetGroups.length === 0) return;

                fullHtml += `<h3 style="margin: 40px 0 15px 0; color: #fff; text-align: left;">[${baseSetName} ì„¸íŠ¸ ìºë¦­í„°ë³„ ìŠ¬ë¡¯ í˜„í™©]</h3>`;
                fullHtml += `<table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
                <thead style="background:#181c33;">
                    <tr>
                        <th style="padding:12px; border:1px solid #2a3158; text-align:center; width:220px;">ì„¸íŠ¸ ì´ë¦„</th>
                        ${slots.map(s => `<th style="padding:12px; border:1px solid #2a3158; text-align:center;">${s}</th>`).join('')}
                    </tr>
                </thead>
                <tbody>`;

                targetGroups.forEach(group => {
                    let styledName = group.full;

                    if (group.isPrefix) {
                        const prefixPart = `<span style="color:#ffd700;">${group.display}</span>`;
                        if (mode === 'EXCEED' && group.tag) {
                            const TAG_COLORS = {"ì„ ë´‰": "#ff4d4d", "ì˜ì§€": "#4d94ff", "ì´ìƒ": "#2ecc71"};
                            const tagColor = TAG_COLORS[group.tag] || "#ffd700";
                            styledName = `<span style="color:${tagColor};">[${group.tag}]</span> ${prefixPart}: ${baseSetName}`;
                        } else {
                            styledName = `${prefixPart}: ${baseSetName}`;
                        }
                    }

                    fullHtml += `<tr>
                    <td style="font-weight:bold; background:#181c33; padding:10px; border:1px solid #2a3158; color:#fff; text-align:left;">${styledName}</td>`;

                    slots.forEach(slot => {
                        const fullKey = `${group.full} ${slot}`;
                        const owners = characters
                            .filter(char => (char.armorCounts?.[fullKey] || 0) > 0)
                            .map(char => `${char.job}(${char.name}) <span style="color:#ffd700; font-weight:bold;">[${char.armorCounts[fullKey]}]</span>`);

                        const cellContent = owners.length > 0 ? owners.join("<br>") : "0";
                        fullHtml += `<td style="padding:10px; border:1px solid #2a3158; text-align:center; font-size:0.9em; line-height:1.5;">${cellContent}</td>`;
                    });
                    fullHtml += `</tr>`;
                });
                fullHtml += `</tbody></table>`;
            });
        });

        // ğŸ’¡ í•µì‹¬ ìˆ˜ì • ë¶€ë¶„: ìˆœì„œ ë³€ê²½ ë° íƒ€ê²Ÿ ëª…í™•í™”
        content.innerHTML = fullHtml || "<p style='color:#888; text-align:center;'>í‘œì‹œí•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";

        // 1. ëª¨ë‹¬ì„ ë¨¼ì € ë³´ì—¬ì¤ë‹ˆë‹¤.
        modal.style.display = "flex";

        // 2. ëª¨ë‹¬ì´ ë³´ì—¬ì§„ ì§í›„ì— ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ ì˜¬ë¦½ë‹ˆë‹¤.
        // #prefixFullModal ë°”ë¡œ ì•„ë˜ì— ìˆëŠ” .modal-contentë¥¼ ì •í™•íˆ ì§€ëª©í•©ë‹ˆë‹¤.
        const scrollBox = modal.querySelector(".modal-content");
        if (scrollBox) {
            scrollBox.scrollTop = 0;  // ìŠ¤í¬ë¡¤ ìœ„ì¹˜ ì´ˆê¸°í™”
            scrollBox.scrollTo(0, 0); // ì¼ë¶€ ë¸Œë¼ìš°ì € í˜¸í™˜ì„±ì„ ìœ„í•´ ì¶”ê°€
        }
    }

    // 3-1. í™”ë©´ ì „í™˜ í•¨ìˆ˜ ìˆ˜ì •
    function switchTo(view) {
        const sections = {
            'char': document.getElementById("section-character-view"),
            'weapon': document.getElementById("section-weapon-view"),
            'equipment': document.getElementById("section-equipment-view")
        };
        const buttons = {
            'char': document.getElementById("tab-char"),
            'weapon': document.getElementById("tab-weapon"),
            'equipment': document.getElementById("tab-equipment")
        };

        // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê³  ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
        Object.keys(sections).forEach(k => {
            if (sections[k]) sections[k].style.display = "none";
            if (buttons[k]) {
                buttons[k].style.background = "#2a3158";
                buttons[k].style.border = "2px solid transparent";
            }
        });

        // ì„ íƒëœ ì„¹ì…˜ ë³´ì´ê¸° ë° ë²„íŠ¼ ê°•ì¡°
        if (sections[view]) sections[view].style.display = "block";
        if (buttons[view]) {
            buttons[view].style.background = "#4a33cc";
            buttons[view].style.border = "2px solid #fff";
        }

        // íƒ­ë³„ ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        if (view === 'char') renderCharacterList();
        if (view === 'weapon') selectWeaponJob('ê·€ê²€ì‚¬', true);
        if (view === 'equipment') {
            renderEquipmentTab('ALL');

            // ì¥ë¹„ ê´€ë¦¬ íˆ´ë°”ì˜ ì²« ë²ˆì§¸ ë²„íŠ¼ì„ ì°¾ì•„ì„œ active í´ë˜ìŠ¤ ë¶€ì—¬
            const equipmentToolbar = document.querySelector("#section-equipment-view .toolbar");
            const firstBtn = equipmentToolbar.querySelector(".char-btn");

            // ëª¨ë“  ì¥ë¹„ ë²„íŠ¼ ì´ˆê¸°í™” í›„ ì²« ë²ˆì§¸ ë²„íŠ¼ë§Œ ì¼¬
            equipmentToolbar.querySelectorAll(".char-btn").forEach(b => b.classList.remove("active"));
            if (firstBtn) firstBtn.classList.add("active");
        }

        window.scrollTo(0, 0);
    }

    // 1. ìºë¦­í„°ë³„ í˜„í™© ë Œë”ë§ (ìµì‹œë“œ ìƒ‰ìƒ ì ìš©)
    function renderEquipmentTab(mode) {
        const displayArea = document.getElementById("equipment-display-area");
        const CATEGORIES = [
            {name: "ë°©ì–´êµ¬", sets: ARMOR_SETS, prefix: ARMOR_PREFIX},
            {name: "ì•…ì„¸", sets: ACCESSORY_SETS, prefix: ACCESSORY_PREFIX},
            {name: "íŠ¹ì¥", sets: SPECIAL_SETS, prefix: SPECIAL_PREFIX}
        ];

        let fullHtml = `<h2 style="color:#ffd700; margin-bottom:20px;">ğŸ“Š ìºë¦­í„°ë³„ ìƒì„¸ í˜„í™© (${mode})</h2>`;

        CATEGORIES.forEach(cat => {
            Object.keys(cat.sets).forEach(baseSetName => {
                const prefixes = cat.prefix[baseSetName] || [];
                const slots = cat.sets[baseSetName];
                const setType = getSetType(baseSetName);
                let targetGroupKeys = [];

                if (mode === 'NORMAL' || mode === 'ALL') targetGroupKeys.push({
                    full: baseSetName,
                    display: "ì¼ë°˜",
                    type: 'NORMAL'
                });
                if (mode === 'PREFIX' || mode === 'ALL') prefixes.forEach(p => targetGroupKeys.push({
                    full: `${p}: ${baseSetName}`,
                    display: p,
                    type: 'PREFIX'
                }));
                if (mode === 'EXCEED' || mode === 'ALL') {
                    prefixes.forEach(p => {
                        EXCEED_TAGS.forEach(tag => targetGroupKeys.push({
                            full: `[${tag}] ${p}: ${baseSetName}`,
                            display: p,
                            tag: tag,
                            type: 'EXCEED'
                        }));
                    });
                }

                if (targetGroupKeys.length === 0) return;

                // í•´ë‹¹ ì„¸íŠ¸ì˜ ì „ì²´ ë‹¬ì„± ìƒíƒœë¥¼ ë¯¸ë¦¬ ê³„ì‚°í•˜ê¸° ìœ„í•´ calcTotalDistinctParts í™œìš© ì¤€ë¹„
                fullHtml += `<h3 style="color:#fff; margin-top:30px;">[${baseSetName} ì„¸íŠ¸]</h3>`;
                fullHtml += `<table style="width:max-content; border-collapse:collapse; margin-bottom:20px; border:1px solid #2a3158;">
                    <thead style="background:#181c33;"><tr>
                        <th style="padding:10px; border:1px solid #2a3158; white-space:nowrap;">ì§ì—…</th>
                        <th style="padding:10px; border:1px solid #2a3158; white-space:nowrap;">ì´ë¦„</th>
                        ${(mode === 'ALL' || mode === 'EXCEED') ? '<th style="padding:10px; border:1px solid #2a3158; white-space:nowrap;">ìµì‹œë“œ</th>' : ''}
                        <th style="padding:10px; border:1px solid #2a3158; white-space:nowrap;">ì ‘ë‘ì–´</th>
                        ${slots.map(s => `<th style="padding:10px; border:1px solid #2a3158; white-space:nowrap;">${s}</th>`).join('')}
                        <th style="padding:10px; border:1px solid #2a3158; white-space:nowrap;">ë‹¬ì„±</th>
                    </tr></thead><tbody>`;

                characters.forEach(char => {
                    // ğŸ’¡ ìˆ˜ì •: í•´ë‹¹ ìºë¦­í„°ì˜ 'ì „ì²´ ê³ ìœ  ë¶€ìœ„'ë¥¼ ë¨¼ì € ê³„ì‚° (ì ‘ë‘ì–´/ìµì‹œë“œ ë¬´ê´€í•˜ê²Œ í•©ì³ì„œ íŒì •í•  ë•Œ ì‚¬ìš©)
                    const totalDistinct = calcTotalDistinctParts(char, baseSetName);

                    targetGroupKeys.forEach(group => {
                        let hasAny = slots.some(s => (char.armorCounts?.[`${group.full} ${s}`] || 0) > 0);
                        if (!hasAny) return;

                        let slotsHtml = slots.map(s => {
                            const count = char.armorCounts?.[`${group.full} ${s}`] || 0;
                            return `<td style="padding:10px; border:1px solid #2a3158; text-align:center; color:${count > 0 ? '#fff' : '#444'}; font-weight:bold;">${count}</td>`;
                        }).join('');

                        let rowInfo = "";
                        const tagColor = EXCEED_COLOR_MAP[group.tag] || "#ffd700"; // ìµì‹œë“œ ìƒ‰ìƒ ì¶”ì¶œ

                        if (mode === 'ALL' || mode === 'EXCEED') {
                            const tagCol = group.tag ? `<td style="padding:10px; border:1px solid #2a3158; color:${tagColor}; font-weight:bold; white-space:nowrap;">[${group.tag}]</td>` : `<td style="border:1px solid #2a3158;"></td>`;
                            rowInfo = tagCol + `<td style="padding:10px; border:1px solid #2a3158; color:#ffd700; font-weight:bold; white-space:nowrap;">${group.display}</td>`;
                        } else {
                            rowInfo = `<td style="padding:10px; border:1px solid #2a3158; color:#ffd700; font-weight:bold; white-space:nowrap;">${group.display}</td>`;
                        }

                        // ğŸ’¡ ìˆ˜ì •: ë‹¬ì„± ìƒ‰ìƒ íŒì • ë¡œì§ì„ ê³µí†µ ê·œì¹™(3ì„¸íŠ¸/5ì„¸íŠ¸)ì— ë§ê²Œ ì ìš©
                        let statusColor = "#fff";
                        if (setType === "ARMOR") {
                            if (totalDistinct === 5) statusColor = "#ffd700";
                            else if (totalDistinct >= 3) statusColor = "#2ecc71";
                        } else {
                            if (totalDistinct === 3) statusColor = "#2ecc71";
                        }

                        fullHtml += `<tr>
                            <td style="padding:10px; border:1px solid #2a3158; background:#181c33; white-space:nowrap;">${char.job}</td>
                            <td style="padding:10px; border:1px solid #2a3158; white-space:nowrap;">${char.name}</td>
                            ${rowInfo}${slotsHtml}
                            <td style="padding:10px; border:1px solid #2a3158; font-weight:bold; text-align:center; color:${statusColor};">${totalDistinct}</td>
                        </tr>`;
                    });
                });
                fullHtml += `</tbody></table>`;
            });
        });

        displayArea.innerHTML = fullHtml;
    }

    // 2. ì „ì²´ í˜„í™© ë Œë”ë§ (ì´ë¦„ ì—´ ë„ˆë¹„ ê³ ì • ë° ìƒ‰ìƒ ì ìš©)
    function renderFullEquipmentTab(mode) {
        const displayArea = document.getElementById("equipment-display-area");
        const CATEGORIES = [
            {name: "ë°©ì–´êµ¬", sets: ARMOR_SETS, prefix: ARMOR_PREFIX},
            {name: "ì•…ì„¸", sets: ACCESSORY_SETS, prefix: ACCESSORY_PREFIX},
            {name: "íŠ¹ì¥", sets: SPECIAL_SETS, prefix: SPECIAL_PREFIX}
        ];

        let fullHtml = `<h2 style="color:#ffd700; margin-bottom:20px;">ğŸŒ ì•„ì´í…œë³„ ì „ì²´ í˜„í™© (${mode})</h2>`;

        CATEGORIES.forEach(cat => {
            Object.keys(cat.sets).forEach(baseSetName => {
                const prefixes = cat.prefix[baseSetName] || [];
                let slots = [...cat.sets[baseSetName]];
                let targetGroups = [];

                if (mode === 'NORMAL') {
                    targetGroups.push({display: baseSetName, full: baseSetName});
                } else if (mode === 'PREFIX') {
                    prefixes.forEach(p => targetGroups.push({
                        display: p,
                        full: `${p}: ${baseSetName}`,
                        type: 'PREFIX'
                    }));
                } else if (mode === 'EXCEED') {
                    slots = slots.filter(s => s === "ìƒì˜" || s === "íŒ”ì°Œ" || s === "ê·€ê±¸ì´");
                    if (slots.length === 0) return;
                    prefixes.forEach(p => {
                        EXCEED_TAGS.forEach(tag => targetGroups.push({
                            display: p,
                            full: `${p}: ${baseSetName}`,
                            tag: tag,
                            type: 'EXCEED'
                        }));
                    });
                }

                if (targetGroups.length === 0) return;

                // í•´ë‹¹ ì„¸íŠ¸ ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ í™•ì¸
                const hasData = targetGroups.some(group => {
                    const searchKeyBase = group.tag ? `[${group.tag}] ${group.full}` : group.full;
                    return characters.some(c => slots.some(slot => (c.armorCounts?.[`${searchKeyBase} ${slot}`] || 0) > 0));
                });
                if (!hasData) return;

                fullHtml += `<h3 style="color:#fff; margin-top:30px; margin-bottom:10px;">[${baseSetName} ì„¸íŠ¸]</h3>`;

                fullHtml += `<table style="width: max-content; border-collapse: collapse; margin-bottom: 20px; border: 1px solid #2a3158;">
                <thead style="background:#181c33;"><tr>
                    <th style="padding:10px; border:1px solid #2a3158; color:#fff; text-align:center; white-space:nowrap;">ì•„ì´í…œ ì„¸íŠ¸ ì´ë¦„</th>
                    ${slots.map(s => `<th style="padding:10px; border:1px solid #2a3158; color:#fff; text-align:center; white-space:nowrap; min-width:180px;">${s}</th>`).join('')}
                </tr></thead><tbody>`;

                targetGroups.forEach(group => {
                    const searchKeyBase = group.tag ? `[${group.tag}] ${group.full}` : group.full;

                    // ì¼ë°˜/ì ‘ë‘ì–´ ëª¨ë“œì—ì„œë§Œ ì‚¬ìš©í•  'ì „ì²´ ìºë¦­í„°' ë¦¬ìŠ¤íŠ¸ (ìµì‹œë“œëŠ” ê° ì¹¸ë§ˆë‹¤ ë”°ë¡œ ì¶”ì¶œ)
                    let relevantOwners = characters.filter(c => {
                        return slots.some(slot => (c.armorCounts?.[`${searchKeyBase} ${slot}`] || 0) > 0);
                    });

                    let displayName = "";
                    if (group.type === 'EXCEED' || group.type === 'PREFIX') {
                        displayName = `<span style="color:#ffd700; font-weight:bold;">${group.display}</span>: <span style="color:#fff;">${baseSetName}</span>`;
                        if (group.tag) {
                            const tagColor = EXCEED_COLOR_MAP[group.tag] || "#ffd700";
                            displayName = `<span style="color:${tagColor}; font-weight:bold;">[${group.tag}]</span> ` + displayName;
                        }
                    } else {
                        displayName = `<span style="color:#fff;">${group.full}</span>`;
                    }

                    fullHtml += `<tr>
                    <td style="padding:12px; border:1px solid #2a3158; background:#111529; vertical-align:middle; text-align:center; white-space:nowrap; color:#fff; font-size:14px;">${displayName}</td>`;

                    slots.forEach(slot => {
                        fullHtml += `<td style="padding:8px; border:1px solid #2a3158; vertical-align:middle; text-align:center; background:#0f1222;">`;

                        if (mode === 'EXCEED') {
                            // ğŸ’¡ ìµì‹œë“œ: ê°€ë¡œì¤„ ë§ì¶”ì§€ ì•Šê³  ë°ì´í„°ê°€ ìˆëŠ” ìºë¦­í„°ë§Œ ì´˜ì´˜í•˜ê²Œ ì¶œë ¥
                            const ownersWithItem = characters.filter(c => (c.armorCounts?.[`${searchKeyBase} ${slot}`] || 0) > 0);
                            if (ownersWithItem.length > 0) {
                                ownersWithItem.forEach(owner => {
                                    const count = owner.armorCounts[`${searchKeyBase} ${slot}`];
                                    fullHtml += `<div style="margin:4px 0; white-space:nowrap; font-size:14px;">
                                    <span style="color:#aaa;">${owner.job}</span>
                                    <span style="color:#fff; font-weight:bold;">(${owner.name})</span>
                                    <span style="color:#ffd700; font-weight:bold;">[${count}]</span>
                                </div>`;
                                });
                            } else {
                                fullHtml += `<span style="color:#444;">0</span>`;
                            }
                        } else {
                            // ğŸ’¡ ì¼ë°˜/ì ‘ë‘ì–´: ëª¨ë“  ìºë¦­í„°ì˜ ìë¦¬ë¥¼ ë§Œë“¤ì–´ ê°€ë¡œì¤„ ë¼ì¸ì„ ë§ì¶¤ (30px ê³ ì •)
                            relevantOwners.forEach(owner => {
                                const count = owner.armorCounts?.[`${searchKeyBase} ${slot}`] || 0;
                                fullHtml += `<div style="height:30px; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; justify-content:center; align-items:center; gap:8px; white-space:nowrap; padding: 0 10px; font-size:14px;">`;
                                if (count > 0) {
                                    fullHtml += `<span style="color:#aaa;">${owner.job}</span>
                                             <span style="color:#fff; font-weight:bold;">(${owner.name})</span>
                                             <span style="color:#ffd700; font-weight:bold;">[${count}]</span>`;
                                } else {
                                    fullHtml += `<span style="color:#444;">0</span>`;
                                }
                                fullHtml += `</div>`;
                            });
                        }
                        fullHtml += `</td>`;
                    });
                    fullHtml += `</tr>`;
                });
                fullHtml += `</tbody></table>`;
            });
        });
        displayArea.innerHTML = fullHtml;
    }

    // ëª¨ë°”ì¼ í„°ì¹˜ ëŒ€ì‘ (í„°ì¹˜ ì‹œì‘ ì‹œ ë‹«ê¸°)
    window.ontouchstart = function (event) {
        const modal = document.getElementById("prefixFullModal");
        if (event.target === modal) {
            modal.style.display = "none";
        }
    };


    // ëª¨ë“  íŒì—…ì°½ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° ì²˜ë¦¬ (í†µí•© ë²„ì „)
    window.onclick = function (event) {
        const updateModal = document.getElementById("updateModal");
        const prefixModal = document.getElementById("prefixFullModal");
        const actionModal = document.getElementById("actionModal");
        const confirmModal = document.getElementById("confirmModal");

        // 1. ìµœê·¼ ì—…ë°ì´íŠ¸ ë‚´ì—­ ëª¨ë‹¬
        if (event.target === updateModal) {
            updateModal.style.display = 'none';
        }
        // 2. ì „ì²´ ì¥ë¹„ í˜„í™© ëª¨ë‹¬
        if (event.target === prefixModal) {
            prefixModal.style.display = 'none';
        }
        // 3. ìºë¦­í„° ì•¡ì…˜(ìˆ˜ì •/ì‚­ì œ ë“±) ëª¨ë‹¬
        if (event.target === actionModal) {
            actionModal.style.display = 'none';
        }
        // 4. í™•ì¸(Confirm) ëª¨ë‹¬
        if (event.target === confirmModal) {
            if (typeof closeConfirmModal === "function") closeConfirmModal();
            else confirmModal.style.display = 'none';
        }
    };

    // ëª¨ë°”ì¼ í™˜ê²½ í„°ì¹˜ ëŒ€ì‘ í†µí•©
    window.ontouchstart = function (event) {
        const prefixModal = document.getElementById("prefixFullModal");
        const updateModal = document.getElementById("updateModal");
        const actionModal = document.getElementById("actionModal");
        const confirmModal = document.getElementById("confirmModal");

        if (event.target === prefixModal) prefixModal.style.display = 'none';
        if (event.target === updateModal) updateModal.style.display = 'none';
        if (event.target === actionModal) actionModal.style.display = 'none';
        if (event.target === confirmModal) {
            if (typeof closeConfirmModal === "function") closeConfirmModal();
            else confirmModal.style.display = 'none';
        }
    };

    // ì¥ë¹„ ê´€ë¦¬ ë²„íŠ¼ í™œì„±í™” ë¡œì§ (ë¬´ê¸° ê´€ë¦¬ ë°©ì‹ ì°¸ì¡°)
    function setActiveEquipmentButton(clickedBtn) {
        // 1. ì¥ë¹„ ê´€ë¦¬ ì„¹ì…˜(#section-equipment-view) ì „ì²´ì—ì„œ ëª¨ë“  char-btnì„ ì°¾ìŒ
        const allEquipmentButtons = document.querySelectorAll("#section-equipment-view .char-btn");

        // 2. ëª¨ë“  ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±° (ë¶ˆë¹› ë„ê¸°)
        allEquipmentButtons.forEach(btn => btn.classList.remove('active'));

        // 3. í˜„ì¬ í´ë¦­í•œ ë²„íŠ¼ì—ë§Œ active í´ë˜ìŠ¤ ì¶”ê°€ (ë¶ˆë¹› ì¼œê¸°)
        if (clickedBtn) {
            clickedBtn.classList.add('active');
        }
    }
</script>

</div>
</div>

<div id="actionModal" class="modal-overlay" style="display:none;">
    <div class="modal-content"></div>
</div>

<div id="confirmModal" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="min-width: 300px; text-align: center;">
        <h3 id="confirmTitle" style="color: #fff; margin-bottom: 15px;"></h3>
        <p id="confirmMessage" style="color: #ccc; margin-bottom: 25px;"></p>

        <div class="modal-options" style="display: flex; gap: 10px; justify-content: center;">
            <button id="confirmYes" class="modal-btn" style="background: #e74c3c; flex: 1; color: #fff;">í™•ì¸</button>
            <button class="modal-btn" style="background: #444; flex: 1; color: #fff;" onclick="closeConfirmModal()">ì·¨ì†Œ
            </button>
        </div>
    </div>
</div>

<div id="prefixFullModal" class="modal-overlay">
    <div class="modal-content"
         style="min-width: 95vw; max-height: 90vh; overflow-y: auto; background: #0f1222; position: relative; text-align: left;">
        <button onclick="closePrefixFullModal()"
                style="position: absolute; top: 20px; right: 20px; background: none; border: none; color: #fff; font-size: 35px; cursor: pointer; line-height: 1; z-index: 10;">
            &times;
        </button>

        <h2 style="color: #fff; margin-bottom: 20px; text-align: left;">ğŸŒŸ ì ‘ë‘ì–´ ì„¸íŠ¸ ìºë¦­í„°ë³„ ìŠ¬ë¡¯ í˜„í™© (ì „ì²´)</h2>
        <div id="prefixFullContent"></div>

        <div class="modal-options" style="margin-top: 30px; text-align: center;">
            <button class="modal-btn modal-cancel-btn" onclick="closePrefixFullModal()">ë‹«ê¸°</button>
        </div>
    </div>
</div>
</body>
</html>