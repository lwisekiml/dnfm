<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ìºë¦­í„° ì¥ë¹„ ê´€ë¦¬ + CSV</title>
  <style>
    body { font-family:sans-serif; background:#0f1222; color:#e6e9ff; }
    h1 { margin-bottom:10px; }

    /* íˆ´ë°” ì˜ì—­ */
    .toolbar { margin:15px 0; display:flex; gap:10px; align-items:center; }
    .action-btn, .file-label {
      min-width:140px; text-align:center; padding:10px 16px;
      border-radius:6px; cursor:pointer; font-weight:bold; transition:0.2s;
    }
    .action-btn { background:linear-gradient(135deg,#25c2a0,#1a8c7d); border:none; color:#fff; }
    .action-btn:hover { background:linear-gradient(135deg,#1a8c7d,#25c2a0); }
    .file-label { background:#4a3f7a; color:#fff; border:none; }
    .file-label:hover { background:#5a4f8a; }
    .file-label input { display:none; }

    /* ìºë¦­í„° ì¶”ê°€ í¼ */
    .form-box { display:flex; gap:10px; margin:10px 0; }
    .form-box input {
      width:20ch; padding:6px; border-radius:6px; border:1px solid #2a3158;
      background:#181c33; color:#e6e9ff;
    }
    .add-btn {
      background:linear-gradient(135deg,#ffd700,#e6b800); border:none; color:#000;
      padding:8px 14px; border-radius:6px; cursor:pointer; font-weight:bold; transition:0.2s;
    }
    .add-btn:hover { background:linear-gradient(135deg,#e6b800,#ffd700); }

    /* ìºë¦­í„° ë²„íŠ¼ */
    .char-btn {
      margin:5px; padding:10px 16px; background:#2a3158; border:none;
      border-radius:6px; color:#fff; font-weight:bold; cursor:pointer; transition:0.2s;
    }
    .char-btn:hover { background:#3a4270; }

    /* ì„¸íŠ¸ ë²„íŠ¼ */
    .set-btn {
      margin:5px; padding:8px 14px; min-width:180px;
      background:#181c33; 
      /* ğŸš¨ ì´ ë¶€ë¶„ì„ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤: 1px -> 3px solid transparentë¡œ ë³€ê²½í•˜ì—¬ ê³µê°„ í™•ë³´ */
      border:3px solid transparent; 
      border-radius:6px;
      color:#e6e9ff; font-weight:bold; cursor:pointer; transition:0.2s;
      text-align:center; white-space:nowrap;
    }
    .set-btn:hover { 
        background:#2a3158; 
        /* í˜¸ë²„ ì‹œ í…Œë‘ë¦¬ ìƒ‰ìƒë§Œ ì‚´ì§ ë³€ê²½ (ì›€ì§ì„ ë°©ì§€) */
        border-color: #3a4270; 
    }
    .set-btn.set3 { background-color:#25c2a0; color:#fff; }
    .set-btn.set5 { background-color:#ffd700; color:#000; }
    
    /* ì„¸íŠ¸ ë²„íŠ¼ ì„ íƒ ì‹œ */
    .set-btn.selected {
      /* 3px ë‘ê»˜ê°€ ìœ ì§€ë˜ë¯€ë¡œ ì›€ì§ì„ ì—†ìŒ */
      border: 3px solid #ffffff; /* í°ìƒ‰ í…Œë‘ë¦¬ ê°•ì¡° */
      box-shadow: 0 0 12px rgba(255, 255, 255, 0.7); /* ì€ì€í•œ í°ìƒ‰ ê·¸ë¦¼ì */
    }

    h2 { margin:24px 0 8px; }
    table { border-collapse:collapse; margin-top:6px; table-layout:fixed; }
    th, td { border:1px solid #2a3158; padding:6px; text-align:center; white-space:nowrap; }
    th { background:#181c33; }
    tr.set3 { background-color:rgba(37,194,160,0.35); }
    tr.set5 { background-color:rgba(255,215,0,0.45); }

    /* ìˆ«ì ë²„íŠ¼ */
    .num-btn {
      padding:6px 10px; border-radius:6px; border:1px solid #2a3158;
      background:#181c33; color:#e6e9ff; cursor:pointer;
    }
    .num-btn.positive {
      background: linear-gradient(135deg, #3399cc, #2a6f9e);
      color: #fff;
      font-weight: bold;
      border: 1px solid #3399cc;
    }

    .character-wrapper {
      display: inline-flex;
      align-items: center;
      margin: 5px;
    }

    .delete-btn {
      padding: 4px 8px;
      background: linear-gradient(135deg, #8c1a1a, #b22222);
      border: none;
      border-radius: 4px;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: 0.2s;
    }
    .delete-btn:hover {
      background: linear-gradient(135deg, #b22222, #8c1a1a);
      transform: scale(1.05);
    }

    .char-btn.active {
      background: #b8860b;   /* ì€ì€í•œ ê¸ˆë¹› ê³„ì—´ (DarkGoldenrod) */
      color: #fff;
      border: 1px solid #daa520; /* ì¡°ê¸ˆ ë” ë°ì€ ê¸ˆë¹› í…Œë‘ë¦¬ */
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.6); /* ì€ì€í•œ ê¸ˆë¹› ê·¸ë¦¼ì */
    }
    /* ì„¸íŠ¸ ë²„íŠ¼ ì•ˆì— ì‚¬ìš©í•  ìˆ«ì ìƒ‰ìƒ */
    .set-btn .count-3 { color: #000000; /* ë°ì€ íŒŒë€ìƒ‰ */ font-weight: bold; }
    .set-btn .count-5 { color: #ff4d4f; /* ë°ì€ ë¹¨ê°„ìƒ‰ */ font-weight: bold; }

	/* CSS ì„¹ì…˜ì— ì¶”ê°€ (ì„ íƒ ì‚¬í•­) */
.exceed-tag {
    color: #25c2a0; /* ì´ˆë¡ìƒ‰ */
    font-weight: bold;
}
.prefix-tag {
    color: #e6b800; /* ì—°í•œ ë…¸ë€ìƒ‰ */
    font-weight: bold;
}

    /* ========================= */
    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    /* ========================= */
    .modal-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7); display: none; justify-content: center;
      align-items: center; z-index: 1000;
    }
    .modal-content {
      background: #181c33; padding: 30px; border-radius: 8px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5); text-align: center;
      min-width: 300px;
    }
    .modal-content h3 { margin-top: 0; color: #ffd700; }
    .modal-options { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
    .modal-btn {
      padding: 10px 20px; border: none; border-radius: 6px;
      font-weight: bold; cursor: pointer; transition: 0.2s;
    }
    .modal-delete-btn { background: #b22222; color: #fff; }
    .modal-delete-btn:hover { background: #8c1a1a; }
    .modal-reset-btn { background: #3399cc; color: #fff; }
    .modal-reset-btn:hover { background: #2a6f9e; }
    .modal-cancel-btn { background: #4a3f7a; color: #fff; }
    .modal-cancel-btn:hover { background: #5a4f8a; }
  </style>
</head>
<body>

<h1>ìºë¦­í„° ì¥ë¹„ ê´€ë¦¬</h1>
<div class="toolbar">
  <button class="action-btn" onclick="exportCSV()">ğŸ’¾ CSV ì €ì¥</button>
  <label class="file-label">
    ğŸ“‚ CSV ë¶ˆëŸ¬ì˜¤ê¸°
    <input type="file" id="csvFile" accept=".csv">
  </label>
  
  <button class="action-btn" style="background: linear-gradient(135deg, #6a5acd, #483d8b);" onclick="exportJSON()">ğŸ’ JSON ì €ì¥ (ë°±ì—…)</button>
  <label class="file-label" style="background: #2c3e50;">
    ğŸ“¥ JSON ë¶ˆëŸ¬ì˜¤ê¸°
    <input type="file" id="jsonFile" accept=".json" onchange="importJSON(event)">
  </label>
</div>

<button class="action-btn" onclick="showRecentUpdates()">ğŸŒŸ ìµœê·¼ ì¥ë¹„ ì—…ë°ì´íŠ¸ (TOP 10)</button>

<h2>[ìºë¦­í„°]</h2>
<div class="form-box">
  <input type="text" id="newCharName" placeholder="ì´ë¦„ ì…ë ¥">
  <input type="text" id="newCharJob" placeholder="ì§ì—… ì…ë ¥">
  <button class="add-btn" onclick="addCharacter()">â• ì¶”ê°€</button>
</div>
<div id="characterList"></div>

<div id="setList"></div>
<div id="panel"></div>


<div id="weaponSection" style="margin-top: 40px; border-top: 1px dashed #2a3158; padding-top: 20px;">
  <h2>[ë¬´ê¸°]</h2>
  <div class="toolbar" id="weaponJobButtons">
    <button class="char-btn" onclick="selectWeaponJob('ê·€ê²€ì‚¬')">ê·€ê²€ì‚¬</button>
    <button class="char-btn" onclick="selectWeaponJob('ê²©íˆ¬ê°€')">ê²©íˆ¬ê°€</button>
    <button class="char-btn" onclick="selectWeaponJob('ê±°ë„ˆ')">ê±°ë„ˆ</button>
	<button class="char-btn" onclick="selectWeaponJob('ë§ˆë²•ì‚¬')">ë§ˆë²•ì‚¬</button>
    <button class="char-btn" onclick="selectWeaponJob('í”„ë¦¬ìŠ¤íŠ¸')">í”„ë¦¬ìŠ¤íŠ¸</button>
	<button class="char-btn" onclick="selectWeaponJob('ì›Œë¦¬ì–´')">ì›Œë¦¬ì–´</button>
    <button class="char-btn" onclick="selectWeaponJob('ë§ˆì°½ì‚¬')">ë§ˆì°½ì‚¬</button>
    <button class="char-btn" onclick="selectWeaponJob('ë„ì ')">ë„ì </button>
  </div>
  <div id="weaponPanel"></div>
</div>


<div id="actionModal" class="modal-overlay">
  <div class="modal-content">
    <h3 id="modalCharName"></h3>
    <p>ì›í•˜ëŠ” ì‘ì—…ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
    <div class="modal-options">
      <button class="modal-btn modal-delete-btn" onclick="deleteCharacterConfirmed()">ìºë¦­í„° ì‚­ì œ</button>
      <button class="modal-btn modal-reset-btn" onclick="resetCharacterStatsConfirmed()">ìˆ˜ì¹˜ ì´ˆê¸°í™”</button>
      <button class="modal-btn modal-cancel-btn" onclick="closeActionModal()">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<div id="confirmModal" class="modal-overlay">
  <div class="modal-content">
    <h3 id="confirmTitle"></h3>
    <p id="confirmMessage"></p>
    <div class="modal-options">
      <button class="modal-btn modal-delete-btn" id="confirmYes" onclick="handleConfirmedAction()">í™•ì¸</button>
      <button class="modal-btn modal-cancel-btn" onclick="closeConfirmModal()">ì·¨ì†Œ</button>
    </div>
  </div>
</div>

<div id="updateModal" class="modal-overlay">
  <div class="modal-content" style="min-width: 90vw;">
    <h3>ğŸŒŸ ìµœê·¼ ì¥ë¹„ ì—…ë°ì´íŠ¸ (TOP 10)</h3>
    <div id="updateModalContent"></div>
    <div class="modal-options" style="margin-top: 30px;">
      <button class="modal-btn modal-cancel-btn" onclick="closeUpdateModal()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<script>
  // =======================================================
  // [ë¡œì»¬ ìŠ¤í† ë¦¬ì§€] ë°ì´í„° ì˜ì†ì„± í•¨ìˆ˜
  // =======================================================

// ë°ì´í„° ì €ì¥ ì‹œ
function saveLocalData() {
    localStorage.setItem("dnfm_eq", JSON.stringify(characters));
}

// ë°ì´í„° ë¡œë“œ ì‹œ (ì´ˆê¸°í™” ë¡œì§ í¬í•¨)
function loadLocalData() {
    const saved = localStorage.getItem("dnfm_eq");
    if (saved) {
        try {
            characters = JSON.parse(saved);
        } catch (e) {
            console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", e);
            characters = [];
        }
    }
}

  // ===== ì„¸íŠ¸ ì •ì˜ =====
  const ARMOR_SETS = {
    "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
    "í¬ì´ì¦ˆë‹ í€¸ ìŠ¤íŒŒì´ë”": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
    "ê±°ì¸ì˜ ìŠ¤í™ì¿¨ë£¸ ì•„ì´ì–¸": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
    "ì–´ë‘ ì„ ì˜ì•„ ë‚´ë¦¬ëŠ”": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
    "ìˆ˜í˜¸ìì˜ ì´ˆí•©ê¸ˆ": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
    "ìŠ¤í‹±í‚¤ ì• ì‹œë“œ ì›¨í€": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
    "ì„¬ëœ©í•œ ê°•ì²  ìš©": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
    "ìµìŠ¤í”Œë¡œì‹œë¸Œ ë²„ë‹ ìŠ¤í†¤": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
    "ë¹›ì˜ í—Œì‹ ì": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
    "ì—¬ëª…ì„ ì˜ì•„ ì˜¬ë¦¬ëŠ” ì": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
    "ì½°íŠ¸ë¡œ ì¹´ì‹œí…Œì›€": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
    "ê·¸ë€í…Œ ì „íˆ¬ê¸°ê°‘ íŒŒì¸ ": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
    "ë ˆê±°ì‹œ:ë§ˆë ¥ì˜ ì†Œìš©ëŒì´": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
    "ë ˆê±°ì‹œ:ìì—°ì˜ ìˆ˜í˜¸ì": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"]
  };
  const ARMOR_PREFIX = {
    "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ": ["ì „ê²©","í—ˆìƒ"],
    "í¬ì´ì¦ˆë‹ í€¸ ìŠ¤íŒŒì´ë”": ["ì‘ì—´","ì¹¨ì‹"],
    "ê±°ì¸ì˜ ìŠ¤í™ì¿¨ë£¸ ì•„ì´ì–¸": ["ìˆ˜í˜¸","ì™œê³¡"],
    "ì–´ë‘ ì„ ì˜ì•„ ë‚´ë¦¬ëŠ”": ["ììƒ","ë§¹ë…"],
    "ìˆ˜í˜¸ìì˜ ì´ˆí•©ê¸ˆ": ["í—ˆìƒ","ë³´í˜¸"],
    "ìŠ¤í‹±í‚¤ ì• ì‹œë“œ ì›¨í€": ["ë§¹ë…","ì™œê³¡"],
    "ì„¬ëœ©í•œ ê°•ì²  ìš©": ["ì‡„ë„","ì¹¨ì‹"],
    "ìµìŠ¤í”Œë¡œì‹œë¸Œ ë²„ë‹ ìŠ¤í†¤": ["ì‹ ì†","ì—°ê²©"],
    "ë¹›ì˜ í—Œì‹ ì": ["ìˆ˜í˜¸","ì—°ê²©"],
    "ì—¬ëª…ì„ ì˜ì•„ ì˜¬ë¦¬ëŠ” ì": ["ììƒ","ì‡„ë„"],
    "ì½°íŠ¸ë¡œ ì¹´ì‹œí…Œì›€": ["ì‘ì—´","ë³´í˜¸"],
    "ê·¸ë€í…Œ ì „íˆ¬ê¸°ê°‘ íŒŒì¸ ": ["ì‹ ì†","ì „ê²©"],
    "ë ˆê±°ì‹œ:ë§ˆë ¥ì˜ ì†Œìš©ëŒì´": [],
    "ë ˆê±°ì‹œ:ìì—°ì˜ ìˆ˜í˜¸ì": []
  };

  const ACCESSORY_SETS = {
    "ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ": ["íŒ”ì°Œ","ëª©ê±¸ì´","ë°˜ì§€"],
    "ì„¬ëœ©í•œ ë¹›ì˜ ê´€ë¦¬ì": ["íŒ”ì°Œ","ëª©ê±¸ì´","ë°˜ì§€"],
    "ë¶€ì‹ëœ ë©”íƒˆê¸°ì–´": ["íŒ”ì°Œ","ëª©ê±¸ì´","ë°˜ì§€"],
    "í™”ë ¥ ê°œì¡° íƒ„ë ": ["íŒ”ì°Œ","ëª©ê±¸ì´","ë°˜ì§€"],
    "ì‹ ë¹„ë¡œìš´ ë¹›ì˜ ì†Œìš©ëŒì´": ["íŒ”ì°Œ","ëª©ê±¸ì´","ë°˜ì§€"],
    "ì½°íŠ¸ë¡œ ë§ˆëˆ„ìŠ¤ ì—°ì‚°ì¥ì¹˜": ["íŒ”ì°Œ","ëª©ê±¸ì´","ë°˜ì§€"],
    "ë ˆê±°ì‹œ:ì—í…Œë¦¬ì–¼ ë¦¬ë² ë„ŒíŠ¸": ["íŒ”ì°Œ","ëª©ê±¸ì´","ë°˜ì§€"],
    "ë ˆê±°ì‹œ:ì§€ë‚˜ì˜¨ ì˜ê´‘ì˜ ì‹œëŒ€": ["íŒ”ì°Œ","ëª©ê±¸ì´","ë°˜ì§€"]
  };
  const ACCESSORY_PREFIX = {
    "ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ": ["ê²¬ê³ ","í˜ˆë…"],
    "ì„¬ëœ©í•œ ë¹›ì˜ ê´€ë¦¬ì": ["ì´ˆì„","ê°ì˜¤"],
    "ë¶€ì‹ëœ ë©”íƒˆê¸°ì–´": ["ê°ì˜¤","ê°€ì†"],
    "í™”ë ¥ ê°œì¡° íƒ„ë ": ["í˜ˆë…","ê²¬ê³ "],
    "ì‹ ë¹„ë¡œìš´ ë¹›ì˜ ì†Œìš©ëŒì´": ["ì¡°í™”","ì´ˆì„"],
    "ì½°íŠ¸ë¡œ ë§ˆëˆ„ìŠ¤ ì—°ì‚°ì¥ì¹˜": ["ê°€ì†","ì¡°í™”"],
    "ë ˆê±°ì‹œ:ì—í…Œë¦¬ì–¼ ë¦¬ë² ë„ŒíŠ¸": [],
    "ë ˆê±°ì‹œ:ì§€ë‚˜ì˜¨ ì˜ê´‘ì˜ ì‹œëŒ€": []
  };

  const SPECIAL_SETS = {
    "ê°œêµ¬ìŸì´ í˜¸ë¬¸ì¿¨ë£¨ìŠ¤": ["ê·€ê±¸ì´","ë§ˆë²•ì„","ë³´ì¥"],
    "ë¼ì´íŠ¸ë‹ ì—ë„ˆì§€ ì½”ì–´": ["ê·€ê±¸ì´","ë§ˆë²•ì„","ë³´ì¥"],
    "ì² ê°‘ì„ ë‘ë¥¸ íƒ‘ì˜ ìˆ˜í˜¸ê¾¼": ["ê·€ê±¸ì´","ë§ˆë²•ì„","ë³´ì¥"],
    "ê¹Šì€ ë¶ˆêµ¬ë©ì´ì˜ ì„¬ë©¸ì": ["ê·€ê±¸ì´","ë§ˆë²•ì„","ë³´ì¥"],
    "í—ˆì˜ ì† ì–´ë‘ ì˜ í”¼ì¡°ë¬¼": ["ê·€ê±¸ì´","ë§ˆë²•ì„","ë³´ì¥"],
    "ë¶€ì •í•œ ë¹›ì˜ ìš°ìƒ": ["ê·€ê±¸ì´","ë§ˆë²•ì„","ë³´ì¥"]
  };
  const SPECIAL_PREFIX = {
    "ê°œêµ¬ìŸì´ í˜¸ë¬¸ì¿¨ë£¨ìŠ¤": ["ë¶ˆêµ´","ìˆ™ë ¨"],
    "ë¼ì´íŠ¸ë‹ ì—ë„ˆì§€ ì½”ì–´": ["ìˆ™ë ¨","ê²°ì˜"],
    "ì² ê°‘ì„ ë‘ë¥¸ íƒ‘ì˜ ìˆ˜í˜¸ê¾¼": ["ê²©ë³€","ì´‰ì§„"],
    "ê¹Šì€ ë¶ˆêµ¬ë©ì´ì˜ ì„¬ë©¸ì": ["ë¶ˆêµ´","ì´‰ì§„"],
    "í—ˆì˜ ì† ì–´ë‘ ì˜ í”¼ì¡°ë¬¼": ["ì§ˆì£¼","ê²°ì˜"],
    "ë¶€ì •í•œ ë¹›ì˜ ìš°ìƒ": ["ì§ˆì£¼","ê²©ë³€"]
  };

  const ALL_SETS = {...ARMOR_SETS, ...ACCESSORY_SETS, ...SPECIAL_SETS};
  const ALL_PREFIX = {...ARMOR_PREFIX, ...ACCESSORY_PREFIX, ...SPECIAL_PREFIX};
  const EXCEED_TAGS = ["ì„ ë´‰","ì˜ì§€","ì´ìƒ"];
  const EXCEED_SLOTS = { "ARMOR":["ìƒì˜"], "ACCESSORY":["íŒ”ì°Œ"], "SPECIAL":["ê·€ê±¸ì´"] };


const WEAPON_DATA_SLAYER = {
    "ì†Œê²€": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ì†Œê²€", "ì•”í‘ì˜ ë³„", "ì™•ìœ„ ê³„ìŠ¹ì"],
    "ë„": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë„", "ìš”ë„ : ë¬´ë¼ë§ˆì‚¬", "íŠ¸ë¦¬ë‹ˆí‹° ì´í„°ë‹ˆì•„"],
    "ë‘”ê¸°": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë‘”ê¸°", "ì„¸ê³„ì˜ ë¬´ê²Œì¶”", "ì‹ ê²€ì˜ ë‚˜ë­‡ê°€ì§€"],
    "ëŒ€ê²€": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ëŒ€ê²€", "ì„±ê²€ : ì—‘ìŠ¤ì¹¼ë¦¬ë²„", "ë°ë¹Œ ì˜¤ë¸Œ í”Œë ˆì–´"],
    "ê´‘ê²€": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ê´‘ê²€", "ì•„ë§ˆ ê²Ÿ ëˆ", "ë‡Œê²€ : ê³ ë£¬"]
};

const WEAPON_DATA_FIGHTER = {
    "ë„ˆí´": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë„ˆí´", "ë¼ì˜¤ ë°ì†”", "ë² ë¥´ì„¸ë¥´í¬"],
    "ê±´í‹€ë¦¿": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ê±´í‹€ë¦¿", "ë°˜ê²©ì˜ ì„œë§‰", "ë£°ë ›ëŸ¬ì‹œì•ˆ"],
    "í´ë¡œ": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - í´ë¡œ", "í‘ì›”ë‘ì•„", "ì•…ë§ˆì˜ ê°ˆí€´ : ì´ê·¸ë…¸ì–´"],
    "ê¶Œíˆ¬ê¸€ëŸ¬ë¸Œ": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ê¶Œíˆ¬ê¸€ëŸ¬ë¸Œ", "í‹°ì¥¬ ì— í”Œë¦¬íŒŒì´ì–´", "íŒŒìš¸ í‚¤ë“œë‹ˆë¸”ë¡œ"],
    "í†µíŒŒ": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - í†µíŒŒ", "í‚¬ ì•„ë¥´ë‹ˆìŠ¤ ë µê³¡", "ìŠµê²©ì˜ ë“œë¼ìš°í”„ë‹ˆë¥´"]
};

const WEAPON_DATA_GUNNER = {
    "ë¦¬ë³¼ë²„": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë¦¬ë³¼ë²„", "ì´ìŠ¤ ë¯¸ í„°ë„ˆ", "ì‹¤ë²„ ë¶ˆë ›"],
    "ìë™ê¶Œì´": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ìë™ê¶Œì´", "ì´ì˜¨ ë¦¬í•„ì„œ", "ë§ˆì´ìŠ¤í„°ì˜ ë¶„ë…¸"],
    "ë¨¸ìŠ¤ì¼“": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë¨¸ìŠ¤ì¼“", "Code N : ì˜¤ë¼í´", "ë¸”ë¼ì¸ë“œ ìŠ¤íŒŸ"],
    "í•¸ë“œìºë„Œ": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - í•¸ë“œìºë„Œ", "ê±°í¬ ìš°ë¥´ë°˜", "í•´ë¥¼ ë¨¹ëŠ” ì"],
    "ë³´ìš°ê±´": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë³´ìš°ê±´", "ë°ìŠ¤ ë¦¬ë·°ì €", "ì œë„ˆëŸ´ ë³´ìš°ê±´"]
};

const WEAPON_DATA_MAGE = {
    "ì°½": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ì°½", "ì¥¬ë¹ŒëŸ°ìŠ¤ í˜¼", "ì „ì¥ì˜ ì—¬ì‹ ì˜ ì°½"],
    "ë´‰": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë´‰", "ì¼€ì„¸ë¼ì„¸ë¼ : í•´í”¼ ~!", "ìš”ì •ì™•ì˜ ë¹„ë°€"],
    "ë¡œë“œ": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë¡œë“œ", "íˆì–´ë¡œ ì˜¤ë¸Œ ë” ë¬¸", "ì–‘ì¹˜ê¸°ì˜ ë¡œë“œ"],
    "ìŠ¤íƒœí”„": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ìŠ¤íƒœí”„", "ì›¨ë¦¬ : ë¦¬ë¯¸íŠ¸ ë¸Œë ˆì´ì»¤", "ì°½ë§ˆí™”ì˜ ì—°"],
    "ë¹—ìë£¨": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë¹—ìë£¨", "ë³´ë°° - íŒŒì´ˆì„ ", "ìŠ¤ë…¸ìš° í”„ë¦°ì„¸ìŠ¤"]
};

const WEAPON_DATA_PRIEST = {
    "ì‹­ìê°€": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ì‹­ìê°€", "í—¤ì´ë  - êµë§Œì˜ ë¹›", "ì €ì£¼ ë°›ì€ ì‹­ìê°€ : í† ë£¨ì•„"],
    "ì—¼ì£¼": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ì—¼ì£¼", "ìŒì–‘ì‚¬ì²œ", "ëª…ì¸ì˜ ìˆ˜"],
    "í† í…œ": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - í† í…œ", "ì”° ë” ë¦¬ë°”ì´ì–´ë˜", "í’ìš´ë‡Œìš°"],
    "ë‚«": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë‚«", "ì†Œìš¸ ë””ë°”ìš°ë§", "ì„ ê³  : ì‚¬ì‹ ì˜ ë‚«"],
    "ë°°í‹€ì—‘ìŠ¤": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë°°í‹€ì—‘ìŠ¤", "í–‰ì„±íŒŒê´´ì", "ì˜¤ë§Œì˜ ë"]
};

const WEAPON_DATA_WARRIOR = {
    "ë½ì†Œë“œ": [
        "ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë½ì†Œë“œ", 
        "ìš°ì£¼ì  ê¸°ìš´ì˜ ë½ì†Œë“œ", 
        "ë¼ì´í”„ íŒŒì¸ë”"
    ],
    "ìœ™ë¸”ë ˆì´ë“œ": [
        "ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ìœ™ë¸”ë ˆì´ë“œ", 
        "í”„ë¡œìŠ¤íŠ¸ ìœ™ ë¸”ë ˆì´ë“œ", 
        "ì½”ì¹´íŠ¸ë¦¬ìŠ¤"
    ]
};

const WEAPON_DATA_LANCER = {
    "ë¯¸ëŠ˜ì°½": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë¯¸ëŠ˜ì°½", "í¬ë¦¼ìŠ¨ ë¡œë“œ", "ê´‘ì—¼ì˜ ê·¹"],
    "íˆ¬ì°½": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - íˆ¬ì°½", "í—¬ ì˜¤ë¸Œ ë°ë¹Œë¡œë“œ", "ë¯¸ë¼í´ ëŸ°ì¹˜"]
};

const WEAPON_DATA_THIEF = {
    "ë‹¨ê²€": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë‹¨ê²€", "ì‹¤ë²„ ìŠ¤í”¼ë¦¿", "ì›”ê´‘ê²€"],
    "ìŒê²€": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ìŒê²€", "í‘ë¯¸ìŒê²€", "íˆê²Œ-íˆìí‚¤ë¦¬"],
    "ì°¨í¬ë¼ì›¨í€": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ì°¨í¬ë¼ì›¨í€", "í¬ë¦¬ë“œ ì˜¤ë¸Œ ë‹Œì", "ë¬´ì—¼í™”"]
};

const WEAPON_PREFIXES = [
    { tag: "[ê´‘ì±„]", color: "#3399cc" }, // íŒŒë€ìƒ‰
    { tag: "[ë¶„ì‡„]", color: "#ff4d4f" }, // ë¹¨ê°„ìƒ‰
    { tag: "[ì„ ëª…]", color: "#25c2a0" }, // ì´ˆë¡ìƒ‰
    { tag: "[ê°•íƒ€]", color: "#ffd700" }  // ë…¸ë€ìƒ‰
];


  // ===== ìºë¦­í„° ë°°ì—´ =====
  let characters = [
    {id:"c1", job:"ê²€ê·€", name:"ê°•ì˜", armorCounts:{
        "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ ìƒì˜":1,
        "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ í•˜ì˜":1,
        "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ ì–´ê¹¨":1,
        "ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ íŒ”ì°Œ":1,
        "[ì˜ì§€] ê²¬ê³ : ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ íŒ”ì°Œ":1,
        "ê°œêµ¬ìŸì´ í˜¸ë¬¸ì¿¨ë£¨ìŠ¤ ê·€ê±¸ì´":1
      }, updateTimes: { // ğŸ’¡ ì¶”ê°€ëœ í•„ë“œ: ì•„ì´í…œë³„ ì—…ë°ì´íŠ¸ ì‹œê°„ ì €ì¥
        "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ ìƒì˜": Date.now() - 50000,
        "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ í•˜ì˜": Date.now() - 40000,
        "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ ì–´ê¹¨": Date.now() - 30000,
        "ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ íŒ”ì°Œ": Date.now() - 20000,
        "[ì˜ì§€] ê²¬ê³ : ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ íŒ”ì°Œ": Date.now() - 10000,
        "ê°œêµ¬ìŸì´ í˜¸ë¬¸ì¿¨ë£¨ìŠ¤ ê·€ê±¸ì´": Date.now()
      }}
  ];

  // ===== ì „ì—­ ìµœëŒ€ ê¸¸ì´ ê³„ì‚° =====
  let globalSetNameWidth=200, globalSlotWidth=100;
  function calculateGlobalWidths(){
    const allNames=[], allSlots=[];
    [ {sets:ARMOR_SETS,pref:ARMOR_PREFIX},
      {sets:ACCESSORY_SETS,pref:ACCESSORY_PREFIX},
      {sets:SPECIAL_SETS,pref:SPECIAL_PREFIX} ].forEach(({sets,pref})=>{
      Object.keys(sets).forEach(setName=>{
        allNames.push(setName);
        const prefixes=pref[setName]||[];
        prefixes.forEach(p=>{
          allNames.push(`${p}: ${setName}`);
          EXCEED_TAGS.forEach(ex=>allNames.push(`[${ex}] ${p}: ${setName}`));
        });
        sets[setName].forEach(slot=>allSlots.push(slot));
      });
    });
    globalSetNameWidth=Math.max(...allNames.map(n=>n.length))*12;
    globalSlotWidth=Math.max(...allSlots.map(s=>s.length))*12;
  }
  calculateGlobalWidths();

  // ===== ìœ í‹¸ =====
  function isExceedName(name){ return /^\[(ì„ ë´‰|ì˜ì§€|ì´ìƒ)\]\s/.test(name); }
  function getGroupKey(name){ return name.replace(/^\[.*?\]\s*/,""); }
  function getSetType(setName){
    if(ARMOR_SETS[setName]) return "ARMOR";
    if(ACCESSORY_SETS[setName]) return "ACCESSORY";
    if(SPECIAL_SETS[setName]) return "SPECIAL";

    // ì ‘ë‘ì–´ë‚˜ ìµì‹œë“œê°€ ë¶™ì€ ì´ë¦„ì—ì„œ ê¸°ë³¸ ì„¸íŠ¸ëª…ì„ ì¶”ì¶œí•˜ì—¬ íŒë³„
    const baseName = setName.includes(':') ? setName.split(':').pop().trim() : setName;
    if(ARMOR_SETS[baseName]) return "ARMOR";
    if(ACCESSORY_SETS[baseName]) return "ACCESSORY";
    if(SPECIAL_SETS[baseName]) return "SPECIAL";

    return "ARMOR"; // ê¸°ë³¸ê°’
  }

  function calcTotalDistinctParts(char, baseSetName) {
    const slots = ALL_SETS[baseSetName] || [];
    const prefixes = ALL_PREFIX[baseSetName] || [];
    const setType = getSetType(baseSetName);
    const exceedSlots = EXCEED_SLOTS[setType] || [];

    // ê²€ìƒ‰í•  ëª¨ë“  ê·¸ë£¹ ì´ë¦„ (ê¸°ë³¸, ì ‘ë‘ì–´, ìµì‹œë“œ) ìƒì„±
    const namesToSearch = [baseSetName];
    prefixes.forEach(pref => {
      const prefixedName = `${pref}: ${baseSetName}`;
      namesToSearch.push(prefixedName);
      EXCEED_TAGS.forEach(tag => {
        namesToSearch.push(`[${tag}] ${prefixedName}`);
      });
    });

    let totalDistinct = 0;

    slots.forEach(slot => {
      let hasPartInSlot = false;
      const slotSuffix = ` ${slot}`;

      namesToSearch.forEach(nameComponent => {
        const isExceedKey = nameComponent.startsWith('[');

        // ìµì‹œë“œ í‚¤ëŠ” íŠ¹ì • ìŠ¬ë¡¯ì—ë§Œ ì¡´ì¬í•˜ë¯€ë¡œ, ì•„ë‹Œ ê²½ìš°ëŠ” ê±´ë„ˆëœë‹ˆë‹¤.
        if (isExceedKey && !exceedSlots.includes(slot)) {
          return;
        }

        const fullKey = `${nameComponent}${slotSuffix}`;
        if ((char.armorCounts[fullKey] || 0) > 0) {
          hasPartInSlot = true;
        }
      });

      if (hasPartInSlot) {
        totalDistinct++;
      }
    });

    return totalDistinct;
  }

  // =======================================================
  // [ëª¨ë‹¬] ì œì–´ ë° ì•¡ì…˜ í•¨ìˆ˜ (ìˆ˜ì • ë° ì¶”ê°€ë¨)
  // =======================================================
  let currentActionCharId = null;
  let pendingActionType = null; // í˜„ì¬ 2ì°¨ í™•ì¸ ëŒ€ê¸° ì¤‘ì¸ ì‘ì—…: 'delete' ë˜ëŠ” 'reset'

  // 1ì°¨ ëª¨ë‹¬ (ì‘ì—… ì„ íƒ) ì œì–´
  function closeActionModal() {
    document.getElementById("actionModal").style.display = 'none';
  }

  function openActionModal(charId, charName, charJob) {
    currentActionCharId = charId;
    document.getElementById("modalCharName").textContent = `${charJob} (${charName}) ì— ëŒ€í•œ ì‘ì—… ì„ íƒ`;
    document.getElementById("actionModal").style.display = 'flex';
  }

  // 2ì°¨ ëª¨ë‹¬ (ìµœì¢… í™•ì¸) ì œì–´
  function closeConfirmModal() {
    document.getElementById("confirmModal").style.display = 'none';
  }

  function openConfirmModal(title, message, actionType) {
    // 1ì°¨ ëª¨ë‹¬ì´ ì—´ë ¤ ìˆì„ ê²½ìš° ë‹«ìŒ
    closeActionModal();

    pendingActionType = actionType;
    document.getElementById("confirmTitle").textContent = title;
    document.getElementById("confirmMessage").textContent = message;
    document.getElementById("confirmModal").style.display = 'flex';
  }

  // ğŸ’¡ ìƒˆë¡œ ì¶”ê°€: ì—…ë°ì´íŠ¸ ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
  function closeUpdateModal() {
    document.getElementById("updateModal").style.display = 'none';
  }


  // 1ì°¨ ëª¨ë‹¬ì—ì„œ 'ìºë¦­í„° ì‚­ì œ' ì„ íƒ ì‹œ (2ì°¨ ëª¨ë‹¬ í˜¸ì¶œ)
  function deleteCharacterConfirmed() {
    if (!currentActionCharId) return;

    openConfirmModal(
            "ìºë¦­í„° ì‚­ì œ í™•ì¸",
            "ìºë¦­í„°ë¥¼ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? í•´ë‹¹ ìºë¦­í„°ì˜ ëª¨ë“  ë°ì´í„°ê°€ ì˜êµ¬ì ìœ¼ë¡œ ì§€ì›Œì§‘ë‹ˆë‹¤.",
            'delete'
    );
  }

  // 1ì°¨ ëª¨ë‹¬ì—ì„œ 'ìˆ˜ì¹˜ ì´ˆê¸°í™”' ì„ íƒ ì‹œ (2ì°¨ ëª¨ë‹¬ í˜¸ì¶œ)
  function resetCharacterStatsConfirmed() {
    if (!currentActionCharId) return;

    openConfirmModal(
            "ìˆ˜ì¹˜ ì´ˆê¸°í™” í™•ì¸",
            "ì¥ë¹„ ìˆ˜ì¹˜ë¥¼ ì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ì¥ì°©ëœ ëª¨ë“  ì¥ë¹„ ìˆ˜ì¹˜ê°€ 0ì´ ë©ë‹ˆë‹¤.",
            'reset'
    );
  }

  // 2ì°¨ ëª¨ë‹¬ì—ì„œ 'í™•ì¸' ë²„íŠ¼ í´ë¦­ ì‹œ (ì‹¤ì œ ì‘ì—… ìˆ˜í–‰)
  function handleConfirmedAction() {
    const charId = currentActionCharId;
    const action = pendingActionType;

    closeConfirmModal(); // 2ì°¨ í™•ì¸ ëª¨ë‹¬ ë‹«ê¸°

    if (!charId || !action) {
      currentActionCharId = null;
      pendingActionType = null;
      return;
    }

    const char = characters.find(c => c.id === charId);

    if (action === 'delete') {
      // ì‹¤ì œ ìºë¦­í„° ì‚­ì œ ë¡œì§
      const index = characters.findIndex(c => c.id === charId);
      if (index !== -1) {
        characters.splice(index, 1);
        saveLocalData();
        renderCharacterList();
        document.getElementById("setList").innerHTML = "";
        document.getElementById("panel").innerHTML = "";
      }
    } else if (action === 'reset') {
      // ì‹¤ì œ ìˆ˜ì¹˜ ì´ˆê¸°í™” ë¡œì§
      if (char) {
        char.armorCounts = {}; // ìˆ˜ì¹˜ ì´ˆê¸°í™”
        char.updateTimes = {}; // ì—…ë°ì´íŠ¸ ì‹œê°„ë„ ì´ˆê¸°í™”
        saveLocalData();

        // UI ì—…ë°ì´íŠ¸
        renderCharacterList();
        showSetButtons(char);

        // í˜„ì¬ ìºë¦­í„°ê°€ ì„ íƒë˜ì–´ ìˆì—ˆë‹¤ë©´ UI ë¦¬ì…‹
        if (currentChar && currentChar.id === charId) {
          document.getElementById("setList").innerHTML = "";
          document.getElementById("panel").innerHTML = "";
        }
      }
    }

    // ì‘ì—… ì™„ë£Œ í›„ ID ì´ˆê¸°í™”
    currentActionCharId = null;
    pendingActionType = null;
  }


  // ===== ìºë¦­í„° ë²„íŠ¼ ë Œë” =====
  function renderCharacterList(){
    const listEl = document.getElementById("characterList");
    listEl.innerHTML = "";

    characters.forEach((c, index) => {
      // ìºë¦­í„° í•˜ë‚˜ë¥¼ ê°ì‹¸ëŠ” wrapper
      const wrapper = document.createElement("div");
      wrapper.className = "character-wrapper";  // ğŸ‘‰ CSSì—ì„œ inline-block ì²˜ë¦¬

      // ì‚­ì œ ë²„íŠ¼
      const delBtn = document.createElement("button");
      delBtn.textContent = "ï¼";
      delBtn.className = "delete-btn";   // ğŸ‘‰ í˜ì´ì§€ ìŠ¤íƒ€ì¼ì— ë§ì¶˜ ì‚­ì œ ë²„íŠ¼
      delBtn.onclick = () => {
        openActionModal(c.id, c.name, c.job); // 1ì°¨ ì„ íƒ ëª¨ë‹¬ í˜¸ì¶œ
      };

      // ìºë¦­í„° ë²„íŠ¼
      const btn = document.createElement("button");
      btn.className = "char-btn";
      btn.textContent = `${c.job} (${c.name})`;
      btn.onclick = () => {
        // ëª¨ë“  ë²„íŠ¼ì—ì„œ active ì œê±°
        document.querySelectorAll(".char-btn").forEach(b => b.classList.remove("active"));
        // í˜„ì¬ ë²„íŠ¼ì— active ì¶”ê°€
        btn.classList.add("active");
        showSetButtons(c);
      };

      // wrapperì— ë²„íŠ¼ë“¤ ì¶”ê°€
      wrapper.appendChild(delBtn);
      wrapper.appendChild(btn);

      // ì „ì²´ ëª©ë¡ì— wrapper ì¶”ê°€
      listEl.appendChild(wrapper);
    });
  }


  // [ë¡œì»¬ ìŠ¤í† ë¦¬ì§€] ì´ˆê¸° ë¡œë“œ ë° ë Œë”ë§
  loadLocalData();
  renderCharacterList();

  // ===== ìºë¦­í„° ì¶”ê°€ =====
  function addCharacter(){
    const name=document.getElementById("newCharName").value.trim();
    const job=document.getElementById("newCharJob").value.trim();
    if(!name||!job){ alert("ì´ë¦„ê³¼ ì§ì—…ì„ ì…ë ¥í•˜ì„¸ìš”!"); return; }
    // ğŸ’¡ updateTimes: {} ì¶”ê°€
    const newChar={id:"c"+Date.now(), job:job, name:name, armorCounts:{}, updateTimes: {}};
    characters.push(newChar);
    saveLocalData(); // [ë¡œì»¬ ìŠ¤í† ë¦¬ì§€] ë°ì´í„° ë³€ê²½ í›„ ì €ì¥
    renderCharacterList();
    document.getElementById("newCharName").value="";
    document.getElementById("newCharJob").value="";
  }

  // ===== ì„¸íŠ¸ ë²„íŠ¼ í‘œì‹œ =====
  function showSetButtons(char){
    const setList = document.getElementById("setList");
    setList.innerHTML = "";

    // ----------------------------------------------------
    // 1. ê° ì¹´í…Œê³ ë¦¬ë³„ ì•„ì´í…œ ì´ ê°œìˆ˜ ê³„ì‚°
    // ----------------------------------------------------
    let totalArmor = 0;
    let totalAccessory = 0;
    let totalSpecial = 0;

    Object.entries(char.armorCounts).forEach(([fullKey, count]) => {
      if (count <= 0) return;

      const parts = fullKey.split(' ');
      const slot = parts.pop();
      const name = parts.join(' ');

      const groupKey = getGroupKey(name);
      const setType = getSetType(groupKey);

      if (setType === "ARMOR") totalArmor += count;
      else if (setType === "ACCESSORY") totalAccessory += count;
      else if (setType === "SPECIAL") totalSpecial += count;
    });

    // ----------------------------------------------------
    // 2. ì œëª©ì— ì´ ê°œìˆ˜ë¥¼ í¬í•¨í•˜ì—¬ í‘œì‹œ
    // ----------------------------------------------------

    // ë°©ì–´êµ¬
    const armorTitle = document.createElement("h2");
    armorTitle.textContent = `[ë°©ì–´êµ¬ (${totalArmor}ê°œ)]`;
    setList.appendChild(armorTitle);
    Object.keys(ARMOR_SETS).forEach(setName => {
      setList.appendChild(makeSetButton(setName, char));
    });

    // ì•…ì„¸
    const accTitle = document.createElement("h2");
    accTitle.textContent = `[ì•…ì„¸ (${totalAccessory}ê°œ)]`;
    setList.appendChild(accTitle);
    Object.keys(ACCESSORY_SETS).forEach(setName => {
      setList.appendChild(makeSetButton(setName, char));
    });

    // íŠ¹ì¥
    const spTitle = document.createElement("h2");
    spTitle.textContent = `[íŠ¹ì¥ (${totalSpecial}ê°œ)]`;
    setList.appendChild(spTitle);
    Object.keys(SPECIAL_SETS).forEach(setName => {
      setList.appendChild(makeSetButton(setName, char));
    });

    document.getElementById("panel").innerHTML = "";
  }

  // ===== ì„¸íŠ¸ ë²„íŠ¼ ìƒì„± =====
function makeSetButton(setName, char){
    let count3 = 0, count5 = 0;
    let totalParts = 0; // x ê°’ (ì´ ê°œìˆ˜) ì´ˆê¸°í™”

    const slots = ALL_SETS[setName] || [];
    const prefixes = ALL_PREFIX[setName] || [];
    const setType = getSetType(setName);
    const exceedSlots = EXCEED_SLOTS[setType] || [];

    // 1. ì „ì²´ ê³ ìœ  ë¶€ìœ„ ê°œìˆ˜ ê³„ì‚° (ì ‘ë‘ì–´/ìµì‹œë“œ ë¬´ì‹œ)
    const distinctParts = calcTotalDistinctParts(char, setName);

    // 2. ì´ ë¶€ìœ„ ê°œìˆ˜ (totalParts, x ê°’) ê³„ì‚°
    const allGroupKeys = [setName];
    prefixes.forEach(pref => {
      const prefixedName = `${pref}: ${setName}`;
      allGroupKeys.push(prefixedName);
      EXCEED_TAGS.forEach(tag => {
        allGroupKeys.push(`[${tag}] ${prefixedName}`);
      });
    });

    allGroupKeys.forEach(groupKey => {
      const isExceedKey = groupKey.startsWith('[');
      slots.forEach(slot => {
        let key = `${groupKey} ${slot}`;

        if (isExceedKey && !exceedSlots.includes(slot)) {
          return;
        }

        totalParts += char.armorCounts[key] || 0;
      });
    });
    // ì´í•© ê³„ì‚° ë

    // 3. ë‹¨ì¼ distinctPartsë¥¼ ì‚¬ìš©í•œ ìµœì¢… ì„¸íŠ¸ íŒì •
    const fullSize = slots.length;

    if(fullSize === 5){ // ë°©ì–´êµ¬
      if(distinctParts === fullSize) count5 = 1; // 5ì„¸íŠ¸ ë‹¬ì„±
      else if(distinctParts >= 3) count3 = 1; // 3ì„¸íŠ¸ ë‹¬ì„± (3 ë˜ëŠ” 4)
    } else { // ì•…ì„¸/íŠ¹ì¥ (3ë¶€ìœ„)
      if(distinctParts === 3) count3 = 1; // 3ì„¸íŠ¸ ë‹¬ì„±
    }

    const btn = document.createElement("button");
    btn.className = "set-btn";

    // í™”ë©´ í‘œì‹œë¥¼ ìœ„í•œ 0 ë˜ëŠ” 1 ê°’ ì„¤ì •
    const final_count3 = count3 > 0 ? 1 : 0;
    const final_count5 = count5 > 0 ? 1 : 0;

    // ë°°ê²½ìƒ‰ ì ìš©
    if(final_count5 > 0) btn.classList.add("set5");
    else if(final_count3 > 0) btn.classList.add("set3");
    
    // [ì„ íƒ ìƒíƒœ ìœ ì§€ ë¡œì§ ì¶”ê°€]: í˜„ì¬ ì„ íƒëœ ì„¸íŠ¸ì™€ ì´ë¦„ì´ ê°™ìœ¼ë©´ selected í´ë˜ìŠ¤ ìœ ì§€
    if (currentSetName === setName && currentChar && currentChar.id === char.id) {
        btn.classList.add("selected");
    }


    // ğŸš¨ ìˆ˜ì •ëœ ë¶€ë¶„: "ì„¸íŠ¸ëª… (ì¥ë¹„ìˆ˜)" í˜•íƒœë¡œ ë‚´ìš© êµ¬ì„±
    const buttonContent = `${setName} (${totalParts})`;


    btn.innerHTML = buttonContent; // innerHTMLë¡œ ë‚´ìš© ì„¤ì •

    btn.onclick = (event) => {
        // [ì„ íƒ ë¡œì§ ì¶”ê°€]: ëª¨ë“  ì„¸íŠ¸ ë²„íŠ¼ì—ì„œ 'selected' í´ë˜ìŠ¤ ì œê±°
        document.querySelectorAll(".set-btn").forEach(b => b.classList.remove("selected"));
        // [ì„ íƒ ë¡œì§ ì¶”ê°€]: í˜„ì¬ í´ë¦­ëœ ë²„íŠ¼ì— 'selected' í´ë˜ìŠ¤ ì¶”ê°€
        event.currentTarget.classList.add("selected");
        
        openSet(setName, char);
    };
    
    return btn;
}

// ===== í‘œ í–‰ ìƒì„± =====
function makeRow(name, setName, char){
    const slots = ALL_SETS[setName] || [];
    const groupKey = getGroupKey(name);
    const isExceed = isExceedName(name);
    const setType = getSetType(setName);
    const exceedSlots = EXCEED_SLOTS[setType];

    // calcTotalDistinctPartsë¡œ ê¸°ë³¸ ì„¸íŠ¸ì˜ ì „ì²´ ê³ ìœ  ë¶€ìœ„ ê°œìˆ˜ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    const totalDistinct = calcTotalDistinctParts(char, setName);
    const fullSize = slots.length;

    const tr = document.createElement("tr");
    let hasAnyPartInRow = false; // ğŸš¨ ì´ í–‰(ì•„ì´í…œ)ì— ë¶€ìœ„ê°€ ì¥ì°©ë˜ì—ˆëŠ”ì§€ í™•ì¸

    // 1. ì¥ì°© ì—¬ë¶€ í™•ì¸
    slots.forEach(slot => {
      let key = `${name} ${slot}`;
      if ((char.armorCounts[key] || 0) > 0) {
        hasAnyPartInRow = true;
      }
    });

    // 2. ì „ì²´ ì„¸íŠ¸ ë‹¬ì„± ì¡°ê±´ê³¼ ì¥ì°© ì—¬ë¶€ë¥¼ ëª¨ë‘ ë§Œì¡±í•  ë•Œë§Œ ìƒ‰ìƒ ê²°ì •
    if (hasAnyPartInRow) {
      if(setType === "ARMOR"){
        if(totalDistinct === fullSize) tr.className = "set5";
        else if(totalDistinct >= 3) tr.className = "set3";
      } else {
        if(totalDistinct === 3) tr.className = "set3";
      }
    }


    // =========================================================
    // ğŸ’¡ [ìµœì¢… ìˆ˜ì •] ì•„ì´í…œ ì´ë¦„ ìŠ¤íƒ€ì¼ë§ ë¡œì§ ì‹œì‘ (HTML ë¬¸ìì—´ ì¡°ë¦½)
    // =========================================================
    let itemName = name;
    let finalHtmlName = itemName;
    
    // 1. ìµì‹œë“œ íƒœê·¸ ([Tag]) ì²˜ë¦¬ (íƒœê·¸ ì œê±° ë° ìŠ¤íƒ€ì¼ë§ëœ íƒœê·¸ ìƒì„±)
    const exceedMatch = itemName.match(/^(\[.*?\])\s*(.*)/);
    let exceedTagHtml = '';
    let nameWithoutTag = itemName;

    if (exceedMatch) {
        const tag = exceedMatch[1]; // ì˜ˆ: [ì´ìƒ]
        nameWithoutTag = exceedMatch[2]; // ì˜ˆ: ì „ê²©: ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ
        let color = '';

        if (tag === '[ì„ ë´‰]') {
            color = '#ff4d4f'; // ë¹¨ê°„ìƒ‰
        } else if (tag === '[ì´ìƒ]') {
            color = '#25c2a0'; // ì´ˆë¡ìƒ‰
        } else if (tag === '[ì˜ì§€]') {
            color = '#3399cc'; // íŒŒë€ìƒ‰
        }
        
        exceedTagHtml = `<span style="color:${color}; font-weight:bold;">${tag}</span> `;
    }
    
    // 2. ì ‘ë‘ì–´ (Prefix:) ì²˜ë¦¬ (ë…¸ë€ìƒ‰ ì ìš©)
    let baseNameHtml = nameWithoutTag; // ìµì‹œë“œ íƒœê·¸ê°€ ìˆì—ˆë“  ì—†ì—ˆë“ , ë‚˜ë¨¸ì§€ ì´ë¦„
    
    const prefixMatch = nameWithoutTag.match(/(.+?):\s*(.+)/);
    
    if (prefixMatch) {
        const prefix = prefixMatch[1]; // ì˜ˆ: ì „ê²©
        const baseSet = prefixMatch[2]; // ì˜ˆ: ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ
        
        const styledPrefix = `<span style="color:#e6b800; font-weight:bold;">${prefix}</span>`;
        
        baseNameHtml = `${styledPrefix}: ${baseSet}`;
    }
    
    // 3. ìµœì¢… HTML ë¬¸ìì—´ ì¡°ë¦½
    finalHtmlName = exceedTagHtml + baseNameHtml;
    // =========================================================
    // ğŸ’¡ [ìµœì¢… ìˆ˜ì •] ì•„ì´í…œ ì´ë¦„ ìŠ¤íƒ€ì¼ë§ ë¡œì§ ë
    // =========================================================

    let html = `<td style="text-align:left;">${finalHtmlName}</td>`; // ìµœì¢… HTMLì„ ì‚½ì…
    
    slots.forEach(slot => {
      let key = `${name} ${slot}`;
      const val = char.armorCounts[key] || 0;
      if(isExceed){
        if(exceedSlots.includes(slot)){
          html += `<td>${makeNumberButton(char.id, key, val)}</td>`;
        } else {
          html += `<td></td>`;
        }
      } else {
        html += `<td>${makeNumberButton(char.id, key, val)}</td>`;
      }
    });
    tr.innerHTML = html;
    return tr;
}

// ===== ì „ì—­ ìƒíƒœ ë³€ìˆ˜ =====
let currentSetName = null;
let currentChar = null;
let currentFilter = 'ALL'; // ğŸ’¡ í˜„ì¬ ì„ íƒëœ í•„í„° ('ALL', 'BASE', 'PREFIX', 'EXCEED')

// ===== ì„¸íŠ¸ í‘œ ì—´ê¸° =====
function openSet(setName, char){
    // ì„¸íŠ¸ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ê¸°ë³¸ í•„í„°ë¥¼ 'ALL'ë¡œ ì´ˆê¸°í™”í•˜ê³  UI ì—…ë°ì´íŠ¸
    if (currentSetName !== setName || currentChar?.id !== char.id) {
         currentFilter = 'ALL'; 
    }
    
    currentSetName = setName;
    currentChar = char;

    const panel = document.getElementById("panel");
    panel.innerHTML = `<h2>[${setName} ì„¸íŠ¸]</h2>`;

    const slots = ALL_SETS[setName] || [];
    const table = document.createElement("table");
    table.innerHTML = `<thead>
 <tr><th>ì„¸íŠ¸ ì´ë¦„</th>${slots.map(s => `<th>${s}</th>`).join("")}</tr>
</thead><tbody></tbody>`;
    const tbody = table.querySelector("tbody");

    tbody.appendChild(makeRow(setName, setName, char));
    const prefixes = ALL_PREFIX[setName] || [];
    prefixes.forEach(pref => {
      tbody.appendChild(makeRow(`${pref}: ${setName}`, setName, char));
    });
    prefixes.forEach(pref => {
      EXCEED_TAGS.forEach(ex => {
        tbody.appendChild(makeRow(`[${ex}] ${pref}: ${setName}`, setName, char));
      });
    });

    panel.appendChild(table);

    table.querySelectorAll("th:first-child, td:first-child").forEach(cell => {
      cell.style.width = globalSetNameWidth + "px";
    });
    table.querySelectorAll("th:not(:first-child), td:not(:first-child)").forEach(cell => {
      cell.style.width = globalSlotWidth + "px";
    });

    // âœ… ìš”ì•½ íŒ¨ë„ ì˜ì—­ì— í•„í„° ë²„íŠ¼ ì¶”ê°€
    const summaryHeader = document.createElement("div");
    summaryHeader.innerHTML = `<h2>[${setName} ì„¸íŠ¸ ìºë¦­í„°ë³„ ìŠ¬ë¡¯ í˜„í™©]</h2>`;
    
    const filterContainer = document.createElement("div");
    filterContainer.className = "toolbar"; // ê¸°ì¡´ toolbar ìŠ¤íƒ€ì¼ ì¬í™œìš©
    filterContainer.style.marginBottom = "20px";
    filterContainer.style.marginTop = "10px";

    // í•„í„° ë²„íŠ¼ ì •ì˜
    const filters = [
        { id: 'ALL', text: 'ëª¨ë‘' },
        { id: 'BASE', text: 'ì¼ë°˜' },
        { id: 'PREFIX', text: 'ì ‘ë‘ì–´' },
        { id: 'EXCEED', text: 'ìµì‹œë“œ' }
    ];

    filters.forEach(filter => {
        const btn = document.createElement("button");
        btn.textContent = filter.text;
        btn.className = "action-btn set-btn"; // set-btn ìŠ¤íƒ€ì¼ì„ ì¬í™œìš©í•˜ì—¬ ë²„íŠ¼ ëª¨ì–‘ ìƒì„±
        btn.style.minWidth = 'unset'; // ë„ˆë¹„ ì œí•œ í•´ì œ
        btn.style.background = '#4a3f7a'; // ë°°ê²½ìƒ‰ í†µì¼ (file-label ìƒ‰ìƒ ì¬í™œìš©)
        // btn.style.borderColor = 'transparent'; // ê¸°ë³¸ í…Œë‘ë¦¬ ì œê±°

        // í˜„ì¬ í•„í„°ì™€ ì¼ì¹˜í•˜ë©´ 'selected' í´ë˜ìŠ¤ ì¶”ê°€ (í°ìƒ‰ í…Œë‘ë¦¬)
        if (currentFilter === filter.id) {
            btn.classList.add('selected');
        }

        btn.onclick = () => {
            currentFilter = filter.id;
            // ëª¨ë“  ë²„íŠ¼ì—ì„œ selected ì œê±°
            filterContainer.querySelectorAll('.set-btn').forEach(b => b.classList.remove('selected'));
            // í˜„ì¬ í´ë¦­ëœ ë²„íŠ¼ì— selected ì¶”ê°€
            btn.classList.add('selected');
            
            // í•„í„°ë§ëœ ë‚´ìš©ì„ ë‹¤ì‹œ ë Œë”ë§
            showSetSlotSummary(setName);
        };
        filterContainer.appendChild(btn);
    });
    
    panel.appendChild(summaryHeader);
    panel.appendChild(filterContainer);
    
    // âœ… í•„í„°ì— ë§ê²Œ ìš”ì•½ íŒ¨ë„ ë Œë”ë§
    showSetSlotSummary(setName);
}

// ===== ìºë¦­í„°ë³„ ìŠ¬ë¡¯ ìš”ì•½ (ìˆ˜ì •ë¨) =====
function showSetSlotSummary(setName){
    // ê¸°ì¡´ showSetSlotSummaryê°€ ë Œë”ë§í•˜ë˜ ì˜ì—­ì„ ì°¾ì•„ì„œ ë¹„ìš°ê±°ë‚˜ ìƒˆë¡œ ë§Œë“­ë‹ˆë‹¤.
    // openSetì—ì„œ 'summaryHeader'ì™€ 'filterContainer'ë¥¼ ì´ë¯¸ ì¶”ê°€í–ˆìœ¼ë¯€ë¡œ,
    // ì—¬ê¸°ì„œëŠ” ì‹¤ì œ í…Œì´ë¸”ë§Œ ë‹¤ì‹œ ê·¸ë¦½ë‹ˆë‹¤.
    let tableContainer = document.getElementById("summaryTableContainer");
    if (!tableContainer) {
        tableContainer = document.createElement("div");
        tableContainer.id = "summaryTableContainer";
        document.getElementById("panel").appendChild(tableContainer);
    }
    tableContainer.innerHTML = '';
    
    const slots = ALL_SETS[setName] || [];
    const table = document.createElement("table");

    // í•„í„°ì— ë”°ë¼ í—¤ë” ë‚´ìš©ê³¼ ì„¸íŠ¸ ë‹¬ì„± ì—´ í‘œì‹œ ì—¬ë¶€ ê²°ì •
    const isFiltered = currentFilter !== 'ALL';
    let headerHtml = `<tr><th>ìºë¦­í„°</th><th>ì§ì—…</th>${slots.map(s=>`<th>${s}</th>`).join("")}`;
    if (!isFiltered) {
        headerHtml += `<th>ì„¸íŠ¸ ë‹¬ì„±</th></tr>`;
    } else {
        headerHtml += `</tr>`;
    }
    
    table.innerHTML = `<thead>${headerHtml}</thead><tbody></tbody>`;
    const tbody = table.querySelector("tbody");

    const prefixes = ALL_PREFIX[setName] || [];
    const setType = getSetType(setName);

    characters.forEach(char => {
        let hasAny = false;
        let html = `<td>${char.name}</td><td>${char.job}</td>`;

        // ìŠ¬ë¡¯ë³„ í•©ê³„ ê³„ì‚° (í˜„ì¬ í•„í„°ì— ë§ê²Œ)
        slots.forEach(slot => {
            let total = calculateSlotCountByFilter(char, setName, slot, currentFilter);
            
            if(total > 0) hasAny = true;
            html += `<td>${total}</td>`;
        });

        if(!hasAny) return; // í•˜ë‚˜ë„ ì¥ì°© ì•ˆ í–ˆìœ¼ë©´ ê±´ë„ˆëœë‹ˆë‹¤.

        // 'ëª¨ë‘' í•„í„°ì¼ ê²½ìš°ì—ë§Œ 'ì„¸íŠ¸ ë‹¬ì„±' ì—´ ì¶”ê°€
        if (!isFiltered) {
            // ğŸš¨ ë‹¬ì„± ì—¬ë¶€: ì ‘ë‘ì–´/ìµì‹œë“œ ë¬´ì‹œí•˜ê³  ì „ì²´ ê³ ìœ  ë¶€ìœ„ ê°œìˆ˜ë¡œ íŒì •
            const totalDistinct = calcTotalDistinctParts(char, setName);

            let status = "-";
            if(setType === "ARMOR"){
                if(totalDistinct === slots.length) status = "5ì„¸íŠ¸ ë‹¬ì„±";
                else if(totalDistinct >= 3) status = "3ì„¸íŠ¸ ë‹¬ì„±";
            } else {
                if(totalDistinct === 3) status = "3ì„¸íŠ¸ ë‹¬ì„±";
            }

            html += `<td>${status}</td>`;
        }

        const tr = document.createElement("tr");
        
        // 'ëª¨ë‘' í•„í„°ì¼ ê²½ìš°ì—ë§Œ ì‹œê° ê°•ì¡° (ì´ ê³ ìœ  ë¶€ìœ„ ê°œìˆ˜ ê¸°ì¤€)
        if (!isFiltered) {
            const totalDistinct = calcTotalDistinctParts(char, setName);
            if(setType === "ARMOR"){
                if(totalDistinct === slots.length) tr.className = "set5";
                else if(totalDistinct >= 3) tr.className = "set3";
            } else {
                if(totalDistinct === 3) tr.className = "set3";
            }
        }


        tr.innerHTML = html;
        tbody.appendChild(tr);
    });

    tableContainer.appendChild(table);
}

// ===== [ì‹ ê·œ í•¨ìˆ˜] í•„í„°ë³„ ìŠ¬ë¡¯ ê°œìˆ˜ ê³„ì‚° =====
function calculateSlotCountByFilter(char, setName, slot, filter) {
    const prefixes = ALL_PREFIX[setName] || [];
    
    let total = 0;
    
    // ê²€ìƒ‰ ëŒ€ìƒ ê·¸ë£¹ ëª©ë¡ ì •ì˜
    const baseGroup = setName;
    const prefixedGroups = prefixes.map(p => `${p}: ${setName}`);
    const exceedGroups = prefixes.flatMap(p => 
        EXCEED_TAGS.map(tag => `[${tag}] ${p}: ${setName}`)
    );

    let groupsToSearch = [];
    
    if (filter === 'ALL') {
        // 'ëª¨ë‘': ì¼ë°˜, ì ‘ë‘ì–´, ìµì‹œë“œ ëª¨ë‘ í•©ì‚°
        groupsToSearch = [baseGroup, ...prefixedGroups, ...exceedGroups];
    } else if (filter === 'BASE') {
        // 'ì¼ë°˜': ìˆœìˆ˜ ì„¸íŠ¸ ì´ë¦„ë§Œ
        groupsToSearch = [baseGroup];
    } else if (filter === 'PREFIX') {
        // 'ì ‘ë‘ì–´': ì ‘ë‘ì–´ ë¶™ì€ ì„¸íŠ¸ë§Œ (ìµì‹œë“œ ì œì™¸)
        groupsToSearch = prefixedGroups;
    } else if (filter === 'EXCEED') {
        // 'ìµì‹œë“œ': ìµì‹œë“œ ë¶™ì€ ì„¸íŠ¸ë§Œ
        groupsToSearch = exceedGroups;
    }

    groupsToSearch.forEach(group => {
        const fullKey = `${group} ${slot}`;
        // ì£¼ì˜: 'BASE'ì™€ 'PREFIX' í•„í„°ì—ì„œëŠ” ìµì‹œë“œê°€ ë¶™ì€ í‚¤ëŠ” ì œì™¸ë©ë‹ˆë‹¤.
        // 'ALL' í•„í„°ì—ì„œëŠ” ìµì‹œë“œê°€ ë¶™ì€ í‚¤ë„ í¬í•¨ë©ë‹ˆë‹¤. (ìœ„ì˜ groupsToSearch ì •ì˜ì— ë”°ë¦„)
        total += char.armorCounts[fullKey] || 0;
    });

    return total;
}

  // ===== ìˆ«ì ë²„íŠ¼ (ìš°í´ë¦­ ê°ì†Œ ê¸°ëŠ¥ í¬í•¨) =====
  function makeNumberButton(charId, key, val){
    const extraClass = val > 0 ? " positive" : "";
    return `<button class="num-btn${extraClass}"
      oncontextmenu="decrement('${charId}','${key}'); return false;"
      onclick="increment('${charId}','${key}')">${val}</button>`;
  }


  // ===== ì¦ê°€/ê°ì†Œ =====
  function increment(charId, key){
    const char = characters.find(c => c.id === charId);
    char.armorCounts[key] = (char.armorCounts[key] || 0) + 1;
    // ğŸ’¡ ì—…ë°ì´íŠ¸ ì‹œê°„ ì¶”ê°€/ê°±ì‹ 
    char.updateTimes[key] = Date.now();
    saveLocalData(); // [ë¡œì»¬ ìŠ¤í† ë¦¬ì§€] ë°ì´í„° ë³€ê²½ í›„ ì €ì¥
    showSetButtons(char);
    if(currentSetName && currentChar){
      openSet(currentSetName, currentChar); // âœ… ì €ì¥ëœ ê°’ìœ¼ë¡œ ë‹¤ì‹œ ì—´ê¸°
    }
  }

  // ğŸš¨ ê°ì†Œ í•¨ìˆ˜ (ìš°í´ë¦­ ì‹œ í˜¸ì¶œ)
  function decrement(charId, key){
    const char = characters.find(c => c.id === charId);
    const cur = char.armorCounts[key] || 0;
    char.armorCounts[key] = Math.max(0, cur - 1); // 0ë³´ë‹¤ ì‘ì•„ì§€ì§€ ì•Šê²Œ
    // ğŸ’¡ ì—…ë°ì´íŠ¸ ì‹œê°„ ì¶”ê°€/ê°±ì‹  (0ì´ ë˜ì–´ë„ ë§ˆì§€ë§‰ ìˆ˜ì • ì‹œê°„ì€ ë‚¨ê¹€)
    char.updateTimes[key] = Date.now();
    saveLocalData(); // [ë¡œì»¬ ìŠ¤í† ë¦¬ì§€] ë°ì´í„° ë³€ê²½ í›„ ì €ì¥
    showSetButtons(char);
    if(currentSetName && currentChar){
      openSet(currentSetName, currentChar); // âœ… ì €ì¥ëœ ê°’ìœ¼ë¡œ ë‹¤ì‹œ ì—´ê¸°
    }
  }

// =======================================================
// [ì¶”ê°€ ê¸°ëŠ¥] ìµœê·¼ ì—…ë°ì´íŠ¸ ë‚´ì—­ í‘œì‹œ (íŒì—…ì°½ ë° ìµì‹œë“œ íƒœê·¸ë³„ ìƒ‰ìƒ ì ìš©)
// =======================================================

function showRecentUpdates() {
    const allUpdates = [];
    const ALL_WEAPON_CATEGORIES = { 
        ...WEAPON_DATA_SLAYER, 
        ...WEAPON_DATA_FIGHTER, 
        ...WEAPON_DATA_GUNNER,
		...WEAPON_DATA_MAGE,
        ...WEAPON_DATA_PRIEST,
		...WEAPON_DATA_WARRIOR,
        ...WEAPON_DATA_LANCER,
        ...WEAPON_DATA_THIEF
    };

    characters.forEach(char => {
        // 1. ë°©ì–´êµ¬/ì•…ì„¸/íŠ¹ì¥ ì—…ë°ì´íŠ¸ ìˆ˜ì§‘ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
        Object.entries(char.updateTimes).forEach(([fullKey, timestamp]) => {
            if (timestamp > 0) {
                const parts = fullKey.split(' ');
                const slot = parts.pop(); 
                const itemName = parts.join(' ');
                const isWeaponTag = WEAPON_PREFIXES.some(p => itemName.includes(p.tag));
                
                if (!isWeaponTag && char.armorCounts[fullKey] !== undefined) {
                    let category = "ë°©ì–´êµ¬";
                    const setType = getSetType(itemName.split(':').pop().trim());
                    if (setType === "ACCESSORY") category = "ì•…ì„¸";
                    else if (setType === "SPECIAL") category = "íŠ¹ì¥";

                    allUpdates.push({
                        name: char.name, job: char.job, itemName: itemName,
                        category: category, slot: slot, count: char.armorCounts[fullKey], timestamp: timestamp
                    });
                }
            }
        });

        // 2. ë¬´ê¸° ì—…ë°ì´íŠ¸ ìˆ˜ì§‘
        if (char.weaponCounts) {
            Object.entries(char.weaponCounts).forEach(([weaponKey, count]) => {
                const timestamp = char.updateTimes[weaponKey];
                if (timestamp > 0) {
                    let weaponSubCategory = "-";
                    for (const [catName, list] of Object.entries(ALL_WEAPON_CATEGORIES)) {
                        if (list.some(name => weaponKey.includes(name))) {
                            weaponSubCategory = catName;
                            break;
                        }
                    }
                    allUpdates.push({
                        name: char.name, job: char.job, itemName: weaponKey,
                        category: "ë¬´ê¸°", slot: weaponSubCategory, count: count, timestamp: timestamp
                    });
                }
            });
        }
    });

    allUpdates.sort((a, b) => b.timestamp - a.timestamp);

    const modalContent = document.getElementById("updateModalContent");
    if (allUpdates.length === 0) {
        modalContent.innerHTML = "<p>ìµœê·¼ ì—…ë°ì´íŠ¸ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
        document.getElementById("updateModal").style.display = 'flex';
        return;
    }

    const table = document.createElement("table");
    table.style.width = '100%';
    table.innerHTML = `
        <thead>
            <tr>
                <th style="width:20%;">ì§ì—… / ì´ë¦„</th>
                <th style="width:15%;">ì¢…ë¥˜ (ë¶€ìœ„)</th>
                <th style="width:35%;">ì•„ì´í…œ</th>
                <th style="width:10%;">ë³´ìœ  ê°œìˆ˜</th>
                <th style="width:20%;">ì—…ë°ì´íŠ¸ ì‹œê°„</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;
    const tbody = table.querySelector("tbody");

    allUpdates.slice(0, 15).forEach(item => {
        const date = new Date(item.timestamp);
        const formatTime = `${date.getFullYear()}-${String(date.getMonth()+1).padStart(2,'0')}-${String(date.getDate()).padStart(2,'0')} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;

        let styledItemName = item.itemName;
        const tagMatch = styledItemName.match(/^(\[.*?\])\s*(.*)/);
        if (tagMatch) {
            const tag = tagMatch[1];
            const restName = tagMatch[2];
            let color = '#25c2a0';

            if (tag === '[ì„ ë´‰]') color = '#ff4d4f';
            else if (tag === '[ì˜ì§€]') color = '#3399cc';
            else if (tag === '[ì´ìƒ]') color = '#25c2a0';
            else if (tag === '[ê´‘ì±„]') color = '#3399cc';
            else if (tag === '[ë¶„ì‡„]') color = '#ff4d4f';
            else if (tag === '[ì„ ëª…]') color = '#25c2a0';
            else if (tag === '[ê°•íƒ€]') color = '#ffd700';

            styledItemName = `<span style="color:${color}; font-weight:bold;">${tag}</span> ${restName}`;
            
            if (restName.includes(':')) {
                const prefixMatch = restName.match(/(.+?):\s*(.+)/);
                if (prefixMatch) {
                    styledItemName = `<span style="color:${color}; font-weight:bold;">${tag}</span> <span style="color:#e6b800; font-weight:bold;">${prefixMatch[1]}</span>: ${prefixMatch[2]}`;
                }
            }
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td style="white-space:nowrap;">${item.job} / ${item.name}</td>
            <td>[${item.category}] ${item.slot}</td>
            <td style="text-align:left;">${styledItemName}</td>
            <td style="font-weight:bold; color:${item.count > 0 ? '#ffcc00' : '#888'};">${item.count}</td>
            <td style="font-size:0.9em;">${formatTime}</td>
        `;
        tbody.appendChild(tr);
    });

    modalContent.innerHTML = "";
    modalContent.appendChild(table);
    document.getElementById("updateModal").style.display = 'flex';
}


  // ===== CSV ì €ì¥ (ìƒëµ ì—†ìŒ) =====
  function exportCSV(){
    // ğŸ’¡ í—¤ë”ì— "ì—…ë°ì´íŠ¸ ì‹œê°„" ì¶”ê°€
    const headers = ["ì´ë¦„","ì§ì—…","ì¹´í…Œê³ ë¦¬","ì„¸íŠ¸ëª…","ìŠ¬ë¡¯","ì ‘ë‘ì–´","ë³´ìœ ê°œìˆ˜","ì—…ë°ì´íŠ¸ ì‹œê°„"];
    const rows = [headers];
    const CATS = [
      {cat:"ë°©ì–´êµ¬", sets:ARMOR_SETS, pref:ARMOR_PREFIX},
      {cat:"ì•…ì„¸", sets:ACCESSORY_SETS, pref:ACCESSORY_PREFIX},
      {cat:"íŠ¹ì¥", sets:SPECIAL_SETS, pref:SPECIAL_PREFIX}
    ];

    // ğŸ’¡ ì‹œê°„ í¬ë§·íŒ… í•¨ìˆ˜
    const formatUpdateTime = (timestamp) => {
      if (!timestamp) return "";
      const date = new Date(timestamp);
      const pad = n => String(n).padStart(2, "0");
      return `${date.getFullYear()}-${pad(date.getMonth()+1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}`;
    };

    characters.forEach(char=>{
      CATS.forEach(({cat, sets, pref})=>{
        Object.keys(sets).forEach(setName=>{
          const slots = sets[setName];
          const pfxs = pref[setName] || [];
          const groups = [setName, ...pfxs.map(p=>`${p}: ${setName}`)];
          groups.forEach(group=>{
            slots.forEach(slot=>{
              const key = `${group} ${slot}`;
              const count = char.armorCounts[key] || 0;
              const updateTime = formatUpdateTime(char.updateTimes[key]); // ğŸ’¡ ì‹œê°„ í¬ë§·íŒ…

              // ğŸ’¡ ë¡œìš°ì— updateTime í•„ë“œ ì¶”ê°€
              rows.push([char.name, char.job, cat, setName, slot,
                group.includes(": ")?group.split(": ")[0]:"", count, updateTime]);

              const exceedNeeded =
                      (cat==="ë°©ì–´êµ¬" && slot==="ìƒì˜") ||
                      (cat==="ì•…ì„¸" && slot==="íŒ”ì°Œ") ||
                      (cat==="íŠ¹ì¥" && slot==="ê·€ê±¸ì´");
              if (exceedNeeded && pfxs.length>0) {
                EXCEED_TAGS.forEach(tag=>{
                  const exceedGroup = `[${tag}] ${group}`;
                  const exceedKey = `${exceedGroup} ${slot}`; // ğŸ’¡ ìµì‹œë“œ í‚¤
                  const countEx = char.armorCounts[exceedKey] || 0;
                  const updateTimeEx = formatUpdateTime(char.updateTimes[exceedKey]); // ğŸ’¡ ìµì‹œë“œ ì‹œê°„ í¬ë§·íŒ…

                  // ğŸ’¡ ìµì‹œë“œ ë¡œìš°ì— updateTimeEx í•„ë“œ ì¶”ê°€
                  rows.push([
                    char.name,
                    char.job,
                    cat,
                    setName,
                    slot,
                    `${group.includes(": ")?group.split(": ")[0]:""} (ìµì‹œë“œ:${tag})`,
                    countEx,
                    updateTimeEx
                  ]);
                });
              }
            });
          });
        });
      });
    });

    const escape = v => String(v).replace(/"/g,'""');
    const csvContent = "\uFEFF" + rows.map(r=>r.map(escape).map(v=>`"${v}"`).join(",")).join("\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;

    // --- ì—¬ê¸°ì„œ íŒŒì¼ëª…ì— ë…„ì›”ì¼ì‹œ ì¶”ê°€ ---
    const now = new Date();
    const pad = n => String(n).padStart(2, "0");
    const filename = `sets_characters_${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}_${pad(now.getHours())}-${pad(now.getMinutes())}.csv`;
    a.download = filename;

    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ===== CSV ì½ê¸° =====
  document.getElementById("csvFile").addEventListener("change", function(e){
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function(evt){
      const text = evt.target.result;
      displayCSV(text);
    };
    reader.readAsText(file, "utf-8");
  });

  function displayCSV(csvText){
    const lines = csvText.trim().split("\n");
    const headers = lines[0].split(",").map(h=>h.replace(/^"|"$/g,""));
    const data = lines.slice(1).map(line=>{
      const cells = line.split(",").map(c=>c.replace(/^"|"$/g,""));
      const obj = {};
      headers.forEach((h,i)=>obj[h]=cells[i]);
      return obj;
    });

    characters.length = 0;
    const grouped = {};
    data.forEach(row=>{
      const key = row["ì´ë¦„"]+"_"+row["ì§ì—…"];
      if(!grouped[key]){
        // CSVì—ì„œ ì½ì€ ìºë¦­í„°ì— ì„ì‹œ ID ë¶€ì—¬ ë° updateTimes ì´ˆê¸°í™”
        grouped[key] = {id:"c_imp_"+Date.now()+"_"+Math.random(), name:row["ì´ë¦„"], job:row["ì§ì—…"], armorCounts:{}, updateTimes: {}};
        characters.push(grouped[key]);
      }
      const char = grouped[key];
      let groupName;
      if(row["ì ‘ë‘ì–´"] && row["ì ‘ë‘ì–´"].includes("(ìµì‹œë“œ:")){
        const basePrefix = row["ì ‘ë‘ì–´"].split(" ")[0];
        const tag = row["ì ‘ë‘ì–´"].match(/\(ìµì‹œë“œ:(.+)\)/)[1];
        groupName = `[${tag}] ${basePrefix}: ${row["ì„¸íŠ¸ëª…"]}`;
      } else if(row["ì ‘ë‘ì–´"]){
        groupName = `${row["ì ‘ë‘ì–´"]}: ${row["ì„¸íŠ¸ëª…"]}`;
      } else {
        groupName = row["ì„¸íŠ¸ëª…"];
      }
      const slot = row["ìŠ¬ë¡¯"];
      const fullKey = `${groupName} ${slot}`;
      char.armorCounts[fullKey] = parseInt(row["ë³´ìœ ê°œìˆ˜"],10);

      // ğŸ’¡ ì—…ë°ì´íŠ¸ ì‹œê°„ ì²˜ë¦¬
      if (row["ì—…ë°ì´íŠ¸ ì‹œê°„"]) {
        // CSVì—ì„œ ì½ì€ ì‹œê°„ ë¬¸ìì—´ì„ Date ê°ì²´ë¡œ ë³€í™˜í•˜ì—¬ timestamp ì €ì¥
        const date = new Date(row["ì—…ë°ì´íŠ¸ ì‹œê°„"]);
        if (!isNaN(date.getTime())) { // ìœ íš¨í•œ ë‚ ì§œì¸ì§€ í™•ì¸
          char.updateTimes[fullKey] = date.getTime();
        }
      }
    });

    saveLocalData(); // [ë¡œì»¬ ìŠ¤í† ë¦¬ì§€] CSV ê°€ì ¸ì˜¤ê¸° ì„±ê³µ ì‹œ ë¡œì»¬ì— ì €ì¥

    renderCharacterList();
    document.getElementById("setList").innerHTML="";
    document.getElementById("panel").innerHTML="";
  }
  
  
function exportJSON() {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');

    // ë³€ê²½ëœ íŒŒì¼ëª… í˜•ì‹: dnfm_eq_YYYY-MM-DD_HH-MM.json
    const fileName = `dnfm_eq_${year}-${month}-${day}_${hours}-${minutes}.json`;

    const dataStr = JSON.stringify(characters, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement("a");
    a.href = url;
    a.download = fileName; 
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

function importJSON(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const imported = JSON.parse(e.target.result);

            if (!Array.isArray(imported)) {
                alert("ì˜¬ë°”ë¥¸ JSON í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
                return;
            }

            // 1. ì „ì—­ ë°ì´í„° êµì²´ ë° ë³´ì •
            characters = imported.map(char => ({
                id: char.id || Date.now().toString() + Math.random(),
                name: char.name || "Unknown",
                job: char.job || "ê·€ê²€ì‚¬",
                armorCounts: char.armorCounts || {},
                weaponCounts: char.weaponCounts || {}, 
                updateTimes: char.updateTimes || {}
            }));

            // 2. ìƒˆë¡œìš´ í‚¤(dnfm_eq)ë¡œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì¦‰ì‹œ ì €ì¥
            saveLocalData();

            // 3. [í•µì‹¬] í™”ë©´ ìƒíƒœì— ë”°ë¥¸ ì¦‰ì‹œ ê°±ì‹  ë¡œì§
            
            // A. ë©”ì¸ ìºë¦­í„° ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
            if (typeof renderCharacterList === "function") renderCharacterList();
            
            // B. ë¬´ê¸° ê´€ë¦¬ í™”ë©´ì¸ ê²½ìš°: í˜„ì¬ ì„ íƒëœ ì§ì—… ë²„íŠ¼ì„ ì°¾ì•„ì„œ ë‹¤ì‹œ í´ë¦­í•œ íš¨ê³¼ë¥¼ ì¤Œ
            const activeWeaponBtn = document.querySelector("#weaponJobButtons .char-btn.active");
            if (activeWeaponBtn && typeof selectWeaponJob === "function") {
                selectWeaponJob(activeWeaponBtn.textContent);
            }

            // C. ë°©ì–´êµ¬ ì„¸íŠ¸ ìƒì„¸ í™”ë©´ì¸ ê²½ìš°: í˜„ì¬ ì—´ë ¤ìˆëŠ” ì„¸íŠ¸ë¥¼ ë‹¤ì‹œ ì—´ê¸°
            if (currentSetName && currentChar) {
                // ë°ì´í„°ê°€ êµì²´ë˜ì—ˆìœ¼ë¯€ë¡œ ìƒˆë¡œìš´ ë°ì´í„° ê°ì²´ì—ì„œ í˜„ì¬ ìºë¦­í„°ë¥¼ ë‹¤ì‹œ ì°¾ìŒ
                const updatedChar = characters.find(c => c.id === currentChar.id);
                if (updatedChar) {
                    openSet(currentSetName, updatedChar);
                }
            }

            // D. ìºë¦­í„° ìƒì„¸ ì •ë³´(Summary) í™”ë©´ì¸ ê²½ìš°: ê°•ì œ ë¦¬ë Œë”ë§
            if (typeof currentCharacterId !== 'undefined' && currentCharacterId) {
                if (typeof showDetail === "function") showDetail(currentCharacterId);
            }

            alert(`ë°ì´í„° ë³µêµ¬ ì™„ë£Œ! ì´ ${characters.length}ëª…ì˜ ë°ì´í„°ê°€ ì¦‰ì‹œ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            event.target.value = '';

        } catch (err) {
            console.error(err);
            alert("íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
        }
    };
    reader.readAsText(file);
}

// ë¬´ê¸° ì „ìš© ìˆ«ì ë²„íŠ¼ ìƒì„± í•¨ìˆ˜ (ê¸°ì¡´ makeNumberButton ë³µì‚¬ ë° ìˆ˜ì •)
function makeWeaponNumberButton(charId, key, val, jobName) {
    const extraClass = val > 0 ? " positive" : "";
    return `<button class="num-btn${extraClass}"
      oncontextmenu="decrementWeapon('${charId}','${key}', '${jobName}'); return false;"
      onclick="incrementWeapon('${charId}','${key}', '${jobName}')">${val}</button>`;
}

// ë¬´ê¸° ì „ìš© ì¦ê°€ í•¨ìˆ˜
function incrementWeapon(charId, key, jobName) {
    const char = characters.find(c => c.id === charId);
    if (!char) return;
    if (!char.weaponCounts) char.weaponCounts = {};
    
    char.weaponCounts[key] = (char.weaponCounts[key] || 0) + 1;
    char.updateTimes[key] = Date.now(); // ì—…ë°ì´íŠ¸ ì‹œê°„ ê¸°ë¡
    
    saveLocalData();    // ğŸ”¥ ì—¬ê¸°ì„œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥!
    selectWeaponJob(jobName); // í™”ë©´ ê°±ì‹ 
}

// ë¬´ê¸° ì „ìš© ê°ì†Œ í•¨ìˆ˜
function decrementWeapon(charId, key, jobName) {
    const char = characters.find(c => c.id === charId);
    if (!char) return;
    if (!char.weaponCounts) char.weaponCounts = {};
    
    const cur = char.weaponCounts[key] || 0;
    char.weaponCounts[key] = Math.max(0, cur - 1);
    char.updateTimes[key] = Date.now();
    
    saveLocalData();    // ğŸ”¥ ì—¬ê¸°ì„œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥!
    selectWeaponJob(jobName); // í™”ë©´ ê°±ì‹ 
}

// ===== ë¬´ê¸° ì§ì—… ì„ íƒ ë° ë²„íŠ¼ ê°±ì‹  (ìˆ˜ì •ë¨) =====
function selectWeaponJob(jobName) {
    // 1. ë²„íŠ¼ í™œì„±í™” ìƒíƒœ í‘œì‹œ
    const container = document.getElementById("weaponJobButtons");
    container.innerHTML = ""; // ë²„íŠ¼ ì˜ì—­ ë¹„ìš°ê¸°

    const jobs = ['ê·€ê²€ì‚¬', 'ê²©íˆ¬ê°€', 'ê±°ë„ˆ', 'ë§ˆë²•ì‚¬', 'í”„ë¦¬ìŠ¤íŠ¸', 'ì›Œë¦¬ì–´', 'ë§ˆì°½ì‚¬', 'ë„ì '];
    
    jobs.forEach(j => {
        let totalCount = 0;
        let jobData = null;

        // ì§ì—…ë³„ ë°ì´í„° ë§¤ì¹­
        if (j === 'ê·€ê²€ì‚¬') jobData = WEAPON_DATA_SLAYER;
        else if (j === 'ê²©íˆ¬ê°€') jobData = WEAPON_DATA_FIGHTER;
        else if (j === 'ê±°ë„ˆ') jobData = WEAPON_DATA_GUNNER;
        else if (j === 'ë§ˆë²•ì‚¬') jobData = WEAPON_DATA_MAGE;
        else if (j === 'í”„ë¦¬ìŠ¤íŠ¸') jobData = WEAPON_DATA_PRIEST;
        else if (j === 'ì›Œë¦¬ì–´') jobData = WEAPON_DATA_WARRIOR;
        else if (j === 'ë§ˆì°½ì‚¬') jobData = WEAPON_DATA_LANCER;
        else if (j === 'ë„ì ') jobData = WEAPON_DATA_THIEF;

        // ëª¨ë“  ìºë¦­í„°ì˜ í•´ë‹¹ ì§ì—… ë¬´ê¸° ê°œìˆ˜ í•©ì‚°
        if (jobData) {
            characters.forEach(char => {
                if (char.weaponCounts) {
                    Object.values(jobData).forEach(weaponList => {
                        weaponList.forEach(weaponName => {
                            WEAPON_PREFIXES.forEach(pref => {
                                const weaponKey = `${pref.tag} ${weaponName}`;
                                totalCount += (char.weaponCounts[weaponKey] || 0);
                            });
                        });
                    });
                }
            });
        }

        const btn = document.createElement("button");
        btn.className = "char-btn" + (j === jobName ? " active" : "");
        btn.textContent = `${j} (${totalCount})`; // ğŸ’¡ ì—¬ê¸°ì— ìˆ«ì í‘œì‹œ
        btn.onclick = () => selectWeaponJob(j);
        container.appendChild(btn);
    });

    // 2. í•˜ë‹¨ ë¬´ê¸° ìƒì„¸ í…Œì´ë¸” ìƒì„± (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
    const weaponPanel = document.getElementById("weaponPanel");
    let currentData = null;
    if (jobName === 'ê·€ê²€ì‚¬') currentData = WEAPON_DATA_SLAYER;
    else if (jobName === 'ê²©íˆ¬ê°€') currentData = WEAPON_DATA_FIGHTER;
    else if (jobName === 'ê±°ë„ˆ') currentData = WEAPON_DATA_GUNNER;
    else if (jobName === 'ë§ˆë²•ì‚¬') currentData = WEAPON_DATA_MAGE;
    else if (jobName === 'í”„ë¦¬ìŠ¤íŠ¸') currentData = WEAPON_DATA_PRIEST;
    else if (jobName === 'ì›Œë¦¬ì–´') currentData = WEAPON_DATA_WARRIOR;
    else if (jobName === 'ë§ˆì°½ì‚¬') currentData = WEAPON_DATA_LANCER;
    else if (jobName === 'ë„ì ') currentData = WEAPON_DATA_THIEF;

    if (!currentData) {
        weaponPanel.innerHTML = `<h3 style="margin-top:20px;">${jobName} ë°ì´í„°ëŠ” ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</h3>`;
        return;
    }

    let html = `<div style="overflow-x: auto; margin-top: 20px; border: 1px solid #2a3158;">`;
    html += `<table style="table-layout: auto; border-collapse: collapse; width: max-content;">`;
    html += `<thead><tr style="background: #181c33;">`;
    html += `<th style="padding: 12px; border: 1px solid #2a3158; white-space: nowrap;">ì¢…ë¥˜</th>`;
    html += `<th style="padding: 12px; border: 1px solid #2a3158; white-space: nowrap;">ë¬´ê¸° ì´ë¦„</th>`;

    characters.forEach(char => {
    // ğŸ’¡ / ëŒ€ì‹  <br>ì„ ë„£ì–´ ì¤„ë°”ê¿ˆì„ ì ìš©í•˜ê³ , í…ìŠ¤íŠ¸ ì •ë ¬ì„ ì¤‘ì•™ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
    html += `<th style="padding: 12px; border: 1px solid #2a3158; white-space: nowrap; text-align: center;">${char.job}<br>${char.name}</th>`;
});
    html += `</tr></thead><tbody>`;

    for (const [category, weaponList] of Object.entries(currentData)) {
        const rowSpanCount = weaponList.length * 5;
        weaponList.forEach((weaponName, wIdx) => {
            WEAPON_PREFIXES.forEach((pref, pIdx) => {
                html += `<tr>`;
                if (wIdx === 0 && pIdx === 0) {
                    html += `<td rowspan="${rowSpanCount}" style="background:#181c33; font-weight:bold; white-space: nowrap; border: 1px solid #2a3158; text-align:center; padding: 10px;">${category}</td>`;
                }
                const styledName = `<span style="color:${pref.color}; font-weight:bold;">${pref.tag}</span>&nbsp;${weaponName}`;
                html += `<td style="text-align:left; padding: 8px 15px; white-space: nowrap; border: 1px solid #2a3158;">${styledName}</td>`;
                characters.forEach(char => {
                    const weaponKey = `${pref.tag} ${weaponName}`;
                    const val = (char.weaponCounts && char.weaponCounts[weaponKey]) || 0;
                    html += `<td style="padding: 5px; border: 1px solid #2a3158; text-align:center;">${makeWeaponNumberButton(char.id, weaponKey, val, jobName)}</td>`;
                });
                html += `</tr>`;
            });
            html += `<tr style="height:20px;"><td colspan="${characters.length + 1}" style="border: 1px solid #2a3158; background: rgba(255,255,255,0.05);"></td></tr>`;
        });
        html += `<tr style="height:40px; background: #0f1222;"><td colspan="${characters.length + 2}" style="border: 1px solid #2a3158;"></td></tr>`;
    }
    html += `</tbody></table></div>`;
    weaponPanel.innerHTML = html;
}

// 1. ì´ˆê¸° ë Œë”ë§ ë° ìºë¦­í„° ì¶”ê°€/ë°ì´í„° ë¡œë“œ ì‹œ ë²„íŠ¼ì„ ë‹¤ì‹œ ê·¸ë¦¬ê¸° ìœ„í•œ í•¨ìˆ˜í™”
function renderWeaponJobButtons() {
    const jobs = ['ê·€ê²€ì‚¬', 'ê²©íˆ¬ê°€', 'ê±°ë„ˆ', 'ë§ˆë²•ì‚¬', 'í”„ë¦¬ìŠ¤íŠ¸', 'ì›Œë¦¬ì–´', 'ë§ˆì°½ì‚¬', 'ë„ì '];
    const container = document.getElementById("weaponJobButtons");
    
    // í˜„ì¬ í™œì„±í™”ëœ ë²„íŠ¼ ì´ë¦„ ê¸°ì–µ
    const activeBtn = container.querySelector(".char-btn.active");
    const activeJobName = activeBtn ? activeBtn.textContent.split(' (')[0] : null;

    container.innerHTML = "";

    jobs.forEach(jobName => {
        let totalCount = 0;
        let jobData = null;

        // í•´ë‹¹ ì§ì—…êµ° ë°ì´í„° ë§¤ì¹­
        if (jobName === 'ê·€ê²€ì‚¬') jobData = WEAPON_DATA_SLAYER;
        else if (jobName === 'ê²©íˆ¬ê°€') jobData = WEAPON_DATA_FIGHTER;
        else if (jobName === 'ê±°ë„ˆ') jobData = WEAPON_DATA_GUNNER;
        else if (jobName === 'ë§ˆë²•ì‚¬') jobData = WEAPON_DATA_MAGE;
        else if (jobName === 'í”„ë¦¬ìŠ¤íŠ¸') jobData = WEAPON_DATA_PRIEST;
        else if (jobName === 'ì›Œë¦¬ì–´') jobData = WEAPON_DATA_WARRIOR;
        else if (jobName === 'ë§ˆì°½ì‚¬') jobData = WEAPON_DATA_LANCER;
        else if (jobName === 'ë„ì ') jobData = WEAPON_DATA_THIEF;

        // ëª¨ë“  ìºë¦­í„°ë¥¼ ëŒë©° í•´ë‹¹ ì§ì—…êµ° ë¬´ê¸° ê°œìˆ˜ í•©ì‚°
        if (jobData) {
            characters.forEach(char => {
                if (char.weaponCounts) {
                    for (const [category, weaponList] of Object.entries(jobData)) {
                        weaponList.forEach(weaponName => {
                            WEAPON_PREFIXES.forEach(pref => {
                                const weaponKey = `${pref.tag} ${weaponName}`;
                                totalCount += (char.weaponCounts[weaponKey] || 0);
                            });
                        });
                    }
                }
            });
        }

        const btn = document.createElement("button");
        btn.className = "char-btn";
        if (jobName === activeJobName) btn.classList.add("active");
        btn.textContent = `${jobName} (${totalCount})`; // ê°œìˆ˜ í‘œì‹œ
        btn.onclick = () => selectWeaponJob(jobName);
        container.appendChild(btn);
    });
}

selectWeaponJob('ê·€ê²€ì‚¬');
</script>

</body>
</html>