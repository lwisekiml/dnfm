<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ìºë¦­í„° ì¥ë¹„ ê´€ë¦¬ + CSV</title>
<style>
  body { font-family:sans-serif; background:#0f1222; color:#e6e9ff; }
  h1 { margin-bottom:10px; }

  /* íˆ´ë°” ì˜ì—­ */
  .toolbar { margin:15px 0; display:flex; gap:10px; align-items:center; }
  .action-btn, .file-label {
    min-width:140px; text-align:center; padding:10px 16px;
    border-radius:6px; cursor:pointer; font-weight:bold; transition:0.2s;
  }
  .action-btn { background:linear-gradient(135deg,#25c2a0,#1a8c7d); border:none; color:#fff; }
  .action-btn:hover { background:linear-gradient(135deg,#1a8c7d,#25c2a0); }
  .file-label { background:#4a3f7a; color:#fff; border:none; }
  .file-label:hover { background:#5a4f8a; }
  .file-label input { display:none; }

  /* ìºë¦­í„° ì¶”ê°€ í¼ */
  .form-box { display:flex; gap:10px; margin:10px 0; }
  .form-box input {
    width:20ch; padding:6px; border-radius:6px; border:1px solid #2a3158;
    background:#181c33; color:#e6e9ff;
  }
  .add-btn {
    background:linear-gradient(135deg,#ffd700,#e6b800); border:none; color:#000;
    padding:8px 14px; border-radius:6px; cursor:pointer; font-weight:bold; transition:0.2s;
  }
  .add-btn:hover { background:linear-gradient(135deg,#e6b800,#ffd700); }

  /* ìºë¦­í„° ë²„íŠ¼ */
  .char-btn {
    margin:5px; padding:10px 16px; background:#2a3158; border:none;
    border-radius:6px; color:#fff; font-weight:bold; cursor:pointer; transition:0.2s;
  }
  .char-btn:hover { background:#3a4270; }

  /* ì„¸íŠ¸ ë²„íŠ¼ */
  .set-btn {
    margin:5px; padding:8px 14px; min-width:180px;
    background:#181c33; border:1px solid #2a3158; border-radius:6px;
    color:#e6e9ff; font-weight:bold; cursor:pointer; transition:0.2s;
    text-align:center; white-space:nowrap;
  }
  .set-btn:hover { background:#2a3158; }
  .set-btn.set3 { background-color:#25c2a0; color:#fff; }
  .set-btn.set5 { background-color:#ffd700; color:#000; }

  h2 { margin:24px 0 8px; }
  table { border-collapse:collapse; margin-top:6px; table-layout:fixed; }
  th, td { border:1px solid #2a3158; padding:6px; text-align:center; white-space:nowrap; }
  th { background:#181c33; }
  tr.set3 { background-color:rgba(37,194,160,0.35); }
  tr.set5 { background-color:rgba(255,215,0,0.45); }

  /* ìˆ«ì ë²„íŠ¼ */
  .num-btn {
    padding:6px 10px; border-radius:6px; border:1px solid #2a3158;
    background:#181c33; color:#e6e9ff; cursor:pointer;
  }
  .num-btn.positive {
    background: linear-gradient(135deg, #3399cc, #2a6f9e);
    color: #fff;
    font-weight: bold;
    border: 1px solid #3399cc;
  }

  .character-wrapper {
    display: inline-flex;
    align-items: center;
    margin: 5px;
  }

  .delete-btn {
    padding: 4px 8px;
    background: linear-gradient(135deg, #8c1a1a, #b22222);
    border: none;
    border-radius: 4px;
    color: #fff;
    font-weight: bold;
    cursor: pointer;
    transition: 0.2s;
  }
  .delete-btn:hover {
    background: linear-gradient(135deg, #b22222, #8c1a1a);
    transform: scale(1.05);
  }
  
.char-btn.active {
  background: #b8860b;   /* ì€ì€í•œ ê¸ˆë¹› ê³„ì—´ (DarkGoldenrod) */
  color: #fff;
  border: 1px solid #daa520; /* ì¡°ê¸ˆ ë” ë°ì€ ê¸ˆë¹› í…Œë‘ë¦¬ */
  box-shadow: 0 0 10px rgba(255, 215, 0, 0.6); /* ì€ì€í•œ ê¸ˆë¹› ê·¸ë¦¼ì */
}

</style>
</head>
<body>

<h1>ìºë¦­í„° ì¥ë¹„ ê´€ë¦¬</h1>
<div class="toolbar">
  <button class="action-btn" onclick="exportCSV()">ğŸ’¾ CSV ì €ì¥</button>
  <label class="file-label">
    ğŸ“‚ CSV ë¶ˆëŸ¬ì˜¤ê¸°
    <input type="file" id="csvFile" accept=".csv">
  </label>
</div>

<h2>[ìºë¦­í„°]</h2>
<div class="form-box">
  <input type="text" id="newCharName" placeholder="ì´ë¦„ ì…ë ¥">
  <input type="text" id="newCharJob" placeholder="ì§ì—… ì…ë ¥">
  <button class="add-btn" onclick="addCharacter()">â• ì¶”ê°€</button>
</div>
<div id="characterList"></div>

<div id="setList"></div>
<div id="panel"></div>



<script>
// ===== ì„¸íŠ¸ ì •ì˜ (ì˜ˆì‹œ ì¼ë¶€ë§Œ, ì‹¤ì œë¡œëŠ” ì „ì²´ ì„¸íŠ¸/ì ‘ë‘ì–´ ì •ì˜ í•„ìš”) =====
const ARMOR_SETS = {
  "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
  "í¬ì´ì¦ˆë‹ í€¸ ìŠ¤íŒŒì´ë”": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
  "ê±°ì¸ì˜ ìŠ¤í™ì¿¨ë£¸ ì•„ì´ì–¸": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
  "ì–´ë‘ ì„ ì˜ì•„ ë‚´ë¦¬ëŠ”": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
  "ìˆ˜í˜¸ìì˜ ì´ˆí•©ê¸ˆ": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
  "ìŠ¤í‹°í‚¤ ì• ì‹œë“œ ì›¨í€": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
  "ì„¬ëœ©í•œ ê°•ì²  ìš©": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
  "ìµìŠ¤í”Œë¡œì‹œë¸Œ ë²„ë‹ ìŠ¤í†¤": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
  "ë¹›ì˜ í—Œì‹ ì": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
  "ì—¬ëª…ì„ ì˜ì•„ ì˜¬ë¦¬ëŠ” ì": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
  "ì½°íŠ¸ë¡œ ì¹´ì‹œí…Œì›€": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
  "ê·¸ë€í…Œ ì „íˆ¬ê¸°ê°‘ íŒŒì¸ ": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
  "ë ˆê±°ì‹œ:ë§ˆë ¥ì˜ ì†Œìš©ëŒì´": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"],
  "ë ˆê±°ì‹œ:ìì—°ì˜ ìˆ˜í˜¸ì": ["ìƒì˜","í•˜ì˜","ì–´ê¹¨","ë²¨íŠ¸","ì‹ ë°œ"]
};
const ARMOR_PREFIX = {
  "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ": ["ì „ê²©","í—ˆìƒ"],
  "í¬ì´ì¦ˆë‹ í€¸ ìŠ¤íŒŒì´ë”": ["ì‘ì—´","ì¹¨ì‹"],
  "ê±°ì¸ì˜ ìŠ¤í™ì¿¨ë£¸ ì•„ì´ì–¸": ["ìˆ˜í˜¸","ì™œê³¡"],
  "ì–´ë‘ ì„ ì˜ì•„ ë‚´ë¦¬ëŠ”": ["ììƒ","ë§¹ë…"],
  "ìˆ˜í˜¸ìì˜ ì´ˆí•©ê¸ˆ": ["í—ˆìƒ","ë³´í˜¸"],
  "ìŠ¤í‹°í‚¤ ì• ì‹œë“œ ì›¨í€": ["ë§¹ë…","ì™œê³¡"],
  "ì„¬ëœ©í•œ ê°•ì²  ìš©": ["ì‡„ë„","ì¹¨ì‹"],
  "ìµìŠ¤í”Œë¡œì‹œë¸Œ ë²„ë‹ ìŠ¤í†¤": ["ì‹ ì†","ì—°ê²©"],
  "ë¹›ì˜ í—Œì‹ ì": ["ìˆ˜í˜¸","ì—°ê²©"],
  "ì—¬ëª…ì„ ì˜ì•„ ì˜¬ë¦¬ëŠ” ì": ["ììƒ","ì‡„ë„"],
  "ì½°íŠ¸ë¡œ ì¹´ì‹œí…Œì›€": ["ì‘ì—´","ë³´í˜¸"],
  "ê·¸ë€í…Œ ì „íˆ¬ê¸°ê°‘ íŒŒì¸ ": ["ì‹ ì†","ì „ê²©"],
  "ë ˆê±°ì‹œ:ë§ˆë ¥ì˜ ì†Œìš©ëŒì´": [],
  "ë ˆê±°ì‹œ:ìì—°ì˜ ìˆ˜í˜¸ì": []
};

const ACCESSORY_SETS = {
  "ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ": ["íŒ”ì°Œ","ëª©ê±¸ì´","ë°˜ì§€"],
  "ì„¬ëœ©í•œ ë¹›ì˜ ê´€ë¦¬ì": ["íŒ”ì°Œ","ëª©ê±¸ì´","ë°˜ì§€"],
  "ë¶€ì‹ëœ ë©”íƒˆê¸°ì–´": ["íŒ”ì°Œ","ëª©ê±¸ì´","ë°˜ì§€"],
  "í™”ë ¥ ê°œì¡° íƒ„ë ": ["íŒ”ì°Œ","ëª©ê±¸ì´","ë°˜ì§€"],
  "ì‹ ë¹„ë¡œìš´ ë¹›ì˜ ì†Œìš©ëŒì´": ["íŒ”ì°Œ","ëª©ê±¸ì´","ë°˜ì§€"],
  "ì½°íŠ¸ë¡œ ë§ˆëˆ„ìŠ¤ ì—°ì‚°ì¥ì¹˜": ["íŒ”ì°Œ","ëª©ê±¸ì´","ë°˜ì§€"],
  "ë ˆê±°ì‹œ:ì—í…Œë¦¬ì–¼ ë¦¬ë² ë„ŒíŠ¸": ["íŒ”ì°Œ","ëª©ê±¸ì´","ë°˜ì§€"],
  "ë ˆê±°ì‹œ:ì§€ë‚˜ì˜¨ ì˜ê´‘ì˜ ì‹œëŒ€": ["íŒ”ì°Œ","ëª©ê±¸ì´","ë°˜ì§€"]
};
const ACCESSORY_PREFIX = {
  "ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ": ["ê²¬ê³ ","í˜ˆë…"],
  "ì„¬ëœ©í•œ ë¹›ì˜ ê´€ë¦¬ì": ["ì´ˆì„","ê°ì˜¤"],
  "ë¶€ì‹ëœ ë©”íƒˆê¸°ì–´": ["ê°ì˜¤","ê°€ì†"],
  "í™”ë ¥ ê°œì¡° íƒ„ë ": ["í˜ˆë…","ê²¬ê³ "],
  "ì‹ ë¹„ë¡œìš´ ë¹›ì˜ ì†Œìš©ëŒì´": ["ì¡°í™”","ì´ˆì„"],
  "ì½°íŠ¸ë¡œ ë§ˆëˆ„ìŠ¤ ì—°ì‚°ì¥ì¹˜": ["ê°€ì†","ì¡°í™”"],
  "ë ˆê±°ì‹œ:ì—í…Œë¦¬ì–¼ ë¦¬ë² ë„ŒíŠ¸": [],
  "ë ˆê±°ì‹œ:ì§€ë‚˜ì˜¨ ì˜ê´‘ì˜ ì‹œëŒ€": []
};

const SPECIAL_SETS = {
  "ê°œêµ¬ìŸì´ í˜¸ë¬¸ì¿¨ë£¨ìŠ¤": ["ê·€ê±¸ì´","ë§ˆë²•ì„","ë³´ì¥"],
  "ë¼ì´íŠ¸ë‹ ì—ë„ˆì§€ ì½”ì–´": ["ê·€ê±¸ì´","ë§ˆë²•ì„","ë³´ì¥"],
  "ì² ê°‘ì„ ë‘ë¥¸ íƒ‘ì˜ ìˆ˜í˜¸ê¾¼": ["ê·€ê±¸ì´","ë§ˆë²•ì„","ë³´ì¥"],
  "ê¹Šì€ ë¶ˆêµ¬ë©ì´ì˜ ì„¬ë©¸ì": ["ê·€ê±¸ì´","ë§ˆë²•ì„","ë³´ì¥"],
  "í—ˆì˜ ì† ì–´ë‘ ì˜ í”¼ì¡°ë¬¼": ["ê·€ê±¸ì´","ë§ˆë²•ì„","ë³´ì¥"],
  "ë¶€ì •í•œ ë¹›ì˜ ìš°ìƒ": ["ê·€ê±¸ì´","ë§ˆë²•ì„","ë³´ì¥"]
};
const SPECIAL_PREFIX = {
  "ê°œêµ¬ìŸì´ í˜¸ë¬¸ì¿¨ë£¨ìŠ¤": ["ì „ê²©","í—ˆìƒ"],
  "ë¼ì´íŠ¸ë‹ ì—ë„ˆì§€ ì½”ì–´": ["ì „ê²©","í—ˆìƒ"],
  "ì² ê°‘ì„ ë‘ë¥¸ íƒ‘ì˜ ìˆ˜í˜¸ê¾¼": ["ì „ê²©","í—ˆìƒ"],
  "ê¹Šì€ ë¶ˆêµ¬ë©ì´ì˜ ì„¬ë©¸ì": ["ì „ê²©","í—ˆìƒ"],
  "í—ˆì˜ ì† ì–´ë‘ ì˜ í”¼ì¡°ë¬¼": ["ì „ê²©","í—ˆìƒ"],
  "ë¶€ì •í•œ ë¹›ì˜ ìš°ìƒ": ["ì „ê²©","í—ˆìƒ"]
};

const ALL_SETS = {...ARMOR_SETS, ...ACCESSORY_SETS, ...SPECIAL_SETS};
const ALL_PREFIX = {...ARMOR_PREFIX, ...ACCESSORY_PREFIX, ...SPECIAL_PREFIX};
const EXCEED_TAGS = ["ì„ ë´‰","ì˜ì§€","ì´ìƒ"];
const EXCEED_SLOTS = { "ARMOR":["ìƒì˜"], "ACCESSORY":["íŒ”ì°Œ"], "SPECIAL":["ê·€ê±¸ì´"] };

// ===== ìºë¦­í„° ë°°ì—´ =====
const characters = [
  {id:"c1", job:"ê²€ê·€", name:"ê°•ì˜", armorCounts:{
    "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ ìƒì˜":1,
    "ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ íŒ”ì°Œ":1,
    "[ì˜ì§€] ê²¬ê³ : ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ íŒ”ì°Œ":1,
    "ê°œêµ¬ìŸì´ í˜¸ë¬¸ì¿¨ë£¨ìŠ¤ ê·€ê±¸ì´":1
  }}
];

// ===== ì „ì—­ ìµœëŒ€ ê¸¸ì´ ê³„ì‚° =====
let globalSetNameWidth=200, globalSlotWidth=100;
function calculateGlobalWidths(){
  const allNames=[], allSlots=[];
  [ {sets:ARMOR_SETS,pref:ARMOR_PREFIX},
    {sets:ACCESSORY_SETS,pref:ACCESSORY_PREFIX},
    {sets:SPECIAL_SETS,pref:SPECIAL_PREFIX} ].forEach(({sets,pref})=>{
      Object.keys(sets).forEach(setName=>{
        allNames.push(setName);
        const prefixes=pref[setName]||[];
        prefixes.forEach(p=>{
          allNames.push(`${p}: ${setName}`);
          EXCEED_TAGS.forEach(ex=>allNames.push(`[${ex}] ${p}: ${setName}`));
        });
        sets[setName].forEach(slot=>allSlots.push(slot));
      });
  });
  globalSetNameWidth=Math.max(...allNames.map(n=>n.length))*12;
  globalSlotWidth=Math.max(...allSlots.map(s=>s.length))*12;
}
calculateGlobalWidths();

// ===== ìœ í‹¸ =====
function isExceedName(name){ return /^\[(ì„ ë´‰|ì˜ì§€|ì´ìƒ)\]\s/.test(name); }
function getGroupKey(name){ return name.replace(/^\[.*?\]\s*/,""); }
function getSetType(setName){
  if(ARMOR_SETS[setName]) return "ARMOR";
  if(ACCESSORY_SETS[setName]) return "ACCESSORY";
  if(SPECIAL_SETS[setName]) return "SPECIAL";
  return "ARMOR";
}
function calcDistinctParts(char, groupKey){
  const baseSet=groupKey.includes(": ")?groupKey.split(": ").pop():groupKey;
  const slots=ALL_SETS[baseSet]||[];
  let countDistinct=0;
  slots.forEach(slot=>{
    let total=char.armorCounts[`${groupKey} ${slot}`]||0;
    if(["ìƒì˜","íŒ”ì°Œ","ê·€ê±¸ì´"].includes(slot)){
      EXCEED_TAGS.forEach(tag=>{
        total+=char.armorCounts[`[${tag}] ${groupKey} ${slot}`]||0;
      });
    }
    if(total>0) countDistinct++;
  });
  return countDistinct;
}

// ===== ìºë¦­í„° ë²„íŠ¼ ë Œë” =====
// ===== ìºë¦­í„° ë²„íŠ¼ ë Œë” =====
function renderCharacterList(){
  const listEl = document.getElementById("characterList");
  listEl.innerHTML = "";

  characters.forEach((c, index) => {
    // ìºë¦­í„° í•˜ë‚˜ë¥¼ ê°ì‹¸ëŠ” wrapper
    const wrapper = document.createElement("div");
    wrapper.className = "character-wrapper";  // ğŸ‘‰ CSSì—ì„œ inline-block ì²˜ë¦¬

    // ì‚­ì œ ë²„íŠ¼
    const delBtn = document.createElement("button");
    delBtn.textContent = "ï¼";
    delBtn.className = "delete-btn";   // ğŸ‘‰ í˜ì´ì§€ ìŠ¤íƒ€ì¼ì— ë§ì¶˜ ì‚­ì œ ë²„íŠ¼
    delBtn.onclick = () => {
      if(confirm(`${c.name} ìºë¦­í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)){
        characters.splice(index, 1);   // ë°°ì—´ì—ì„œ ì‚­ì œ
        renderCharacterList();         // ëª©ë¡ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
        document.getElementById("setList").innerHTML = "";
        document.getElementById("panel").innerHTML = "";
      }
    };

    // ìºë¦­í„° ë²„íŠ¼
    const btn = document.createElement("button");
    btn.className = "char-btn";
    btn.textContent = `${c.job} (${c.name})`;
    btn.onclick = () => {
      // ëª¨ë“  ë²„íŠ¼ì—ì„œ active ì œê±°
      document.querySelectorAll(".char-btn").forEach(b => b.classList.remove("active"));
      // í˜„ì¬ ë²„íŠ¼ì— active ì¶”ê°€
      btn.classList.add("active");
      showSetButtons(c);
    };

    // wrapperì— ë²„íŠ¼ë“¤ ì¶”ê°€
    wrapper.appendChild(delBtn);
    wrapper.appendChild(btn);

    // ì „ì²´ ëª©ë¡ì— wrapper ì¶”ê°€
    listEl.appendChild(wrapper);
  });
}


renderCharacterList();

// ===== ìºë¦­í„° ì¶”ê°€ =====
function addCharacter(){
  const name=document.getElementById("newCharName").value.trim();
  const job=document.getElementById("newCharJob").value.trim();
  if(!name||!job){ alert("ì´ë¦„ê³¼ ì§ì—…ì„ ì…ë ¥í•˜ì„¸ìš”!"); return; }
  const newChar={id:"c"+Date.now(), job:job, name:name, armorCounts:{}};
  characters.push(newChar);
  renderCharacterList();
  document.getElementById("newCharName").value="";
  document.getElementById("newCharJob").value="";
}

// ===== ì„¸íŠ¸ ë²„íŠ¼ í‘œì‹œ =====
function showSetButtons(char){
  const setList = document.getElementById("setList");
  setList.innerHTML = "";

  // ë°©ì–´êµ¬
  const armorTitle = document.createElement("h2");
  armorTitle.textContent = "[ë°©ì–´êµ¬]";
  setList.appendChild(armorTitle);
  Object.keys(ARMOR_SETS).forEach(setName => {
    setList.appendChild(makeSetButton(setName, char));
  });

  // ì•…ì„¸
  const accTitle = document.createElement("h2");
  accTitle.textContent = "[ì•…ì„¸]";
  setList.appendChild(accTitle);
  Object.keys(ACCESSORY_SETS).forEach(setName => {
    setList.appendChild(makeSetButton(setName, char));
  });

  // íŠ¹ì¥
  const spTitle = document.createElement("h2");
  spTitle.textContent = "[íŠ¹ì¥]";
  setList.appendChild(spTitle);
  Object.keys(SPECIAL_SETS).forEach(setName => {
    setList.appendChild(makeSetButton(setName, char));
  });

  document.getElementById("panel").innerHTML = "";
}

// ===== ì„¸íŠ¸ ë²„íŠ¼ ìƒì„± =====
function makeSetButton(setName, char){
  let count3 = 0, count5 = 0;
  const prefixes = ALL_PREFIX[setName] || [];
  const groups = [setName, ...prefixes.map(pref => `${pref}: ${setName}`)];

  groups.forEach(group => {
    const distinctParts = calcDistinctParts(char, group);
    const fullSize = (ALL_SETS[setName] || []).length;
    if(fullSize === 5){
      if(distinctParts === fullSize) count5++;
      else if(distinctParts >= 3) count3++;
    } else {
      if(distinctParts === 3) count3++;
    }
  });

  const btn = document.createElement("button");
  btn.className = "set-btn";
  const setType = getSetType(setName);

  if(setType === "ARMOR"){
    btn.textContent = `${setName} (${count3}/${count5})`;
    if(count5 > 0) btn.classList.add("set5");
    else if(count3 > 0) btn.classList.add("set3");
  } else {
    btn.textContent = `${setName} (${count3})`;
    if(count3 > 0) btn.classList.add("set3");
  }

  btn.onclick = () => openSet(setName, char);
  return btn;
}

// ===== í‘œ í–‰ ìƒì„± =====
function makeRow(name, setName, char){
  const slots = ALL_SETS[setName] || [];
  const groupKey = getGroupKey(name);
  const isExceed = isExceedName(name);
  const setType = getSetType(setName);
  const exceedSlots = EXCEED_SLOTS[setType];

  let distinctParts = calcDistinctParts(char, groupKey);
  if(isExceed){
    exceedSlots.forEach(slot => {
      const val = char.armorCounts[`${name} ${slot}`] || 0;
      if(val <= 0) distinctParts = 0;
    });
  }

  const tr = document.createElement("tr");
  if(setType === "ARMOR"){
    if(distinctParts === slots.length) tr.className = "set5";
    else if(distinctParts >= 3) tr.className = "set3";
  } else {
    if(distinctParts === 3) tr.className = "set3";
  }

  let html = `<td>${name}</td>`;
  slots.forEach(slot => {
    let key = `${name} ${slot}`;
    const val = char.armorCounts[key] || 0;
    if(isExceed){
      if(exceedSlots.includes(slot)){
        html += `<td>${makeNumberButton(char.id, key, val)}</td>`;
      } else {
        html += `<td></td>`;
      }
    } else {
      html += `<td>${makeNumberButton(char.id, key, val)}</td>`;
    }
  });
  tr.innerHTML = html;
  return tr;
}

// ===== ì„¸íŠ¸ í‘œ ì—´ê¸° =====
function openSet(setName, char){
  currentSetName = setName;
  currentChar = char;

  const panel = document.getElementById("panel");
  panel.innerHTML = `<h2>[${setName} ì„¸íŠ¸]</h2>`;

  const slots = ALL_SETS[setName] || [];
  const table = document.createElement("table");
  table.innerHTML = `<thead>
    <tr><th>ì„¸íŠ¸ ì´ë¦„</th>${slots.map(s => `<th>${s}</th>`).join("")}</tr>
  </thead><tbody></tbody>`;
  const tbody = table.querySelector("tbody");

  tbody.appendChild(makeRow(setName, setName, char));
  const prefixes = ALL_PREFIX[setName] || [];
  prefixes.forEach(pref => {
    tbody.appendChild(makeRow(`${pref}: ${setName}`, setName, char));
  });
  prefixes.forEach(pref => {
    EXCEED_TAGS.forEach(ex => {
      tbody.appendChild(makeRow(`[${ex}] ${pref}: ${setName}`, setName, char));
    });
  });

  panel.appendChild(table);

  table.querySelectorAll("th:first-child, td:first-child").forEach(cell => {
    cell.style.width = globalSetNameWidth + "px";
  });
  table.querySelectorAll("th:not(:first-child), td:not(:first-child)").forEach(cell => {
    cell.style.width = globalSlotWidth + "px";
  });

  // âœ… ìš”ì•½ íŒ¨ë„ ì¶”ê°€
  showSetSlotSummary(setName);
}

// ===== ìºë¦­í„°ë³„ ìŠ¬ë¡¯ ìš”ì•½ =====
function showSetSlotSummary(setName){
  const summaryPanel = document.createElement("div");
  summaryPanel.innerHTML = `<h2>[${setName} ì„¸íŠ¸ ìºë¦­í„°ë³„ ìŠ¬ë¡¯ í˜„í™©]</h2>`;

  const slots = ALL_SETS[setName] || [];
  const table = document.createElement("table");
  table.innerHTML = `<thead>
    <tr><th>ìºë¦­í„°</th><th>ì§ì—…</th>${slots.map(s=>`<th>${s}</th>`).join("")}<th>ì„¸íŠ¸ ë‹¬ì„±</th></tr>
  </thead><tbody></tbody>`;
  const tbody = table.querySelector("tbody");

  const prefixes = ALL_PREFIX[setName] || [];
  const groups = [setName, ...prefixes.map(p => `${p}: ${setName}`)];
  const setType = getSetType(setName);

  characters.forEach(char => {
    let hasAny = false;
    let html = `<td>${char.name}</td><td>${char.job}</td>`;

    // ìŠ¬ë¡¯ë³„ í•©ê³„(ëª¨ë“  ê·¸ë£¹+ìµì‹œë“œ) í‘œì‹œ
    slots.forEach(slot => {
      let total = 0;
      groups.forEach(group => {
        total += char.armorCounts[`${group} ${slot}`] || 0;
        EXCEED_TAGS.forEach(tag=>{
          total += char.armorCounts[`[${tag}] ${group} ${slot}`] || 0;
        });
      });
      if(total > 0) hasAny = true;
      html += `<td>${total}</td>`;
    });

    if(!hasAny) return;

    // ë‹¬ì„± ì—¬ë¶€: ê·¸ë£¹ë³„ ê³ ìœ  íŒŒì¸  ìˆ˜ì˜ ìµœëŒ€ê°’ìœ¼ë¡œ íŒì •
    let maxDistinct = 0;
    groups.forEach(group=>{
      const distinct = calcDistinctParts(char, group);
      if(distinct > maxDistinct) maxDistinct = distinct;
    });

    let status = "-";
    if(setType === "ARMOR"){
      if(maxDistinct === slots.length) status = "5ì„¸íŠ¸ ë‹¬ì„±";
      else if(maxDistinct >= 3) status = "3ì„¸íŠ¸ ë‹¬ì„±";
    } else {
      // ì•…ì„¸/íŠ¹ì¥ì€ 3ë¶€ìœ„
      if(maxDistinct === 3) status = "3ì„¸íŠ¸ ë‹¬ì„±";
    }

    html += `<td>${status}</td>`;
    const tr = document.createElement("tr");
    // ì‹œê° ê°•ì¡° (ì„ íƒì‚¬í•­): ë‹¬ì„± ì •ë„ì— ë”°ë¼ í–‰ ë°°ê²½ ì ìš©
    if(setType === "ARMOR"){
      if(maxDistinct === slots.length) tr.className = "set5";
      else if(maxDistinct >= 3) tr.className = "set3";
    } else {
      if(maxDistinct === 3) tr.className = "set3";
    }

    tr.innerHTML = html;
    tbody.appendChild(tr);
  });

  summaryPanel.appendChild(table);
  document.getElementById("panel").appendChild(summaryPanel);
}




// ===== ìˆ«ì ë²„íŠ¼ =====
function makeNumberButton(charId, key, val){
  const extraClass = val > 0 ? " positive" : "";
  return `<button class="num-btn${extraClass}"
            onmousedown="startDecrement('${charId}','${key}')"
            onmouseup="stopDecrement()"
            onclick="increment('${charId}','${key}')">${val}</button>`;
}


// ===== ì¦ê°€/ê°ì†Œ =====
function increment(charId, key){
  const char = characters.find(c => c.id === charId);
  char.armorCounts[key] = (char.armorCounts[key] || 0) + 1;
  showSetButtons(char);
  if(currentSetName && currentChar){
    openSet(currentSetName, currentChar);  // âœ… ì €ì¥ëœ ê°’ìœ¼ë¡œ ë‹¤ì‹œ ì—´ê¸°
  }
}

function startDecrement(charId, key){
  decInterval = setInterval(() => {
    const char = characters.find(c => c.id === charId);
    const cur = char.armorCounts[key] || 0;
    char.armorCounts[key] = Math.max(0, cur - 1);
    showSetButtons(char);
    if(currentSetName && currentChar){
      openSet(currentSetName, currentChar); // âœ… ì €ì¥ëœ ê°’ìœ¼ë¡œ ë‹¤ì‹œ ì—´ê¸°
    }
  }, 500);
}

function stopDecrement(){
  clearInterval(decInterval);
  decInterval = null;
}

// ===== CSV ì €ì¥ =====
function exportCSV(){
  const headers = ["ì´ë¦„","ì§ì—…","ì¹´í…Œê³ ë¦¬","ì„¸íŠ¸ëª…","ìŠ¬ë¡¯","ì ‘ë‘ì–´","ë³´ìœ ê°œìˆ˜"];
  const rows = [headers];
  const CATS = [
    {cat:"ë°©ì–´êµ¬", sets:ARMOR_SETS, pref:ARMOR_PREFIX},
    {cat:"ì•…ì„¸",   sets:ACCESSORY_SETS, pref:ACCESSORY_PREFIX},
    {cat:"íŠ¹ì¥",   sets:SPECIAL_SETS, pref:SPECIAL_PREFIX}
  ];
  characters.forEach(char=>{
    CATS.forEach(({cat, sets, pref})=>{
      Object.keys(sets).forEach(setName=>{
        const slots = sets[setName];
        const pfxs = pref[setName] || [];
        const groups = [setName, ...pfxs.map(p=>`${p}: ${setName}`)];
        groups.forEach(group=>{
          slots.forEach(slot=>{
            const count = char.armorCounts[`${group} ${slot}`] || 0;
            rows.push([char.name, char.job, cat, setName, slot,
                       group.includes(": ")?group.split(": ")[0]:"", count]);
            const exceedNeeded =
              (cat==="ë°©ì–´êµ¬" && slot==="ìƒì˜") ||
              (cat==="ì•…ì„¸"   && slot==="íŒ”ì°Œ") ||
              (cat==="íŠ¹ì¥"   && slot==="ê·€ê±¸ì´");
            if (exceedNeeded && pfxs.length>0) {
              EXCEED_TAGS.forEach(tag=>{
                const exceedGroup = `[${tag}] ${group}`;
                const countEx = char.armorCounts[`${exceedGroup} ${slot}`] || 0;
                rows.push([
                  char.name,
                  char.job,
                  cat,
                  setName,
                  slot,
                  `${group.includes(": ")?group.split(": ")[0]:""} (ìµì‹œë“œ:${tag})`,
                  countEx
                ]);
              });
            }
          });
        });
      });
    });
  });
  const escape = v => String(v).replace(/"/g,'""');
  const csvContent = "\uFEFF" + rows.map(r=>r.map(escape).map(v=>`"${v}"`).join(",")).join("\n");
  const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = "sets_characters.csv";
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ===== CSV ì½ê¸° =====
document.getElementById("csvFile").addEventListener("change", function(e){
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(evt){
    const text = evt.target.result;
    displayCSV(text);
  };
  reader.readAsText(file, "utf-8");
});

function displayCSV(csvText){
  const lines = csvText.trim().split("\n");
  const headers = lines[0].split(",").map(h=>h.replace(/^"|"$/g,""));
  const data = lines.slice(1).map(line=>{
    const cells = line.split(",").map(c=>c.replace(/^"|"$/g,""));
    const obj = {};
    headers.forEach((h,i)=>obj[h]=cells[i]);
    return obj;
  });

  characters.length = 0;
  const grouped = {};
  data.forEach(row=>{
    const key = row["ì´ë¦„"]+"_"+row["ì§ì—…"];
    if(!grouped[key]){
      grouped[key] = {id:key, name:row["ì´ë¦„"], job:row["ì§ì—…"], armorCounts:{}};
      characters.push(grouped[key]);
    }
    const char = grouped[key];
    let groupName;
    if(row["ì ‘ë‘ì–´"] && row["ì ‘ë‘ì–´"].includes("(ìµì‹œë“œ:")){
      const basePrefix = row["ì ‘ë‘ì–´"].split(" ")[0];
      const tag = row["ì ‘ë‘ì–´"].match(/\(ìµì‹œë“œ:(.+)\)/)[1];
      groupName = `[${tag}] ${basePrefix}: ${row["ì„¸íŠ¸ëª…"]}`;
    } else if(row["ì ‘ë‘ì–´"]){
      groupName = `${row["ì ‘ë‘ì–´"]}: ${row["ì„¸íŠ¸ëª…"]}`;
    } else {
      groupName = row["ì„¸íŠ¸ëª…"];
    }
    const slot = row["ìŠ¬ë¡¯"];
    const fullKey = `${groupName} ${slot}`;
    char.armorCounts[fullKey] = parseInt(row["ë³´ìœ ê°œìˆ˜"],10);
  });

  renderCharacterList();
  document.getElementById("setList").innerHTML="";
  document.getElementById("panel").innerHTML="";
}
</script>

</body>
</html>
