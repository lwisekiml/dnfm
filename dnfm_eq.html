<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ìºë¦­í„° ì¥ë¹„ ê´€ë¦¬</title>
    <style>
        /* ========================================
   1. ê¸°ë³¸ ìŠ¤íƒ€ì¼ (Body, í—¤ë”©)
   ======================================== */
        body {
            font-family: sans-serif;
            background: #0f1222;
            color: #e6e9ff;
        }

        h1 {
            margin-bottom: 10px;
        }

        h2 {
            margin: 24px 0 8px;
        }

        /* ========================================
           2. ê³µí†µ ë²„íŠ¼ ìŠ¤íƒ€ì¼
           ======================================== */
        .action-btn, .file-label {
            min-width: 140px;
            text-align: center;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        .action-btn {
            background: linear-gradient(135deg, #25c2a0, #1a8c7d);
            border: none;
            color: #fff;
        }

        .action-btn:hover {
            background: linear-gradient(135deg, #1a8c7d, #25c2a0);
        }

        .file-label {
            background: #4a3f7a;
            color: #fff;
            border: none;
        }

        .file-label:hover {
            background: #5a4f8a;
        }

        .file-label input {
            display: none;
        }

        .add-btn {
            background: linear-gradient(135deg, #ffd700, #e6b800);
            border: none;
            color: #000;
            padding: 8px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        .add-btn:hover {
            background: linear-gradient(135deg, #e6b800, #ffd700);
        }

        /* ========================================
           3. íˆ´ë°” ì˜ì—­
           ======================================== */
        .toolbar {
            margin: 15px 0;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        /* ========================================
           4. í¼ (ì…ë ¥ì°½)
           ======================================== */
        .form-box {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }

        .form-box input {
            width: 20ch;
            padding: 6px;
            border-radius: 6px;
            border: 1px solid #2a3158;
            background: #181c33;
            color: #e6e9ff;
        }

        /* ========================================
           5. ìºë¦­í„° ê´€ë ¨ ìŠ¤íƒ€ì¼
           ======================================== */
        /* 5-1. ìºë¦­í„° ë˜í¼ (ë“œë˜ê·¸ ì•¤ ë“œë¡­) */
        .character-wrapper {
            display: inline-flex;
            align-items: center;
            margin: 5px;
            cursor: move;
            transition: all 0.2s ease;
        }

        .character-wrapper.dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .character-wrapper.drag-over {
            border-left: 3px solid #ffd700;
            padding-left: 5px;
        }

        /* 5-2. ë“œë˜ê·¸ í•¸ë“¤ */
        .drag-handle {
            cursor: grab;
            padding: 4px 8px;
            color: #888;
            font-size: 18px;
            user-select: none;
        }

        .drag-handle:hover {
            color: #ffd700;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        /* 5-3. ìºë¦­í„° ë²„íŠ¼ */
        .char-btn {
            margin: 5px;
            padding: 10px 16px;
            background: #2a3158;
            border: none;
            border-radius: 6px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .char-btn:hover {
            background: #3a4270;
        }

        .char-btn.active {
            border-color: #ffd700 !important;
            color: #ffd700 !important;
            background: rgba(255, 215, 0, 0.1) !important;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
            font-weight: bold;
        }

        /* 5-4. ì„¤ì • ë²„íŠ¼ */
        .settings-btn {
            background: #4a3f7a;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 14px;
            margin-left: 5px;
            transition: background 0.2s;
        }

        .settings-btn:hover {
            background: #6254a8;
        }

        /* 5-5. ì‚­ì œ ë²„íŠ¼ */
        .delete-btn {
            padding: 4px 8px;
            background: linear-gradient(135deg, #8c1a1a, #b22222);
            border: none;
            border-radius: 4px;
            color: #fff;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .delete-btn:hover {
            background: linear-gradient(135deg, #b22222, #8c1a1a);
            transform: scale(1.05);
        }

        /* ========================================
           6. ì„¸íŠ¸ ë²„íŠ¼ (ì¥ë¹„ ì„¸íŠ¸)
           ======================================== */
        .set-btn {
            margin: 5px;
            padding: 8px 14px;
            min-width: 180px;
            background: #181c33;
            border: 3px solid transparent;
            border-radius: 6px;
            color: #e6e9ff;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            text-align: center;
            white-space: nowrap;
        }

        .set-btn:hover {
            background: #2a3158;
            border-color: #3a4270;
        }

        .set-btn.selected {
            border: 3px solid #ffffff;
            box-shadow: 0 0 12px rgba(255, 255, 255, 0.7);
        }

        .set-btn.set3 {
            background-color: #25c2a0;
            color: #fff;
        }

        .set-btn.set5 {
            background-color: #ffd700;
            color: #000;
        }

        /* ì„¸íŠ¸ ë²„íŠ¼ ë‚´ ìˆ«ì ìƒ‰ìƒ */
        .set-btn .count-3 {
            color: #000000;
            font-weight: bold;
        }

        .set-btn .count-5 {
            color: #ff4d4f;
            font-weight: bold;
        }

        /* ========================================
           7. í…Œì´ë¸” (ì¥ë¹„ ëª©ë¡)
           ======================================== */
        table {
            border-collapse: collapse;
            margin-top: 6px;
            table-layout: fixed;
        }

        th, td {
            border: 1px solid #2a3158;
            padding: 6px;
            text-align: center;
            white-space: nowrap;
        }

        th {
            background: #181c33;
        }

        tr.set3 {
            background-color: rgba(37, 194, 160, 0.35);
        }

        tr.set5 {
            background-color: rgba(255, 215, 0, 0.45);
        }

        /* ========================================
           8. ìˆ«ì ë²„íŠ¼ (ì¥ë¹„ ê°œìˆ˜)
           ======================================== */
        .num-btn {
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #2a3158;
            background: #181c33;
            color: #e6e9ff;
            cursor: pointer;
        }

        .num-btn.positive {
            background: linear-gradient(135deg, #3399cc, #2a6f9e);
            color: #fff;
            font-weight: bold;
            border: 1px solid #3399cc;
        }

        /* ========================================
           9. íƒœê·¸ ìƒ‰ìƒ (ìµì‹œë“œ, ì ‘ë‘ì–´)
           ======================================== */
        .exceed-tag {
            color: #25c2a0;
            font-weight: bold;
        }

        .prefix-tag {
            color: #e6b800;
            font-weight: bold;
        }

        /* ========================================
           10. ëª¨ë‹¬ (íŒì—…ì°½)
           ======================================== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: #181c33;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            text-align: center;
            min-width: 300px;
        }

        .modal-content h3 {
            margin-top: 0;
            color: #ffd700;
        }

        .modal-options {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        /* ëª¨ë‹¬ ë²„íŠ¼ ê³µí†µ */
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        /* ëª¨ë‹¬ ë²„íŠ¼ ì¢…ë¥˜ë³„ */
        .modal-delete-btn {
            background: #b22222;
            color: #fff;
        }

        .modal-delete-btn:hover {
            background: #8c1a1a;
        }

        .modal-reset-btn {
            background: #3399cc;
            color: #fff;
        }

        .modal-reset-btn:hover {
            background: #2a6f9e;
        }

        .modal-cancel-btn {
            background: #4a3f7a;
            color: #fff;
        }

        .modal-cancel-btn:hover {
            background: #5a4f8a;
        }

        .modal-edit-btn {
            background: #25c2a0 !important;
            color: white;
        }

        /* ========================================
           11. í˜ì´ì§€ë„¤ì´ì…˜
           ======================================== */
        .pagination {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 10px 15px;
            border: 1px solid #2a3158;
            background: #181c33;
            color: #e6e9ff;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
            min-width: 40px;
        }

        .pagination button:hover {
            background: #2a3158;
            border-color: #3a4270;
        }

        .pagination button.active {
            background: #4a33cc;
            border-color: #ffd700;
            color: #ffd700;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.6);
            font-weight: bold;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ========================================
           12. ì œì‘ ì‹œìŠ¤í…œ
           ======================================== */
        .craft-input {
            background: #1b1e33;
            color: #e0e0e0;
            border: 1px solid #444a7a;
            border-radius: 4px;
            padding: 4px;
        }

        .craft-input:focus {
            outline: none;
            border-color: #6b5cff;
            background: #20244a;
        }

        /* ìˆ«ì ì…ë ¥ ì¦ê° ë²„íŠ¼ ì œê±° */
        .craft-input::-webkit-inner-spin-button,
        .craft-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .craft-lock-btn {
            background: #2a3158;
            color: #fff;
            border: 2px solid transparent;
            padding: 4px 10px;
            cursor: pointer;
            border-radius: 6px;
        }

        .craft-lock-btn.active {
            border: 2px solid #ffffff;
        }
    </style>
</head>
<body>

<h1>ìºë¦­í„° ì¥ë¹„ ê´€ë¦¬</h1>

<div class="toolbar" style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap; padding: 10px 0;">
    <button class="action-btn" style="background: linear-gradient(135deg, #6a5acd, #483d8b);" onclick="exportJSON()">
        ğŸ’ JSON ì €ì¥ (ë°±ì—…)
    </button>
    <button onclick="saveJsonWithLocation()" class="char-btn" style="background: #e67e22;">ğŸ“‚ JSON ê²½ë¡œ ì§€ì • ì €ì¥</button>
    <label class="file-label" style="background: #2c3e50; margin: 0; cursor: pointer;">
        ğŸ“¥ JSON ë¶ˆëŸ¬ì˜¤ê¸°
        <input type="file" id="jsonFile" accept=".json" onchange="importJSON(event)" style="display:none;">
    </label>

    <div style="width: 1px; height: 25px; background: #444; margin: 0 5px;"></div>

    <button id="tab-char" class="modal-btn"
            style="background: #4a33cc; color: #ffffff; border: 1px solid #fff; font-weight: bold;"
            onclick="switchTo('char')">ìºë¦­í„° ê´€ë¦¬
    </button>
    <button id="tab-weapon" class="modal-btn"
            style="background: #2a3158; color: #ffffff; border: 1px solid transparent;" onclick="switchTo('weapon')">ë¬´ê¸°
        ê´€ë¦¬
    </button>
    <button id="tab-equipment" class="modal-btn"
            style="background: #2a3158; color: #ffffff; border: 1px solid transparent;" onclick="switchTo('equipment')">
        ì¥ë¹„ ê´€ë¦¬
    </button>
    <button id="tab-craft" class="modal-btn"
            style="background: #2a3158; color: #ffffff; border: 1px solid transparent;"
            onclick="switchTo('craft')">
        ì œì‘
    </button>

</div>

<button class="action-btn" onclick="showRecentUpdates()">ğŸŒŸ ìµœê·¼ ì—…ë°ì´íŠ¸</button>

<div id="section-equipment-view" style="display:none; padding: 20px;">
    <div class="toolbar"
         style="margin-bottom: 20px; display: flex; flex-direction: column; gap: 10px; align-items: flex-start;">

        <div class="equipment-button-row"
             style="display: flex; flex-direction: row; flex-wrap: nowrap; gap: 8px; overflow-x: auto; width: 100%;">
            <button class="char-btn active" style="white-space: nowrap; min-width: 100px;"
                    onclick="renderEquipmentTab('ALL'); setActiveEquipmentButton(this)">ëª¨ë‘
            </button>
            <button class="char-btn" style="white-space: nowrap; min-width: 100px;"
                    onclick="renderEquipmentTab('NORMAL'); setActiveEquipmentButton(this)">ì¼ë°˜
            </button>
            <button class="char-btn" style="white-space: nowrap; min-width: 100px;"
                    onclick="renderEquipmentTab('PREFIX'); setActiveEquipmentButton(this)">ì ‘ë‘ì–´
            </button>
            <button class="char-btn" style="white-space: nowrap; min-width: 100px;"
                    onclick="renderEquipmentTab('EXCEED'); setActiveEquipmentButton(this)">ìµì‹œë“œ
            </button>
        </div>

        <div class="equipment-button-row"
             style="display: flex; flex-direction: row; flex-wrap: nowrap; gap: 8px; overflow-x: auto; width: 100%;">
            <button class="char-btn" style="white-space: nowrap; min-width: 100px; border-color: #ffd700;"
                    onclick="renderFullEquipmentTab('NORMAL'); setActiveEquipmentButton(this)">ì¼ë°˜ì¥ë¹„
            </button>
            <button class="char-btn" style="white-space: nowrap; min-width: 100px; border-color: #ffd700;"
                    onclick="renderFullEquipmentTab('PREFIX'); setActiveEquipmentButton(this)">ì ‘ë‘ì–´ì¥ë¹„
            </button>
            <button class="char-btn" style="white-space: nowrap; min-width: 100px; border-color: #ffd700;"
                    onclick="renderFullEquipmentTab('EXCEED'); setActiveEquipmentButton(this)">ìµì‹œë“œì¥ë¹„
            </button>
        </div>

        <!-- âœ… ì„¸ ë²ˆì§¸ ì¤„ë„ equipment-button-row í´ë˜ìŠ¤ ì¶”ê°€ -->
        <div class="equipment-button-row"
             style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
            <button class="char-btn" style="white-space: nowrap; min-width: 180px; border-color: #ffd700;"
                    onclick="toggleCharacterEquipmentView(); setActiveEquipmentButton(this)">ğŸ“‹ ìºë¦­í„°ë³„ ì¥ë¹„ ë³´ìœ  í˜„í™©
            </button>
            <button class="char-btn" style="white-space: nowrap; min-width: 100px; border-color: #ffd700;"
                    onclick="showEquipmentStatistics(); setActiveEquipmentButton(this)">ğŸ“Š í†µê³„
            </button>

            <!-- âœ… ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€ -->
            <div style="display: flex; gap: 5px; align-items: center;">
                <input type="text" id="equipment-search-input" placeholder="ì„¸íŠ¸ëª… ê²€ìƒ‰ (ì˜ˆ: ë§ê´„ëŸ‰ì´)"
                       style="padding: 8px 12px; border-radius: 6px; border: 1px solid #2a3158; background: #181c33; color: #e6e9ff; width: 200px;">
                <button class="char-btn" style="white-space: nowrap; min-width: 80px; background: #25c2a0;"
                        onclick="searchEquipment(); setActiveEquipmentButton(this)">ğŸ” ê²€ìƒ‰
                </button>
            </div>
        </div>
    </div>

    <div id="equipment-display-area"
         style="overflow-x: auto; background: #0f1222; padding: 15px; border-radius: 8px; border: 1px solid #2a3158;">
    </div>

    <!-- âœ… ìƒˆë¡œ ì¶”ê°€: ìºë¦­í„° ì„ íƒ ì˜ì—­ -->
    <div id="character-selection-area" style="display: none; margin-top: 20px;">
        <h3 style="color: #ffd700;">ìºë¦­í„° ì„ íƒ</h3>
        <div id="character-buttons-area" style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px;">
        </div>
    </div>

    <!-- âœ… ìƒˆë¡œ ì¶”ê°€: ìºë¦­í„° ì¥ë¹„ í˜„í™© í‘œì‹œ ì˜ì—­ -->
    <div id="character-equipment-detail" style="display: none; margin-top: 20px;">
    </div>
</div>


<div id="updateModal" class="modal-overlay">
    <div class="modal-content" style="width: 1200px; max-width: 90vw; max-height: 85vh; overflow-y: auto;">
        <h3>ğŸŒŸ ìµœê·¼ ì¥ë¹„ ì—…ë°ì´íŠ¸</h3>

        <div id="updateModalContent"></div>

        <div id="updatePagination" class="pagination"></div>

        <div class="modal-options" style="margin-top: 30px;">
            <button class="modal-btn modal-cancel-btn" onclick="closeUpdateModal()">ë‹«ê¸°</button>
        </div>
    </div>
</div>


<div id="section-character-view">
    <h2>[ìºë¦­í„°]</h2>
    <div class="form-box">
        <input type="text" id="newCharName" placeholder="ì´ë¦„ ì…ë ¥">
        <input type="text" id="newCharJob" placeholder="ì§ì—… ì…ë ¥">
        <button class="add-btn" onclick="addCharacter()">â• ì¶”ê°€</button>
        <!-- âœ… ìƒˆë¡œ ì¶”ê°€ -->
        <button id="edit-order-btn" class="add-btn" style="background: linear-gradient(135deg, #3399cc, #2a6f9e);"
                onclick="toggleEditMode()">âœï¸í¸ì§‘</button>
    </div>

    <!-- ğŸ’¡ ìˆœì„œ ì´ˆê¸°í™” ë²„íŠ¼ ì¶”ê°€ -->
    <div style="margin-bottom: 10px;">
        <button class="char-btn" style="background: #e67e22; font-size: 0.9em; font-weight: bold;"
                onclick="saveCurrentOrder()">
            ğŸ’¾ ìˆœì„œ ë“±ë¡
        </button>
        <button class="char-btn" style="background: #25c2a0; font-size: 0.9em;"
                onclick="resetToOriginalOrder()">
            ğŸ”„ ë“±ë¡ ìˆœì„œë¡œ ë³µì›
        </button>
        <button class="char-btn" style="background: #666; font-size: 0.9em;"
                onclick="sortCharactersByName()">
            ğŸ”¤ ì´ë¦„ìˆœ ì •ë ¬
        </button>
        <button class="char-btn" style="background: #666; font-size: 0.9em;"
                onclick="sortCharactersByJob()">
            ğŸ’¼ ì§ì—…ìˆœ ì •ë ¬
        </button>
    </div>

    <div id="characterList" class="char-grid"></div>
    <div id="characterDetail" class="detail-container" style="display:none;"></div>

    <div id="setList"></div>
    <div id="panel"></div>
</div>

<div id="section-weapon-view" style="display: none; padding-top: 0;">
    <h2>[ë¬´ê¸°]</h2>
    <div class="toolbar" id="weaponJobButtons">
        <button class="char-btn" onclick="selectWeaponJob('ê·€ê²€ì‚¬')">ê·€ê²€ì‚¬</button>
        <button class="char-btn" onclick="selectWeaponJob('ê²©íˆ¬ê°€')">ê²©íˆ¬ê°€</button>
        <button class="char-btn" onclick="selectWeaponJob('ê±°ë„ˆ')">ê±°ë„ˆ</button>
        <button class="char-btn" onclick="selectWeaponJob('ë§ˆë²•ì‚¬')">ë§ˆë²•ì‚¬</button>
        <button class="char-btn" onclick="selectWeaponJob('í”„ë¦¬ìŠ¤íŠ¸')">í”„ë¦¬ìŠ¤íŠ¸</button>
        <button class="char-btn" onclick="selectWeaponJob('ì›Œë¦¬ì–´')">ì›Œë¦¬ì–´</button>
        <button class="char-btn" onclick="selectWeaponJob('ë§ˆì°½ì‚¬')">ë§ˆì°½ì‚¬</button>
        <button class="char-btn" onclick="selectWeaponJob('ë„ì ')">ë„ì </button>
    </div>
    <div id="weaponPanel"></div>
</div>

<div id="section-craft-view" style="display:none; padding:20px;">
    <div style="display:flex; align-items:center; gap:10px;">
        <h2 style="margin:0;">[ì œì‘]</h2>

        <button id="craft-lock-btn"
                onclick="setCraftLock(true)"
                class="craft-lock-btn active">
            ì ê¸ˆ
        </button>

        <button id="craft-unlock-btn"
                onclick="setCraftLock(false)"
                class="craft-lock-btn">
            í•´ì œ
        </button>
    </div>
    <div id="craft-table-area"
         style="overflow-x:auto; background:#0f1222; padding:15px;
                border-radius:8px; border:1px solid #2a3158;">
    </div>
</div>


<script>
    /* ========================================
       1. ì „ì—­ ë³€ìˆ˜ & ìƒìˆ˜ ì„ ì–¸
       ======================================== */
    let activeCharacterId = null;
    let activeWeaponJob = null;
    let currentUpdatePage = 1;
    let allUpdatesData = [];
    const ITEMS_PER_PAGE = 10;
    const TOTAL_PAGES = 5;

    let currentActionCharId = null;

    // ===== ì „ì—­ ìƒíƒœ ë³€ìˆ˜ =====
    let currentSetName = null;
    let currentChar = null;
    let currentFilter = 'ALL'; // ğŸ’¡ í˜„ì¬ ì„ íƒëœ í•„í„° ('ALL', 'BASE', 'PREFIX', 'EXCEED')

    // ğŸ’¡ ë¬´ê¸° í…Œì´ë¸” í–‰ ê°•ì¡° í•¨ìˆ˜
    let highlightedRowId = null;

    // ğŸ’¡ ê°•ì¡° ìƒíƒœë¥¼ ê´€ë¦¬í•˜ê¸° ìœ„í•œ ì „ì—­ ë³€ìˆ˜ (ê¸°ì¡´ Setì—ì„œ ë‹¨ì¼ ë³€ìˆ˜ë¡œ ë³€ê²½)
    let highlightedColumnIndex = null;

    let craftLocked = true;

    // âœ… ì¶”ê°€: ìºë¦­í„° ìˆœì„œ í¸ì§‘ ëª¨ë“œ
    let isEditingCharacterOrder = false;

    // ì„¸íŠ¸ ì •ì˜
    const ARMOR_SETS = {
        "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "í¬ì´ì¦ˆë‹ í€¸ ìŠ¤íŒŒì´ë”": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ê±°ì¸ì˜ ìŠ¤í™ì¿¨ë£¸ ì•„ì´ì–¸": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ì–´ë‘ ì„ ì˜ì•„ ë‚´ë¦¬ëŠ” ì": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ìˆ˜í˜¸ìì˜ ì´ˆí•©ê¸ˆ": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ìŠ¤í‹±í‚¤ ì• ì‹œë“œ ì›¨í€": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ì„¬ëœ©í•œ ê°•ì²  ìš©": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ìµìŠ¤í”Œë¡œì‹œë¸Œ ë²„ë‹ ìŠ¤í†¤": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ë¹›ì˜ í—Œì‹ ì": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ì—¬ëª…ì„ ì˜ì•„ ì˜¬ë¦¬ëŠ” ì": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ì½°íŠ¸ë¡œ ì¹´ì‹œí…Œì›€": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ê·¸ë€í…Œ ì „íˆ¬ê¸°ê°‘ íŒŒì¸ ": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ë ˆê±°ì‹œ: ë§ˆë ¥ì˜ ì†Œìš©ëŒì´": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"],
        "ë ˆê±°ì‹œ: ìì—°ì˜ ìˆ˜í˜¸ì": ["ìƒì˜", "í•˜ì˜", "ì–´ê¹¨", "ë²¨íŠ¸", "ì‹ ë°œ"]
    };
    const ARMOR_PREFIX = {
        "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ": ["ì „ê²©", "í—ˆìƒ"],
        "í¬ì´ì¦ˆë‹ í€¸ ìŠ¤íŒŒì´ë”": ["ì‘ì—´", "ì¹¨ì‹"],
        "ê±°ì¸ì˜ ìŠ¤í™ì¿¨ë£¸ ì•„ì´ì–¸": ["ìˆ˜í˜¸", "ì™œê³¡"],
        "ì–´ë‘ ì„ ì˜ì•„ ë‚´ë¦¬ëŠ” ì": ["ììƒ", "ë§¹ë…"],
        "ìˆ˜í˜¸ìì˜ ì´ˆí•©ê¸ˆ": ["í—ˆìƒ", "ë³´í˜¸"],
        "ìŠ¤í‹±í‚¤ ì• ì‹œë“œ ì›¨í€": ["ë§¹ë…", "ì™œê³¡"],
        "ì„¬ëœ©í•œ ê°•ì²  ìš©": ["ì‡„ë„", "ì¹¨ì‹"],
        "ìµìŠ¤í”Œë¡œì‹œë¸Œ ë²„ë‹ ìŠ¤í†¤": ["ì‹ ì†", "ì—°ê²©"],
        "ë¹›ì˜ í—Œì‹ ì": ["ìˆ˜í˜¸", "ì—°ê²©"],
        "ì—¬ëª…ì„ ì˜ì•„ ì˜¬ë¦¬ëŠ” ì": ["ììƒ", "ì‡„ë„"],
        "ì½°íŠ¸ë¡œ ì¹´ì‹œí…Œì›€": ["ì‘ì—´", "ë³´í˜¸"],
        "ê·¸ë€í…Œ ì „íˆ¬ê¸°ê°‘ íŒŒì¸ ": ["ì‹ ì†", "ì „ê²©"],
        "ë ˆê±°ì‹œ: ë§ˆë ¥ì˜ ì†Œìš©ëŒì´": [],
        "ë ˆê±°ì‹œ: ìì—°ì˜ ìˆ˜í˜¸ì": []
    };
    const ARMOR_EXCEED_ONLY = ["ë ˆê±°ì‹œ: ë§ˆë ¥ì˜ ì†Œìš©ëŒì´", "ë ˆê±°ì‹œ: ìì—°ì˜ ìˆ˜í˜¸ì"];
    // const ACCESSORY_SETS = {
    //     "ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ": ["íŒ”ì°Œ", "ëª©ê±¸ì´", "ë°˜ì§€"],
    //     "ì„¬ëœ©í•œ ë¹›ì˜ ê´€ë¦¬ì": ["íŒ”ì°Œ", "ëª©ê±¸ì´", "ë°˜ì§€"],
    //     "ë¶€ì‹ëœ ë©”íƒˆê¸°ì–´": ["íŒ”ì°Œ", "ëª©ê±¸ì´", "ë°˜ì§€"],
    //     "í™”ë ¥ ê°œì¡° íƒ„ë ": ["íŒ”ì°Œ", "ëª©ê±¸ì´", "ë°˜ì§€"],
    //     "ì‹ ë¹„ë¡œìš´ ë¹›ì˜ ì†Œìš©ëŒì´": ["íŒ”ì°Œ", "ëª©ê±¸ì´", "ë°˜ì§€"],
    //     "ì½°íŠ¸ë¡œ ë§ˆëˆ„ìŠ¤ ì—°ì‚°ì¥ì¹˜": ["íŒ”ì°Œ", "ëª©ê±¸ì´", "ë°˜ì§€"],
    //     "ë ˆê±°ì‹œ: ì—í…Œë¦¬ì–¼ ë¦¬ë² ë„ŒíŠ¸": ["íŒ”ì°Œ", "ëª©ê±¸ì´", "ë°˜ì§€"],
    //     "ë ˆê±°ì‹œ: ì§€ë‚˜ì˜¨ ì˜ê´‘ì˜ ì‹œëŒ€": ["íŒ”ì°Œ", "ëª©ê±¸ì´", "ë°˜ì§€"]
    // };
    const ACCESSORY_SETS = {
        "ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ": ["ì„ ëª…í•œ ê¸°ì–µì˜ íŒ”ì°Œ<br>ë¬»íŒ ì‹œê°„ì˜ íŒ”ì°Œ", "íë¦¿í•œ ê³¼ê±°ì˜ ëª©ê±¸ì´", "ë®ì–´ë‘” ê¸°ì–µì˜ ë°˜ì§€"],
        "ì„¬ëœ©í•œ ë¹›ì˜ ê´€ë¦¬ì": ["ì´ì‹¬ì „ì‹¬<br>ë¬´ì–¸ì˜ ì—°ê²°", "ìˆ¨ê²¨ì§„ ë§¥ë½", "ê°ì¶°ì§„ ê²°"],
        "ë¶€ì‹ëœ ë©”íƒˆê¸°ì–´": ["ê¸°ê³„ì˜ ì‹¬ë°•<br>ê¸°ê³„ì˜ ë§¥ë°•", "ì‚¬ë¼ì§„ ë™ë ¥", "ì •ì§€ëœ íë¦„"],
        "í™”ë ¥ ê°œì¡° íƒ„ë ": ["ë©€í‹°í”Œ íˆ´ì¦ˆ<br>íŠ¸ë¦¬í”Œ íˆ´ì¦ˆ", "í”¼ì–´ì‹± ë“œë¦´ ë„¤í´ë ˆìŠ¤", "ì˜¤í† ë§¤í‹± ì‹¤ë¦°ë”"],
        "ì‹ ë¹„ë¡œìš´ ë¹›ì˜ ì†Œìš©ëŒì´": ["ì‹œë¦° ë‹¬ë¹›<br>í‘¸ë¥¸ ë‹¬ë¹›", "ì€ìƒ‰ì˜ ë³„ë¹›", "ë¶‰ì€ í–‡ë¹›"],
        "ì½°íŠ¸ë¡œ ë§ˆëˆ„ìŠ¤ ì—°ì‚°ì¥ì¹˜": ["ê¸°ê³„ì˜ ì£¼ì‹œ<br>ê¸°ê³„ì˜ ì‹œì„ ", "ì—ë„ˆì§€ì˜ ëˆˆ", "ì‘ì‹œì˜ í”ì "],
        "ë ˆê±°ì‹œ: ì—í…Œë¦¬ì–¼ ë¦¬ë² ë„ŒíŠ¸": ["ë ˆê±°ì‹œ: ì•„ì´ì–¸ ì— ë²¨ë¦¬ì‹œë“œ ë°´ë“œ<br>ë ˆê±°ì‹œ: ê°•ì²  ë¦¬ìŠ¤íŠ¸ ê°€ë“œ", "ë ˆê±°ì‹œ: ì˜í˜¼ ì¶”ì ì¥ì¹˜", "ë ˆê±°ì‹œ: í• ê¸°ì˜ ë³¸ë§"],
        "ë ˆê±°ì‹œ: ì§€ë‚˜ì˜¨ ì˜ê´‘ì˜ ì‹œëŒ€": ["ë ˆê±°ì‹œ: ì„¸ì´íŠ¸ ë£¨ë©˜ì•„ì´íŠ¸ ë ë¦­<br>ë ˆê±°ì‹œ: í™€ë¦¬ ë¯¸ìŠ¤ë¦´ ë ë¦­", "ë ˆê±°ì‹œ: í  ë¡œìŠ¤ ê¸€ë¡œë¦¬", "ë ˆê±°ì‹œ: ì—ì´ì…˜íŠ¸ ì—˜ë¸ ë§"]
    };
    const ACCESSORY_PREFIX = {
        "ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ": ["ê²¬ê³ ", "í˜ˆë…"],
        "ì„¬ëœ©í•œ ë¹›ì˜ ê´€ë¦¬ì": ["ì´ˆì„", "ê°ì˜¤"],
        "ë¶€ì‹ëœ ë©”íƒˆê¸°ì–´": ["ê°ì˜¤", "ê°€ì†"],
        "í™”ë ¥ ê°œì¡° íƒ„ë ": ["í˜ˆë…", "ê²¬ê³ "],
        "ì‹ ë¹„ë¡œìš´ ë¹›ì˜ ì†Œìš©ëŒì´": ["ì¡°í™”", "ì´ˆì„"],
        "ì½°íŠ¸ë¡œ ë§ˆëˆ„ìŠ¤ ì—°ì‚°ì¥ì¹˜": ["ê°€ì†", "ì¡°í™”"],
        "ë ˆê±°ì‹œ: ì—í…Œë¦¬ì–¼ ë¦¬ë² ë„ŒíŠ¸": [],
        "ë ˆê±°ì‹œ: ì§€ë‚˜ì˜¨ ì˜ê´‘ì˜ ì‹œëŒ€": []
    };
    const ACCESSORY_EXCEED_ONLY = ["ë ˆê±°ì‹œ: ì—í…Œë¦¬ì–¼ ë¦¬ë² ë„ŒíŠ¸", "ë ˆê±°ì‹œ: ì§€ë‚˜ì˜¨ ì˜ê´‘ì˜ ì‹œëŒ€"];
    // const SPECIAL_SETS = {
    //     "ê°œêµ¬ìŸì´ í˜¸ë¬¸ì¿¨ë£¨ìŠ¤": ["ê·€ê±¸ì´", "ë§ˆë²•ì„", "ë³´ì¥"],
    //     "ë¼ì´íŠ¸ë‹ ì—ë„ˆì§€ ì½”ì–´": ["ê·€ê±¸ì´", "ë§ˆë²•ì„", "ë³´ì¥"],
    //     "ì² ê°‘ì„ ë‘ë¥¸ íƒ‘ì˜ ìˆ˜í˜¸ê¾¼": ["ê·€ê±¸ì´", "ë§ˆë²•ì„", "ë³´ì¥"],
    //     "ê¹Šì€ ë¶ˆêµ¬ë©ì´ì˜ ì„¬ë©¸ì": ["ê·€ê±¸ì´", "ë§ˆë²•ì„", "ë³´ì¥"],
    //     "í—ˆì˜ ì† ì–´ë‘ ì˜ í”¼ì¡°ë¬¼": ["ê·€ê±¸ì´", "ë§ˆë²•ì„", "ë³´ì¥"],
    //     "ë¶€ì •í•œ ë¹›ì˜ ìš°ìƒ": ["ê·€ê±¸ì´", "ë§ˆë²•ì„", "ë³´ì¥"]
    // };
    const SPECIAL_SETS = {
        "ê°œêµ¬ìŸì´ í˜¸ë¬¸ì¿¨ë£¨ìŠ¤": ["ë§ê´„ëŸ‰ì´ì˜ ë¬¸ì–‘ ê·€ê±¸ì´<br>ë² í‚¤ì˜ ë¬¸ì–‘ ê·€ê±¸ì´", "ë² í‚¤ì˜ ìƒˆì´", "ë² í‚¤ì˜ ì¥ê°‘"],
        "ë¼ì´íŠ¸ë‹ ì—ë„ˆì§€ ì½”ì–´": ["ê±°ì‹ ì˜ ìŠ¤í™ì¿¨ë£¸ ì´ì–´ë§<br>ê±°ì¸ì˜ ìŠ¤í™ì¿¨ë£¸ ì´ì–´ë§", "ê±°ì¸ì˜ ìŠ¤í™ì¿¨ë£¸ ì½”ì–´", "ê±°ì¸ì˜ ê±´ë“¤ë¦¿"],
        "ì² ê°‘ì„ ë‘ë¥¸ íƒ‘ì˜ ìˆ˜í˜¸ê¾¼": ["ë©”íƒˆê¸°ì–´ì˜ ì´ˆí•©ê¸ˆ íƒœì—½<br>ë©”íƒˆê¸°ì–´ì˜ íƒœì—½ ê·€ê±¸ì´", "ë©”íƒˆê¸°ì–´ì˜ ë‘ë‡Œ", "ë©”íƒˆê¸°ì–´ì˜ ì¡°ì‘ë¶€"],
        "ê¹Šì€ ë¶ˆêµ¬ë©ì´ì˜ ì„¬ë©¸ì": ["ê°•ì²  ìš©ì˜ ê¸°ê´€ì´ ì´ì–´ë§<br>ê°•ì²  ìš©ì˜ ê¸°ì´ ì´ì–´ë§", "ê°•ì²  ìš©ì˜ ì²œê³µê¸°", "ê°•ì²  ìš©ì˜ ì¹¼ë‚  ì™¸ê³¨ê²©"],
        "í—ˆì˜ ì† ì–´ë‘ ì˜ í”¼ì¡°ë¬¼": ["ê³¨ë“œ í¬ë¼ìš´ì˜ ì„œì»¤ìŠ¤ ì¥ì‹<br>ê³¨ë“œ í¬ë¼ìš´ì˜ ë¨¸ë¦¬ ì¥ì‹", "ê³¨ë“œ í¬ë¼ìš´ì˜ í•µì‹¬ ë¶€í’ˆ", "ê³¨ë“œ í¬ë¼ìš´ì˜ ì—ë„ˆì§€ ë°©ì¶œê¸°"],
        "ë¶€ì •í•œ ë¹›ì˜ ìš°ìƒ": ["ì½°íŠ¸ë¡œ ë§ˆëˆ„ìŠ¤ì˜ ê¸°ì–µ<br>ì½°íŠ¸ë¡œ ë§ˆëˆ„ìŠ¤ì˜ íƒœì—½ ì¥ì‹", "ì½°íŠ¸ë¡œ ë§ˆëˆ„ìŠ¤ì˜ ë‘ë‡Œ", "ì½°íŠ¸ë¡œ ë§ˆëˆ„ìŠ¤ì˜ ì—ë„ˆì§€ ì½”ì–´"]
    };
    const SPECIAL_PREFIX = {
        "ê°œêµ¬ìŸì´ í˜¸ë¬¸ì¿¨ë£¨ìŠ¤": ["ë¶ˆêµ´", "ìˆ™ë ¨"],
        "ë¼ì´íŠ¸ë‹ ì—ë„ˆì§€ ì½”ì–´": ["ìˆ™ë ¨", "ê²°ì˜"],
        "ì² ê°‘ì„ ë‘ë¥¸ íƒ‘ì˜ ìˆ˜í˜¸ê¾¼": ["ê²©ë³€", "ì´‰ì§„"],
        "ê¹Šì€ ë¶ˆêµ¬ë©ì´ì˜ ì„¬ë©¸ì": ["ë¶ˆêµ´", "ì´‰ì§„"],
        "í—ˆì˜ ì† ì–´ë‘ ì˜ í”¼ì¡°ë¬¼": ["ì§ˆì£¼", "ê²°ì˜"],
        "ë¶€ì •í•œ ë¹›ì˜ ìš°ìƒ": ["ì§ˆì£¼", "ê²©ë³€"]
    };
    const ALL_SETS = {...ARMOR_SETS, ...ACCESSORY_SETS, ...SPECIAL_SETS};
    const ALL_PREFIX = {...ARMOR_PREFIX, ...ACCESSORY_PREFIX, ...SPECIAL_PREFIX};
    const EXCEED_TAGS = ["ì„ ë´‰", "ì˜ì§€", "ì´ìƒ"];
    const EXCEED_SLOTS = {"ARMOR": ["ìƒì˜"], "ACCESSORY": ["íŒ”ì°Œ"], "SPECIAL": ["ê·€ê±¸ì´"]};
    const EXCEED_COLOR_MAP = {
        "ì„ ë´‰": "#ff4d4d",
        "ì˜ì§€": "#4d94ff",
        "ì´ìƒ": "#2ecc71"
    };

    // ì•…ì„¸ ì¶”ê°€ ì •ë³´
    const ACCESSORY_EXTRA_INFO = {
        "ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ": "ì„ ëª…í•œ,ë¬»íŒ / íë¦¿í•œ / ë®ì–´ë‘”",
        "ì„¬ëœ©í•œ ë¹›ì˜ ê´€ë¦¬ì": "ì´ì‹¬ì „ì‹¬,ë¬´ì–¸ / ìˆ¨ê²¨ì§„ / ê°ì¶°ì§„",
        "ë¶€ì‹ëœ ë©”íƒˆê¸°ì–´": "ê¸°ê³„ì˜ ì‹¬ë°•,ë§¥ë°• / ì‚¬ë¼ì§„ / ì •ì§€",
        "í™”ë ¥ ê°œì¡° íƒ„ë ": "ë©€í‹°í”Œ,íŠ¸ë¦¬í”Œ / í”¼ì–´ì‹± / ì˜¤í† ë§¤í‹±",
        "ì‹ ë¹„ë¡œìš´ ë¹›ì˜ ì†Œìš©ëŒì´": "ì‹œë¦°,í‘¸ë¥¸ / ì€ìƒ‰ / ë¶‰ì€",
        "ì½°íŠ¸ë¡œ ë§ˆëˆ„ìŠ¤ ì—°ì‚°ì¥ì¹˜": "ê¸°ê³„ì˜ ì£¼ì‹œ,ì‹œì„  / ì—ë„ˆì§€ / ì‘ì‹œ",
        "ë ˆê±°ì‹œ: ì—í…Œë¦¬ì–¼ ë¦¬ë² ë„ŒíŠ¸": "ì•„ì´ì–¸,ê°•ì²  / ì˜í˜¼ / í• ê¸°",
        "ë ˆê±°ì‹œ: ì§€ë‚˜ì˜¨ ì˜ê´‘ì˜ ì‹œëŒ€": "ì„¸ì´íŠ¸,í™€ë¦¬ / í  / ì—ì´ì…˜íŠ¸"
    };

    // íŠ¹ì¥ ì¶”ê°€ ì •ë³´
    const SPECIAL_EXTRA_INFO = {
        "ê°œêµ¬ìŸì´ í˜¸ë¬¸ì¿¨ë£¨ìŠ¤": "ë§ê´„ëŸ‰ì´,ë² í‚¤",
        "ë¼ì´íŠ¸ë‹ ì—ë„ˆì§€ ì½”ì–´": "ê±°ì‹ ,ê±°ì¸",
        "ì² ê°‘ì„ ë‘ë¥¸ íƒ‘ì˜ ìˆ˜í˜¸ê¾¼": "ë©”íƒˆê¸°ì–´",
        "ê¹Šì€ ë¶ˆêµ¬ë©ì´ì˜ ì„¬ë©¸ì": "ê°•ì² ",
        "í—ˆì˜ ì† ì–´ë‘ ì˜ í”¼ì¡°ë¬¼": "ê³¨ë“œ",
        "ë¶€ì •í•œ ë¹›ì˜ ìš°ìƒ": "ì½°íŠ¸ë¡œ"
    };


    // ë¬´ê¸° ë°ì´í„°
    const WEAPON_DATA_SLAYER = {
        "ì†Œê²€": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ì†Œê²€", "ì•”í‘ì˜ ë³„", "ì™•ìœ„ ê³„ìŠ¹ì"],
        "ë„": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë„", "ìš”ë„ : ë¬´ë¼ë§ˆì‚¬", "íŠ¸ë¦¬ë‹ˆí‹° ì´í„°ë‹ˆì•„"],
        "ë‘”ê¸°": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë‘”ê¸°", "ì„¸ê³„ì˜ ë¬´ê²Œì¶”", "ì‹ ê²€ì˜ ë‚˜ë­‡ê°€ì§€"],
        "ëŒ€ê²€": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ëŒ€ê²€", "ì„±ê²€ : ì—‘ìŠ¤ì¹¼ë¦¬ë²„", "ë°ë¹Œ ì˜¤ë¸Œ í”Œë ˆì–´"],
        "ê´‘ê²€": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ê´‘ê²€", "ì•„ë§ˆ ê²Ÿ ëˆ", "ë‡Œê²€ : ê³ ë£¬"]
    };
    const WEAPON_DATA_FIGHTER = {
        "ë„ˆí´": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë„ˆí´", "ë¼ì˜¤ ë°ì†”", "ë² ë¥´ì„¸ë¥´í¬"],
        "ê±´í‹€ë¦¿": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ê±´í‹€ë¦¿", "ë°˜ê²©ì˜ ì„œë§‰", "ë£°ë ›ëŸ¬ì‹œì•ˆ"],
        "í´ë¡œ": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - í´ë¡œ", "í‘ì›”ë‘ì•„", "ì•…ë§ˆì˜ ê°ˆí€´ : ì´ê·¸ë…¸ì–´"],
        "ê¶Œíˆ¬ê¸€ëŸ¬ë¸Œ": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ê¶Œíˆ¬ê¸€ëŸ¬ë¸Œ", "í‹°ì¥¬ ì— í”Œë¦¬íŒŒì´ì–´", "íŒŒìš¸ í‚¤ë“œë‹ˆë¸”ë¡œ"],
        "í†µíŒŒ": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - í†µíŒŒ", "í‚¬ ì•„ë¥´ë‹ˆìŠ¤ ë µê³¡", "ìŠµê²©ì˜ ë“œë¼ìš°í”„ë‹ˆë¥´"]
    };
    const WEAPON_DATA_GUNNER = {
        "ë¦¬ë³¼ë²„": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë¦¬ë³¼ë²„", "ì´ìŠ¤ ë¯¸ í„°ë„ˆ", "ì‹¤ë²„ ë¶ˆë ›"],
        "ìë™ê¶Œì´": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ìë™ê¶Œì´", "ì´ì˜¨ ë¦¬í•„ì„œ", "ë§ˆì´ìŠ¤í„°ì˜ ë¶„ë…¸"],
        "ë¨¸ìŠ¤ì¼“": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë¨¸ìŠ¤ì¼“", "Code N : ì˜¤ë¼í´", "ë¸”ë¼ì¸ë“œ ìŠ¤íŒŸ"],
        "í•¸ë“œìºë„Œ": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - í•¸ë“œìºë„Œ", "ê±°í¬ ìš°ë¥´ë°˜", "í•´ë¥¼ ë¨¹ëŠ” ì"],
        "ë³´ìš°ê±´": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë³´ìš°ê±´", "ë°ìŠ¤ ë¦¬ë·°ì €", "ì œë„ˆëŸ´ ë³´ìš°ê±´"]
    };
    const WEAPON_DATA_MAGE = {
        "ì°½": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ì°½", "ì¥¬ë¹ŒëŸ°ìŠ¤ í˜¼", "ì „ì¥ì˜ ì—¬ì‹ ì˜ ì°½"],
        "ë´‰": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë´‰", "ì¼€ì„¸ë¼ì„¸ë¼ : í•´í”¼ ~!", "ìš”ì •ì™•ì˜ ë¹„ë°€"],
        "ë¡œë“œ": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë¡œë“œ", "íˆì–´ë¡œ ì˜¤ë¸Œ ë” ë¬¸", "ì–‘ì¹˜ê¸°ì˜ ë¡œë“œ"],
        "ìŠ¤íƒœí”„": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ìŠ¤íƒœí”„", "ì›¨ë¦¬ : ë¦¬ë¯¸íŠ¸ ë¸Œë ˆì´ì»¤", "ì°½ë§ˆí™”ì˜ ì—°"],
        "ë¹—ìë£¨": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë¹—ìë£¨", "ë³´ë°° - íŒŒì´ˆì„ ", "ìŠ¤ë…¸ìš° í”„ë¦°ì„¸ìŠ¤"]
    };
    const WEAPON_DATA_PRIEST = {
        "ì‹­ìê°€": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ì‹­ìê°€", "í—¤ì´ë  - êµë§Œì˜ ë¹›", "ì €ì£¼ ë°›ì€ ì‹­ìê°€ : í† ë£¨ì•„"],
        "ì—¼ì£¼": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ì—¼ì£¼", "ìŒì–‘ì‚¬ì²œ", "ëª…ì¸ì˜ ìˆ˜"],
        "í† í…œ": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - í† í…œ", "ì”° ë” ë¦¬ë°”ì´ì–´ë˜", "í’ìš´ë‡Œìš°"],
        "ë‚«": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë‚«", "ì†Œìš¸ ë””ë°”ìš°ë§", "ì„ ê³  : ì‚¬ì‹ ì˜ ë‚«"],
        "ë°°í‹€ì—‘ìŠ¤": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë°°í‹€ì—‘ìŠ¤", "í–‰ì„±íŒŒê´´ì", "ì˜¤ë§Œì˜ ë"]
    };
    const WEAPON_DATA_WARRIOR = {
        "ë½ì†Œë“œ": [
            "ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë½ì†Œë“œ",
            "ìš°ì£¼ì  ê¸°ìš´ì˜ ë½ì†Œë“œ",
            "ë¼ì´í”„ íŒŒì¸ë”"
        ],
        "ìœ™ë¸”ë ˆì´ë“œ": [
            "ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ìœ™ë¸”ë ˆì´ë“œ",
            "í”„ë¡œìŠ¤íŠ¸ ìœ™ ë¸”ë ˆì´ë“œ",
            "ì½”ì¹´íŠ¸ë¦¬ìŠ¤"
        ]
    };
    const WEAPON_DATA_LANCER = {
        "ë¯¸ëŠ˜ì°½": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë¯¸ëŠ˜ì°½", "í¬ë¦¼ìŠ¨ ë¡œë“œ", "ê´‘ì—¼ì˜ ê·¹"],
        "íˆ¬ì°½": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - íˆ¬ì°½", "í—¬ ì˜¤ë¸Œ ë°ë¹Œë¡œë“œ", "ë¯¸ë¼í´ ëŸ°ì¹˜"]
    };
    const WEAPON_DATA_THIEF = {
        "ë‹¨ê²€": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ë‹¨ê²€", "ì‹¤ë²„ ìŠ¤í”¼ë¦¿", "ì›”ê´‘ê²€"],
        "ìŒê²€": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ìŒê²€", "í‘ë¯¸ìŒê²€", "íˆê²Œ-íˆìí‚¤ë¦¬"],
        "ì°¨í¬ë¼ì›¨í€": ["ëŒ€ì„œì‚¬ì˜ íƒ„ìƒ - ì°¨í¬ë¼ì›¨í€", "í¬ë¦¬ë“œ ì˜¤ë¸Œ ë‹Œì", "ë¬´ì—¼í™”"]
    };
    const WEAPON_PREFIXES = [
        {tag: "[ê´‘ì±„]", color: "#3399cc"}, // íŒŒë€ìƒ‰
        {tag: "[ë¶„ì‡„]", color: "#ff4d4f"}, // ë¹¨ê°„ìƒ‰
        {tag: "[ì„ ëª…]", color: "#25c2a0"}, // ì´ˆë¡ìƒ‰
        {tag: "[ê°•íƒ€]", color: "#ffd700"}  // ë…¸ë€ìƒ‰
    ];
    const WEAPON_DATA_MAP = {
        'ê·€ê²€ì‚¬': WEAPON_DATA_SLAYER,
        'ê²©íˆ¬ê°€': WEAPON_DATA_FIGHTER,
        'ê±°ë„ˆ': WEAPON_DATA_GUNNER,
        'ë§ˆë²•ì‚¬': WEAPON_DATA_MAGE,
        'í”„ë¦¬ìŠ¤íŠ¸': WEAPON_DATA_PRIEST,
        'ì›Œë¦¬ì–´': WEAPON_DATA_WARRIOR,
        'ë§ˆì°½ì‚¬': WEAPON_DATA_LANCER,
        'ë„ì ': WEAPON_DATA_THIEF
    };
    const JOB_LIST = Object.keys(WEAPON_DATA_MAP);

    // ìºë¦­í„° ë°°ì—´
    let characters = [
        {
            id: "c1", job: "ê²€ê·€", name: "ê°•ì˜", armorCounts: {
                "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ ìƒì˜": 1,
                "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ í•˜ì˜": 1,
                "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ ì–´ê¹¨": 1,
                "ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ íŒ”ì°Œ": 1,
                "[ì˜ì§€] ê²¬ê³ : ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ íŒ”ì°Œ": 1,
                "ê°œêµ¬ìŸì´ í˜¸ë¬¸ì¿¨ë£¨ìŠ¤ ê·€ê±¸ì´": 1
            }, updateTimes: { // ğŸ’¡ ì¶”ê°€ëœ í•„ë“œ: ì•„ì´í…œë³„ ì—…ë°ì´íŠ¸ ì‹œê°„ ì €ì¥
                "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ ìƒì˜": Date.now() - 50000,
                "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ í•˜ì˜": Date.now() - 40000,
                "ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ ì–´ê¹¨": Date.now() - 30000,
                "ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ íŒ”ì°Œ": Date.now() - 20000,
                "[ì˜ì§€] ê²¬ê³ : ì—˜íŒ… ë©”ëª¨ë¦¬ì–¼ì˜ ê¸°ì–µ íŒ”ì°Œ": Date.now() - 10000,
                "ê°œêµ¬ìŸì´ í˜¸ë¬¸ì¿¨ë£¨ìŠ¤ ê·€ê±¸ì´": Date.now()
            }
        }
    ];

    // ì „ì—­ ìµœëŒ€ ê¸¸ì´
    let globalSetNameWidth = 200;
    let globalSlotWidth = 100;


    /* ========================================
        2. ë°ì´í„° ê´€ë¦¬ (ë¡œì»¬ ìŠ¤í† ë¦¬ì§€)
       ======================================== */
    // ë°ì´í„° ì €ì¥ ì‹œ
    /*
        [
          {
            "id": "c1234567890",
            "name": "ê°•ì˜",
            "job": "ê²€ê·€",
            "armorCounts": {...},
            "updateTimes": {...},
            "createdOrder": 0
          },
          {
            "id": "c1234567891",
            "name": "ì² ìˆ˜",
            "job": "ê²©íˆ¬ê°€",
            "createdOrder": 1
          }
        ]
     */
    function saveLocalData() {
        localStorage.setItem("dnfm_eq", JSON.stringify(characters));
    }

    // ë°ì´í„° ë¡œë“œ ì‹œ (ì´ˆê¸°í™” ë¡œì§ í¬í•¨)
    function loadLocalData() {
        const saved = localStorage.getItem("dnfm_eq");
        if (saved) {
            try {
                characters = JSON.parse(saved);
            } catch (e) {
                console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", e);
                characters = [];
            }
        }
    }

    /* ========================================
       3. ì´ˆê¸° ê³„ì‚° í•¨ìˆ˜
       ======================================== */
    function calculateGlobalWidths() {
        const allNames = [], allSlots = [];
        [{sets: ARMOR_SETS, pref: ARMOR_PREFIX},
            {sets: ACCESSORY_SETS, pref: ACCESSORY_PREFIX},
            {sets: SPECIAL_SETS, pref: SPECIAL_PREFIX}].forEach(({sets, pref}) => {
            Object.keys(sets).forEach(setName => {
                allNames.push(setName);
                const prefixes = pref[setName] || [];
                prefixes.forEach(p => {
                    allNames.push(`${p}: ${setName}`);
                    EXCEED_TAGS.forEach(ex => allNames.push(`[${ex}] ${p}: ${setName}`));
                });
                sets[setName].forEach(slot => allSlots.push(slot));
            });
        });
        globalSetNameWidth = Math.max(...allNames.map(n => n.length)) * 12;
        globalSlotWidth = Math.max(...allSlots.map(s => s.length)) * 12;
    }

    /* ========================================
       4. ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
       ======================================== */
    function isExceedName(name) {
        return /^\[(ì„ ë´‰|ì˜ì§€|ì´ìƒ)\]\s/.test(name);
    }

    function getGroupKey(name) {
        return name.replace(/^\[.*?\]\s*/, "");
    }

    function getSetType(setName) {
        if (ARMOR_SETS[setName]) return "ARMOR";
        if (ACCESSORY_SETS[setName]) return "ACCESSORY";
        if (SPECIAL_SETS[setName]) return "SPECIAL";

        // ì ‘ë‘ì–´ë‚˜ ìµì‹œë“œê°€ ë¶™ì€ ì´ë¦„ì—ì„œ ê¸°ë³¸ ì„¸íŠ¸ëª…ì„ ì¶”ì¶œí•˜ì—¬ íŒë³„
        const baseName = setName.includes(':') ? setName.split(':').pop().trim() : setName;
        if (ARMOR_SETS[baseName]) return "ARMOR";
        if (ACCESSORY_SETS[baseName]) return "ACCESSORY";
        if (SPECIAL_SETS[baseName]) return "SPECIAL";

        return "ARMOR"; // ê¸°ë³¸ê°’
    }

    function calcTotalDistinctParts(char, baseSetName) {
        const slots = ALL_SETS[baseSetName] || [];
        const prefixes = ALL_PREFIX[baseSetName] || [];
        const setType = getSetType(baseSetName);
        const exceedSlots = EXCEED_SLOTS[setType] || [];

        // ê²€ìƒ‰í•  ëª¨ë“  ê·¸ë£¹ ì´ë¦„ (ê¸°ë³¸, ì ‘ë‘ì–´, ìµì‹œë“œ) ìƒì„±
        const namesToSearch = [baseSetName];

        if (prefixes.length > 0) {
            // ì ‘ë‘ì–´ê°€ ìˆëŠ” ê²½ìš°: ê¸°ì¡´ ë¡œì§
            prefixes.forEach(pref => {
                const prefixedName = `${pref}: ${baseSetName}`;
                namesToSearch.push(prefixedName);
                EXCEED_TAGS.forEach(tag => {
                    namesToSearch.push(`[${tag}] ${prefixedName}`);
                });
            });
        } else {
            // ğŸ’¡ ì‹ ê·œ ì¶”ê°€: ì ‘ë‘ì–´ê°€ ì—†ëŠ” ê²½ìš° (ë ˆê±°ì‹œ ì¥ë¹„)
            const isExceedOnlyArmor = (typeof ARMOR_EXCEED_ONLY !== 'undefined' && ARMOR_EXCEED_ONLY.includes(baseSetName));
            const isExceedOnlyAccessory = (typeof ACCESSORY_EXCEED_ONLY !== 'undefined' && ACCESSORY_EXCEED_ONLY.includes(baseSetName));

            if (isExceedOnlyArmor || isExceedOnlyAccessory) {
                EXCEED_TAGS.forEach(tag => {
                    namesToSearch.push(`[${tag}] ${baseSetName}`);
                });
            }
        }

        let totalDistinct = 0;

        slots.forEach(slot => {
            let hasPartInSlot = false;
            const slotSuffix = ` ${slot}`;

            namesToSearch.forEach(nameComponent => {
                const isExceedKey = nameComponent.startsWith('[');

                // ìµì‹œë“œ í‚¤ëŠ” íŠ¹ì • ìŠ¬ë¡¯ì—ë§Œ ì¡´ì¬í•˜ë¯€ë¡œ, ì•„ë‹Œ ê²½ìš°ëŠ” ê±´ë„ˆëœë‹ˆë‹¤.
                if (isExceedKey && !exceedSlots.includes(slot)) {
                    return;
                }

                const fullKey = `${nameComponent}${slotSuffix}`;
                if ((char.armorCounts[fullKey] || 0) > 0) {
                    hasPartInSlot = true;
                }
            });

            if (hasPartInSlot) {
                totalDistinct++;
            }
        });

        return totalDistinct;
    }

    // ===== í•„í„°ë³„ ìŠ¬ë¡¯ ê°œìˆ˜ ê³„ì‚° =====
    function calculateSlotCountByFilter(char, setName, slot, filter) {
        const prefixes = ALL_PREFIX[setName] || [];

        let total = 0;

        // ê²€ìƒ‰ ëŒ€ìƒ ê·¸ë£¹ ëª©ë¡ ì •ì˜
        const baseGroup = setName;
        const prefixedGroups = prefixes.map(p => `${p}: ${setName}`);
        const exceedGroups = prefixes.flatMap(p =>
            EXCEED_TAGS.map(tag => `[${tag}] ${p}: ${setName}`)
        );

        let groupsToSearch = [];

        if (filter === 'ALL') {
            // 'ëª¨ë‘': ì¼ë°˜, ì ‘ë‘ì–´, ìµì‹œë“œ ëª¨ë‘ í•©ì‚°
            groupsToSearch = [baseGroup, ...prefixedGroups, ...exceedGroups];
        } else if (filter === 'BASE') {
            // 'ì¼ë°˜': ìˆœìˆ˜ ì„¸íŠ¸ ì´ë¦„ë§Œ
            groupsToSearch = [baseGroup];
        } else if (filter === 'PREFIX') {
            // 'ì ‘ë‘ì–´': ì ‘ë‘ì–´ ë¶™ì€ ì„¸íŠ¸ë§Œ (ìµì‹œë“œ ì œì™¸)
            groupsToSearch = prefixedGroups;
        } else if (filter === 'EXCEED') {
            // 'ìµì‹œë“œ': ìµì‹œë“œ ë¶™ì€ ì„¸íŠ¸ë§Œ
            groupsToSearch = exceedGroups;
        }

        groupsToSearch.forEach(group => {
            const fullKey = `${group} ${slot}`;
            // ì£¼ì˜: 'BASE'ì™€ 'PREFIX' í•„í„°ì—ì„œëŠ” ìµì‹œë“œê°€ ë¶™ì€ í‚¤ëŠ” ì œì™¸ë©ë‹ˆë‹¤.
            // 'ALL' í•„í„°ì—ì„œëŠ” ìµì‹œë“œê°€ ë¶™ì€ í‚¤ë„ í¬í•¨ë©ë‹ˆë‹¤. (ìœ„ì˜ groupsToSearch ì •ì˜ì— ë”°ë¦„)
            total += char.armorCounts[fullKey] || 0;
        });

        return total;
    }

    /* ========================================
       5. ìºë¦­í„° ê´€ë¦¬
       ======================================== */
    // 5-1. ìºë¦­í„° CRUD
    function addCharacter() {
        const name = document.getElementById("newCharName").value.trim();
        const job = document.getElementById("newCharJob").value.trim();
        if (!name || !job) {
            alert("ì´ë¦„ê³¼ ì§ì—…ì„ ì…ë ¥í•˜ì„¸ìš”!");
            return;
        }

        const newChar = {
            id: "c" + Date.now(),
            job: job,
            name: name,
            armorCounts: {},
            updateTimes: {},
            craftMaterials: {}  // ğŸ‘ˆ ì¶”ê°€
        };

        characters.push(newChar);
        saveLocalData();
        renderCharacterList();
        document.getElementById("newCharName").value = "";
        document.getElementById("newCharJob").value = "";
    }

    function deleteCharacterConfirmed() {
        openConfirmModal(
            "ìºë¦­í„° ì‚­ì œ",
            "ì •ë§ë¡œ ì´ ìºë¦­í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì‚­ì œëœ ë°ì´í„°ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
            function () {
                // 1. ì „ì—­ ë°°ì—´ì—ì„œ í•´ë‹¹ ìºë¦­í„° ì œì™¸ (í•„í„°ë§)
                characters = characters.filter(c => String(c.id) !== String(currentActionCharId));

                // 2. ğŸ’¡ ìˆ˜ì • í¬ì¸íŠ¸: saveData ëŒ€ì‹  ì‹¤ì œ ì¡´ì¬í•˜ëŠ” saveLocalData í˜¸ì¶œ
                saveLocalData();

                // 3. í™”ë©´ UI ê°±ì‹  (ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ê·¸ë¦¬ê¸°)
                renderCharacterList();

                // 4. ì‚­ì œí•œ ìºë¦­í„°ê°€ í˜„ì¬ ì„ íƒëœ ìºë¦­í„°ì˜€ë‹¤ë©´ ìƒì„¸ í™”ë©´ë„ ë¹„ìš°ê¸°
                if (activeCharacterId === currentActionCharId) {
                    const setListEl = document.getElementById("setList");
                    const panelEl = document.getElementById("panel");
                    if (setListEl) setListEl.innerHTML = "";
                    if (panelEl) panelEl.innerHTML = "";
                    activeCharacterId = null;
                }

                // 5. ë§ˆë¬´ë¦¬
                closeActionModal();
                alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        );
    }

    function resetCharacterStatsConfirmed() {
        const targetId = currentActionCharId;

        if (!targetId) {
            alert("ëŒ€ìƒ ìºë¦­í„°ë¥¼ ì„ íƒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        openConfirmModal(
            "ìˆ˜ì¹˜ ì´ˆê¸°í™”",
            "ì´ ìºë¦­í„°ì˜ ëª¨ë“  ì¥ë¹„ ë³´ìœ  í˜„í™© ë° ì—…ë°ì´íŠ¸ ê¸°ë¡ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?",
            function () {
                // 1. ìºë¦­í„° ë°ì´í„° ì°¾ê¸°
                const char = characters.find(c => String(c.id) === String(targetId));

                if (char) {
                    // 2. ğŸ’¡ í•µì‹¬: ì‚¬ìš©ìë‹˜ì˜ ë°ì´í„° í•„ë“œëª…(armorCounts, updateTimes)ì„ ì´ˆê¸°í™”í•©ë‹ˆë‹¤.
                    char.armorCounts = {};
                    char.updateTimes = {};

                    // ë¬´ê¸° ì •ë³´ê°€ ìˆë‹¤ë©´ í•¨ê»˜ ì´ˆê¸°í™”
                    if (char.weaponCounts) char.weaponCounts = {};

                    // 3. ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì¦‰ì‹œ ì €ì¥
                    saveLocalData();

                    // 4. í™”ë©´ UI ê°±ì‹ 
                    if (typeof renderCharacterList === "function") renderCharacterList();

                    // 5. ìƒì„¸ ë³´ê¸° ì˜ì—­ ë¹„ìš°ê¸° (ì´ˆê¸°í™”ë˜ì—ˆìœ¼ë¯€ë¡œ ì´ì „ ì •ë³´ë¥¼ ì§€ì›ë‹ˆë‹¤)
                    const setListEl = document.getElementById("setList");
                    const panelEl = document.getElementById("panel");
                    if (setListEl) setListEl.innerHTML = "";
                    if (panelEl) panelEl.innerHTML = "";

                    activeCharacterId = null; // ì„ íƒ ìƒíƒœ í•´ì œ

                    alert("ëª¨ë“  ìˆ˜ì¹˜ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    closeActionModal(); // ì„¤ì • ì°½ ë‹«ê¸°
                } else {
                    alert("ìºë¦­í„° ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                }
            }
        );
    }

    // ì¸ì ìˆœì„œê°€ ì¤‘ìš”í•©ë‹ˆë‹¤: (ìºë¦­í„°ID, ìˆ˜ì •ëœì´ë¦„, ìˆ˜ì •ëœì§ì—…)
    function updateCharacterInfo(charId) {
        // ğŸš¨ 787ë²ˆ ì¤„ ìˆ˜ì •: charName ëŒ€ì‹  edit-charNameì„ ì°¾ìŠµë‹ˆë‹¤.
        const nameInput = document.getElementById("edit-charName");
        const jobInput = document.getElementById("edit-charJob");

        // ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•˜ì—¬ null ì—ëŸ¬ ë°©ì§€
        if (!nameInput || !jobInput) {
            alert("ìˆ˜ì • ì…ë ¥ì°½ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        const newName = nameInput.value.trim();
        const newJob = jobInput.value.trim();

        if (!newName || !newJob) {
            alert("ì´ë¦„ê³¼ ì§ì—…ì„ ëª¨ë‘ ì…ë ¥í•´ ì£¼ì„¸ìš”.");
            return;
        }

        const char = characters.find(c => c.id === charId);
        if (char) {
            char.name = newName;
            char.job = newJob;

            saveLocalData();
            renderCharacterList(); // ë¦¬ìŠ¤íŠ¸ ê°±ì‹ 
            closeActionModal();    // ëª¨ë‹¬ ë‹«ê¸°
            alert("ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    }

    // 5-2. ìºë¦­í„° ë Œë”ë§
    function renderCharacterList() {
        const listEl = document.getElementById("characterList");
        if (!listEl) return;

        listEl.innerHTML = "";

        characters.forEach((c, index) => {
            const wrapper = document.createElement("div");
            wrapper.className = "character-wrapper";
            wrapper.style.display = "inline-flex";
            wrapper.style.alignItems = "center";
            wrapper.style.marginRight = "10px";
            wrapper.style.marginBottom = "10px";

            // ìºë¦­í„° ë²„íŠ¼
            const btn = document.createElement("button");
            btn.className = "char-btn" + (c.id === activeCharacterId ? " active" : "");
            btn.textContent = `${c.job} (${c.name})`;
            btn.onclick = () => {
                if (typeof showSetButtons === "function") showSetButtons(c);
            };

            // âš™ï¸ ì„¤ì • ë²„íŠ¼
            const settingsBtn = document.createElement("button");
            settingsBtn.textContent = "âš™ï¸";
            settingsBtn.className = "settings-btn";
            settingsBtn.onclick = (e) => {
                e.stopPropagation();
                openActionModal(c.id, c.name, c.job);
            };

            wrapper.appendChild(btn);
            wrapper.appendChild(settingsBtn);

            // // âœ… í¸ì§‘ ëª¨ë“œì¼ ë•Œë§Œ â¬†ï¸â¬‡ï¸ ë²„íŠ¼ í‘œì‹œ
            // if (isEditingCharacterOrder) {
            //     // â¬†ï¸ ìœ„ë¡œ ë²„íŠ¼
            //     const upBtn = document.createElement("button");
            //     upBtn.textContent = "â¬†ï¸";
            //     upBtn.className = "settings-btn";
            //     upBtn.title = "ìœ„ë¡œ ì´ë™";
            //     upBtn.onclick = (e) => {
            //         e.stopPropagation();
            //         moveCharacterUp(index);
            //     };
            //     if (index === 0) {
            //         upBtn.disabled = true;
            //         upBtn.style.opacity = "0.3";
            //         upBtn.style.cursor = "not-allowed";
            //     }
            //
            //     // â¬‡ï¸ ì•„ë˜ë¡œ ë²„íŠ¼
            //     const downBtn = document.createElement("button");
            //     downBtn.textContent = "â¬‡ï¸";
            //     downBtn.className = "settings-btn";
            //     downBtn.title = "ì•„ë˜ë¡œ ì´ë™";
            //     downBtn.onclick = (e) => {
            //         e.stopPropagation();
            //         moveCharacterDown(index);
            //     };
            //     if (index === characters.length - 1) {
            //         downBtn.disabled = true;
            //         downBtn.style.opacity = "0.3";
            //         downBtn.style.cursor = "not-allowed";
            //     }
            //
            //     wrapper.appendChild(upBtn);
            //     wrapper.appendChild(downBtn);
            // }
            // âœ… í¸ì§‘ ëª¨ë“œì¼ ë•Œë§Œ â¬…ï¸â¡ï¸ ë²„íŠ¼ í‘œì‹œ
            if (isEditingCharacterOrder) {
                // â¬…ï¸ ì™¼ìª½(ìœ„ë¡œ) ë²„íŠ¼
                const leftBtn = document.createElement("button");
                leftBtn.textContent = "â¬…ï¸";
                leftBtn.className = "settings-btn";
                leftBtn.title = "ì™¼ìª½ìœ¼ë¡œ ì´ë™";
                leftBtn.onclick = (e) => {
                    e.stopPropagation();
                    moveCharacterUp(index);
                };
                if (index === 0) {
                    leftBtn.disabled = true;
                    leftBtn.style.opacity = "0.3";
                    leftBtn.style.cursor = "not-allowed";
                }

                // â¡ï¸ ì˜¤ë¥¸ìª½(ì•„ë˜ë¡œ) ë²„íŠ¼
                const rightBtn = document.createElement("button");
                rightBtn.textContent = "â¡ï¸";
                rightBtn.className = "settings-btn";
                rightBtn.title = "ì˜¤ë¥¸ìª½ìœ¼ë¡œ ì´ë™";
                rightBtn.onclick = (e) => {
                    e.stopPropagation();
                    moveCharacterDown(index);
                };
                if (index === characters.length - 1) {
                    rightBtn.disabled = true;
                    rightBtn.style.opacity = "0.3";
                    rightBtn.style.cursor = "not-allowed";
                }

                wrapper.appendChild(leftBtn);
                wrapper.appendChild(rightBtn);
            }


            listEl.appendChild(wrapper);
        });
    }

    // 5-3. ìºë¦­í„° ìˆœì„œ ê´€ë¦¬
    // ğŸ’¡ í˜„ì¬ ìˆœì„œë¥¼ ë“±ë¡ ìˆœì„œë¡œ ì €ì¥
    function saveCurrentOrder() {
        characters.forEach((char, index) => {
            char.createdOrder = index;                       // í˜„ì¬ ì¸ë±ìŠ¤ë¥¼ ë“±ë¡ ìˆœì„œë¡œ ì €ì¥
        });

        saveLocalData();                                     // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
        alert('âœ… í˜„ì¬ ìˆœì„œê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    // ğŸ’¡ ë“±ë¡ ìˆœì„œë¡œ ë³µì›
    function resetToOriginalOrder() {
        if (characters.length === 0) {
            alert('ìºë¦­í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        // createdOrderê°€ ì—†ëŠ” ìºë¦­í„° í™•ì¸
        const hasUndefinedOrder = characters.some(
            char => char.createdOrder === undefined
        );

        if (hasUndefinedOrder) {
            alert('âš ï¸ ë¨¼ì € "ìˆœì„œ ë“±ë¡" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”!');
            return;
        }

        // ğŸ¯ í•µì‹¬: createdOrder ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
        characters.sort((a, b) => {
            const orderA = a.createdOrder !== undefined ? a.createdOrder : 9999;
            const orderB = b.createdOrder !== undefined ? b.createdOrder : 9999;
            return orderA - orderB;                          // ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬
        });

        saveLocalData();
        renderCharacterList();

        alert('ğŸ”„ ë“±ë¡í–ˆë˜ ìˆœì„œë¡œ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤!');
    }

    // ğŸ’¡ ì´ë¦„ìˆœ ì •ë ¬
    function sortCharactersByName() {
        if (characters.length === 0) return;

        characters.sort((a, b) => {
            return a.name.localeCompare(b.name, 'ko-KR');   // í•œê¸€ ê°€ë‚˜ë‹¤ìˆœ
        });

        saveLocalData();
        renderCharacterList();

        alert('ì´ë¦„ìˆœìœ¼ë¡œ ì •ë ¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // ğŸ’¡ ì§ì—…ìˆœ ì •ë ¬
    function sortCharactersByJob() {
        if (characters.length === 0) return;

        characters.sort((a, b) => {
            const jobCompare = a.job.localeCompare(b.job, 'ko-KR');
            if (jobCompare !== 0) return jobCompare;         // ì§ì—…ì´ ë‹¤ë¥´ë©´ ì§ì—…ìˆœ
            return a.name.localeCompare(b.name, 'ko-KR');    // ì§ì—…ì´ ê°™ìœ¼ë©´ ì´ë¦„ìˆœ
        });

        saveLocalData();
        renderCharacterList();

        alert('ì§ì—…ìˆœìœ¼ë¡œ ì •ë ¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    }

    // 5-4. ìºë¦­í„° ìˆœì„œ ë³€ê²½ (â†‘â†“ ë²„íŠ¼)
    function moveCharacterUp(index) {
        if (index === 0) return; // ì²« ë²ˆì§¸ëŠ” ìœ„ë¡œ ê°ˆ ìˆ˜ ì—†ìŒ

        // ë°°ì—´ì—ì„œ ìœ„ì¹˜ êµí™˜
        [characters[index], characters[index - 1]] = [characters[index - 1], characters[index]];

        saveLocalData();
        renderCharacterList();

        // í˜„ì¬ ì„ íƒëœ ìºë¦­í„° ìœ ì§€
        if (activeCharacterId) {
            const activeChar = characters.find(c => c.id === activeCharacterId);
            if (activeChar) showSetButtons(activeChar, true);
        }
    }

    function moveCharacterDown(index) {
        if (index === characters.length - 1) return; // ë§ˆì§€ë§‰ì€ ì•„ë˜ë¡œ ê°ˆ ìˆ˜ ì—†ìŒ

        // ë°°ì—´ì—ì„œ ìœ„ì¹˜ êµí™˜
        [characters[index], characters[index + 1]] = [characters[index + 1], characters[index]];

        saveLocalData();
        renderCharacterList();

        // í˜„ì¬ ì„ íƒëœ ìºë¦­í„° ìœ ì§€
        if (activeCharacterId) {
            const activeChar = characters.find(c => c.id === activeCharacterId);
            if (activeChar) showSetButtons(activeChar, true);
        }
    }

    // 5-5. í¸ì§‘ ëª¨ë“œ í† ê¸€
    function toggleEditMode() {
        const editBtn = document.getElementById("edit-order-btn");

        isEditingCharacterOrder = !isEditingCharacterOrder;

        if (isEditingCharacterOrder) {
            // í¸ì§‘ ëª¨ë“œ í™œì„±í™”
            editBtn.textContent = "âœ… ë³€ê²½ì™„ë£Œ";
            editBtn.style.background = "linear-gradient(135deg, #25c2a0, #1a8c7d)";
        } else {
            // í¸ì§‘ ëª¨ë“œ ë¹„í™œì„±í™”
            editBtn.textContent = "âœï¸ í¸ì§‘";
            editBtn.style.background = "linear-gradient(135deg, #3399cc, #2a6f9e)";

            // ë°ì´í„° ì €ì¥
            saveLocalData();
            alert("ìˆœì„œ ë³€ê²½ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
        }

        // ìºë¦­í„° ë¦¬ìŠ¤íŠ¸ ë‹¤ì‹œ ë Œë”ë§
        renderCharacterList();
    }

    /* ========================================
       6. ëª¨ë‹¬ ê´€ë¦¬
       ======================================== */
    function openActionModal(charId, name, job) {
        // 1. í˜„ì¬ ì‘ì—… ëŒ€ìƒ IDë¥¼ ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
        currentActionCharId = charId;

        const modal = document.getElementById("actionModal");
        // ğŸ’¡ ìˆ˜ì • í¬ì¸íŠ¸: modal ìì²´ê°€ nullì¸ì§€ í™•ì¸í•˜ê³ , ë‚´ë¶€ content ì˜ì—­ì„ ì•ˆì „í•˜ê²Œ ì°¸ì¡°í•©ë‹ˆë‹¤.
        if (!modal) return;

        // ì‚¬ìš©ìë‹˜ì˜ HTML êµ¬ì¡°ì— ë§ì¶° í´ë˜ìŠ¤ëª…ì´ modal-contentì¸ ìš”ì†Œë¥¼ ì°¾ìŠµë‹ˆë‹¤.
        const content = modal.querySelector(".modal-content");
        if (!content) return;

        // 2. ëª¨ë‹¬ ë‚´ë¶€ UI ìƒì„± (ì‚¬ìš©ìë‹˜ ì½”ë“œ ìœ ì§€ + ì˜¤íƒ€ ë°©ì§€)
        content.innerHTML = `
      <h2 style="margin-bottom:25px; color:#fff;">ìºë¦­í„° ì„¤ì • ìˆ˜ì •</h2>

      <div style="margin-bottom:15px; display:flex; align-items:center;">
          <label style="width:60px; font-weight:bold; color:#ccc;">ì´ë¦„ :</label>
          <input type="text" id="edit-charName" value="${name}"
                 style="flex:1; padding:8px; background:#181c33; color:#fff; border:1px solid #2a3158; border-radius:4px;">
      </div>

      <div style="margin-bottom:25px; display:flex; align-items:center;">
          <label style="width:60px; font-weight:bold; color:#ccc;">ì§ì—… :</label>
          <input type="text" id="edit-charJob" value="${job}"
                 style="flex:1; padding:8px; background:#181c33; color:#fff; border:1px solid #2a3158; border-radius:4px;">
      </div>

      <div class="modal-options" style="display:flex; flex-direction:column; gap:10px;">
          <button type="button" class="modal-btn" style="background:#25c2a0; font-weight:bold; color:#fff;"
                  onclick="updateCharacterInfo('${charId}')">ì •ë³´ ìˆ˜ì • ì™„ë£Œ</button>
          <div style="display:flex; gap:8px;">
              <button type="button" class="modal-btn" style="flex:1; background:#f39c12; font-size:0.9em; color:#fff;"
                      onclick="resetCharacterStatsConfirmed()">ìˆ˜ì¹˜ ì´ˆê¸°í™”</button>
              <button type="button" class="modal-btn" style="flex:1; background:#e74c3c; font-size:0.9em; color:#fff;"
                      onclick="deleteCharacterConfirmed()">ìºë¦­í„° ì‚­ì œ</button>
          </div>
          <button type="button" class="modal-btn" style="background:#444; color:#fff;" onclick="closeActionModal()">ì·¨ì†Œ</button>
      </div>
  `;
        modal.style.display = "flex";
    }

    // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜ê°€ ì—†ë‹¤ë©´ ì•„ë˜ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.
    function closeActionModal() {
        const modal = document.getElementById("actionModal");
        if (modal) modal.style.display = "none";
    }

    // í™•ì¸ ëª¨ë‹¬ ì—´ê¸° í•¨ìˆ˜ (ì—ëŸ¬ ë°©ì§€ìš© ë³´ì™„)
    function openConfirmModal(title, message, onConfirm) {
        const modal = document.getElementById("confirmModal");
        const titleEl = document.getElementById("confirmTitle");
        const messageEl = document.getElementById("confirmMessage");
        const confirmBtn = document.getElementById("confirmYes");

        if (!modal || !titleEl || !messageEl || !confirmBtn) return;

        titleEl.textContent = title;
        messageEl.textContent = message;

        // ğŸ’¡ í•µì‹¬ ìˆ˜ì •: onclickì— í•¨ìˆ˜ë¥¼ ì§ì ‘ í• ë‹¹í•©ë‹ˆë‹¤.
        confirmBtn.onclick = function () {
            if (typeof onConfirm === "function") {
                onConfirm(); // ì—¬ê¸°ì„œ ì „ë‹¬ë°›ì€ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.
            }
            closeConfirmModal();
        };

        modal.style.display = 'flex';
    }

    // ëª¨ë‹¬ ë‹«ê¸° (ê¸°ì¡´ ì½”ë“œì™€ ë™ì¼)
    function closeConfirmModal() {
        const modal = document.getElementById("confirmModal");
        if (modal) modal.style.display = 'none';
    }

    /* ========================================
       7. ì¥ë¹„ ê´€ë¦¬ (ì„¸íŠ¸ ì‹œìŠ¤í…œ)
       ======================================== */
    // 7-1. ì„¸íŠ¸ ë²„íŠ¼ & í‘œì‹œ
    // ===== ì„¸íŠ¸ ë²„íŠ¼ í‘œì‹œ =====
    function showSetButtons(char, isRefresh = false) {
        const setList = document.getElementById("setList");
        const panel = document.getElementById("panel");

        // 1. [í† ê¸€ ë¡œì§]
        // ìƒˆë¡œê³ ì¹¨(isRefresh=true)ì´ ì•„ë‹ ë•Œë§Œ 'ì´ë¯¸ ì—´ë¦° ìºë¦­í„°'ë¥¼ ëˆ„ë¥´ë©´ ë‹«íˆê²Œ í•©ë‹ˆë‹¤.
        if (!isRefresh && activeCharacterId === char.id) {
            activeCharacterId = null;
            setList.innerHTML = "";
            panel.innerHTML = "";
            renderCharacterList(); // ì„ íƒ í‘œì‹œ(ë…¸ë€ë¶ˆ) í•´ì œ
            return;
        }

        // ìºë¦­í„° ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸ ë° ë…¸ë€ìƒ‰ ë¶ˆ ì¼œê¸°
        activeCharacterId = char.id;
        renderCharacterList();

        setList.innerHTML = "";

        // ----------------------------------------------------
        // 1. ê° ì¹´í…Œê³ ë¦¬ë³„ ì•„ì´í…œ ì´ ê°œìˆ˜ ê³„ì‚°
        // ----------------------------------------------------
        let totalArmor = 0;
        let totalAccessory = 0;
        let totalSpecial = 0;

        Object.entries(char.armorCounts).forEach(([fullKey, count]) => {
            if (count <= 0) return;

            const parts = fullKey.split(' ');
            const slot = parts.pop();
            const name = parts.join(' ');

            const groupKey = getGroupKey(name);
            const setType = getSetType(groupKey);

            if (setType === "ARMOR") totalArmor += count;
            else if (setType === "ACCESSORY") totalAccessory += count;
            else if (setType === "SPECIAL") totalSpecial += count;
        });

        // ----------------------------------------------------
        // 2. ì œëª©ì— ì´ ê°œìˆ˜ë¥¼ í¬í•¨í•˜ì—¬ í‘œì‹œ
        // ----------------------------------------------------

        // ë°©ì–´êµ¬
        const armorTitle = document.createElement("h2");
        armorTitle.textContent = `[ë°©ì–´êµ¬ (${totalArmor}ê°œ)]`;
        setList.appendChild(armorTitle);
        Object.keys(ARMOR_SETS).forEach(setName => {
            setList.appendChild(makeSetButton(setName, char));
        });

        // ì•…ì„¸
        const accTitle = document.createElement("h2");
        accTitle.textContent = `[ì•…ì„¸ (${totalAccessory}ê°œ)]`;
        setList.appendChild(accTitle);
        Object.keys(ACCESSORY_SETS).forEach(setName => {
            setList.appendChild(makeSetButton(setName, char));
        });

        // íŠ¹ì¥
        const spTitle = document.createElement("h2");
        spTitle.textContent = `[íŠ¹ì¥ (${totalSpecial}ê°œ)]`;
        setList.appendChild(spTitle);
        Object.keys(SPECIAL_SETS).forEach(setName => {
            setList.appendChild(makeSetButton(setName, char));
        });

        document.getElementById("panel").innerHTML = "";
    }

    // ===== ì„¸íŠ¸ ë²„íŠ¼ ìƒì„± =====
    function makeSetButton(setName, char) {
        let count3 = 0, count5 = 0;
        let totalParts = 0; // x ê°’ (ì´ ê°œìˆ˜) ì´ˆê¸°í™”

        const slots = ALL_SETS[setName] || [];
        const prefixes = ALL_PREFIX[setName] || [];
        const setType = getSetType(setName);
        const exceedSlots = EXCEED_SLOTS[setType] || [];

        // 1. ì „ì²´ ê³ ìœ  ë¶€ìœ„ ê°œìˆ˜ ê³„ì‚° (ì ‘ë‘ì–´/ìµì‹œë“œ ë¬´ì‹œ)
        const distinctParts = calcTotalDistinctParts(char, setName);

        // 2. ì´ ë¶€ìœ„ ê°œìˆ˜ (totalParts, x ê°’) ê³„ì‚°
        const allGroupKeys = [setName];
        prefixes.forEach(pref => {
            const prefixedName = `${pref}: ${setName}`;
            allGroupKeys.push(prefixedName);
            EXCEED_TAGS.forEach(tag => {
                allGroupKeys.push(`[${tag}] ${prefixedName}`);
            });
        });

        allGroupKeys.forEach(groupKey => {
            const isExceedKey = groupKey.startsWith('[');
            slots.forEach(slot => {
                let key = `${groupKey} ${slot}`;

                if (isExceedKey && !exceedSlots.includes(slot)) {
                    return;
                }

                totalParts += char.armorCounts[key] || 0;
            });
        });
        // ì´í•© ê³„ì‚° ë

        // 3. ë‹¨ì¼ distinctPartsë¥¼ ì‚¬ìš©í•œ ìµœì¢… ì„¸íŠ¸ íŒì •
        const fullSize = slots.length;

        if (fullSize === 5) { // ë°©ì–´êµ¬
            if (distinctParts === fullSize) count5 = 1; // 5ì„¸íŠ¸ ë‹¬ì„±
            else if (distinctParts >= 3) count3 = 1; // 3ì„¸íŠ¸ ë‹¬ì„± (3 ë˜ëŠ” 4)
        } else { // ì•…ì„¸/íŠ¹ì¥ (3ë¶€ìœ„)
            if (distinctParts === 3) count3 = 1; // 3ì„¸íŠ¸ ë‹¬ì„±
        }

        const btn = document.createElement("button");
        btn.className = "set-btn";

        // í™”ë©´ í‘œì‹œë¥¼ ìœ„í•œ 0 ë˜ëŠ” 1 ê°’ ì„¤ì •
        const final_count3 = count3 > 0 ? 1 : 0;
        const final_count5 = count5 > 0 ? 1 : 0;

        // ë°°ê²½ìƒ‰ ì ìš©
        if (final_count5 > 0) btn.classList.add("set5");
        else if (final_count3 > 0) btn.classList.add("set3");

        // [ì„ íƒ ìƒíƒœ ìœ ì§€ ë¡œì§ ì¶”ê°€]: í˜„ì¬ ì„ íƒëœ ì„¸íŠ¸ì™€ ì´ë¦„ì´ ê°™ìœ¼ë©´ selected í´ë˜ìŠ¤ ìœ ì§€
        if (currentSetName === setName && currentChar && currentChar.id === char.id) {
            btn.classList.add("selected");
        }

        // ğŸš¨ ìˆ˜ì •ëœ ë¶€ë¶„: "ì„¸íŠ¸ëª… (ì¥ë¹„ìˆ˜)" í˜•íƒœë¡œ ë‚´ìš© êµ¬ì„±
        let buttonContent = `${setName} (${totalParts})`;

        // âœ… ì¶”ê°€: ì•…ì„¸/íŠ¹ì¥ ì¶”ê°€ ì •ë³´ í‘œì‹œ
        if (setType === "ACCESSORY" && ACCESSORY_EXTRA_INFO[setName]) {
            buttonContent += `<br>(${ACCESSORY_EXTRA_INFO[setName]})</span>`;
        } else if (setType === "SPECIAL" && SPECIAL_EXTRA_INFO[setName]) {
            buttonContent += `<br>(${SPECIAL_EXTRA_INFO[setName]})</span>`;
        }

        btn.innerHTML = buttonContent; // innerHTMLë¡œ ë‚´ìš© ì„¤ì •

        btn.onclick = (event) => {
            // [ì„ íƒ ë¡œì§ ì¶”ê°€]: ëª¨ë“  ì„¸íŠ¸ ë²„íŠ¼ì—ì„œ 'selected' í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll(".set-btn").forEach(b => b.classList.remove("selected"));
            // [ì„ íƒ ë¡œì§ ì¶”ê°€]: í˜„ì¬ í´ë¦­ëœ ë²„íŠ¼ì— 'selected' í´ë˜ìŠ¤ ì¶”ê°€
            event.currentTarget.classList.add("selected");

            openSet(setName, char);
        };

        return btn;
    }

    // ===== ì„¸íŠ¸ í‘œ ì—´ê¸° =====
    function openSet(setName, char) {
        // ì„¸íŠ¸ê°€ ë³€ê²½ë  ë•Œë§ˆë‹¤ ê¸°ë³¸ í•„í„°ë¥¼ 'ALL'ë¡œ ì´ˆê¸°í™”í•˜ê³  UI ì—…ë°ì´íŠ¸
        if (currentSetName !== setName || currentChar?.id !== char.id) {
            currentFilter = 'ALL';
        }

        currentSetName = setName;
        currentChar = char;

        const panel = document.getElementById("panel");
        panel.innerHTML = `<h2>[${setName} ì„¸íŠ¸]</h2>`;

        const slots = ALL_SETS[setName] || [];
        const table = document.createElement("table");
        table.innerHTML = `<thead>
 <tr><th>ì„¸íŠ¸ ì´ë¦„</th>${slots.map(s => `<th>${s}</th>`).join("")}</tr>
</thead><tbody></tbody>`;
        const tbody = table.querySelector("tbody");

        tbody.appendChild(makeRow(setName, setName, char));
        const prefixes = ALL_PREFIX[setName] || [];

        // ğŸ’¡ ì¼ë°˜ ì ‘ë‘ì–´ í–‰ ì¶”ê°€
        prefixes.forEach(pref => {
            tbody.appendChild(makeRow(`${pref}: ${setName}`, setName, char));
        });

        // ğŸ’¡ ìµì‹œë“œ í–‰ ì¶”ê°€ ë¡œì§ ìˆ˜ì •
        if (prefixes.length > 0) {
            // ì ‘ë‘ì–´ê°€ ìˆëŠ” ê²½ìš°: ê¸°ì¡´ ë¡œì§ëŒ€ë¡œ [íƒœê·¸] ì ‘ë‘ì–´: ì„¸íŠ¸ëª…
            prefixes.forEach(pref => {
                EXCEED_TAGS.forEach(ex => {
                    tbody.appendChild(makeRow(`[${ex}] ${pref}: ${setName}`, setName, char));
                });
            });
        } else {
            // ğŸ’¡ ì‹ ê·œ ì¶”ê°€: ì ‘ë‘ì–´ê°€ ì—†ëŠ” ê²½ìš° (ë ˆê±°ì‹œ ì¥ë¹„)
            // ARMOR_EXCEED_ONLY ë˜ëŠ” ACCESSORY_EXCEED_ONLYì— í•´ë‹¹í•˜ë©´ ìµì‹œë“œë§Œ ì¶”ê°€
            const isExceedOnlyArmor = (typeof ARMOR_EXCEED_ONLY !== 'undefined' && ARMOR_EXCEED_ONLY.includes(setName));
            const isExceedOnlyAccessory = (typeof ACCESSORY_EXCEED_ONLY !== 'undefined' && ACCESSORY_EXCEED_ONLY.includes(setName));

            if (isExceedOnlyArmor || isExceedOnlyAccessory) {
                EXCEED_TAGS.forEach(ex => {
                    tbody.appendChild(makeRow(`[${ex}] ${setName}`, setName, char));
                });
            }
        }

        panel.appendChild(table);

        table.querySelectorAll("th:first-child, td:first-child").forEach(cell => {
            cell.style.width = globalSetNameWidth + "px";
        });
        table.querySelectorAll("th:not(:first-child), td:not(:first-child)").forEach(cell => {
            cell.style.width = globalSlotWidth + "px";
        });
    }

    // 7-2. í…Œì´ë¸” í–‰ ìƒì„±
    // ===== í‘œ í–‰ ìƒì„± =====
    function makeRow(name, setName, char) {
        const slots = ALL_SETS[setName] || [];
        const groupKey = getGroupKey(name);
        const isExceed = isExceedName(name);
        const setType = getSetType(setName);
        const exceedSlots = EXCEED_SLOTS[setType];

        // calcTotalDistinctPartsë¡œ ê¸°ë³¸ ì„¸íŠ¸ì˜ ì „ì²´ ê³ ìœ  ë¶€ìœ„ ê°œìˆ˜ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
        const totalDistinct = calcTotalDistinctParts(char, setName);
        const fullSize = slots.length;

        const tr = document.createElement("tr");
        let hasAnyPartInRow = false; // ğŸš¨ ì´ í–‰(ì•„ì´í…œ)ì— ë¶€ìœ„ê°€ ì¥ì°©ë˜ì—ˆëŠ”ì§€ í™•ì¸

        // 1. ì¥ì°© ì—¬ë¶€ í™•ì¸
        slots.forEach(slot => {
            let key = `${name} ${slot}`;
            if ((char.armorCounts[key] || 0) > 0) {
                hasAnyPartInRow = true;
            }
        });

        // 2. ì „ì²´ ì„¸íŠ¸ ë‹¬ì„± ì¡°ê±´ê³¼ ì¥ì°© ì—¬ë¶€ë¥¼ ëª¨ë‘ ë§Œì¡±í•  ë•Œë§Œ ìƒ‰ìƒ ê²°ì •
        if (hasAnyPartInRow) {
            if (setType === "ARMOR") {
                if (totalDistinct === fullSize) tr.className = "set5";
                else if (totalDistinct >= 3) tr.className = "set3";
            } else {
                if (totalDistinct === 3) tr.className = "set3";
            }
        }


        // =========================================================
        // ğŸ’¡ [ìµœì¢… ìˆ˜ì •] ì•„ì´í…œ ì´ë¦„ ìŠ¤íƒ€ì¼ë§ ë¡œì§ ì‹œì‘ (HTML ë¬¸ìì—´ ì¡°ë¦½)
        // =========================================================
        let itemName = name;
        let finalHtmlName = itemName;

        // 1. ìµì‹œë“œ íƒœê·¸ ([Tag]) ì²˜ë¦¬ (íƒœê·¸ ì œê±° ë° ìŠ¤íƒ€ì¼ë§ëœ íƒœê·¸ ìƒì„±)
        const exceedMatch = itemName.match(/^(\[.*?\])\s*(.*)/);
        let exceedTagHtml = '';
        let nameWithoutTag = itemName;

        if (exceedMatch) {
            const tag = exceedMatch[1]; // ì˜ˆ: [ì´ìƒ]
            nameWithoutTag = exceedMatch[2]; // ì˜ˆ: ì „ê²©: ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ
            let color = '';

            if (tag === '[ì„ ë´‰]') {
                color = '#ff4d4f'; // ë¹¨ê°„ìƒ‰
            } else if (tag === '[ì´ìƒ]') {
                color = '#25c2a0'; // ì´ˆë¡ìƒ‰
            } else if (tag === '[ì˜ì§€]') {
                color = '#3399cc'; // íŒŒë€ìƒ‰
            }

            exceedTagHtml = `<span style="color:${color}; font-weight:bold;">${tag}</span> `;
        }

        // 2. ì ‘ë‘ì–´ (Prefix:) ì²˜ë¦¬ (ë…¸ë€ìƒ‰ ì ìš©)
        let baseNameHtml = nameWithoutTag; // ìµì‹œë“œ íƒœê·¸ê°€ ìˆì—ˆë“  ì—†ì—ˆë“ , ë‚˜ë¨¸ì§€ ì´ë¦„

        const prefixMatch = nameWithoutTag.match(/(.+?):\s*(.+)/);

        if (prefixMatch) {
            const prefix = prefixMatch[1]; // ì˜ˆ: ì „ê²©
            const baseSet = prefixMatch[2]; // ì˜ˆ: ì–´ëŠ ë§ê´„ëŸ‰ì´ì˜ íƒì‚¬ë³µ

            const styledPrefix = `<span style="color:#e6b800; font-weight:bold;">${prefix}</span>`;

            baseNameHtml = `${styledPrefix}: ${baseSet}`;
        }

        // 3. ìµœì¢… HTML ë¬¸ìì—´ ì¡°ë¦½
        finalHtmlName = exceedTagHtml + baseNameHtml;
        // =========================================================
        // ğŸ’¡ [ìµœì¢… ìˆ˜ì •] ì•„ì´í…œ ì´ë¦„ ìŠ¤íƒ€ì¼ë§ ë¡œì§ ë
        // =========================================================

        let html = `<td style="text-align:left;">${finalHtmlName}</td>`; // ìµœì¢… HTMLì„ ì‚½ì…

        slots.forEach(slot => {
            let key = `${name} ${slot}`;
            const val = char.armorCounts[key] || 0;
            if (isExceed) {
                if (exceedSlots.includes(slot)) {
                    html += `<td>${makeNumberButton(char.id, key, val)}</td>`;
                } else {
                    html += `<td></td>`;
                }
            } else {
                html += `<td>${makeNumberButton(char.id, key, val)}</td>`;
            }
        });
        tr.innerHTML = html;
        return tr;
    }

    // 7-3. ì¥ë¹„ ì¦ê°
    // ===== ìˆ«ì ë²„íŠ¼ (ìš°í´ë¦­ ê°ì†Œ ê¸°ëŠ¥ í¬í•¨) =====
    function makeNumberButton(charId, key, val) {
        const extraClass = val > 0 ? " positive" : "";
        return `<button class="num-btn${extraClass}"
      oncontextmenu="decrement('${charId}','${key}'); return false;"
      onclick="increment('${charId}','${key}')">${val}</button>`;
    }

    // ===== ì¦ê°€/ê°ì†Œ =====
    function increment(charId, key) {
        const char = characters.find(c => c.id === charId);
        char.armorCounts[key] = (char.armorCounts[key] || 0) + 1;
        // ğŸ’¡ ì—…ë°ì´íŠ¸ ì‹œê°„ ì¶”ê°€/ê°±ì‹ 
        char.updateTimes[key] = Date.now();
        saveLocalData(); // [ë¡œì»¬ ìŠ¤í† ë¦¬ì§€] ë°ì´í„° ë³€ê²½ í›„ ì €ì¥
        showSetButtons(char, true);
        if (currentSetName && currentChar) {
            openSet(currentSetName, currentChar); // âœ… ì €ì¥ëœ ê°’ìœ¼ë¡œ ë‹¤ì‹œ ì—´ê¸°
        }
    }

    // ğŸš¨ ê°ì†Œ í•¨ìˆ˜ (ìš°í´ë¦­ ì‹œ í˜¸ì¶œ)
    function decrement(charId, key) {
        const char = characters.find(c => c.id === charId);
        const cur = char.armorCounts[key] || 0;
        char.armorCounts[key] = Math.max(0, cur - 1); // 0ë³´ë‹¤ ì‘ì•„ì§€ì§€ ì•Šê²Œ
        // ğŸ’¡ ì—…ë°ì´íŠ¸ ì‹œê°„ ì¶”ê°€/ê°±ì‹  (0ì´ ë˜ì–´ë„ ë§ˆì§€ë§‰ ìˆ˜ì • ì‹œê°„ì€ ë‚¨ê¹€)
        char.updateTimes[key] = Date.now();
        saveLocalData(); // [ë¡œì»¬ ìŠ¤í† ë¦¬ì§€] ë°ì´í„° ë³€ê²½ í›„ ì €ì¥
        showSetButtons(char, true);
        if (currentSetName && currentChar) {
            openSet(currentSetName, currentChar); // âœ… ì €ì¥ëœ ê°’ìœ¼ë¡œ ë‹¤ì‹œ ì—´ê¸°
        }
    }

    // 7-4. ì¥ë¹„ ê´€ë¦¬ íƒ­
    // 1. ìºë¦­í„°ë³„ í˜„í™© ë Œë”ë§ (ìµì‹œë“œ ìƒ‰ìƒ ì ìš©)
    function renderEquipmentTab(mode) {
        // âœ… ìƒíƒœ ì´ˆê¸°í™”
        isCharacterEquipmentViewOpen = false;
        isStatisticsViewOpen = false;
        selectedCharacterForEquipment = null;

        // âœ… ëª¨ë“  ì˜ì—­ ì´ˆê¸°í™”
        document.getElementById("character-selection-area").style.display = "none";
        document.getElementById("character-equipment-detail").style.display = "none";
        document.getElementById("equipment-display-area").style.display = "block";

        const displayArea = document.getElementById("equipment-display-area");
        const CATEGORIES = [
            {name: "ë°©ì–´êµ¬", sets: ARMOR_SETS, prefix: ARMOR_PREFIX, id: 'cat-armor'},
            {name: "ì•…ì„¸", sets: ACCESSORY_SETS, prefix: ACCESSORY_PREFIX, id: 'cat-accessory'},
            {name: "íŠ¹ì¥", sets: SPECIAL_SETS, prefix: SPECIAL_PREFIX, id: 'cat-special'}
        ];

        // ìŠ¤í¬ë¡¤ ë²„íŠ¼ ì¶”ê°€
        let scrollButtonHtml = `<div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">`;
        CATEGORIES.forEach(cat => {
            scrollButtonHtml += `<button class="char-btn" style="background: #4a33cc; border: 1px solid #ffd700;"
                            onclick="scrollToCategory('${cat.id}')">${cat.name}ë¡œ ì´ë™ â†’</button>`;
        });
        scrollButtonHtml += `</div>`;

        let fullHtml = scrollButtonHtml + `<h2 style="color:#ffd700; margin-bottom:20px;">ğŸ“Š ìºë¦­í„°ë³„ ìƒì„¸ í˜„í™© (${mode})</h2>`;

        CATEGORIES.forEach(cat => {
            fullHtml += `<div id="${cat.id}" style="margin-bottom: 50px; padding-top: 20px; border-top: 3px solid #4a33cc;">`;
            fullHtml += `<h2 style="color:#ffd700; font-size: 24px; margin-bottom: 15px;">ğŸ”¹ ${cat.name}</h2>`;

            Object.keys(cat.sets).forEach(baseSetName => {
                const prefixes = cat.prefix[baseSetName] || [];
                const slots = cat.sets[baseSetName];
                const setType = getSetType(baseSetName);
                let targetGroupKeys = [];

                if (mode === 'NORMAL' || mode === 'ALL') targetGroupKeys.push({
                    full: baseSetName,
                    display: "ì¼ë°˜",
                    type: 'NORMAL'
                });
                if (mode === 'PREFIX' || mode === 'ALL') prefixes.forEach(p => targetGroupKeys.push({
                    full: `${p}: ${baseSetName}`,
                    display: p,
                    type: 'PREFIX'
                }));
                if (mode === 'EXCEED' || mode === 'ALL') {
                    // ğŸ’¡ ê¸°ì¡´ ë¡œì§ (ì ‘ë‘ì–´ ìˆëŠ” ìµì‹œë“œ)
                    if (prefixes.length > 0) {
                        prefixes.forEach(p => {
                            EXCEED_TAGS.forEach(tag => targetGroupKeys.push({
                                full: `[${tag}] ${p}: ${baseSetName}`,
                                display: p,
                                tag: tag,
                                type: 'EXCEED'
                            }));
                        });
                    } else {
                        // ğŸ’¡ ì‹ ê·œ ì¶”ê°€: ì ‘ë‘ì–´ ì—†ëŠ” ìµì‹œë“œ (ë ˆê±°ì‹œ ì¥ë¹„)
                        const isExceedOnlyArmor = (typeof ARMOR_EXCEED_ONLY !== 'undefined' && ARMOR_EXCEED_ONLY.includes(baseSetName));
                        const isExceedOnlyAccessory = (typeof ACCESSORY_EXCEED_ONLY !== 'undefined' && ACCESSORY_EXCEED_ONLY.includes(baseSetName));

                        if (isExceedOnlyArmor || isExceedOnlyAccessory) {
                            EXCEED_TAGS.forEach(tag => targetGroupKeys.push({
                                full: `[${tag}] ${baseSetName}`,
                                display: "ë ˆê±°ì‹œ",
                                tag: tag,
                                type: 'EXCEED'
                            }));
                        }
                    }
                }

                if (targetGroupKeys.length === 0) return;

                fullHtml += `<h3 style="color:#fff; margin-top:30px;">[${baseSetName} ì„¸íŠ¸]</h3>`;

                // ìµì‹œë“œ ëª¨ë“œì¼ ë•Œ ìŠ¬ë¡¯ í•„í„°ë§
                let displaySlots = slots;
                if (mode === 'EXCEED') {
                    if (setType === "ARMOR") {
                        displaySlots = ["ìƒì˜"];
                    } else if (setType === "ACCESSORY") {
                        displaySlots = ["íŒ”ì°Œ"];
                    } else if (setType === "SPECIAL") {
                        displaySlots = ["ê·€ê±¸ì´"];
                    }
                }

                fullHtml += `<table style="width:max-content; border-collapse:collapse; margin-bottom:20px; border:1px solid #2a3158;">
            <thead style="background:#181c33;"><tr>
                <th style="padding:10px; border:1px solid #2a3158; white-space:nowrap;">ì§ì—…</th>
                <th style="padding:10px; border:1px solid #2a3158; white-space:nowrap;">ì´ë¦„</th>
                ${(mode === 'ALL' || mode === 'EXCEED') ? '<th style="padding:10px; border:1px solid #2a3158; white-space:nowrap;">ìµì‹œë“œ</th>' : ''}
                ${mode !== 'NORMAL' ? '<th style="padding:10px; border:1px solid #2a3158; white-space:nowrap;">ì ‘ë‘ì–´</th>' : ''}
                ${displaySlots.map(s => `<th style="padding:10px; border:1px solid #2a3158; white-space:nowrap;">${s}</th>`).join('')}
                ${mode !== 'EXCEED' ? '<th style="padding:10px; border:1px solid #2a3158; white-space:nowrap;">ë‹¬ì„±</th>' : ''}
            </tr></thead><tbody>`;

                characters.forEach(char => {
                    const totalDistinct = calcTotalDistinctParts(char, baseSetName);

                    // í•´ë‹¹ ìºë¦­í„°ê°€ ê°€ì§„ í˜„ì¬ ì„¸íŠ¸ì˜ ì•„ì´í…œ ë°ì´í„° ê·¸ë£¹ë“¤
                    const charGroups = targetGroupKeys.filter(group =>
                        slots.some(s => (char.armorCounts?.[`${group.full} ${s}`] || 0) > 0)
                    );

                    charGroups.forEach((group, gIdx) => {
                        // ê° ëª¨ë“œë³„ë¡œ ë‹¬ì„±ë„ ê³„ì‚°
                        let displayDistinct = totalDistinct;
                        let statusColor = "#fff";

                        if (mode === 'NORMAL') {
                            displayDistinct = 0;
                            slots.forEach(slot => {
                                const key = `${baseSetName} ${slot}`;
                                if ((char.armorCounts[key] || 0) > 0) {
                                    displayDistinct++;
                                }
                            });
                        } else if (mode === 'PREFIX') {
                            displayDistinct = 0;
                            slots.forEach(slot => {
                                const key = `${group.full} ${slot}`;
                                if ((char.armorCounts[key] || 0) > 0) {
                                    displayDistinct++;
                                }
                            });
                        }

                        // ìƒ‰ìƒ ê²°ì •
                        if (setType === "ARMOR") {
                            if (displayDistinct === 5) statusColor = "#ffd700";
                            else if (displayDistinct >= 3) statusColor = "#2ecc71";
                        } else {
                            if (displayDistinct === 3) statusColor = "#2ecc71";
                        }

                        let slotsHtml = displaySlots.map(s => {
                            const count = char.armorCounts?.[`${group.full} ${s}`] || 0;
                            return `<td style="padding:10px; border:1px solid #2a3158; text-align:center; color:${count > 0 ? '#fff' : '#444'}; font-weight:bold;">${count}</td>`;
                        }).join('');

                        let rowInfo = "";
                        const tagColor = EXCEED_COLOR_MAP[group.tag] || "#ffd700";

                        // ğŸ’¡ ì¼ë°˜ ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ì ‘ë‘ì–´(display) ì…€ì„ ìƒì„±
                        if (mode === 'ALL' || mode === 'EXCEED') {
                            const tagCol = group.tag ? `<td style="padding:10px; border:1px solid #2a3158; color:${tagColor}; font-weight:bold; white-space:nowrap;">[${group.tag}]</td>` : `<td style="border:1px solid #2a3158;"></td>`;
                            rowInfo = tagCol + `<td style="padding:10px; border:1px solid #2a3158; color:#ffd700; font-weight:bold; white-space:nowrap;">${group.display}</td>`;
                        } else if (mode === 'PREFIX') {
                            rowInfo = `<td style="padding:10px; border:1px solid #2a3158; color:#ffd700; font-weight:bold; white-space:nowrap;">${group.display}</td>`;
                        }

                        // ğŸ’¡ [ëª¨ë‘] ë²„íŠ¼ì¼ ë•Œë§Œ ìºë¦­í„° ê²½ê³„ì„ ì— ì§„í•œ ì„  ì ìš©
                        const isLastRowOfChar = (gIdx === charGroups.length - 1);
                        const borderStyle = (mode === 'ALL' && isLastRowOfChar) ? "border-bottom: 3px solid #666;" : "border-bottom: 1px solid #2a3158;";

                        fullHtml += `<tr>
                    <td style="padding:10px; ${borderStyle} background:#181c33; white-space:nowrap;">${char.job}</td>
                    <td style="padding:10px; ${borderStyle} white-space:nowrap;">${char.name}</td>
                    ${rowInfo.replace(/border:1px solid #2a3158/g, borderStyle)}${slotsHtml.replace(/border:1px solid #2a3158/g, borderStyle)}
                    ${mode !== 'EXCEED' ? `<td style="padding:10px; ${borderStyle} font-weight:bold; text-align:center; color:${statusColor};">${displayDistinct}</td>` : ''}
                </tr>`;
                    });
                });
                fullHtml += `</tbody></table>`;
            });

            fullHtml += `</div>`; // ì¹´í…Œê³ ë¦¬ ë‹«ëŠ” íƒœê·¸ ì¶”ê°€
        });

        displayArea.innerHTML = fullHtml;
    }

    // 2. ì „ì²´ í˜„í™© ë Œë”ë§ (ì´ë¦„ ì—´ ë„ˆë¹„ ê³ ì • ë° ìƒ‰ìƒ ì ìš©)
    function renderFullEquipmentTab(mode) {
        // âœ… ìƒíƒœ ì´ˆê¸°í™”
        isCharacterEquipmentViewOpen = false;
        isStatisticsViewOpen = false;
        selectedCharacterForEquipment = null;

        // âœ… ëª¨ë“  ì˜ì—­ ì´ˆê¸°í™”
        document.getElementById("character-selection-area").style.display = "none";
        document.getElementById("character-equipment-detail").style.display = "none";
        document.getElementById("equipment-display-area").style.display = "block";

        const displayArea = document.getElementById("equipment-display-area");
        const CATEGORIES = [
            {name: "ë°©ì–´êµ¬", sets: ARMOR_SETS, prefix: ARMOR_PREFIX, id: 'cat-armor'},
            {name: "ì•…ì„¸", sets: ACCESSORY_SETS, prefix: ACCESSORY_PREFIX, id: 'cat-accessory'},
            {name: "íŠ¹ì¥", sets: SPECIAL_SETS, prefix: SPECIAL_PREFIX, id: 'cat-special'}
        ];

        // ìŠ¤í¬ë¡¤ ë²„íŠ¼ ì¶”ê°€
        let scrollButtonHtml = `<div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">`;
        CATEGORIES.forEach(cat => {
            scrollButtonHtml += `<button class="char-btn" style="background: #4a33cc; border: 1px solid #ffd700;"
                            onclick="scrollToCategory('${cat.id}')">${cat.name}ë¡œ ì´ë™ â†’</button>`;
        });
        scrollButtonHtml += `</div>`;

        let fullHtml = scrollButtonHtml + `<h2 style="color:#ffd700; margin-bottom:20px;">ğŸŒ ì•„ì´í…œë³„ ì „ì²´ í˜„í™© (${mode})</h2>`;

        CATEGORIES.forEach(cat => {
            fullHtml += `<div id="${cat.id}" style="margin-bottom: 50px; padding-top: 20px; border-top: 3px solid #4a33cc;">`;
            fullHtml += `<h2 style="color:#ffd700; font-size: 24px; margin-bottom: 15px;">ğŸ”¹ ${cat.name}</h2>`;

            Object.keys(cat.sets).forEach(baseSetName => {
                const prefixes = cat.prefix[baseSetName] || [];
                let slots = [...cat.sets[baseSetName]];
                let targetGroups = [];

                if (mode === 'NORMAL') {
                    targetGroups.push({display: baseSetName, full: baseSetName, type: 'NORMAL'});
                } else if (mode === 'PREFIX') {
                    prefixes.forEach(p => targetGroups.push({
                        display: p,
                        full: `${p}: ${baseSetName}`,
                        type: 'PREFIX'
                    }));
                } else if (mode === 'EXCEED') {
                    slots = slots.filter(s => s === "ìƒì˜" || s === "íŒ”ì°Œ" || s === "ê·€ê±¸ì´");
                    if (slots.length === 0) return;

                    // ğŸ’¡ ê¸°ì¡´ ë¡œì§ (ì ‘ë‘ì–´ ìˆëŠ” ìµì‹œë“œ)
                    if (prefixes.length > 0) {
                        prefixes.forEach(p => {
                            EXCEED_TAGS.forEach(tag => targetGroups.push({
                                display: p,
                                full: `${p}: ${baseSetName}`,
                                tag: tag,
                                type: 'EXCEED'
                            }));
                        });
                    } else {
                        // ğŸ’¡ ì‹ ê·œ ì¶”ê°€: ì ‘ë‘ì–´ ì—†ëŠ” ìµì‹œë“œ (ë ˆê±°ì‹œ ì¥ë¹„)
                        const isExceedOnlyArmor = (typeof ARMOR_EXCEED_ONLY !== 'undefined' && ARMOR_EXCEED_ONLY.includes(baseSetName));
                        const isExceedOnlyAccessory = (typeof ACCESSORY_EXCEED_ONLY !== 'undefined' && ACCESSORY_EXCEED_ONLY.includes(baseSetName));

                        if (isExceedOnlyArmor || isExceedOnlyAccessory) {
                            EXCEED_TAGS.forEach(tag => targetGroups.push({
                                display: "ë ˆê±°ì‹œ",
                                full: baseSetName,
                                tag: tag,
                                type: 'EXCEED'
                            }));
                        }
                    }
                }

                if (targetGroups.length === 0) return;

                // í•´ë‹¹ ì„¸íŠ¸ ë°ì´í„° ì¡´ì¬ ì—¬ë¶€ í™•ì¸
                const hasData = targetGroups.some(group => {
                    const searchKeyBase = group.tag ? `[${group.tag}] ${group.full}` : group.full;
                    return characters.some(c => slots.some(slot => (c.armorCounts?.[`${searchKeyBase} ${slot}`] || 0) > 0));
                });
                if (!hasData) return;

                fullHtml += `<h3 style="color:#fff; margin-top:30px; margin-bottom:10px;">[${baseSetName} ì„¸íŠ¸]</h3>`;

                fullHtml += `<table style="width: max-content; border-collapse: collapse; margin-bottom: 20px; border: 1px solid #2a3158;">
                <thead style="background:#181c33;"><tr>
                    <th style="padding:10px; border:1px solid #2a3158; color:#fff; text-align:center; white-space:nowrap;">ì•„ì´í…œ ì„¸íŠ¸ ì´ë¦„</th>
                    ${slots.map(s => `<th style="padding:10px; border:1px solid #2a3158; color:#fff; text-align:center; white-space:nowrap; min-width:180px;">${s}</th>`).join('')}
                </tr></thead><tbody>`;

                targetGroups.forEach(group => {
                    const searchKeyBase = group.tag ? `[${group.tag}] ${group.full}` : group.full;

                    // ğŸ’¡ ì ‘ë‘ì–´ ì¥ë¹„ì¼ ë•Œë§Œ ëª¨ë“  ìŠ¬ë¡¯ ë³´ìœ  ì—¬ë¶€ë¥¼ ì²´í¬
                    const isFullPrefixSet = (group.type === 'PREFIX') && slots.every(slot =>
                        characters.some(c => (c.armorCounts?.[`${searchKeyBase} ${slot}`] || 0) > 0)
                    );

                    const rowBg = isFullPrefixSet ? "#5c4d00" : "#0f1222";
                    const labelBg = isFullPrefixSet ? "#7a6700" : "#111529";

                    let relevantOwners = characters.filter(c => {
                        return slots.some(slot => (c.armorCounts?.[`${searchKeyBase} ${slot}`] || 0) > 0);
                    });

                    let displayName = "";
                    if (group.type === 'EXCEED' || group.type === 'PREFIX') {
                        displayName = `<span style="color:#ffd700; font-weight:bold;">${group.display}</span>: <span style="color:#fff;">${baseSetName}</span>`;
                        if (group.tag) {
                            const tagColor = EXCEED_COLOR_MAP[group.tag] || "#ffd700";
                            displayName = `<span style="color:${tagColor}; font-weight:bold;">[${group.tag}]</span> ` + displayName;
                        }
                    } else {
                        displayName = `<span style="color:#fff;">${group.full}</span>`;
                    }

                    fullHtml += `<tr style="background: ${rowBg};">
                <td style="padding:12px; border:1px solid #2a3158; background:${labelBg}; vertical-align:middle; text-align:center; white-space:nowrap; color:#fff; font-size:14px;">${displayName}</td>`;

                    slots.forEach(slot => {
                        fullHtml += `<td style="padding:8px; border:1px solid #2a3158; vertical-align:middle; text-align:center;">`;

                        if (mode === 'EXCEED') {
                            // ğŸ’¡ ìµì‹œë“œ: ê°€ë¡œì¤„ ë§ì¶”ì§€ ì•Šê³  ë°ì´í„°ê°€ ìˆëŠ” ìºë¦­í„°ë§Œ ì´˜ì´˜í•˜ê²Œ ì¶œë ¥
                            const ownersWithItem = characters.filter(c => (c.armorCounts?.[`${searchKeyBase} ${slot}`] || 0) > 0);
                            if (ownersWithItem.length > 0) {
                                ownersWithItem.forEach(owner => {
                                    const count = owner.armorCounts[`${searchKeyBase} ${slot}`];
                                    fullHtml += `<div style="margin:4px 0; white-space:nowrap; font-size:14px;">
                                    <span style="color:#aaa;">${owner.job}</span>
                                    <span style="color:#fff; font-weight:bold;">(${owner.name})</span>
                                    <span style="color:#ffd700; font-weight:bold;">[${count}]</span>
                                </div>`;
                                });
                            } else {
                                fullHtml += `<span style="color:#444;">0</span>`;
                            }
                        } else {
                            // ğŸ’¡ ì¼ë°˜/ì ‘ë‘ì–´: ëª¨ë“  ìºë¦­í„°ì˜ ìë¦¬ë¥¼ ë§Œë“¤ì–´ ê°€ë¡œì¤„ ë¼ì¸ì„ ë§ì¶¤ (30px ê³ ì •)
                            relevantOwners.forEach(owner => {
                                const count = owner.armorCounts?.[`${searchKeyBase} ${slot}`] || 0;
                                fullHtml += `<div style="height:30px; border-bottom:1px solid rgba(255,255,255,0.05); display:flex; justify-content:center; align-items:center; gap:8px; white-space:nowrap; padding: 0 10px; font-size:14px;">`;
                                if (count > 0) {
                                    fullHtml += `<span style="color:#aaa;">${owner.job}</span>
                                             <span style="color:#fff; font-weight:bold;">(${owner.name})</span>
                                             <span style="color:#ffd700; font-weight:bold;">[${count}]</span>`;
                                } else {
                                    fullHtml += `<span style="color:#444;">0</span>`;
                                }
                                fullHtml += `</div>`;
                            });
                        }
                        fullHtml += `</td>`;
                    });
                    fullHtml += `</tr>`;
                });
                fullHtml += `</tbody></table>`;
            });
            fullHtml += `</div>`; // ì¹´í…Œê³ ë¦¬ ë‹«ëŠ” íƒœê·¸ ì¶”ê°€
        });

        displayArea.innerHTML = fullHtml;
    }

    // ì¥ë¹„ ê´€ë¦¬ ë²„íŠ¼ í™œì„±í™” ë¡œì§ (ë¬´ê¸° ê´€ë¦¬ ë°©ì‹ ì°¸ì¡°)
    function setActiveEquipmentButton(clickedBtn) {
        // 1. ì¥ë¹„ ê´€ë¦¬ ì„¹ì…˜(#section-equipment-view) ì „ì²´ì—ì„œ ëª¨ë“  char-btnì„ ì°¾ìŒ
        const allEquipmentButtons = document.querySelectorAll("#section-equipment-view .char-btn");

        // 2. ëª¨ë“  ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±° (ë¶ˆë¹› ë„ê¸°)
        allEquipmentButtons.forEach(btn => btn.classList.remove('active'));

        // 3. í˜„ì¬ í´ë¦­í•œ ë²„íŠ¼ì—ë§Œ active í´ë˜ìŠ¤ ì¶”ê°€ (ë¶ˆë¹› ì¼œê¸°)
        if (clickedBtn) {
            clickedBtn.classList.add('active');
        }
    }

    function scrollToCategory(categoryId) {
        const element = document.getElementById(categoryId);
        if (element) {
            element.scrollIntoView({ behavior: 'smooth' });
        }
    }

    /* ========================================
   7-5. ìºë¦­í„°ë³„ ì¥ë¹„ ë³´ìœ  í˜„í™©
   ======================================== */
    let isCharacterEquipmentViewOpen = false;
    let selectedCharacterForEquipment = null;
    let isStatisticsViewOpen = false;  // í†µê³„ í™”ë©´ ìƒíƒœ ì¶”ê°€

    // ìºë¦­í„°ë³„ ì¥ë¹„ ë³´ìœ  í˜„í™© í† ê¸€
    function toggleCharacterEquipmentView() {
        const selectionArea = document.getElementById("character-selection-area");
        const detailArea = document.getElementById("character-equipment-detail");
        const displayArea = document.getElementById("equipment-display-area");

        // âœ… í†µê³„ í™”ë©´ ë‹«ê¸°
        isStatisticsViewOpen = false;

        // í† ê¸€
        isCharacterEquipmentViewOpen = !isCharacterEquipmentViewOpen;

        if (isCharacterEquipmentViewOpen) {
            // ì—´ê¸°
            displayArea.style.display = "none";
            selectionArea.style.display = "block";
            detailArea.style.display = "none";

            // ìºë¦­í„° ë²„íŠ¼ ë Œë”ë§
            renderCharacterButtons();

            // âœ… ëª¨ë“  ì¥ë¹„ ê´€ë¦¬ ë²„íŠ¼ ë¹„í™œì„±í™”
            document.querySelectorAll("#section-equipment-view .equipment-button-row .char-btn").forEach(btn => {
                btn.classList.remove('active');
            });
        } else {
            // ë‹«ê¸°
            selectionArea.style.display = "none";
            detailArea.style.display = "none";
            displayArea.style.display = "block";

            // ê¸°ë³¸ í™”ë©´ìœ¼ë¡œ ë³µê·€
            renderEquipmentTab('ALL');

            // âœ… ì²« ë²ˆì§¸ ë²„íŠ¼(ëª¨ë‘) í™œì„±í™”
            const firstBtn = document.querySelector("#section-equipment-view .equipment-button-row .char-btn");
            if (firstBtn) {
                firstBtn.classList.add('active');
            }
        }
    }

    // ìºë¦­í„° ë²„íŠ¼ ë Œë”ë§
    function renderCharacterButtons() {
        const buttonArea = document.getElementById("character-buttons-area");
        buttonArea.innerHTML = "";

        characters.forEach(char => {
            const btn = document.createElement("button");
            btn.className = "char-btn";
            btn.textContent = `${char.job} (${char.name})`;
            btn.style.minWidth = "150px";

            if (selectedCharacterForEquipment === char.id) {
                btn.classList.add("active");
            }

            btn.onclick = () => {
                selectedCharacterForEquipment = char.id;
                renderCharacterButtons(); // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ê°±ì‹ 
                renderCharacterEquipmentDetail(char);
            };

            buttonArea.appendChild(btn);
        });
    }

    // ìºë¦­í„° ì¥ë¹„ ìƒì„¸ í˜„í™© ë Œë”ë§
    function renderCharacterEquipmentDetail(char) {
        const detailArea = document.getElementById("character-equipment-detail");
        detailArea.style.display = "block";

        let html = `<h2 style="color: #ffd700; margin-bottom: 20px;">${char.job} (${char.name}) - ì¥ë¹„ ë³´ìœ  í˜„í™©</h2>`;

        const CATEGORIES = [
            {
                title: "ë°©ì–´êµ¬",
                sets: ARMOR_SETS,
                prefix: ARMOR_PREFIX,
                exceedOnly: ARMOR_EXCEED_ONLY,
                exceedSlot: "ìƒì˜"
            },
            {
                title: "ì•…ì„¸",
                sets: ACCESSORY_SETS,
                prefix: ACCESSORY_PREFIX,
                exceedOnly: ACCESSORY_EXCEED_ONLY,
                exceedSlot: "íŒ”ì°Œ"
            },
            {
                title: "íŠ¹ì¥",
                sets: SPECIAL_SETS,
                prefix: SPECIAL_PREFIX,
                exceedOnly: [],
                exceedSlot: "ê·€ê±¸ì´"
            }
        ];

        CATEGORIES.forEach(category => {
            // âœ… ì¹´í…Œê³ ë¦¬ë³„ ì´ ê°œìˆ˜ ê³„ì‚°
            let categoryTotal = 0;
            Object.keys(category.sets).forEach(baseSetName => {
                const setSlots = category.sets[baseSetName];
                const prefixes = category.prefix[baseSetName] || [];
                const isExceedOnly = category.exceedOnly.includes(baseSetName);

                // ì¼ë°˜ ì¥ë¹„ ê°œìˆ˜
                setSlots.forEach(slot => {
                    const normalKey = `${baseSetName} ${slot}`;
                    categoryTotal += char.armorCounts[normalKey] || 0;
                });

                // ì ‘ë‘ì–´ ì¥ë¹„ ê°œìˆ˜
                prefixes.forEach(pref => {
                    setSlots.forEach(slot => {
                        const prefixKey = `${pref}: ${baseSetName} ${slot}`;
                        categoryTotal += char.armorCounts[prefixKey] || 0;
                    });
                });

                // ìµì‹œë“œ ì¥ë¹„ ê°œìˆ˜
                EXCEED_TAGS.forEach(tag => {
                    if (isExceedOnly) {
                        // ë ˆê±°ì‹œ ì¥ë¹„
                        setSlots.forEach(slot => {
                            const exceedKey = `[${tag}] ${baseSetName} ${slot}`;
                            categoryTotal += char.armorCounts[exceedKey] || 0;
                        });
                    } else {
                        // ì¼ë°˜ ì¥ë¹„
                        prefixes.forEach(pref => {
                            setSlots.forEach(slot => {
                                const exceedKey = `[${tag}] ${pref}: ${baseSetName} ${slot}`;
                                categoryTotal += char.armorCounts[exceedKey] || 0;
                            });
                        });
                    }
                });
            });

            // âœ… ì œëª©ì— ì´ ê°œìˆ˜ í‘œì‹œ
            html += `<h2 style="color: #ffd700; margin-bottom: 15px;">ğŸ”¹ ${category.title} <span style="color: #ffd700; font-weight: bold;">(${categoryTotal}ê°œ)</span></h2>`;

            html += `<table style="width: max-content; border-collapse: collapse; margin-bottom: 30px;">`;

            // í—¤ë”
            const slots = Object.values(category.sets)[0] || [];
            html += `<thead style="background: #181c33;"><tr>
            <th style="padding: 10px; border: 1px solid #2a3158; white-space: nowrap; text-align: center;">ì„¸íŠ¸</th>
            <th style="padding: 10px; border: 1px solid #2a3158; white-space: nowrap;">ìµì‹œë“œ</th>
            <th style="padding: 10px; border: 1px solid #2a3158; white-space: nowrap;">ì ‘ë‘ì–´</th>`;

            slots.forEach(slot => {
                html += `<th style="padding: 10px; border: 1px solid #2a3158; white-space: nowrap;">${slot}</th>`;
            });

            html += `</tr></thead><tbody>`;

            // ê° ì„¸íŠ¸ë³„ ë°ì´í„°
            Object.keys(category.sets).forEach(baseSetName => {
                const setSlots = category.sets[baseSetName];
                const prefixes = category.prefix[baseSetName] || [];
                const isExceedOnly = category.exceedOnly.includes(baseSetName);
                const exceedSlot = category.exceedSlot;

                // ì„¸íŠ¸ë³„ ë°ì´í„° ìˆ˜ì§‘
                let rows = [];

                // 1. ìµì‹œë“œ í–‰ë“¤ (ì ‘ë‘ì–´ë³„ë¡œ)
                if (isExceedOnly) {
                    // ë ˆê±°ì‹œ ì¥ë¹„: ì ‘ë‘ì–´ ì—†ì´ ìµì‹œë“œë§Œ
                    EXCEED_TAGS.forEach(tag => {
                        let rowData = {
                            type: 'exceed',
                            exceed: tag,
                            prefix: '',
                            slots: {}
                        };

                        setSlots.forEach(slot => {
                            const key = `[${tag}] ${baseSetName} ${slot}`;
                            rowData.slots[slot] = char.armorCounts[key] || 0;
                        });

                        // ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ë§Œ ì¶”ê°€
                        if (Object.values(rowData.slots).some(v => v > 0)) {
                            rows.push(rowData);
                        }
                    });
                } else if (prefixes.length > 0) {
                    // ì¼ë°˜ ì¥ë¹„: ì ‘ë‘ì–´ë³„ ìµì‹œë“œ
                    prefixes.forEach(pref => {
                        EXCEED_TAGS.forEach(tag => {
                            let rowData = {
                                type: 'exceed',
                                exceed: tag,
                                prefix: pref,
                                slots: {}
                            };

                            setSlots.forEach(slot => {
                                const key = `[${tag}] ${pref}: ${baseSetName} ${slot}`;
                                rowData.slots[slot] = char.armorCounts[key] || 0;
                            });

                            // ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ë§Œ ì¶”ê°€
                            if (Object.values(rowData.slots).some(v => v > 0)) {
                                rows.push(rowData);
                            }
                        });
                    });
                }

                // 2. ì ‘ë‘ì–´ í–‰ë“¤
                prefixes.forEach(pref => {
                    let rowData = {
                        type: 'prefix',
                        exceed: '',
                        prefix: pref,
                        slots: {}
                    };

                    setSlots.forEach(slot => {
                        const key = `${pref}: ${baseSetName} ${slot}`;
                        rowData.slots[slot] = char.armorCounts[key] || 0;
                    });

                    // ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ë§Œ ì¶”ê°€
                    if (Object.values(rowData.slots).some(v => v > 0)) {
                        rows.push(rowData);
                    }
                });

                // 3. ì¼ë°˜ í–‰
                let normalRowData = {
                    type: 'normal',
                    exceed: '',
                    prefix: '',
                    slots: {}
                };

                setSlots.forEach(slot => {
                    const key = `${baseSetName} ${slot}`;
                    normalRowData.slots[slot] = char.armorCounts[key] || 0;
                });

                // ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš°ë§Œ ì¶”ê°€
                if (Object.values(normalRowData.slots).some(v => v > 0)) {
                    rows.push(normalRowData);
                }

                // í–‰ì´ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ì´ ì„¸íŠ¸ëŠ” ê±´ë„ˆëœ€
                if (rows.length === 0) return;

                // í…Œì´ë¸” í–‰ ë Œë”ë§
                rows.forEach((row, rowIdx) => {
                    html += `<tr style="border-bottom: 1px solid #444;">`;

                    // ì„¸íŠ¸ëª… (ì²« í–‰ì—ë§Œ rowspanìœ¼ë¡œ í‘œì‹œ)
                    if (rowIdx === 0) {
                        html += `<td rowspan="${rows.length}" style="padding: 10px; border: 1px solid #2a3158; font-weight: bold; background: #1a1e33; text-align: center; vertical-align: middle; white-space: nowrap;">${baseSetName}</td>`;
                    }

                    // ìµì‹œë“œ ì—´
                    if (row.exceed) {
                        const tagColor = EXCEED_COLOR_MAP[row.exceed] || "#ffd700";
                        html += `<td style="padding: 10px; border: 1px solid #2a3158; text-align: center; white-space: nowrap;">
                        <span style="color: ${tagColor}; font-weight: bold;">[${row.exceed}]</span>
                    </td>`;
                    } else {
                        html += `<td style="padding: 10px; border: 1px solid #2a3158; text-align: center;"></td>`;
                    }

                    // ì ‘ë‘ì–´ ì—´
                    if (row.prefix) {
                        html += `<td style="padding: 10px; border: 1px solid #2a3158; text-align: center; white-space: nowrap;">
                        <span style="color: #e6b800; font-weight: bold;">${row.prefix}</span>
                    </td>`;
                    } else {
                        html += `<td style="padding: 10px; border: 1px solid #2a3158; text-align: center;"></td>`;
                    }

                    // ê° ìŠ¬ë¡¯ë³„ ê°œìˆ˜
                    setSlots.forEach(slot => {
                        const count = row.slots[slot] || 0;

                        // ìµì‹œë“œ í–‰ì¸ë° ìµì‹œë“œ ìŠ¬ë¡¯ì´ ì•„ë‹ˆë©´ ë¹ˆì¹¸
                        if (row.type === 'exceed' && slot !== exceedSlot) {
                            html += `<td style="padding: 10px; border: 1px solid #2a3158; text-align: center; background: #0a0c15;"></td>`;
                        } else {
                            const displayCount = count > 0 ? count : "";
                            html += `<td style="padding: 10px; border: 1px solid #2a3158; text-align: center; color: #fff; font-weight: bold;">${displayCount}</td>`;
                        }
                    });

                    html += `</tr>`;
                });

                // ì„¸íŠ¸ êµ¬ë¶„ì„  (ë‘êº¼ìš´ ì„ )
                html += `<tr style="height: 3px; background: #2a3158;"><td colspan="${3 + setSlots.length}" style="padding: 0; border: none;"></td></tr>`;
            });

            html += `</tbody></table>`;
        });

        // âœ… ë¬´ê¸° ì„¹ì…˜ ì¶”ê°€
        if (char.weaponCounts && Object.keys(char.weaponCounts).length > 0) {
            // ë¬´ê¸° ì´ ê°œìˆ˜ ê³„ì‚°
            let totalWeapons = 0;
            Object.values(char.weaponCounts).forEach(count => {
                totalWeapons += count || 0;
            });

            html += `<h2 style="color: #ffd700; margin-top: 40px; margin-bottom: 15px;">ğŸ”¹ ë¬´ê¸° <span style="color: #ffd700; font-weight: bold;">(${totalWeapons}ê°œ)</span></h2>`;

            // ì§ì—…ë³„ë¡œ ë¬´ê¸° ë¶„ë¥˜
            JOB_LIST.forEach(jobName => {
                const jobWeaponData = WEAPON_DATA_MAP[jobName];
                if (!jobWeaponData) return;

                // í•´ë‹¹ ì§ì—…ì˜ ë¬´ê¸°ë¥¼ ë³´ìœ í•˜ê³  ìˆëŠ”ì§€ í™•ì¸
                let hasWeaponsForJob = false;
                const weaponRows = [];

                Object.entries(jobWeaponData).forEach(([category, weaponList]) => {
                    let categoryWeapons = [];

                    weaponList.forEach(weaponName => {
                        WEAPON_PREFIXES.forEach(prefix => {
                            const weaponKey = `${prefix.tag} ${weaponName}`;
                            const count = char.weaponCounts[weaponKey] || 0;

                            if (count > 0) {
                                hasWeaponsForJob = true;
                                categoryWeapons.push({
                                    name: weaponName,
                                    prefix: prefix,
                                    count: count
                                });
                            }
                        });
                    });

                    if (categoryWeapons.length > 0) {
                        weaponRows.push({
                            category: category,
                            weapons: categoryWeapons
                        });
                    }
                });

                // ë¬´ê¸°ê°€ ì—†ìœ¼ë©´ ì´ ì§ì—…ì€ ê±´ë„ˆëœ€
                if (!hasWeaponsForJob) return;

                // ì§ì—…ëª… í—¤ë”
                html += `<h4 style="color: #fff; margin-top: 25px; margin-bottom: 10px;">[${jobName}]</h4>`;

                // ë¬´ê¸° í…Œì´ë¸”
                html += `<table style="width: max-content; border-collapse: collapse; margin-bottom: 20px;">`;
                html += `<thead style="background: #181c33;"><tr>
                <th style="padding: 10px; border: 1px solid #2a3158; white-space: nowrap; text-align: center; width: 100px;">ì¢…ë¥˜</th>
                <th style="padding: 10px; border: 1px solid #2a3158; white-space: nowrap; text-align: left;">ë¬´ê¸° ì´ë¦„</th>
                <th style="padding: 10px; border: 1px solid #2a3158; white-space: nowrap; text-align: center; width: 80px;">ê°œìˆ˜</th>
            </tr></thead><tbody>`;

                weaponRows.forEach(row => {
                    row.weapons.forEach((weapon, idx) => {
                        html += `<tr style="border-bottom: 1px solid #444;">`;

                        // ì¢…ë¥˜ (ì²« ë¬´ê¸°ì—ë§Œ rowspan)
                        if (idx === 0) {
                            html += `<td rowspan="${row.weapons.length}" style="padding: 10px; border: 1px solid #2a3158; font-weight: bold; background: #1a1e33; text-align: center; vertical-align: middle;">${row.category}</td>`;
                        }

                        // ë¬´ê¸° ì´ë¦„ (ì ‘ë‘ì–´ ìƒ‰ìƒ ì ìš©)
                        html += `<td style="padding: 10px; border: 1px solid #2a3158; text-align: left;">
                        <span style="color: ${weapon.prefix.color}; font-weight: bold;">${weapon.prefix.tag}</span> ${weapon.name}
                    </td>`;

                        // ê°œìˆ˜
                        html += `<td style="padding: 10px; border: 1px solid #2a3158; text-align: center; color: #fff; font-weight: bold;">${weapon.count}</td>`;

                        html += `</tr>`;
                    });

                    // ì¢…ë¥˜ êµ¬ë¶„ì„ 
                    html += `<tr style="height: 3px; background: #2a3158;"><td colspan="3" style="padding: 0; border: none;"></td></tr>`;
                });

                html += `</tbody></table>`;
            });
        }

        detailArea.innerHTML = html;
    }

    // ì¥ë¹„ í†µê³„ í‘œì‹œ í•¨ìˆ˜
    function showEquipmentStatistics() {
        // âœ… ìƒíƒœ ì—…ë°ì´íŠ¸
        isCharacterEquipmentViewOpen = false;
        isStatisticsViewOpen = true;
        selectedCharacterForEquipment = null;

        // ê¸°ì¡´ í™”ë©´ ìˆ¨ê¸°ê¸°
        document.getElementById("character-selection-area").style.display = "none";
        document.getElementById("character-equipment-detail").style.display = "none";

        const displayArea = document.getElementById("equipment-display-area");
        displayArea.style.display = "block";

        // âœ… ëª¨ë“  ì¥ë¹„ ê´€ë¦¬ ë²„íŠ¼ ë¹„í™œì„±í™”
        document.querySelectorAll("#section-equipment-view .equipment-button-row .char-btn").forEach(btn => {
            btn.classList.remove('active');
        });

        let html = `<h2 style="color: #ffd700; margin-bottom: 20px;">ğŸ“Š ìºë¦­í„°ë³„ ì¥ë¹„ ë³´ìœ  í†µê³„</h2>`;

        // í†µê³„ í…Œì´ë¸”
        html += `<table style="width: max-content; border-collapse: collapse; margin-bottom: 30px;">`;
        html += `<thead style="background: #181c33;"><tr>
        <th style="padding: 10px; border: 1px solid #2a3158; white-space: nowrap; text-align: center;">ì§ì—…(ì´ë¦„)</th>
        <th style="padding: 10px; border: 1px solid #2a3158; white-space: nowrap; text-align: center;">ë°©ì–´êµ¬</th>
        <th style="padding: 10px; border: 1px solid #2a3158; white-space: nowrap; text-align: center;">ì•…ì„¸</th>
        <th style="padding: 10px; border: 1px solid #2a3158; white-space: nowrap; text-align: center;">íŠ¹ì¥</th>
        <th style="padding: 10px; border: 1px solid #2a3158; white-space: nowrap; text-align: center;">ë¬´ê¸°</th>
        <th style="padding: 10px; border: 1px solid #2a3158; white-space: nowrap; text-align: center;">í•©ê³„</th>
    </tr></thead><tbody>`;

        // ê° ìºë¦­í„°ë³„ í†µê³„
        characters.forEach(char => {
            let armorCount = 0;
            let accessoryCount = 0;
            let specialCount = 0;
            let weaponCount = 0;

            // ë°©ì–´êµ¬/ì•…ì„¸/íŠ¹ì¥ ê°œìˆ˜ ê³„ì‚°
            if (char.armorCounts) {
                Object.entries(char.armorCounts).forEach(([key, count]) => {
                    if (count <= 0) return;

                    const parts = key.split(' ');
                    const slot = parts.pop();
                    const name = parts.join(' ');
                    const groupKey = getGroupKey(name);
                    const setType = getSetType(groupKey);

                    if (setType === "ARMOR") armorCount += count;
                    else if (setType === "ACCESSORY") accessoryCount += count;
                    else if (setType === "SPECIAL") specialCount += count;
                });
            }

            // ë¬´ê¸° ê°œìˆ˜ ê³„ì‚°
            if (char.weaponCounts) {
                Object.values(char.weaponCounts).forEach(count => {
                    weaponCount += count || 0;
                });
            }

            const total = armorCount + accessoryCount + specialCount + weaponCount;

            html += `<tr style="border-bottom: 1px solid #444;">
            <td style="padding: 10px; border: 1px solid #2a3158; text-align: center; font-weight: bold;">${char.job}(${char.name})</td>
            <td style="padding: 10px; border: 1px solid #2a3158; text-align: center; color: #fff; font-weight: bold;">${armorCount}</td>
            <td style="padding: 10px; border: 1px solid #2a3158; text-align: center; color: #fff; font-weight: bold;">${accessoryCount}</td>
            <td style="padding: 10px; border: 1px solid #2a3158; text-align: center; color: #fff; font-weight: bold;">${specialCount}</td>
            <td style="padding: 10px; border: 1px solid #2a3158; text-align: center; color: #fff; font-weight: bold;">${weaponCount}</td>
            <td style="padding: 10px; border: 1px solid #2a3158; text-align: center; color: #ffd700; font-weight: bold;">${total}</td>
        </tr>`;
        });

        // ì „ì²´ í•©ê³„ í–‰
        let totalArmor = 0;
        let totalAccessory = 0;
        let totalSpecial = 0;
        let totalWeapon = 0;

        characters.forEach(char => {
            if (char.armorCounts) {
                Object.entries(char.armorCounts).forEach(([key, count]) => {
                    if (count <= 0) return;
                    const parts = key.split(' ');
                    const slot = parts.pop();
                    const name = parts.join(' ');
                    const groupKey = getGroupKey(name);
                    const setType = getSetType(groupKey);

                    if (setType === "ARMOR") totalArmor += count;
                    else if (setType === "ACCESSORY") totalAccessory += count;
                    else if (setType === "SPECIAL") totalSpecial += count;
                });
            }

            if (char.weaponCounts) {
                Object.values(char.weaponCounts).forEach(count => {
                    totalWeapon += count || 0;
                });
            }
        });

        const grandTotal = totalArmor + totalAccessory + totalSpecial + totalWeapon;

        html += `<tr style="background: #1a1e33; border-top: 3px solid #ffd700;">
        <td style="padding: 10px; border: 1px solid #2a3158; text-align: center; font-weight: bold; color: #ffd700;">ì „ì²´ í•©ê³„</td>
        <td style="padding: 10px; border: 1px solid #2a3158; text-align: center; color: #ffd700; font-weight: bold;">${totalArmor}</td>
        <td style="padding: 10px; border: 1px solid #2a3158; text-align: center; color: #ffd700; font-weight: bold;">${totalAccessory}</td>
        <td style="padding: 10px; border: 1px solid #2a3158; text-align: center; color: #ffd700; font-weight: bold;">${totalSpecial}</td>
        <td style="padding: 10px; border: 1px solid #2a3158; text-align: center; color: #ffd700; font-weight: bold;">${totalWeapon}</td>
        <td style="padding: 10px; border: 1px solid #2a3158; text-align: center; color: #ffd700; font-weight: bold; font-size: 1.1em;">${grandTotal}</td>
    </tr>`;

        html += `</tbody></table>`;

        displayArea.innerHTML = html;
    }

    /* ========================================
   7-6. ì¥ë¹„ ê²€ìƒ‰ ê¸°ëŠ¥
   ======================================== */
    function searchEquipment() {
        const searchInput = document.getElementById("equipment-search-input");
        const searchTerm = searchInput.value.trim();

        if (!searchTerm) {
            alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
        }

        // âœ… ìƒíƒœ ì—…ë°ì´íŠ¸
        isCharacterEquipmentViewOpen = false;
        isStatisticsViewOpen = false;
        selectedCharacterForEquipment = null;

        // ê¸°ì¡´ í™”ë©´ ìˆ¨ê¸°ê¸°
        document.getElementById("character-selection-area").style.display = "none";
        document.getElementById("character-equipment-detail").style.display = "none";

        const displayArea = document.getElementById("equipment-display-area");
        displayArea.style.display = "block";

        // âœ… ëª¨ë“  ì¥ë¹„ ê´€ë¦¬ ë²„íŠ¼ ë¹„í™œì„±í™”
        document.querySelectorAll("#section-equipment-view .equipment-button-row .char-btn").forEach(btn => {
            btn.classList.remove('active');
        });

        let html = `<h2 style="color: #ffd700; margin-bottom: 20px;">ğŸ” ê²€ìƒ‰ ê²°ê³¼: "${searchTerm}"</h2>`;

        const CATEGORIES = [
            {name: "ë°©ì–´êµ¬", sets: ARMOR_SETS, prefix: ARMOR_PREFIX, exceedOnly: ARMOR_EXCEED_ONLY},
            {name: "ì•…ì„¸", sets: ACCESSORY_SETS, prefix: ACCESSORY_PREFIX, exceedOnly: ACCESSORY_EXCEED_ONLY},
            {name: "íŠ¹ì¥", sets: SPECIAL_SETS, prefix: SPECIAL_PREFIX, exceedOnly: []}
        ];

        let foundSets = [];

        // ê²€ìƒ‰ì–´ì™€ ì¼ì¹˜í•˜ëŠ” ì„¸íŠ¸ ì°¾ê¸°
        CATEGORIES.forEach(category => {
            Object.keys(category.sets).forEach(baseSetName => {
                if (baseSetName.includes(searchTerm)) {
                    foundSets.push({
                        category: category.name,
                        setName: baseSetName,
                        slots: category.sets[baseSetName],
                        prefixes: category.prefix[baseSetName] || [],
                        exceedOnly: category.exceedOnly
                    });
                }
            });
        });

        if (foundSets.length === 0) {
            html += `<p style="color: #888; font-size: 1.2em; margin-top: 50px; text-align: center;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
            displayArea.innerHTML = html;
            return;
        }

        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        foundSets.forEach(set => {
            html += `<h3 style="color: #fff; margin-top: 30px; margin-bottom: 15px;">[${set.category}] ${set.setName}</h3>`;

            html += `<table style="width: max-content; border-collapse: collapse; margin-bottom: 30px; border: 1px solid #2a3158;">`;
            html += `<thead style="background: #181c33;"><tr>
            <th style="padding: 10px; border: 1px solid #2a3158; white-space: nowrap;">ì§ì—…(ì´ë¦„)</th>
            <th style="padding: 10px; border: 1px solid #2a3158; white-space: nowrap;">ìµì‹œë“œ</th>
            <th style="padding: 10px; border: 1px solid #2a3158; white-space: nowrap;">ì ‘ë‘ì–´</th>`;

            set.slots.forEach(slot => {
                html += `<th style="padding: 10px; border: 1px solid #2a3158; white-space: nowrap;">${slot}</th>`;
            });

            html += `<th style="padding: 10px; border: 1px solid #2a3158; white-space: nowrap;">í•©ê³„</th>`;
            html += `</tr></thead><tbody>`;

            // ìºë¦­í„°ë³„ ë°ì´í„° ìˆ˜ì§‘
            characters.forEach(char => {
                let charRows = [];

                // ìµì‹œë“œ ë°ì´í„° ìˆ˜ì§‘
                const isExceedOnly = set.exceedOnly.includes(set.setName);

                if (isExceedOnly) {
                    // ë ˆê±°ì‹œ ì¥ë¹„ (ì ‘ë‘ì–´ ì—†ìŒ)
                    EXCEED_TAGS.forEach(tag => {
                        let rowData = {type: 'exceed', exceed: tag, prefix: '', slots: {}, total: 0};

                        set.slots.forEach(slot => {
                            const key = `[${tag}] ${set.setName} ${slot}`;
                            const count = char.armorCounts?.[key] || 0;
                            rowData.slots[slot] = count;
                            rowData.total += count;
                        });

                        if (rowData.total > 0) charRows.push(rowData);
                    });
                } else if (set.prefixes.length > 0) {
                    // ì¼ë°˜ ì¥ë¹„ (ì ‘ë‘ì–´ ìˆìŒ)
                    set.prefixes.forEach(pref => {
                        EXCEED_TAGS.forEach(tag => {
                            let rowData = {type: 'exceed', exceed: tag, prefix: pref, slots: {}, total: 0};

                            set.slots.forEach(slot => {
                                const key = `[${tag}] ${pref}: ${set.setName} ${slot}`;
                                const count = char.armorCounts?.[key] || 0;
                                rowData.slots[slot] = count;
                                rowData.total += count;
                            });

                            if (rowData.total > 0) charRows.push(rowData);
                        });
                    });
                }

                // ì ‘ë‘ì–´ ë°ì´í„° ìˆ˜ì§‘
                set.prefixes.forEach(pref => {
                    let rowData = {type: 'prefix', exceed: '', prefix: pref, slots: {}, total: 0};

                    set.slots.forEach(slot => {
                        const key = `${pref}: ${set.setName} ${slot}`;
                        const count = char.armorCounts?.[key] || 0;
                        rowData.slots[slot] = count;
                        rowData.total += count;
                    });

                    if (rowData.total > 0) charRows.push(rowData);
                });

                // ì¼ë°˜ ë°ì´í„° ìˆ˜ì§‘
                let normalRow = {type: 'normal', exceed: '', prefix: '', slots: {}, total: 0};

                set.slots.forEach(slot => {
                    const key = `${set.setName} ${slot}`;
                    const count = char.armorCounts?.[key] || 0;
                    normalRow.slots[slot] = count;
                    normalRow.total += count;
                });

                if (normalRow.total > 0) charRows.push(normalRow);

                // í–‰ì´ ì—†ìœ¼ë©´ ì´ ìºë¦­í„°ëŠ” ê±´ë„ˆëœ€
                if (charRows.length === 0) return;

                // í…Œì´ë¸” í–‰ ë Œë”ë§
                charRows.forEach((row, rowIdx) => {
                    html += `<tr style="border-bottom: 1px solid #444;">`;

                    // ìºë¦­í„° ì´ë¦„ (ì²« í–‰ì—ë§Œ rowspan)
                    if (rowIdx === 0) {
                        html += `<td rowspan="${charRows.length}" style="padding: 10px; border: 1px solid #2a3158; font-weight: bold; background: #1a1e33; text-align: center; vertical-align: middle; white-space: nowrap;">${char.job}(${char.name})</td>`;
                    }

                    // ìµì‹œë“œ ì—´
                    if (row.exceed) {
                        const tagColor = EXCEED_COLOR_MAP[row.exceed] || "#ffd700";
                        html += `<td style="padding: 10px; border: 1px solid #2a3158; text-align: center; white-space: nowrap;">
                        <span style="color: ${tagColor}; font-weight: bold;">[${row.exceed}]</span>
                    </td>`;
                    } else {
                        html += `<td style="padding: 10px; border: 1px solid #2a3158;"></td>`;
                    }

                    // ì ‘ë‘ì–´ ì—´
                    if (row.prefix) {
                        html += `<td style="padding: 10px; border: 1px solid #2a3158; text-align: center; white-space: nowrap;">
                        <span style="color: #e6b800; font-weight: bold;">${row.prefix}</span>
                    </td>`;
                    } else {
                        html += `<td style="padding: 10px; border: 1px solid #2a3158;"></td>`;
                    }

                    // ìŠ¬ë¡¯ë³„ ê°œìˆ˜
                    set.slots.forEach(slot => {
                        const count = row.slots[slot] || 0;
                        const displayCount = count > 0 ? count : "";
                        html += `<td style="padding: 10px; border: 1px solid #2a3158; text-align: center; color: #fff; font-weight: bold;">${displayCount}</td>`;
                    });

                    // í•©ê³„
                    html += `<td style="padding: 10px; border: 1px solid #2a3158; text-align: center; color: #ffd700; font-weight: bold;">${row.total}</td>`;

                    html += `</tr>`;
                });

                // ìºë¦­í„° êµ¬ë¶„ì„ 
                html += `<tr style="height: 3px; background: #666;"><td colspan="${4 + set.slots.length}" style="padding: 0; border: none;"></td></tr>`;
            });

            html += `</tbody></table>`;
        });

        displayArea.innerHTML = html;
    }

    // âœ… Enter í‚¤ë¡œë„ ê²€ìƒ‰ ê°€ëŠ¥í•˜ë„ë¡ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì´ˆê¸°í™” ì„¹ì…˜ì— ì¶”ê°€)
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById("equipment-search-input");
        if (searchInput) {
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchEquipment();
                }
            });
        }
    });

    /* ========================================
       8. ë¬´ê¸° ê´€ë¦¬
       ======================================== */
    // 8-1. ë¬´ê¸° ë Œë”ë§
    // ===== ë¬´ê¸° ì§ì—… ì„ íƒ ë° ë²„íŠ¼ ê°±ì‹  (ì¢…ë¥˜ ì—´ ë„ˆë¹„ ê³ ì • ë° ì •ì¤‘ì•™ ì •ë ¬) =====
    function selectWeaponJob(jobName, keepOpen = false) {
        const weaponPanel = document.getElementById("weaponPanel");
        const container = document.getElementById("weaponJobButtons");

        if (!keepOpen && activeWeaponJob === jobName) {
            activeWeaponJob = null;
            weaponPanel.innerHTML = "";
            selectWeaponJob(null);
            return;
        }

        activeWeaponJob = jobName;

        // 1. ìƒë‹¨ ì§ì—… ë²„íŠ¼ ìƒì„± ë° ì‹¤ì‹œê°„ í•©ì‚°
        container.innerHTML = "";
        JOB_LIST.forEach(j => {
            let totalCount = 0;
            const jobData = WEAPON_DATA_MAP[j];
            if (jobData) {
                characters.forEach(char => {
                    if (char.weaponCounts) {
                        Object.values(jobData).forEach(weaponList => {
                            weaponList.forEach(weaponName => {
                                WEAPON_PREFIXES.forEach(pref => {
                                    const weaponKey = `${pref.tag} ${weaponName}`;
                                    totalCount += (char.weaponCounts[weaponKey] || 0);
                                });
                            });
                        });
                    }
                });
            }
            const btn = document.createElement("button");
            btn.className = "char-btn" + (j === activeWeaponJob ? " active" : "");
            btn.textContent = `${j} (${totalCount})`;
            btn.onclick = () => selectWeaponJob(j);
            container.appendChild(btn);
        });

        if (!jobName) return;

        const currentData = WEAPON_DATA_MAP[jobName];
        if (!currentData) {
            weaponPanel.innerHTML = `<h3 style="margin-top:20px;">${jobName} ë°ì´í„°ëŠ” ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.</h3>`;
            return;
        }

        let html = `<div style="overflow-x: auto; margin-top: 20px; border: 1px solid #2a3158;">`;
        html += `<table id="weaponDetailTable" style="table-layout: fixed; border-collapse: collapse; width: max-content;">`; // fixed ë ˆì´ì•„ì›ƒ ê¶Œì¥
        html += `<thead><tr style="background: #181c33;">`;

        // ğŸ’¡ 1. ì¢…ë¥˜ ì—´ì˜ ë„ˆë¹„ë¥¼ 120pxë¡œ ê³ ì • (ê°€ì¥ ê¸´ ê¸€ìì¸ 'ìë™ê¶Œì´' ë“±ì„ ê³ ë ¤)
        html += `<th style="width: 120px; padding: 12px; border: 1px solid #2a3158; white-space: nowrap;">ì¢…ë¥˜</th>`;
        html += `<th style="width: 300px; padding: 12px; border: 1px solid #2a3158; white-space: nowrap;">ë¬´ê¸° ì´ë¦„</th>`;

        characters.forEach((char, idx) => {
            const colIdx = idx + 2;
            html += `<th onclick="toggleColumnHighlight(${colIdx})" style="width: 100px; padding: 12px; border: 1px solid #2a3158; white-space: nowrap; text-align: center; cursor: pointer; user-select: none;">${char.job}<br>${char.name}</th>`;
        });
        html += `</tr></thead><tbody>`;

        // ---------------------------------------------------------
        // ğŸ’¡ ì¢…ë¥˜ë³„ ë£¨í”„ (ì •ì¤‘ì•™ ì •ë ¬ ë° ê³ ì • ë„ˆë¹„ ì ìš©)
        // ---------------------------------------------------------
        const categories = Object.keys(currentData);

        categories.forEach((category, cIdx) => {
            const weaponList = currentData[category];
            const rowSpanCount = weaponList.length * WEAPON_PREFIXES.length;

            weaponList.forEach((weaponName, wIdx) => {
                WEAPON_PREFIXES.forEach((pref, pIdx) => {
                    const rowId = `weapon-row-${categories.indexOf(category)}-${wIdx}-${pIdx}`;
                    html += `<tr id="${rowId}" onclick="toggleRowHighlight('${rowId}')">`;

                    // ğŸ’¡ ì¢…ë¥˜ ì…€: ê°€ë¡œ/ì„¸ë¡œ ì •ì¤‘ì•™ + ë„ˆë¹„ ê³ ì • ì ìš©
                    if (wIdx === 0 && pIdx === 0) {
                        html += `<td rowspan="${rowSpanCount}" style="background:#181c33; font-weight:bold; width: 120px; border: 1px solid #2a3158; text-align:center; vertical-align: middle; color: #fff; padding: 10px;">${category}</td>`;
                    }

                    const styledName = `<span style="color:${pref.color}; font-weight:bold;">${pref.tag}</span>&nbsp;${weaponName}`;
                    html += `<td style="text-align:left; padding: 8px 15px; white-space: nowrap; border: 1px solid #2a3158; cursor: pointer;">${styledName}</td>`;

                    characters.forEach(char => {
                        const weaponKey = `${pref.tag} ${weaponName}`;
                        const val = (char.weaponCounts && char.weaponCounts[weaponKey]) || 0;
                        html += `<td style="padding: 5px; border: 1px solid #2a3158; text-align:center;">${makeWeaponNumberButton(char.id, weaponKey, val, jobName)}</td>`;
                    });
                    html += `</tr>`;
                });
            });

            // ì¹´í…Œê³ ë¦¬ ê°„ êµ¬ë¶„ ê³µë°± (íˆ¬ëª…)
            if (cIdx < categories.length - 1) {
                html += `<tr style="height: 20px;">`;
                html += `<td colspan="${characters.length + 2}" style="border: none; border-bottom: 1px solid #2a3158; background: transparent;"></td>`;
                html += `</tr>`;
            }
        });

        html += `</tbody></table></div>`;
        weaponPanel.innerHTML = html;

        if (typeof applyStoredHighlights === "function") {
            applyStoredHighlights();
        }
    }

    // ë¬´ê¸° ì „ìš© ìˆ«ì ë²„íŠ¼ ìƒì„± í•¨ìˆ˜ (ê¸°ì¡´ makeNumberButton ë³µì‚¬ ë° ìˆ˜ì •)
    function makeWeaponNumberButton(charId, key, val, jobName) {
        const extraClass = val > 0 ? " positive" : "";
        return `<button class="num-btn${extraClass}"
      oncontextmenu="decrementWeapon('${charId}','${key}', '${jobName}'); return false;"
      onclick="incrementWeapon('${charId}','${key}', '${jobName}')">${val}</button>`;
    }

    // 8-2. ë¬´ê¸° ì¦ê°
    // ë¬´ê¸° ì „ìš© ì¦ê°€ í•¨ìˆ˜
    function incrementWeapon(charId, key, jobName) {
        const char = characters.find(c => c.id === charId);
        if (!char) return;
        if (!char.weaponCounts) char.weaponCounts = {};

        char.weaponCounts[key] = (char.weaponCounts[key] || 0) + 1;
        char.updateTimes[key] = Date.now();

        saveLocalData();

        // ğŸ’¡ ì „ì²´ í…Œì´ë¸” ì¬ë Œë”ë§ ëŒ€ì‹  í•´ë‹¹ ë²„íŠ¼ë§Œ ì—…ë°ì´íŠ¸
        updateWeaponButton(charId, key, char.weaponCounts[key]);
    }

    // ë¬´ê¸° ì „ìš© ê°ì†Œ í•¨ìˆ˜
    function decrementWeapon(charId, key, jobName) {
        const char = characters.find(c => c.id === charId);
        if (!char) return;
        if (!char.weaponCounts) char.weaponCounts = {};

        const cur = char.weaponCounts[key] || 0;
        char.weaponCounts[key] = Math.max(0, cur - 1);
        char.updateTimes[key] = Date.now();

        saveLocalData();

        // ğŸ’¡ ì „ì²´ í…Œì´ë¸” ì¬ë Œë”ë§ ëŒ€ì‹  í•´ë‹¹ ë²„íŠ¼ë§Œ ì—…ë°ì´íŠ¸
        updateWeaponButton(charId, key, char.weaponCounts[key]);
    }

    // ğŸ’¡ ë¬´ê¸° ë²„íŠ¼ë§Œ ì—…ë°ì´íŠ¸í•˜ëŠ” í—¬í¼ í•¨ìˆ˜ (ì „ì²´ í…Œì´ë¸” ì¬ë Œë”ë§ ë°©ì§€)
    function updateWeaponButton(charId, key, newValue) {
        // í•´ë‹¹ ë²„íŠ¼ì„ ì°¾ì•„ì„œ ë‚´ìš©ê³¼ ìŠ¤íƒ€ì¼ë§Œ ì—…ë°ì´íŠ¸
        const table = document.getElementById("weaponDetailTable");
        if (!table) return;

        const buttons = table.querySelectorAll('.num-btn');
        buttons.forEach(btn => {
            // onclick ì†ì„±ì—ì„œ charIdì™€ keyê°€ ì¼ì¹˜í•˜ëŠ” ë²„íŠ¼ ì°¾ê¸°
            const onclickStr = btn.getAttribute('onclick') || '';
            if (onclickStr.includes(`'${charId}'`) && onclickStr.includes(`'${key}'`)) {
                btn.textContent = newValue;
                // positive í´ë˜ìŠ¤ í† ê¸€
                if (newValue > 0) {
                    btn.classList.add('positive');
                } else {
                    btn.classList.remove('positive');
                }
            }
        });

        // ìƒë‹¨ ì§ì—… ë²„íŠ¼ì˜ ì´ ê°œìˆ˜ë„ ì—…ë°ì´íŠ¸
        updateWeaponJobTotals();
    }

    // ğŸ’¡ ì§ì—…ë³„ ì´ ê°œìˆ˜ë§Œ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
    function updateWeaponJobTotals() {
        const container = document.getElementById("weaponJobButtons");
        if (!container) return;

        JOB_LIST.forEach(j => {
            let totalCount = 0;
            const jobData = WEAPON_DATA_MAP[j];
            if (jobData) {
                characters.forEach(char => {
                    if (char.weaponCounts) {
                        Object.values(jobData).forEach(weaponList => {
                            weaponList.forEach(weaponName => {
                                WEAPON_PREFIXES.forEach(pref => {
                                    const weaponKey = `${pref.tag} ${weaponName}`;
                                    totalCount += (char.weaponCounts[weaponKey] || 0);
                                });
                            });
                        });
                    }
                });
            }

            // í•´ë‹¹ ì§ì—… ë²„íŠ¼ ì°¾ì•„ì„œ í…ìŠ¤íŠ¸ë§Œ ì—…ë°ì´íŠ¸
            const buttons = container.querySelectorAll('.char-btn');
            buttons.forEach(btn => {
                if (btn.textContent.startsWith(j)) {
                    btn.textContent = `${j} (${totalCount})`;
                }
            });
        });
    }

    // 8-3. ë¬´ê¸° í…Œì´ë¸” ê°•ì¡°
    function toggleRowHighlight(rowId) {
        const table = document.getElementById("weaponDetailTable");
        if (!table) return;

        const rows = table.querySelectorAll('tbody tr');

        // ì´ë¯¸ ì„ íƒëœ í–‰ì„ ë‹¤ì‹œ ëˆ„ë¥´ë©´ í•´ì œ
        if (highlightedRowId === rowId) {
            highlightedRowId = null;
        } else {
            highlightedRowId = rowId;
        }

        // ëª¨ë“  í–‰ì˜ ê°•ì¡° í•´ì œ
        rows.forEach(row => {
            row.style.backgroundColor = "";
        });

        // ì„ íƒëœ í–‰ë§Œ ê°•ì¡°
        if (highlightedRowId) {
            const selectedRow = document.getElementById(highlightedRowId);
            if (selectedRow) {
                selectedRow.style.backgroundColor = "rgba(255, 255, 200, 0.15)";
            }
        }
    }

    function toggleColumnHighlight(colIdx) {
        // ğŸ’¡ ì´ë¯¸ ì„ íƒëœ ì—´ì„ ë‹¤ì‹œ ëˆ„ë¥´ë©´ í•´ì œ, ì•„ë‹ˆë©´ í•´ë‹¹ ì—´ ë²ˆí˜¸ ì €ì¥
        if (highlightedColumnIndex === colIdx) {
            highlightedColumnIndex = null;
        } else {
            highlightedColumnIndex = colIdx;
        }
        applyStoredHighlights();
    }

    function applyStoredHighlights() {
        const table = document.getElementById("weaponDetailTable");
        if (!table) return;

        const rows = table.rows;
        for (let i = 0; i < rows.length; i++) {
            const cells = rows[i].cells;

            // ì¢…ë¥˜/ë¬´ê¸°ì´ë¦„ ì…€ì„ ì œì™¸í•œ ì‹¤ì œ ìºë¦­í„° ë°ì´í„° ì…€ë“¤ì˜ ì‹œì‘ ìœ„ì¹˜ ê³„ì‚°
            const charStartIdx = cells.length - characters.length;

            characters.forEach((_, charIdx) => {
                const currentCellIdx = charStartIdx + charIdx;
                const absoluteColIdx = charIdx + 2; // ìºë¦­í„°ì˜ ê³ ìœ  ìˆœë²ˆ(2ë²ˆë¶€í„° ì‹œì‘)

                if (cells[currentCellIdx]) {
                    // ğŸ’¡ í˜„ì¬ ìˆœë²ˆì´ ì €ì¥ëœ ë‹¨ì¼ ì„ íƒ ì¸ë±ìŠ¤ì™€ ì¼ì¹˜í•  ë•Œë§Œ ê°•ì¡°
                    if (highlightedColumnIndex === absoluteColIdx) {
                        cells[currentCellIdx].style.backgroundColor = "rgba(255, 255, 200, 0.15)";
                    } else {
                        // ê°•ì¡°ë˜ì§€ ì•Šì€ ì…€ì€ ì›ë˜ ìƒ‰ìƒìœ¼ë¡œ ë³µêµ¬
                        cells[currentCellIdx].style.backgroundColor = i === 0 ? "#181c33" : "";
                    }
                }
            });
        }
    }

    /* ========================================
       9. ìµœê·¼ ì—…ë°ì´íŠ¸ ë‚´ì—­
       ======================================== */
    function showRecentUpdates() {
        allUpdatesData = [];

        characters.forEach(char => {
            Object.entries(char.updateTimes).forEach(([fullKey, timestamp]) => {
                if (!timestamp || timestamp <= 0) return;

                if (char.armorCounts && char.armorCounts[fullKey] !== undefined) {
                    const parts = fullKey.split(' ');
                    const slot = parts.pop();
                    const itemName = parts.join(' ');

                    let category = "ë°©ì–´êµ¬";
                    const baseName = itemName.split(':').pop().trim();
                    const setType = getSetType(baseName);
                    if (setType === "ACCESSORY") category = "ì•…ì„¸";
                    else if (setType === "SPECIAL") category = "íŠ¹ì¥";

                    allUpdatesData.push({
                        name: char.name, job: char.job, itemName: itemName,
                        category: category, slot: slot, count: char.armorCounts[fullKey], timestamp: timestamp
                    });
                } else if (char.weaponCounts && char.weaponCounts[fullKey] !== undefined) {
                    let weaponSubCategory = "-";
                    outerLoop:
                        for (const jobData of Object.values(WEAPON_DATA_MAP)) {
                            for (const [catName, list] of Object.entries(jobData)) {
                                if (list.some(name => fullKey.includes(name))) {
                                    weaponSubCategory = catName;
                                    break outerLoop;
                                }
                            }
                        }
                    allUpdatesData.push({
                        name: char.name, job: char.job, itemName: fullKey,
                        category: "ë¬´ê¸°", slot: weaponSubCategory, count: char.weaponCounts[fullKey], timestamp: timestamp
                    });
                }
            });
        });

        allUpdatesData.sort((a, b) => b.timestamp - a.timestamp);

        const modalContent = document.getElementById("updateModalContent");
        if (allUpdatesData.length === 0) {
            modalContent.innerHTML = "<p>ìµœê·¼ ì—…ë°ì´íŠ¸ëœ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>";
            document.getElementById("updatePagination").innerHTML = "";
            document.getElementById("updateModal").style.display = 'flex';
            return;
        }

        currentUpdatePage = 1;
        renderUpdatePage(1);
        document.getElementById("updateModal").style.display = 'flex';
    }

    function renderUpdatePage(pageNum) {
        const modalContent = document.getElementById("updateModalContent");
        const paginationContainer = document.getElementById("updatePagination");

        const startIdx = (pageNum - 1) * ITEMS_PER_PAGE;
        const endIdx = startIdx + ITEMS_PER_PAGE;
        const pageItems = allUpdatesData.slice(startIdx, endIdx);

        const table = document.createElement("table");
        table.style.width = '100%';
        table.innerHTML = `<thead><tr>
    <th style="width:20%;">ì§ì—… / ì´ë¦„</th>
    <th style="width:15%;">ì¢…ë¥˜ (ë¶€ìœ„)</th>
    <th style="width:35%;">ì•„ì´í…œ</th>
    <th style="width:10%;">ë³´ìœ  ê°œìˆ˜</th>
    <th style="width:20%;">ì—…ë°ì´íŠ¸ ì‹œê°„</th>
</tr></thead><tbody></tbody>`;

        const tbody = table.querySelector("tbody");

        pageItems.forEach(item => {
            const date = new Date(item.timestamp);
            const formatTime = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')} ${String(date.getHours()).padStart(2, '0')}:${String(date.getMinutes()).padStart(2, '0')}`;

            let styledItemName = item.itemName;
            const tagMatch = styledItemName.match(/^(\[.*?\])\s*(.*)/);

            if (tagMatch) {
                const tag = tagMatch[1];
                const restName = tagMatch[2];
                let tagColor = '#ffd700';
                if (tag.includes('ì„ ë´‰') || tag.includes('ë¶„ì‡„')) tagColor = '#ff4d4f';
                else if (tag.includes('ì˜ì§€') || tag.includes('ê´‘ì±„')) tagColor = '#3399cc';
                else if (tag.includes('ì´ìƒ')) tagColor = '#25c2a0';
                else if (tag.includes('ê°•íƒ€')) tagColor = '#ffd700';

                let baseNamePart = restName;
                if (restName.includes(':')) {
                    const pMatch = restName.match(/(.+?):\s*(.+)/);
                    if (pMatch) baseNamePart = `<span style="color:#e6b800; font-weight:bold;">${pMatch[1]}</span>: ${pMatch[2]}`;
                }
                styledItemName = `<span style="color:${tagColor}; font-weight:bold;">${tag}</span> ${baseNamePart}`;
            } else if (styledItemName.includes(':')) {
                const pMatch = styledItemName.match(/(.+?):\s*(.+)/);
                if (pMatch) styledItemName = `<span style="color:#e6b800; font-weight:bold;">${pMatch[1]}</span>: ${pMatch[2]}`;
            }

            const tr = document.createElement("tr");
            tr.innerHTML = `
        <td style="white-space:nowrap;">${item.job} / ${item.name}</td>
        <td>[${item.category}] ${item.slot}</td>
        <td style="text-align:left;">${styledItemName}</td>
        <td style="font-weight:bold; color:${item.count > 0 ? '#ffcc00' : '#888'};">${item.count}</td>
        <td style="font-size:0.9em;">${formatTime}</td>
    `;
            tbody.appendChild(tr);
        });

        modalContent.innerHTML = "";
        modalContent.appendChild(table);

        renderPaginationButtons(pageNum);
    }

    function renderPaginationButtons(currentPage) {
        const paginationContainer = document.getElementById("updatePagination");
        paginationContainer.innerHTML = "";

        const totalPages = Math.ceil(allUpdatesData.length / ITEMS_PER_PAGE);

        // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë²„íŠ¼ ìƒì„± ì•ˆ í•¨
        if (totalPages === 0) return;

        // ì²˜ìŒìœ¼ë¡œ ë²„íŠ¼
        const firstBtn = document.createElement("button");
        firstBtn.textContent = "â® ì²˜ìŒìœ¼ë¡œ";
        firstBtn.disabled = currentPage === 1;
        firstBtn.onclick = () => {
            currentUpdatePage = 1;
            renderUpdatePage(1);
        };
        paginationContainer.appendChild(firstBtn);

        // ì´ì „ í˜ì´ì§€ ë²„íŠ¼
        const prevBtn = document.createElement("button");
        prevBtn.textContent = "â—€ ì´ì „";
        prevBtn.disabled = currentPage === 1;
        prevBtn.onclick = () => {
            if (currentPage > 1) {
                currentUpdatePage = currentPage - 1;
                renderUpdatePage(currentUpdatePage);
            }
        };
        paginationContainer.appendChild(prevBtn);

        // í˜ì´ì§€ ë²”ìœ„ ê³„ì‚° (í˜„ì¬ í˜ì´ì§€ ê¸°ì¤€ìœ¼ë¡œ 5ê°œì”©)
        const pageGroupStart = Math.floor((currentPage - 1) / 5) * 5 + 1;
        const pageGroupEnd = Math.min(pageGroupStart + 4, totalPages);

        // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ (5ê°œì”© í‘œì‹œ)
        for (let i = pageGroupStart; i <= pageGroupEnd; i++) {
            const pageBtn = document.createElement("button");
            pageBtn.textContent = i;
            pageBtn.className = currentPage === i ? "active" : "";
            pageBtn.onclick = () => {
                currentUpdatePage = i;
                renderUpdatePage(i);
            };
            paginationContainer.appendChild(pageBtn);
        }

        // ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼
        const nextBtn = document.createElement("button");
        nextBtn.textContent = "ë‹¤ìŒ â–¶";
        nextBtn.disabled = currentPage === totalPages;
        nextBtn.onclick = () => {
            if (currentPage < totalPages) {
                currentUpdatePage = currentPage + 1;
                renderUpdatePage(currentUpdatePage);
            }
        };
        paginationContainer.appendChild(nextBtn);

        // ëìœ¼ë¡œ ë²„íŠ¼
        const lastBtn = document.createElement("button");
        lastBtn.textContent = "ëìœ¼ë¡œ â­";
        lastBtn.disabled = currentPage === totalPages;
        lastBtn.onclick = () => {
            currentUpdatePage = totalPages;
            renderUpdatePage(totalPages);
        };
        paginationContainer.appendChild(lastBtn);

        // í˜ì´ì§€ ê²€ìƒ‰ ì…ë ¥ì°½ ì¶”ê°€
        const searchDiv = document.createElement("div");
        searchDiv.style.display = "flex";
        searchDiv.style.gap = "8px";
        searchDiv.style.alignItems = "center";
        searchDiv.style.marginLeft = "15px";

        const searchLabel = document.createElement("span");
        searchLabel.textContent = "í˜ì´ì§€ ê²€ìƒ‰:";
        searchLabel.style.color = "#e6e9ff";
        searchLabel.style.fontWeight = "bold";
        searchDiv.appendChild(searchLabel);

        const searchInput = document.createElement("input");
        searchInput.type = "number";
        searchInput.min = "1";
        searchInput.max = totalPages;
        searchInput.placeholder = `1-${totalPages}`;
        searchInput.style.width = "80px";
        searchInput.style.padding = "8px";
        searchInput.style.border = "1px solid #2a3158";
        searchInput.style.background = "#181c33";
        searchInput.style.color = "#e6e9ff";
        searchInput.style.borderRadius = "6px";
        searchInput.style.textAlign = "center";

        const searchBtn = document.createElement("button");
        searchBtn.textContent = "ğŸ” ì´ë™";
        searchBtn.style.padding = "8px 15px";
        searchBtn.style.border = "1px solid #2a3158";
        searchBtn.style.background = "#25c2a0";
        searchBtn.style.color = "#fff";
        searchBtn.style.borderRadius = "6px";
        searchBtn.style.cursor = "pointer";
        searchBtn.style.fontWeight = "bold";
        searchBtn.style.transition = "0.2s";
        searchBtn.onmouseover = () => searchBtn.style.background = "#1a8c7d";
        searchBtn.onmouseout = () => searchBtn.style.background = "#25c2a0";

        searchBtn.onclick = () => {
            const pageNum = parseInt(searchInput.value);
            if (isNaN(pageNum) || pageNum < 1 || pageNum > totalPages) {
                alert(`1 ~ ${totalPages} ì‚¬ì´ì˜ í˜ì´ì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”.`);
                return;
            }
            currentUpdatePage = pageNum;
            renderUpdatePage(pageNum);
        };

        // Enter í‚¤ë¡œë„ ê²€ìƒ‰ ê°€ëŠ¥
        searchInput.onkeypress = (e) => {
            if (e.key === "Enter") {
                searchBtn.click();
            }
        };

        searchDiv.appendChild(searchInput);
        searchDiv.appendChild(searchBtn);
        paginationContainer.appendChild(searchDiv);
    }

    // ğŸ’¡ ìƒˆë¡œ ì¶”ê°€: ì—…ë°ì´íŠ¸ ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
    function closeUpdateModal() {
        document.getElementById("updateModal").style.display = 'none';
    }

    /* ========================================
       10. ì œì‘ ì‹œìŠ¤í…œ
       ======================================== */
    function renderCraftTable() {
        const area = document.getElementById("craft-table-area");

        // âœ… í˜„ì¬ í¬ì»¤ìŠ¤ëœ inputì˜ ìœ„ì¹˜ ì €ì¥
        const focusedElement = document.activeElement;
        let focusedCharIndex = -1;
        let focusedMatIndex = -1;

        if (focusedElement && focusedElement.className === "craft-input") {
            // ì–´ëŠ ìºë¦­í„°, ì–´ëŠ ì¬ë£Œì¸ì§€ ì°¾ê¸°
            const allInputs = Array.from(document.querySelectorAll(".craft-input"));
            const focusedIndex = allInputs.indexOf(focusedElement);

            if (focusedIndex !== -1) {
                const materialsCount = 8; // ì¬ë£Œ ê°œìˆ˜
                focusedCharIndex = Math.floor(focusedIndex / materialsCount);
                focusedMatIndex = focusedIndex % materialsCount;
            }
        }

        area.innerHTML = "";

        const materials = [
            { name: "ë§ê°€ì§„ ê¸°ê³„ ìº¡ìŠ", img: "ë§ê°€ì§„ê¸°ê³„ìº¡ìŠ.png" },
            { name: "ìŠ¤í™ì¿¨ë£¸ íŒŒí¸", img: "ìŠ¤í™ì¿¨ë£¸íŒŒí¸.png" },
            { name: "ë§ê°€ì§„ ê°•ì²  í†±ë‹ˆë°”í€´", img: "ë§ê°€ì§„ê°•ì² í†±ë‹ˆë°”í€´.png" },
            { name: "ê°•ì²  í™”ë¡œì˜ íŒŒí¸", img: "ê°•ì² í™”ë¡œì˜íŒŒí¸.png" },
            { name: "ë¹›ì˜ ì €ì¥ì†Œ", img: "ë¹ì˜ì €ì¥ì†Œ.png" },
            { name: "ë§ˆëˆ„ìŠ¤ ë©”ëª¨ë¦¬ì–¼", img: "ë§ˆëˆ„ìŠ¤ë©”ëª¨ë¦¬ì–¼.png" },
            { name: "ë°ì´í„° ì¹© ìƒì", img: "ë°ì´í„°ì¹©.png" },
            { name: "ê°•í™”ëœ ë°ì´í„° ì¹© ìƒì", img: "ê°•í™”ëœë°ì´í„°ì¹©.png" }
        ];

        const table = document.createElement("table");

        // âœ… í—¤ë” 1í–‰: ì¬ë£Œëª… + í•©ê³„
        const headerRow1 = document.createElement("tr");
        const emptyTh = document.createElement("th");
        emptyTh.textContent = "ìºë¦­í„°";
        headerRow1.appendChild(emptyTh);

        materials.forEach(mat => {
            const th = document.createElement("th");
            th.textContent = mat.name;
            headerRow1.appendChild(th);
        });

        // âœ… í•©ê³„ ì—´ í—¤ë”
        const totalTh = document.createElement("th");
        totalTh.textContent = "í•©ê³„";
        totalTh.style.background = "#ffd700";
        totalTh.style.color = "#000";
        headerRow1.appendChild(totalTh);

        table.appendChild(headerRow1);

        // âœ… í—¤ë” 2í–‰: ì¬ë£Œ ì´ë¯¸ì§€ + ë¹ˆ ì¹¸
        const headerRow2 = document.createElement("tr");
        const emptyTh2 = document.createElement("th");
        headerRow2.appendChild(emptyTh2);

        materials.forEach(mat => {
            const th = document.createElement("th");
            th.innerHTML = `<img src="${mat.img}" style="width:32px;">`;
            headerRow2.appendChild(th);
        });

        // âœ… í•©ê³„ ì—´ ë¹ˆ ì¹¸
        const emptyTotalTh = document.createElement("th");
        emptyTotalTh.style.background = "#ffd700";
        headerRow2.appendChild(emptyTotalTh);

        table.appendChild(headerRow2);

        // âœ… ì¬ë£Œë³„ í•©ê³„ë¥¼ ì €ì¥í•  ë°°ì—´
        const materialTotals = materials.map(() => 0);

        // âœ… ë°ì´í„° í–‰: ê° ìºë¦­í„°
        characters.forEach((char, charIdx) => {
            if (!char.craftMaterials) {
                char.craftMaterials = {};
            }

            const tr = document.createElement("tr");

            // ìºë¦­í„° ì´ë¦„
            const nameTd = document.createElement("td");
            nameTd.innerHTML = `${char.job}<br>(${char.name})`;
            nameTd.style.fontWeight = "bold";
            tr.appendChild(nameTd);

            let charTotal = 0; // ìºë¦­í„°ë³„ í•©ê³„

            // ê° ì¬ë£Œì˜ ì…ë ¥ í•„ë“œ
            materials.forEach((mat, matIdx) => {
                const td = document.createElement("td");
                const input = document.createElement("input");
                input.type = "number";
                input.className = "craft-input";
                input.style.width = "60px";
                input.min = "0";
                input.placeholder = "0";

                const savedValue = char.craftMaterials[mat.name];
                if (savedValue && savedValue > 0) {
                    input.value = savedValue;
                    charTotal += savedValue;
                    materialTotals[matIdx] += savedValue;
                }

                input.addEventListener('input', function() {
                    const value = parseInt(this.value);

                    if (isNaN(value) || value <= 0) {
                        delete char.craftMaterials[mat.name];
                    } else {
                        char.craftMaterials[mat.name] = value;
                    }

                    saveLocalData();
                    renderCraftTable(); // âœ… í•©ê³„ ê°±ì‹ ì„ ìœ„í•´ ì¬ë Œë”ë§
                });

                // âœ… í¬ì»¤ìŠ¤ ë³µì›
                if (charIdx === focusedCharIndex && matIdx === focusedMatIndex) {
                    setTimeout(() => {
                        input.focus();
                        // ì»¤ì„œë¥¼ ëìœ¼ë¡œ ì´ë™
                        const len = input.value.length;
                        input.setSelectionRange(len, len);
                    }, 0);
                }

                td.appendChild(input);
                tr.appendChild(td);
            });

            // âœ… ìºë¦­í„°ë³„ í•©ê³„ í‘œì‹œ
            const totalTd = document.createElement("td");
            totalTd.textContent = charTotal > 0 ? charTotal : "";
            totalTd.style.textAlign = "center";
            totalTd.style.fontWeight = "bold";
            totalTd.style.background = "#ffd700";
            totalTd.style.color = "#000";
            tr.appendChild(totalTd);

            table.appendChild(tr);
        });

        // âœ… í•©ê³„ í–‰ ì¶”ê°€
        const totalRow = document.createElement("tr");
        totalRow.style.background = "#ffd700";

        const totalLabelTd = document.createElement("td");
        totalLabelTd.textContent = "í•©ê³„";
        totalLabelTd.style.fontWeight = "bold";
        totalLabelTd.style.color = "#000";
        totalLabelTd.style.textAlign = "center";
        totalRow.appendChild(totalLabelTd);

        let grandTotal = 0;

        materialTotals.forEach(total => {
            const td = document.createElement("td");
            td.textContent = total > 0 ? total : "";
            td.style.textAlign = "center";
            td.style.fontWeight = "bold";
            td.style.color = "#000";
            grandTotal += total;
            totalRow.appendChild(td);
        });

        // âœ… ì „ì²´ í•©ê³„ (ì˜¤ë¥¸ìª½ ì•„ë˜)
        const grandTotalTd = document.createElement("td");
        grandTotalTd.textContent = grandTotal > 0 ? grandTotal : "";
        grandTotalTd.style.textAlign = "center";
        grandTotalTd.style.fontWeight = "bold";
        grandTotalTd.style.color = "#000";
        grandTotalTd.style.fontSize = "1.1em";
        totalRow.appendChild(grandTotalTd);

        table.appendChild(totalRow);

        area.appendChild(table);
        setCraftLock(craftLocked);
    }

    function setCraftLock(lock) {
        craftLocked = lock;

        // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
        document.getElementById("craft-lock-btn")
            .classList.toggle("active", lock);
        document.getElementById("craft-unlock-btn")
            .classList.toggle("active", !lock);

        // ì…ë ¥ì¹¸ í™œì„±/ë¹„í™œì„±
        document.querySelectorAll("#section-craft-view input")
            .forEach(input => {
                input.disabled = lock;
            });
    }

    /* ========================================
       11. íƒ­ ì „í™˜
       ======================================== */
    // 3-1. í™”ë©´ ì „í™˜ í•¨ìˆ˜ ìˆ˜ì •
    function switchTo(view) {
        const sections = {
            'char': document.getElementById("section-character-view"),
            'weapon': document.getElementById("section-weapon-view"),
            'equipment': document.getElementById("section-equipment-view"),
            'craft': document.getElementById("section-craft-view") // âœ… ì¶”ê°€
        };
        const buttons = {
            'char': document.getElementById("tab-char"),
            'weapon': document.getElementById("tab-weapon"),
            'equipment': document.getElementById("tab-equipment"),
            'craft': document.getElementById("tab-craft") // âœ… ì¶”ê°€
        };

        // ëª¨ë“  ì„¹ì…˜ ìˆ¨ê¸°ê³  ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
        Object.keys(sections).forEach(k => {
            if (sections[k]) sections[k].style.display = "none";
            if (buttons[k]) {
                buttons[k].style.background = "#2a3158";
                buttons[k].style.border = "2px solid transparent";
            }
        });

        // ì„ íƒëœ ì„¹ì…˜ ë³´ì´ê¸° ë° ë²„íŠ¼ ê°•ì¡°
        if (sections[view]) sections[view].style.display = "block";
        if (buttons[view]) {
            buttons[view].style.background = "#4a33cc";
            buttons[view].style.border = "2px solid #fff";
        }

        // íƒ­ë³„ ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        if (view === 'char') renderCharacterList();
        if (view === 'weapon') selectWeaponJob('ê·€ê²€ì‚¬', true);
        if (view === 'equipment') {
            renderEquipmentTab('ALL');

            // ì¥ë¹„ ê´€ë¦¬ íˆ´ë°”ì˜ ì²« ë²ˆì§¸ ë²„íŠ¼ì„ ì°¾ì•„ì„œ active í´ë˜ìŠ¤ ë¶€ì—¬
            const equipmentToolbar = document.querySelector("#section-equipment-view .toolbar");
            const firstBtn = equipmentToolbar.querySelector(".char-btn");

            // ëª¨ë“  ì¥ë¹„ ë²„íŠ¼ ì´ˆê¸°í™” í›„ ì²« ë²ˆì§¸ ë²„íŠ¼ë§Œ ì¼¬
            equipmentToolbar.querySelectorAll(".char-btn").forEach(b => b.classList.remove("active"));
            if (firstBtn) firstBtn.classList.add("active");
        }
        if (view === 'craft') renderCraftTable();

        window.scrollTo(0, 0);
    }

    /* ========================================
       12. JSON ë°±ì—…/ë³µì›
       ======================================== */
    function exportJSON() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');

        // ë³€ê²½ëœ íŒŒì¼ëª… í˜•ì‹: dnfm_eq_YYYY-MM-DD_HH-MM.json
        const fileName = `dnfm_eq_${year}-${month}-${day}_${hours}-${minutes}.json`;

        const dataStr = JSON.stringify(characters, null, 2);
        const blob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = fileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    async function saveJsonWithLocation() {
        const dataStr = localStorage.getItem('dnfm_eq');
        if (!dataStr) {
            alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
            return;
        }

        // íŒŒì¼ ê¸°ë³¸ ì´ë¦„ ì„¤ì • (ì˜¤ëŠ˜ ë‚ ì§œ í¬í•¨)
        const defaultName = "dnfm_eq_JSON_backup_" + new Date().toISOString().slice(0, 10) + ".json";

        // 1. ìµœì‹  ë¸Œë¼ìš°ì €ìš© (File System Access API) - ì§ì ‘ í´ë”/ì´ë¦„ ì§€ì • ê°€ëŠ¥
        if ('showSaveFilePicker' in window) {
            try {
                const handle = await window.showSaveFilePicker({
                    suggestedName: defaultName,
                    types: [{
                        description: 'JSON Files',
                        accept: { 'application/json': ['.json'] },
                    }],
                });

                const writable = await handle.createWritable();
                await writable.write(dataStr);
                await writable.close();

                alert("ì§€ì •ëœ ìœ„ì¹˜ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            } catch (err) {
                // ì‚¬ìš©ìê°€ ì·¨ì†Œë¥¼ ëˆ„ë¥¸ ê²½ìš° ì™¸ì˜ ì—ëŸ¬ ì²˜ë¦¬
                if (err.name !== 'AbortError') {
                    console.error(err);
                    alert("íŒŒì¼ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                }
            }
        }
        // 2. êµ¬í˜• ë¸Œë¼ìš°ì €/ëª¨ë°”ì¼ìš© (ëŒ€ì²´ ìˆ˜ë‹¨)
        else {
            alert("í˜„ì¬ ë¸Œë¼ìš°ì €ê°€ ì €ì¥ ìœ„ì¹˜ ì§€ì •ì„ ì§ì ‘ ì§€ì›í•˜ì§€ ì•Šì•„ ê¸°ë³¸ ë‹¤ìš´ë¡œë“œ ë°©ì‹ìœ¼ë¡œ ì§„í–‰í•©ë‹ˆë‹¤.");
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = defaultName;
            link.click();
            URL.revokeObjectURL(url);
        }
    }

    function importJSON(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
            try {
                const imported = JSON.parse(e.target.result);

                if (!Array.isArray(imported)) {
                    throw new Error("ë°ì´í„°ê°€ ë°°ì—´ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤.");
                }

                // 1. ì „ì—­ ë°ì´í„° êµì²´ ë° í•„ìˆ˜ í•„ë“œ ë³´ì •
                characters = imported.map(char => {
                    if (!char.name || !char.job) throw new Error("ìºë¦­í„° ì´ë¦„ ë˜ëŠ” ì§ì—… ì •ë³´ê°€ ëˆ„ë½ëœ í•­ëª©ì´ ìˆìŠµë‹ˆë‹¤.");
                    return {
                        id: char.id || "c" + Date.now() + Math.random().toString(36).substr(2, 5),
                        name: char.name,
                        job: char.job,
                        armorCounts: char.armorCounts || {},
                        weaponCounts: char.weaponCounts || {},
                        updateTimes: char.updateTimes || {},
                        craftMaterials: char.craftMaterials || {}
                    };
                });

                // 2. ìƒíƒœ ì´ˆê¸°í™” (UI ê¼¬ì„ ë°©ì§€)
                activeCharacterId = null;
                currentSetName = null;
                currentChar = null;

                // 3. ë¡œì»¬ ì €ì¥
                saveLocalData();

                // 4. âœ… ê° ì„¹ì…˜ DOM ìš”ì†Œ ë¯¸ë¦¬ ê°€ì ¸ì˜¤ê¸°
                const charView = document.getElementById("section-character-view");
                const weaponView = document.getElementById("section-weapon-view");
                const equipmentView = document.getElementById("section-equipment-view");
                const craftView = document.getElementById("section-craft-view");

                // 5. ìºë¦­í„° íƒ­ ê°±ì‹  (í•­ìƒ)
                renderCharacterList();
                document.getElementById("setList").innerHTML = "";
                document.getElementById("panel").innerHTML = "";

                // 6. ë¬´ê¸° íƒ­ì´ ì—´ë ¤ìˆìœ¼ë©´ ê°±ì‹ 
                if (weaponView.style.display !== "none") {
                    selectWeaponJob(activeWeaponJob || 'ê·€ê²€ì‚¬', true);
                }

                // 7. âœ… ì¥ë¹„ ê´€ë¦¬ íƒ­ì´ ì—´ë ¤ìˆìœ¼ë©´ ê°±ì‹ 
                if (equipmentView.style.display !== "none") {
                    // âœ… ìºë¦­í„°ë³„ ì¥ë¹„ ë³´ìœ  í˜„í™©ì´ ì—´ë ¤ìˆìœ¼ë©´ ê°±ì‹ 
                    if (isCharacterEquipmentViewOpen && selectedCharacterForEquipment) {
                        const char = characters.find(c => c.id === selectedCharacterForEquipment);
                        if (char) {
                            renderCharacterButtons();
                            renderCharacterEquipmentDetail(char);
                        }
                    } else {
                        // ì¼ë°˜ ì¥ë¹„ ê´€ë¦¬ í™”ë©´ì´ë©´ ê°±ì‹ 
                        renderEquipmentTab('ALL');
                    }
                }

                // 8. ì œì‘ íƒ­ì´ ì—´ë ¤ìˆìœ¼ë©´ ê°±ì‹ 
                if (craftView.style.display !== "none") {
                    renderCraftTable();
                }

                alert(`ë°ì´í„° ë³µêµ¬ ì™„ë£Œ! ì´ ${characters.length}ëª…ì˜ ë°ì´í„°ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                event.target.value = '';

            } catch (err) {
                console.error(err);
                alert("íŒŒì¼ ì½ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
            }
        };
        reader.readAsText(file);
    }

    /* ========================================
       13. ì´ˆê¸°í™” ì‹¤í–‰ (ë§¨ ë§ˆì§€ë§‰)
       ======================================== */
    calculateGlobalWidths();
    loadLocalData();
    renderCharacterList();
    selectWeaponJob('ê·€ê²€ì‚¬');

    // ëª¨ë°”ì¼ í™˜ê²½ í„°ì¹˜ ëŒ€ì‘ í†µí•©
    window.ontouchstart = function (event) {
        const prefixModal = document.getElementById("prefixFullModal");
        const updateModal = document.getElementById("updateModal");
        const actionModal = document.getElementById("actionModal");
        const confirmModal = document.getElementById("confirmModal");

        if (event.target === prefixModal) prefixModal.style.display = 'none';
        if (event.target === updateModal) updateModal.style.display = 'none';
        if (event.target === actionModal) actionModal.style.display = 'none';
        if (event.target === confirmModal) {
            if (typeof closeConfirmModal === "function") closeConfirmModal();
            else confirmModal.style.display = 'none';
        }
    };

    // Enter í‚¤ ê²€ìƒ‰ ì§€ì›
    const searchInput = document.getElementById("equipment-search-input");
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchEquipment();
            }
        });
    }

    // // ëª¨ë°”ì¼ í™˜ê²½ì„ ìœ„í•œ í„°ì¹˜ ì´ë²¤íŠ¸ ëŒ€ì‘
    // window.ontouchstart = function (event) {
    //     const modal = document.getElementById("updateModal");
    //     if (event.target === modal) {
    //         modal.style.display = 'none';
    //     }
    // };
    //
    //
    // // ëª¨ë°”ì¼ í„°ì¹˜ ëŒ€ì‘ (í„°ì¹˜ ì‹œì‘ ì‹œ ë‹«ê¸°)
    // window.ontouchstart = function (event) {
    //     const modal = document.getElementById("prefixFullModal");
    //     if (event.target === modal) {
    //         modal.style.display = "none";
    //     }
    // };


    // // ëª¨ë“  íŒì—…ì°½ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° ì²˜ë¦¬ (í†µí•© ë²„ì „)
    // window.onclick = function (event) {
    //     const updateModal = document.getElementById("updateModal");
    //     const prefixModal = document.getElementById("prefixFullModal");
    //     const actionModal = document.getElementById("actionModal");
    //     const confirmModal = document.getElementById("confirmModal");
    //
    //     // 1. ìµœê·¼ ì—…ë°ì´íŠ¸ ë‚´ì—­ ëª¨ë‹¬
    //     if (event.target === updateModal) {
    //         updateModal.style.display = 'none';
    //     }
    //     // 2. ì „ì²´ ì¥ë¹„ í˜„í™© ëª¨ë‹¬
    //     if (event.target === prefixModal) {
    //         prefixModal.style.display = 'none';
    //     }
    //     // 3. ìºë¦­í„° ì•¡ì…˜(ìˆ˜ì •/ì‚­ì œ ë“±) ëª¨ë‹¬
    //     if (event.target === actionModal) {
    //         actionModal.style.display = 'none';
    //     }
    //     // 4. í™•ì¸(Confirm) ëª¨ë‹¬
    //     if (event.target === confirmModal) {
    //         if (typeof closeConfirmModal === "function") closeConfirmModal();
    //         else confirmModal.style.display = 'none';
    //     }
    // };

</script>

</div>

<div id="actionModal" class="modal-overlay" style="display:none;">
    <div class="modal-content"></div>
</div>

<div id="confirmModal" class="modal-overlay" style="display:none;">
    <div class="modal-content" style="min-width: 300px; text-align: center;">
        <h3 id="confirmTitle" style="color: #fff; margin-bottom: 15px;"></h3>
        <p id="confirmMessage" style="color: #ccc; margin-bottom: 25px;"></p>

        <div class="modal-options" style="display: flex; gap: 10px; justify-content: center;">
            <button id="confirmYes" class="modal-btn" style="background: #e74c3c; flex: 1; color: #fff;">í™•ì¸</button>
            <button class="modal-btn" style="background: #444; flex: 1; color: #fff;" onclick="closeConfirmModal()">ì·¨ì†Œ
            </button>
        </div>
    </div>
</div>
<!--gap ê°’: í™”ì‚´í‘œ ì‚¬ì´ ê°„ê²©-->
<div class="scroll-buttons" style="position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 5px; z-index: 1000;">
    <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})"
            style="width: 40px; height: 40px; border-radius: 50%; background: #4a33cc; color: white; border: 2px solid #fff; cursor: pointer; font-size: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
        â–²
    </button>
    <button onclick="window.scrollTo({top: document.body.scrollHeight, behavior: 'smooth'})"
            style="width: 40px; height: 40px; border-radius: 50%; background: #4a33cc; color: white; border: 2px solid #fff; cursor: pointer; font-size: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
        â–¼
    </button>
</div>
</body>
</html>