<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>í†µí•© í…ŒìŠ¤íŠ¸ v2</title>
    <style>
        body { font-family: 'Malgun Gothic', sans-serif; background: #0f0f12; color: #ddd; padding: 20px; margin: 0; }
        h1 { color: #c5a678; border-bottom: 2px solid #c5a678; padding-bottom: 10px; }
        h2 { color: #c5a678; margin-top: 30px; }
        .test-container { background: #1a1a1f; border: 2px solid #444; padding: 20px; margin: 20px 0; border-radius: 5px; }
        .test-suite { margin: 15px 0; }
        .test-case { padding: 8px; margin: 5px 0; border-left: 4px solid #666; background: #121216; }
        .test-case.pass { border-left-color: #4ade80; background: #1a4a2a; }
        .test-case.fail { border-left-color: #f87171; background: #4a1a1a; }
        .status { font-weight: bold; padding: 2px 8px; border-radius: 3px; margin-right: 10px; }
        .status.pass { color: #4ade80; }
        .status.fail { color: #f87171; }
        .error-detail { color: #f87171; font-size: 12px; margin-top: 5px; padding-left: 20px; font-family: monospace; }
        .summary { background: #2a2a32; padding: 15px; margin: 20px 0; border-radius: 5px; font-size: 18px; }
        .summary.success { border: 2px solid #4ade80; }
        .summary.failure { border: 2px solid #f87171; }
        button { background: #1d4ed8; color: white; border: none; padding: 10px 20px; font-size: 16px; cursor: pointer; border-radius: 5px; margin: 10px 5px; }
        button:hover { background: #2563eb; }
        button:disabled { background: #666; cursor: not-allowed; }
        #testFrame { width: 100%; height: 600px; border: 2px solid #444; background: white; margin: 20px 0; display: none; }
        .progress { width: 100%; height: 30px; background: #121216; border: 1px solid #444; border-radius: 5px; overflow: hidden; margin: 10px 0; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, #1d4ed8, #2563eb); transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
    </style>
</head>
<body>
<h1>ğŸ§ª í†µí•© í…ŒìŠ¤íŠ¸ v2 (ìºì‹œ ìš°íšŒ)</h1>

<div class="test-container">
    <button onclick="runAllTests()" id="runBtn">â–¶ ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰</button>
    <button onclick="clearResults()">ğŸ—‘ï¸ ê²°ê³¼ ì§€ìš°ê¸°</button>
    <button onclick="toggleFrame()">ğŸ‘ï¸ í”„ë ˆì„ ë³´ê¸°/ìˆ¨ê¸°ê¸°</button>

    <div class="progress">
        <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
    </div>

    <div id="summary"></div>
</div>

<iframe id="testFrame" src="../index.html"></iframe>

<div id="results"></div>

<script>
    let testWin, testDoc;
    let testResults = [];
    let currentTest = 0;
    let totalTests = 35;

    console.log('ğŸ”¥ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œë¨ - v2');

    function toggleFrame() {
        const f = document.getElementById('testFrame');
        f.style.display = f.style.display === 'none' ? 'block' : 'none';
    }

    function clearResults() {
        document.getElementById('results').innerHTML = '';
        document.getElementById('summary').innerHTML = '';
        document.getElementById('progressBar').style.width = '0%';
        document.getElementById('progressBar').textContent = '0%';
        testResults = [];
        currentTest = 0;
    }

    function updateProgress() {
        const p = Math.round((currentTest / totalTests) * 100);
        const pb = document.getElementById('progressBar');
        pb.style.width = p + '%';
        pb.textContent = p + '%';
    }

    function displayTest(suiteName, testName, status, error = null) {
        let sd = document.getElementById('suite-' + suiteName.replace(/\s+/g, '-'));

        if (!sd) {
            sd = document.createElement('div');
            sd.id = 'suite-' + suiteName.replace(/\s+/g, '-');
            sd.className = 'test-suite';
            sd.innerHTML = `<h2>${suiteName}</h2>`;
            document.getElementById('results').appendChild(sd);
        }

        const td = document.createElement('div');
        td.className = 'test-case ' + status;

        let st = status === 'pass' ? 'âœ… PASS' : 'âŒ FAIL';
        td.innerHTML = `<span class="status ${status}">${st}</span>${testName}`;

        if (error) td.innerHTML += `<div class="error-detail">${error}</div>`;

        sd.appendChild(td);
        testResults.push({ suite: suiteName, test: testName, status, error });
        currentTest++;
        updateProgress();
    }

    function displaySummary() {
        const passed = testResults.filter(r => r.status === 'pass').length;
        const failed = testResults.filter(r => r.status === 'fail').length;
        const total = testResults.length;

        const sd = document.getElementById('summary');
        sd.className = 'summary ' + (failed === 0 ? 'success' : 'failure');
        sd.innerHTML = `<strong>í…ŒìŠ¤íŠ¸ ì™„ë£Œ!</strong><br>ì´ ${total}ê°œ | í†µê³¼ ${passed}ê°œ | ì‹¤íŒ¨ ${failed}ê°œ ${failed === 0 ? ' ğŸ‰' : ' âš ï¸'}`;
    }

    function delay(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function runAllTests() {
        console.log('ğŸš€ í…ŒìŠ¤íŠ¸ ì‹œì‘!');
        clearResults();
        document.getElementById('runBtn').disabled = true;

        const iframe = document.getElementById('testFrame');

        console.log('ğŸ§¹ localStorage ì´ˆê¸°í™” ì¤‘...');
        iframe.contentWindow.localStorage.clear();
        iframe.contentWindow.location.reload();
        await delay(2000);

        console.log('âœ… í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
        testWin = iframe.contentWindow;
        testDoc = iframe.contentDocument;

        console.log('ğŸ“Š ì´ˆê¸° ìºë¦­í„° ê°œìˆ˜:', testDoc.querySelectorAll('.char-section').length);

        try {
            await suite1();
            await suite2();
            await suite3();
            await suite4();
            await suite5();
            await suite6();
            await suite7();
            await suite8();
        } catch (e) {
            console.error('âŒ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜:', e);
        }

        displaySummary();
        document.getElementById('runBtn').disabled = false;
    }

    async function suite1() {
        const s = 'Suite 1: DOM ìš”ì†Œ';

        try {
            if (testDoc.querySelector('.control-bar')) displayTest(s, 'ì»¨íŠ¸ë¡¤ë°”', 'pass');
            else throw new Error('ì—†ìŒ');
        } catch (e) { displayTest(s, 'ì»¨íŠ¸ë¡¤ë°”', 'fail', e.message); }

        try {
            if (testDoc.querySelector('.btn-add')) displayTest(s, 'ìºë¦­í„° ì¶”ê°€ ë²„íŠ¼', 'pass');
            else throw new Error('ì—†ìŒ');
        } catch (e) { displayTest(s, 'ìºë¦­í„° ì¶”ê°€ ë²„íŠ¼', 'fail', e.message); }

        try {
            if (testDoc.getElementById('characterContainer')) displayTest(s, 'ìºë¦­í„° ì»¨í…Œì´ë„ˆ', 'pass');
            else throw new Error('ì—†ìŒ');
        } catch (e) { displayTest(s, 'ìºë¦­í„° ì»¨í…Œì´ë„ˆ', 'fail', e.message); }

        try {
            if (testDoc.getElementById('modalOverlay')) displayTest(s, 'ëª¨ë‹¬ ì˜¤ë²„ë ˆì´', 'pass');
            else throw new Error('ì—†ìŒ');
        } catch (e) { displayTest(s, 'ëª¨ë‹¬ ì˜¤ë²„ë ˆì´', 'fail', e.message); }

        try {
            if (testDoc.getElementById('skillRunemodal')) displayTest(s, 'ìŠ¤í‚¬ë£¬ ëª¨ë‹¬', 'pass');
            else throw new Error('ì—†ìŒ');
        } catch (e) { displayTest(s, 'ìŠ¤í‚¬ë£¬ ëª¨ë‹¬', 'fail', e.message); }

        await delay(300);
    }

    async function suite2() {
        const s = 'Suite 2: ìºë¦­í„° ìƒì„±';

        // â­ localStorage ë¹„ìš°ë©´ ìë™ìœ¼ë¡œ 1ê°œ ìƒì„±ë¨!
        try {
            const sec = testDoc.querySelectorAll('.char-section');
            console.log('ğŸ“ Suite2 ì‹œì‘ - ìºë¦­í„° ê°œìˆ˜:', sec.length);
            if (sec.length === 1) displayTest(s, 'ì´ˆê¸°: ìë™ ìƒì„±ëœ ìºë¦­í„° 1ê°œ í™•ì¸', 'pass');
            else throw new Error(`${sec.length}ê°œ ì¡´ì¬ (ì˜ˆìƒ: 1ê°œ ìë™ ìƒì„±)`);
        } catch (e) { displayTest(s, 'ì´ˆê¸°: ìë™ ìƒì„±ëœ ìºë¦­í„° 1ê°œ í™•ì¸', 'fail', e.message); }

        // â­ ìë™ ìƒì„±ëœ ìºë¦­í„° ì‚­ì œ í›„ ìƒˆë¡œ ì¶”ê°€
        try {
            console.log('ğŸ§¹ ê¸°ì¡´ ìºë¦­í„° ì‚­ì œ ì¤‘...');
            const existingSections = testDoc.querySelectorAll('.char-section');
            existingSections.forEach(sec => sec.remove());
            await delay(300);

            console.log('â• ìƒˆ ìºë¦­í„° ì¶”ê°€ ì¤‘...');
            testDoc.querySelector('.btn-add').click();
            await delay(500);
            displayTest(s, 'ìºë¦­í„° ì¶”ê°€ ë²„íŠ¼ í´ë¦­', 'pass');
        } catch (e) { displayTest(s, 'ìºë¦­í„° ì¶”ê°€ ë²„íŠ¼ í´ë¦­', 'fail', e.message); }

        try {
            const sec = testDoc.querySelectorAll('.char-section');
            console.log('ğŸ“ ìºë¦­í„° ì¶”ê°€ í›„ ê°œìˆ˜:', sec.length);
            if (sec.length === 1) displayTest(s, 'ìºë¦­í„° ì„¹ì…˜ ìƒì„±', 'pass');
            else throw new Error(`${sec.length}ê°œ (ì˜ˆìƒ: 1)`);
        } catch (e) { displayTest(s, 'ìºë¦­í„° ì„¹ì…˜ ìƒì„±', 'fail', e.message); }

        try {
            if (testDoc.querySelector('.char-section table')) displayTest(s, 'í…Œì´ë¸” ìƒì„±', 'pass');
            else throw new Error('ì—†ìŒ');
        } catch (e) { displayTest(s, 'í…Œì´ë¸” ìƒì„±', 'fail', e.message); }

        try {
            const slots = testDoc.querySelector('.char-section').querySelectorAll('.col-slot');
            console.log('ğŸ“ ìŠ¬ë¡¯ ê°œìˆ˜:', slots.length);
            // â­ ì¹­í˜¸ rowspan ë•Œë¬¸ì— 19ê°œê°€ ì •ìƒ!
            if (slots.length === 19) displayTest(s, '19ê°œ ìŠ¬ë¡¯ ìƒì„± (ì¹­í˜¸ rowspan í¬í•¨)', 'pass');
            else throw new Error(`${slots.length}ê°œ (ì˜ˆìƒ: 19)`);
        } catch (e) { displayTest(s, '19ê°œ ìŠ¬ë¡¯ ìƒì„± (ì¹­í˜¸ rowspan í¬í•¨)', 'fail', e.message); }

        await delay(300);
    }

    async function suite3() {
        const s = 'Suite 3: ë°ì´í„° ì…ë ¥';

        try {
            const job = testDoc.querySelector('[data-key="info_job"]');
            job.value = 'ê·€ê²€ì‚¬';
            job.dispatchEvent(new Event('input', { bubbles: true }));
            await delay(300);
            if (job.value === 'ê·€ê²€ì‚¬') displayTest(s, 'ì§ì—… ì…ë ¥', 'pass');
            else throw new Error('ì‹¤íŒ¨');
        } catch (e) { displayTest(s, 'ì§ì—… ì…ë ¥', 'fail', e.message); }

        try {
            const name = testDoc.querySelector('[data-key="info_name"]');
            name.value = 'í…ŒìŠ¤íŠ¸ìºë¦­í„°';
            name.dispatchEvent(new Event('input', { bubbles: true }));
            await delay(300);
            if (name.value === 'í…ŒìŠ¤íŠ¸ìºë¦­í„°') displayTest(s, 'ì´ë¦„ ì…ë ¥', 'pass');
            else throw new Error('ì‹¤íŒ¨');
        } catch (e) { displayTest(s, 'ì´ë¦„ ì…ë ¥', 'fail', e.message); }

        try {
            const rarity = testDoc.querySelector('[data-key="ë¬´ê¸°_rarity"]');
            rarity.value = 'ì—í”½';
            rarity.dispatchEvent(new Event('change', { bubbles: true }));
            await delay(300);
            if (rarity.value === 'ì—í”½') displayTest(s, 'í¬ê·€ë„ ì„ íƒ', 'pass');
            else throw new Error('ì‹¤íŒ¨');
        } catch (e) { displayTest(s, 'í¬ê·€ë„ ì„ íƒ', 'fail', e.message); }

        try {
            const item = testDoc.querySelector('[data-key="ë¬´ê¸°_itemname"]');
            if (item.tagName === 'SELECT') item.selectedIndex = 1;
            else item.value = 'í…ŒìŠ¤íŠ¸ë¬´ê¸°';
            item.dispatchEvent(new Event('change', { bubbles: true }));
            await delay(300);
            displayTest(s, 'ì•„ì´í…œ ì´ë¦„', 'pass');
        } catch (e) { displayTest(s, 'ì•„ì´í…œ ì´ë¦„', 'fail', e.message); }

        await delay(300);
    }

    async function suite4() {
        const s = 'Suite 4: ìë™ ì €ì¥';

        await delay(1000);

        try {
            const saved = testWin.localStorage.getItem('dnfm_character_equipment_data');
            if (saved) displayTest(s, 'localStorage ì €ì¥', 'pass');
            else throw new Error('ì—†ìŒ');
        } catch (e) { displayTest(s, 'localStorage ì €ì¥', 'fail', e.message); }

        try {
            const saved = testWin.localStorage.getItem('dnfm_character_equipment_data');
            const data = JSON.parse(saved);
            if (Array.isArray(data) && data.length > 0) displayTest(s, 'ë°ì´í„° í˜•ì‹', 'pass');
            else throw new Error('í˜•ì‹ ì˜¤ë¥˜');
        } catch (e) { displayTest(s, 'ë°ì´í„° í˜•ì‹', 'fail', e.message); }

        try {
            const saved = testWin.localStorage.getItem('dnfm_character_equipment_data');
            const data = JSON.parse(saved);
            if (data[0].inputs['info_name'].val === 'í…ŒìŠ¤íŠ¸ìºë¦­í„°') displayTest(s, 'ì…ë ¥ê°’ í™•ì¸', 'pass');
            else throw new Error('ë¶ˆì¼ì¹˜');
        } catch (e) { displayTest(s, 'ì…ë ¥ê°’ í™•ì¸', 'fail', e.message); }

        try {
            const saved = testWin.localStorage.getItem('dnfm_character_equipment_data');
            const data = JSON.parse(saved);
            if (data[0].id && data[0].inputs) displayTest(s, 'ë°ì´í„° êµ¬ì¡°', 'pass');
            else throw new Error('êµ¬ì¡° ì˜¤ë¥˜');
        } catch (e) { displayTest(s, 'ë°ì´í„° êµ¬ì¡°', 'fail', e.message); }

        await delay(300);
    }

    async function suite5() {
        const s = 'Suite 5: ìŠ¤í‚¬ë£¬ ëª¨ë‹¬';

        try {
            const sec = testDoc.querySelector('.char-section');
            if (sec && sec.id) displayTest(s, 'ìºë¦­í„° ID', 'pass');
            else throw new Error('ì—†ìŒ');
        } catch (e) { displayTest(s, 'ìºë¦­í„° ID', 'fail', e.message); }

        try {
            const sec = testDoc.querySelector('.char-section');
            const btns = sec.querySelectorAll('button');
            let rb = null;
            for (let b of btns) if (b.textContent.includes('ìˆ˜ì •')) { rb = b; break; }

            if (rb) {
                rb.click();
                await delay(500);
                displayTest(s, 'ëª¨ë‹¬ ì—´ê¸°', 'pass');
            } else throw new Error('ë²„íŠ¼ ì—†ìŒ');
        } catch (e) { displayTest(s, 'ëª¨ë‹¬ ì—´ê¸°', 'fail', e.message); }

        try {
            const m = testDoc.getElementById('skillRunemodal');
            const o = testDoc.getElementById('modalOverlay');
            if (m.style.display === 'block' && o.style.display === 'block') displayTest(s, 'ëª¨ë‹¬ í‘œì‹œ', 'pass');
            else throw new Error(`ëª¨ë‹¬:${m.style.display} ì˜¤ë²„ë ˆì´:${o.style.display}`);
        } catch (e) { displayTest(s, 'ëª¨ë‹¬ í‘œì‹œ', 'fail', e.message); }

        try {
            const rows = testDoc.querySelectorAll('#runeModalBody tr');
            if (rows.length === 20) displayTest(s, '20ê°œ ë£¬ í–‰', 'pass');
            else throw new Error(`${rows.length}ê°œ`);
        } catch (e) { displayTest(s, '20ê°œ ë£¬ í–‰', 'fail', e.message); }

        try {
            testDoc.getElementById('modalOverlay').click();
            await delay(300);
            const m = testDoc.getElementById('skillRunemodal');
            if (m.style.display === 'none') displayTest(s, 'ëª¨ë‹¬ ë‹«ê¸°', 'pass');
            else throw new Error('ì‹¤íŒ¨');
        } catch (e) { displayTest(s, 'ëª¨ë‹¬ ë‹«ê¸°', 'fail', e.message); }

        await delay(300);
    }

    async function suite6() {
        const s = 'Suite 6: JSON';

        let cd;
        try {
            const saved = testWin.localStorage.getItem('dnfm_character_equipment_data');
            cd = JSON.parse(saved);
            if (cd) displayTest(s, 'ë°ì´í„° ê°€ì ¸ì˜¤ê¸°', 'pass');
            else throw new Error('ì—†ìŒ');
        } catch (e) { displayTest(s, 'ë°ì´í„° ê°€ì ¸ì˜¤ê¸°', 'fail', e.message); }

        try {
            const js = JSON.stringify(cd);
            const p = JSON.parse(js);
            if (p) displayTest(s, 'JSON ì§ë ¬í™”/ì—­ì§ë ¬í™”', 'pass');
            else throw new Error('ì‹¤íŒ¨');
        } catch (e) { displayTest(s, 'JSON ì§ë ¬í™”/ì—­ì§ë ¬í™”', 'fail', e.message); }

        try {
            if (cd[0].id && cd[0].inputs && typeof cd[0].locked === 'boolean') displayTest(s, 'êµ¬ì¡° í™•ì¸', 'pass');
            else throw new Error('ì˜¤ë¥˜');
        } catch (e) { displayTest(s, 'êµ¬ì¡° í™•ì¸', 'fail', e.message); }

        await delay(300);
    }

    async function suite7() {
        const s = 'Suite 7: ë¹„êµ ëª¨ë“œ';

        try {
            testDoc.querySelector('.btn-add').click();
            await delay(500);
            const sec = testDoc.querySelectorAll('.char-section');
            console.log('ğŸ“ Suite7 - ë‘ ë²ˆì§¸ ì¶”ê°€ í›„ ê°œìˆ˜:', sec.length);
            // â­ ì´ë¯¸ 1ê°œ ìˆìœ¼ë¯€ë¡œ ì¶”ê°€í•˜ë©´ 2ê°œ
            if (sec.length === 2) displayTest(s, 'ë‘ ë²ˆì§¸ ìºë¦­í„°', 'pass');
            else throw new Error(`${sec.length}ê°œ (ì˜ˆìƒ: 2)`);
        } catch (e) { displayTest(s, 'ë‘ ë²ˆì§¸ ìºë¦­í„°', 'fail', e.message); }

        try {
            testDoc.getElementById('btnCompareMode').click();
            await delay(500);
            displayTest(s, 'ë¹„êµ ëª¨ë“œ ë²„íŠ¼', 'pass');
        } catch (e) { displayTest(s, 'ë¹„êµ ëª¨ë“œ ë²„íŠ¼', 'fail', e.message); }

        try {
            const c = testDoc.getElementById('compareCharSelectionContainer');
            if (c.style.display === 'block') displayTest(s, 'ë¹„êµ UI í‘œì‹œ', 'pass');
            else throw new Error('ë¯¸í‘œì‹œ');
        } catch (e) { displayTest(s, 'ë¹„êµ UI í‘œì‹œ', 'fail', e.message); }

        try {
            const sl = testDoc.getElementById('compareCharacterSelectLeft');
            const opts = sl.querySelectorAll('option');
            if (opts.length >= 2) displayTest(s, 'ë“œë¡­ë‹¤ìš´ ì˜µì…˜', 'pass');
            else throw new Error(`${opts.length}ê°œ`);
        } catch (e) { displayTest(s, 'ë“œë¡­ë‹¤ìš´ ì˜µì…˜', 'fail', e.message); }

        try {
            testDoc.getElementById('btnBasicMode').click();
            await delay(300);
            const c = testDoc.getElementById('characterContainer');
            if (c.style.display === 'block') displayTest(s, 'ê¸°ë³¸ ëª¨ë“œ ë³µê·€', 'pass');
            else throw new Error('ì‹¤íŒ¨');
        } catch (e) { displayTest(s, 'ê¸°ë³¸ ëª¨ë“œ ë³µê·€', 'fail', e.message); }

        await delay(300);
    }

    async function suite8() {
        const s = 'Suite 8: ì ê¸ˆ/í•´ì œ';

        try {
            const lb = testDoc.querySelector('.char-section .lock-btn');
            lb.click();
            await delay(300);
            if (lb.classList.contains('btn-active')) displayTest(s, 'ì ê¸ˆ ë²„íŠ¼', 'pass');
            else throw new Error('ì‹¤íŒ¨');
        } catch (e) { displayTest(s, 'ì ê¸ˆ ë²„íŠ¼', 'fail', e.message); }

        try {
            const inp = testDoc.querySelector('.char-section input[data-key="info_name"]');
            if (inp.readOnly) displayTest(s, 'ì…ë ¥ í•„ë“œ ë¹„í™œì„±í™”', 'pass');
            else throw new Error('ì‹¤íŒ¨');
        } catch (e) { displayTest(s, 'ì…ë ¥ í•„ë“œ ë¹„í™œì„±í™”', 'fail', e.message); }

        try {
            const ub = testDoc.querySelector('.char-section .unlock-btn');
            ub.click();
            await delay(300);
            if (ub.classList.contains('btn-active')) displayTest(s, 'í•´ì œ ë²„íŠ¼', 'pass');
            else throw new Error('ì‹¤íŒ¨');
        } catch (e) { displayTest(s, 'í•´ì œ ë²„íŠ¼', 'fail', e.message); }

        try {
            const inp = testDoc.querySelector('.char-section input[data-key="info_name"]');
            if (!inp.readOnly) displayTest(s, 'ì…ë ¥ í•„ë“œ í™œì„±í™”', 'pass');
            else throw new Error('ì‹¤íŒ¨');
        } catch (e) { displayTest(s, 'ì…ë ¥ í•„ë“œ í™œì„±í™”', 'fail', e.message); }

        await delay(300);
    }
</script>
</body>
</html>