
/* ========================================
[섹션 1] 전역 변수 & 상수 선언
======================================== */
let activeCharacterId = null;
let activeWeaponJob = null;
let currentUpdatePage = 1;
let allUpdatesData = [];
const ITEMS_PER_PAGE = 10;
const TOTAL_PAGES = 5;

let currentActionCharId = null;

// ===== 전역 상태 변수 =====
let currentSetName = null;
let currentChar = null;
let currentFilter = 'ALL'; // 💡 현재 선택된 필터 ('ALL', 'BASE', 'PREFIX', 'EXCEED')

// 💡 무기 테이블 행 강조 함수
let highlightedRowId = null;

// 💡 강조 상태를 관리하기 위한 전역 변수 (기존 Set에서 단일 변수로 변경)
let highlightedColumnIndex = null;

let craftLocked = true;

// calcTotalDistinctParts 결과 캐시
// 구조: { "charId|setName": distinctParts }
let distinctPartsCache = {};

// ✅ 추가: 캐릭터 순서 편집 모드
let isEditingCharacterOrder = false;

/* ========================================
[섹션 2] 데이터 정의
======================================== */

// ─────────────────────────────────────────
// 2.1 방어구 세트
// ─────────────────────────────────────────
const ARMOR_SETS = {
    "어느 말괄량이의 탐사복": ["상의", "하의", "어깨", "벨트", "신발"],
    "포이즈닝 퀸 스파이더": ["상의", "하의", "어깨", "벨트", "신발"],
    "거인의 스펙쿨룸 아이언": ["상의", "하의", "어깨", "벨트", "신발"],
    "어둠을 쏘아 내리는 자": ["상의", "하의", "어깨", "벨트", "신발"],
    "수호자의 초합금": ["상의", "하의", "어깨", "벨트", "신발"],
    "스틱키 애시드 웨펀": ["상의", "하의", "어깨", "벨트", "신발"],
    "섬뜩한 강철 용": ["상의", "하의", "어깨", "벨트", "신발"],
    "익스플로시브 버닝 스톤": ["상의", "하의", "어깨", "벨트", "신발"],
    "빛의 헌신자": ["상의", "하의", "어깨", "벨트", "신발"],
    "여명을 쏘아 올리는 자": ["상의", "하의", "어깨", "벨트", "신발"],
    "콰트로 카시테움": ["상의", "하의", "어깨", "벨트", "신발"],
    "그란테 전투기갑 파츠": ["상의", "하의", "어깨", "벨트", "신발"],
    "레거시: 마력의 소용돌이": ["상의", "하의", "어깨", "벨트", "신발"],
    "레거시: 자연의 수호자": ["상의", "하의", "어깨", "벨트", "신발"]
};
const ARMOR_PREFIX = {
    "어느 말괄량이의 탐사복": ["전격", "허상"],
    "포이즈닝 퀸 스파이더": ["작열", "침식"],
    "거인의 스펙쿨룸 아이언": ["수호", "왜곡"],
    "어둠을 쏘아 내리는 자": ["자상", "맹독"],
    "수호자의 초합금": ["허상", "보호"],
    "스틱키 애시드 웨펀": ["맹독", "왜곡"],
    "섬뜩한 강철 용": ["쇄도", "침식"],
    "익스플로시브 버닝 스톤": ["신속", "연격"],
    "빛의 헌신자": ["수호", "연격"],
    "여명을 쏘아 올리는 자": ["자상", "쇄도"],
    "콰트로 카시테움": ["작열", "보호"],
    "그란테 전투기갑 파츠": ["신속", "전격"],
    "레거시: 마력의 소용돌이": ["레거시"],
    "레거시: 자연의 수호자": ["레거시"]
};
// 레거시 장비는 접두어만 있고 일반 장비가 없음 (빈 배열)
const ARMOR_EXCEED_ONLY = [];
// ─────────────────────────────────────────
// 2.2 악세 세트
// ─────────────────────────────────────────
const ACCESSORY_SETS = {
    "엘팅 메모리얼의 기억": ["팔찌", "목걸이", "반지"],
    "섬뜩한 빛의 관리자": ["팔찌", "목걸이", "반지"],
    "부식된 메탈기어": ["팔찌", "목걸이", "반지"],
    "화력 개조 탄띠": ["팔찌", "목걸이", "반지"],
    "신비로운 빛의 소용돌이": ["팔찌", "목걸이", "반지"],
    "콰트로 마누스 연산장치": ["팔찌", "목걸이", "반지"],
    "레거시: 에테리얼 리베넌트": ["팔찌", "목걸이", "반지"],
    "레거시: 지나온 영광의 시대": ["팔찌", "목걸이", "반지"]
};
const ACCESSORY_PREFIX = {
    "엘팅 메모리얼의 기억": ["견고", "혈독"],
    "섬뜩한 빛의 관리자": ["초석", "각오"],
    "부식된 메탈기어": ["각오", "가속"],
    "화력 개조 탄띠": ["혈독", "견고"],
    "신비로운 빛의 소용돌이": ["조화", "초석"],
    "콰트로 마누스 연산장치": ["가속", "조화"],
    "레거시: 에테리얼 리베넌트": ["레거시"],
    "레거시: 지나온 영광의 시대": ["레거시"]
};
// 레거시 장비는 접두어만 있고 일반 장비가 없음 (빈 배열)
const ACCESSORY_EXCEED_ONLY = [];
// ─────────────────────────────────────────
// 2.3 특장 세트
// ─────────────────────────────────────────
const SPECIAL_SETS = {
    "개구쟁이 호문쿨루스": ["귀걸이", "마법석", "보장"],
    "라이트닝 에너지 코어": ["귀걸이", "마법석", "보장"],
    "철갑을 두른 탑의 수호꾼": ["귀걸이", "마법석", "보장"],
    "깊은 불구덩이의 섬멸자": ["귀걸이", "마법석", "보장"],
    "허영 속 어둠의 피조물": ["귀걸이", "마법석", "보장"],
    "부정한 빛의 우상": ["귀걸이", "마법석", "보장"]
};
const SPECIAL_PREFIX = {
    "개구쟁이 호문쿨루스": ["불굴", "숙련"],
    "라이트닝 에너지 코어": ["숙련", "결의"],
    "철갑을 두른 탑의 수호꾼": ["격변", "촉진"],
    "깊은 불구덩이의 섬멸자": ["불굴", "촉진"],
    "허영 속 어둠의 피조물": ["질주", "결의"],
    "부정한 빛의 우상": ["질주", "격변"]
};
const ALL_SETS = {...ARMOR_SETS, ...ACCESSORY_SETS, ...SPECIAL_SETS};
const ALL_PREFIX = {...ARMOR_PREFIX, ...ACCESSORY_PREFIX, ...SPECIAL_PREFIX};

// ★ 레거시 세트: 접두어는 "레거시"지만 키는 setName 자체를 그대로 사용
// e.g., makePrefixKey("레거시", "레거시: 마력의 소용돌이") => "레거시: 마력의 소용돌이"
// (NOT "레거시: 레거시: 마력의 소용돌이")
const LEGACY_PREFIX_SETS = [
    "레거시: 마력의 소용돌이",
    "레거시: 자연의 수호자",
    "레거시: 에테리얼 리베넌트",
    "레거시: 지나온 영광의 시대"
];

function makePrefixKey(pref, setName) {
    if (LEGACY_PREFIX_SETS.includes(setName)) return setName;
    return `${pref}: ${setName}`;
}

// ─────────────────────────────────────────
// 2.4 익시드 관련
// ─────────────────────────────────────────
const EXCEED_TAGS = ["선봉", "의지", "이상"];
const EXCEED_SLOTS = {"ARMOR": ["상의"], "ACCESSORY": ["팔찌"], "SPECIAL": ["귀걸이"]};
const EXCEED_COLOR_MAP = {
    "선봉": "#ff4d4d",
    "의지": "#4d94ff",
    "이상": "#2ecc71"
};

// ─────────────────────────────────────────
// 2.5 표시용 이름 매핑
// ─────────────────────────────────────────
const ARMOR_DISPLAY_NAMES = {
    "어느 말괄량이의 탐사복": {
        "상의": ["못말리는 말괄량이의 가죽", "어느 말괄량이의 가죽 자켓"],
        "하의": "어느 말괄량이의 버블 반바지",
        "어깨": "어느 말괄량이의 특수 고글",
        "벨트": "어느 말괄량이의 벨트",
        "신발": "어느 말괄량이의 신발"
    },
    "포이즈닝 퀸 스파이더": {
        "상의": ["엠프리스 스파이더 상의", "퀸 스파이더 상의"],
        "하의": "퀸 스파이더 하의",
        "어깨": "퀸 스파이더 머리",
        "벨트": "퀸 스파이더 벨트 장식",
        "신발": "퀸 스파이더 신발"
    },
    "거인의 스펙쿨룸 아이언": {
        "상의": ["거신의 스펙쿨룸 상의", "거인의 스펙쿨룸 상의"],
        "하의": "거인의 스펙쿨룸 하의",
        "어깨": "거인의 스펙쿨룸 어깨 장식",
        "벨트": "거인의 스펙쿨룸 허리띠",
        "신발": "거인의 스펙쿨룸 신발"
    },
    "어둠을 쏘아 내리는 자": {
        "상의": ["밤을 쏘아 내리는 자의 상의", "어둠을 쏘아 내리는 자의 상의"],
        "하의": "어둠을 쏘아 내리는 자의 하의",
        "어깨": "어둠을 쏘아 내리는 자의 어깨 덧댐",
        "벨트": "어둠을 쏘아 내리는 자의 허리띠",
        "신발": "어둠을 쏘아 내리는 자의 신발"
    },
    "수호자의 초합금": {
        "상의": ["수호군주의 초합금 상의", "수호자의 초합금 상의"],
        "하의": "수호자의 초합금 하의",
        "어깨": "수호자의 초합금 어깨",
        "벨트": "수호자의 초합금 벨트",
        "신발": "수호자의 초합금 신발"
    },
    "스틱키 애시드 웨펀": {
        "상의": ["네트 스파이더 상의", "웹 스파이더의 상의"],
        "하의": "웹 스파이더의 하의",
        "어깨": "웹 스파이더의 어깨",
        "벨트": "웹 스파이더의 허리",
        "신발": "웹 스파이더의 신발"
    },
    "섬뜩한 강철 용": {
        "상의": ["강철 용의 스케일 재킷", "강철 용의 가죽 재킷"],
        "하의": "강철 용의 가죽 그리브",
        "어깨": "강철 용의 뿔 장식",
        "벨트": "강철 용의 휴대용 벨트",
        "신발": "강철 용의 가죽 신발"
    },
    "익스플로시브 버닝 스톤": {
        "상의": ["블레이징 기어 플레이트 메일", "버닝 기어 플레이트 메일"],
        "하의": "버닝 기어 플레이트 레깅스",
        "어깨": "버닝 기어 플레이트 햇",
        "벨트": "버닝 기어 플레이트 코일",
        "신발": "버닝 기어 플레이트 사바톤"
    },
    "빛의 헌신자": {
        "상의": ["빛의 수호자의 상의", "빛의 헌신자의 상의"],
        "하의": "빛의 헌신자의 하의",
        "어깨": "빛의 헌신자의 모자",
        "벨트": "빛의 헌신자의 허리장식",
        "신발": "빛의 헌신자의 신발"
    },
    "여명을 쏘아 올리는 자": {
        "상의": ["여명을 밝힌 자의 상의", "여명을 쏘아 올리는 자의 상의"],
        "하의": "여명을 쏘아 올리는 자의 바지",
        "어깨": "여명을 쏘아 올리는 자의 어깨 덧댐",
        "벨트": "여명을 쏘아 올리는 자의 허리띠",
        "신발": "여명을 쏘아 올리는 자의 신발"
    },
    "콰트로 카시테움": {
        "상의": ["콰트로 카시테움 아머Mk2", "콰트로 카시테움 아머"],
        "하의": "콰트로 카시테움 각반",
        "어깨": "콰트로 카시테움 새로운 손",
        "벨트": "콰트로 카시테움 코일",
        "신발": "콰트로 카시테움 그리브"
    },
    "그란테 전투기갑 파츠": {
        "상의": ["그런데 마누스 전투기갑 상의", "그란데 전투기갑 상의"],
        "하의": "그란데 전투기갑 하의",
        "어깨": "그란데 전투기갑 헤드기어",
        "벨트": "그란데 전투기갑 허리",
        "신발": "그란데 전투기갑 신발"
    },
    "레거시: 마력의 소용돌이": {
        "상의": ["휘몰아치는 마력의 태풍", "마력의 폭풍우"],
        "하의": "영력의 회오리",
        "어깨": "마법의 대격변",
        "벨트": "마나의 소용돌이",
        "신발": "정수의 태풍"
    },
    "레거시: 자연의 수호자": {
        "상의": ["루미너스 오토 상의", "라이트니스 오토 상의"],
        "하의": "파이어니스 오토 하의",
        "어깨": "블랙니스 오토 어깨",
        "벨트": "아이니스 오토 벨트",
        "신발": "윈드니스 오토 신발"
    }
};

// 악세 표시용 이름 매핑 (레거시 아이템은 "레거시: " 접두어 제거)
const ACCESSORY_DISPLAY_NAMES = {
    "엘팅 메모리얼의 기억": {
        "팔찌": ["선명한 기억의 팔찌", "묻힌 시간의 팔찌"],
        "목걸이": "흐릿한 과거의 목걸이",
        "반지": "덮어둔 기억의 반지"
    },
    "섬뜩한 빛의 관리자": {
        "팔찌": ["이심전심", "무언의 연결"],
        "목걸이": "숨겨진 맥락",
        "반지": "감춰진 결"
    },
    "부식된 메탈기어": {
        "팔찌": ["기계의 심박", "기계의 맥박"],
        "목걸이": "사라진 동력",
        "반지": "정지된 흐름"
    },
    "화력 개조 탄띠": {
        "팔찌": ["멀티플 툴즈", "트리플 툴즈"],
        "목걸이": "피어싱 드릴 네클레스",
        "반지": "오토매틱 실린더"
    },
    "신비로운 빛의 소용돌이": {
        "팔찌": ["시린 달빛", "푸른 달빛"],
        "목걸이": "은색의 별빛",
        "반지": "붉은 햇빛"
    },
    "콰트로 마누스 연산장치": {
        "팔찌": ["기계의 주시", "기계의 시선"],
        "목걸이": "에너지의 눈",
        "반지": "응시의 흔적"
    },
    "레거시: 에테리얼 리베넌트": {
        "팔찌": ["아이언 엠벨리시드 밴드", "강철 리스트 가드"],
        "목걸이": "영혼 추적장치",
        "반지": "할기의 본링"
    },
    "레거시: 지나온 영광의 시대": {
        "팔찌": ["세이트 루멘아이트 렐릭", "홀리 미스릴 렐릭"],
        "목걸이": "펠 로스 글로리",
        "반지": "에이션트 엘븐 링"
    }
};

// 악세 추가 정보
const ACCESSORY_EXTRA_INFO = {
    "엘팅 메모리얼의 기억": "선명한,묻힌 / 흐릿한 / 덮어둔",
    "섬뜩한 빛의 관리자": "이심전심,무언 / 숨겨진 / 감춰진",
    "부식된 메탈기어": "기계의 심박,맥박 / 사라진 / 정지",
    "화력 개조 탄띠": "멀티플,트리플 / 피어싱 / 오토매틱",
    "신비로운 빛의 소용돌이": "시린,푸른 / 은색 / 붉은",
    "콰트로 마누스 연산장치": "기계의 주시,시선 / 에너지 / 응시",
    "레거시: 에테리얼 리베넌트": "아이언,강철 / 영혼 / 할기",
    "레거시: 지나온 영광의 시대": "세이트,홀리 / 펠 / 에이션트"
};

// 특장 추가 정보
const SPECIAL_EXTRA_INFO = {
    "개구쟁이 호문쿨루스": "말괄량이,베키",
    "라이트닝 에너지 코어": "거신,거인",
    "철갑을 두른 탑의 수호꾼": "메탈기어",
    "깊은 불구덩이의 섬멸자": "강철",
    "허영 속 어둠의 피조물": "골드",
    "부정한 빛의 우상": "콰트로"
};

// ✅ 새로 추가: 특수장비 표시용 이름 매핑
const SPECIAL_DISPLAY_NAMES = {
    "개구쟁이 호문쿨루스": {
        "귀걸이": ["말괄량이의 문양 귀걸이", "베키의 문양 귀걸이"],
        "마법석": "베키의 새총",
        "보장": "베키의 장갑"
    },
    "라이트닝 에너지 코어": {
        "귀걸이": ["거신의 스펙쿨룸 이어링", "거인의 스펙쿨룸 이어링"],
        "마법석": "거인의 스펙쿨룸 코어",
        "보장": "거인의 건들릿"
    },
    "철갑을 두른 탑의 수호꾼": {
        "귀걸이": ["메탈기어의 초합금 태엽", "메탈기어의 태엽 귀걸이"],
        "마법석": "메탈기어의 두뇌",
        "보장": "메탈기어의 조작부"
    },
    "깊은 불구덩이의 섬멸자": {
        "귀걸이": ["강철 용의 기관총 이어링", "강철 용의 기총 이어링"],
        "마법석": "강철 용의 천공기",
        "보장": "강철 용의 칼날 외골격"
    },
    "허영 속 어둠의 피조물": {
        "귀걸이": ["골드 크라운의 서커스 장식", "골드 크라운의 머리 장식"],
        "마법석": "골드 크라운의 핵심 부품",
        "보장": "골드 크라운의 에너지 방출기"
    },
    "부정한 빛의 우상": {
        "귀걸이": ["콰트로 마누스의 기억", "콰트로 마누스의 태엽 장식"],
        "마법석": "콰트로 마누스의 두뇌",
        "보장": "콰트로 마누스의 에너지 코어"
    }
};

// ─────────────────────────────────────────
// 2.6 무기 데이터
// ─────────────────────────────────────────
const WEAPON_DATA_SLAYER = {
    "소검": ["대서사의 탄생 - 소검", "암흑의 별", "왕위 계승자"],
    "도": ["대서사의 탄생 - 도", "요도 : 무라마사", "트리니티 이터니아"],
    "둔기": ["대서사의 탄생 - 둔기", "세계의 무게추", "신검의 나뭇가지"],
    "대검": ["대서사의 탄생 - 대검", "성검 : 엑스칼리버", "데빌 오브 플레어"],
    "광검": ["대서사의 탄생 - 광검", "아마 겟 돈", "뇌검 : 고룬"]
};
const WEAPON_DATA_FIGHTER = {
    "너클": ["대서사의 탄생 - 너클", "라오 데솔", "베르세르크"],
    "건틀릿": ["대서사의 탄생 - 건틀릿", "반격의 서막", "룰렛러시안"],
    "클로": ["대서사의 탄생 - 클로", "흑월랑아", "악마의 갈퀴 : 이그노어"],
    "권투글러브": ["대서사의 탄생 - 권투글러브", "티쥬 엠플리파이어", "파울 키드니블로"],
    "통파": ["대서사의 탄생 - 통파", "킬 아르니스 렵곡", "습격의 드라우프니르"]
};
const WEAPON_DATA_GUNNER = {
    "리볼버": ["대서사의 탄생 - 리볼버", "이스 미 터너", "실버 불렛"],
    "자동권총": ["대서사의 탄생 - 자동권총", "이온 리필서", "마이스터의 분노"],
    "머스켓": ["대서사의 탄생 - 머스켓", "Code N : 오라클", "블라인드 스팟"],
    "핸드캐넌": ["대서사의 탄생 - 핸드캐넌", "거포 우르반", "해를 먹는 자"],
    "보우건": ["대서사의 탄생 - 보우건", "데스 리뷰저", "제너럴 보우건"]
};
const WEAPON_DATA_MAGE = {
    "창": ["대서사의 탄생 - 창", "쥬빌런스 혼", "전장의 여신의 창"],
    "봉": ["대서사의 탄생 - 봉", "케세라세라 : 해피 ~!", "요정왕의 비밀"],
    "로드": ["대서사의 탄생 - 로드", "히어로 오브 더 문", "양치기의 로드"],
    "스태프": ["대서사의 탄생 - 스태프", "웨리 : 리미트 브레이커", "창마화의 연"],
    "빗자루": ["대서사의 탄생 - 빗자루", "보배 - 파초선", "스노우 프린세스"]
};
const WEAPON_DATA_PRIEST = {
    "십자가": ["대서사의 탄생 - 십자가", "헤이렐 - 교만의 빛", "저주 받은 십자가 : 토루아"],
    "염주": ["대서사의 탄생 - 염주", "음양사천", "명인의 수"],
    "토템": ["대서사의 탄생 - 토템", "씰 더 리바이어던", "풍운뇌우"],
    "낫": ["대서사의 탄생 - 낫", "소울 디바우링", "선고 : 사신의 낫"],
    "배틀엑스": ["대서사의 탄생 - 배틀엑스", "행성파괴자", "오만의 끝"]
};
const WEAPON_DATA_WARRIOR = {
    "락소드": ["대서사의 탄생 - 락소드", "우주적 기운의 락소드", "라이프 파인더"],
    "윙블레이드": ["대서사의 탄생 - 윙블레이드", "프로스트 윙 블레이드", "코카트리스"]
};
const WEAPON_DATA_LANCER = {
    "미늘창": ["대서사의 탄생 - 미늘창", "크림슨 로드", "광염의 극"],
    "투창": ["대서사의 탄생 - 투창", "헬 오브 데빌로드", "미라클 런치"]
};
const WEAPON_DATA_THIEF = {
    "단검": ["대서사의 탄생 - 단검", "실버 스피릿", "월광검"],
    "쌍검": ["대서사의 탄생 - 쌍검", "흑미쌍검", "히게-히자키리"],
    "차크라웨펀": ["대서사의 탄생 - 차크라웨펀", "크리드 오브 닌자", "무염화"]
};
const WEAPON_PREFIXES = [
    {tag: "[광채]", color: "#3399cc"}, // 파란색
    {tag: "[분쇄]", color: "#ff4d4f"}, // 빨간색
    {tag: "[선명]", color: "#25c2a0"}, // 초록색
    {tag: "[강타]", color: "#ffd700"}  // 노란색
];
const WEAPON_DATA_MAP = {
    '귀검사': WEAPON_DATA_SLAYER,
    '격투가': WEAPON_DATA_FIGHTER,
    '거너': WEAPON_DATA_GUNNER,
    '마법사': WEAPON_DATA_MAGE,
    '프리스트': WEAPON_DATA_PRIEST,
    '워리어': WEAPON_DATA_WARRIOR,
    '마창사': WEAPON_DATA_LANCER,
    '도적': WEAPON_DATA_THIEF
};
const JOB_LIST = Object.keys(WEAPON_DATA_MAP);

/* ========================================
[섹션 3] 초기 캐릭터 데이터
======================================== */
let characters = [
    {
        id: "c1", job: "검귀", name: "강의", armorCounts: {
            "어느 말괄량이의 탐사복 상의": 1,
            "어느 말괄량이의 탐사복 하의": 1,
            "어느 말괄량이의 탐사복 어깨": 1,
            "엘팅 메모리얼의 기억 팔찌": 1,
            "[의지] 견고: 엘팅 메모리얼의 기억 팔찌": 1,
            "개구쟁이 호문쿨루스 귀걸이": 1
        }, updateTimes: { // 💡 추가된 필드: 아이템별 업데이트 시간 저장
            "어느 말괄량이의 탐사복 상의": Date.now() - 50000,
            "어느 말괄량이의 탐사복 하의": Date.now() - 40000,
            "어느 말괄량이의 탐사복 어깨": Date.now() - 30000,
            "엘팅 메모리얼의 기억 팔찌": Date.now() - 20000,
            "[의지] 견고: 엘팅 메모리얼의 기억 팔찌": Date.now() - 10000,
            "개구쟁이 호문쿨루스 귀걸이": Date.now()
        }
    }
];

// 전역 최대 길이
let globalSetNameWidth = 200;
let globalSlotWidth = 100;
