<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG í†µí•© ì¥ë¹„ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        :root {
            --bg: #0f0f12;
            --table-bg: #1a1a1f;
            --border: #444; 
            --border-heavy: #c5a678; 
            --gold: #c5a678;
            --text: #ddd;
            --input-bg: #000;
            --fs: 11px;
            --txt-epic: #fcc419;   --txt-unique: #ff80ab; --txt-rare: #b197fc;   --txt-uncom: #4dabf7; --txt-common: #888;
            --ex-sunbong: #ff5252; --ex-uiji: #448aff;
            --ex-isang: #40c057; 
            --emb-red: #4a1212; --emb-yellow: #4a3f12; --emb-blue: #121d4a; --emb-green: #124a1d; --emb-gray: #2d2d2d;
            --gakin-2: #fff5f5bb; 
        }

        body { background-color: var(--bg); color: var(--text); font-family: 'Malgun Gothic', sans-serif; margin: 0; padding: 10px; }
        h2 { color: var(--gold); border-bottom: 2px solid var(--gold); padding-bottom: 5px; margin: 0 0 10px 0; font-size: 1.1rem; }

        .control-bar { margin-bottom: 10px; display: flex; gap: 10px; align-items: center; position: sticky; top: 0; background: var(--bg); z-index: 1000; padding: 5px 0; }
        .btn-action { background: #1d4ed8; color: white; border: none; padding: 5px 15px; cursor: pointer; border-radius: 3px; font-weight: bold; font-size: 11px;}
        .btn-add { background: #7c3aed; }
        .status-msg { font-size: 12px; color: var(--gold); }

        .char-section { margin-bottom: 30px; }
        .table-container { overflow-x: auto; }
        
        table { 
            border-collapse: collapse; 
            background-color: var(--table-bg); 
            width: max-content; 
            font-size: var(--fs); 
            border: 2px solid var(--gold); 
        }
        
        th, td { border: 1px solid var(--border) !important; padding: 1px 2px; text-align: center; height: 26px; color: #ccc; }
        th { background-color: #2a2a32; color: var(--gold); font-weight: bold; white-space: nowrap; }
        
        .v-border-heavy { border-left: 2px solid var(--border-heavy) !important; }
        .group-header { border-bottom: 2px solid var(--gold) !important; }
        
        .col-char-info { width: 120px !important; }
        .col-slot { width: 45px !important; font-weight: bold; color: var(--gold) !important; }
        .col-rarity { width: 42px !important; }
        .col-exceed { width: 45px !important; }
        .col-prefix { width: 38px !important; }
        .col-val-short { width: 35px !important; }
        .col-emblem { width: 40px !important; }
        .col-enchant { width: 55px !important; min-width: 55px; } 

        input { 
            background: var(--input-bg); 
            color: #fff; 
            border: 1px solid #444; 
            padding: 1px 2px; 
            width: 100%; 
            font-size: var(--fs); 
            box-sizing: border-box; 
            height: 22px; 
            outline: none; 
            text-align: center; 
        }

        select { 
            background: linear-gradient(to bottom, #2a2a32 0%, #000000 100%); 
            color: #fff; 
            border: 1px solid #555; 
            padding: 1px 0px; 
            width: 100%; 
            font-size: var(--fs); 
            box-sizing: border-box; 
            height: 22px; 
            outline: none; 
            text-align: center; 
            -webkit-appearance: none; 
            -moz-appearance: none; 
            appearance: none; 
            cursor: pointer;
            pointer-events: auto !important; 
            touch-action: auto !important;
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0.1);
        }

        select option { background-color: #1a1a1f; color: #fff; }
        select:hover { border-color: var(--gold); }

        input:disabled, select:disabled { 
            cursor: not-allowed; 
            opacity: 1; 
            -webkit-text-fill-color: inherit; 
            pointer-events: none !important;
        }

        .rare-ì—í”½, .bg-ì—í”½ { color: var(--txt-epic) !important; font-weight: bold; }
        .rare-ìœ ë‹ˆí¬, .bg-ìœ ë‹ˆí¬ { color: var(--txt-unique) !important; font-weight: bold; }
        .rare-ë ˆì–´, .bg-ë ˆì–´ { color: var(--txt-rare) !important; font-weight: bold; }
        .rare-ì–¸ì»¤ë¨¼, .bg-ì–¸ì»¤ë¨¼ { color: var(--txt-uncom) !important; font-weight: bold; }
        .rare-ì»¤ë¨¼, .bg-ì»¤ë¨¼ { color: var(--txt-common) !important; font-weight: bold; }
        .rare-í‹°ì–´ { color: #ffffff !important; font-weight: bold; }
        
        .ex-ì´ìƒ { color: var(--ex-isang) !important; font-weight: bold; }
        .ex-ì„ ë´‰ { color: var(--ex-sunbong) !important; font-weight: bold; }
        .ex-ì˜ì§€ { color: var(--ex-uiji) !important; font-weight: bold; }
        .prefix-selected { color: var(--txt-epic) !important; font-weight: bold; }
        .prefix-tier { color: #ffffff !important; font-weight: bold; }
        
        .emb-bg-red { background: linear-gradient(to bottom, #6a1a1a 0%, var(--emb-red) 100%) !important; color: #fff !important; }
        .emb-bg-yellow { background: linear-gradient(to bottom, #6a5a1a 0%, var(--emb-yellow) 100%) !important; color: #fff !important; }
        .emb-bg-blue { background: linear-gradient(to bottom, #1a2a6a 0%, var(--emb-blue) 100%) !important; color: #fff !important; }
        .emb-bg-green { background: linear-gradient(to bottom, #1a6a2a 0%, var(--emb-green) 100%) !important; color: #fff !important; }
        .emb-bg-gray { background: linear-gradient(to bottom, #444 0%, var(--emb-gray) 100%) !important; color: #fff !important; }

        .artifact-main-wrapper { display: flex; gap: 8px; justify-content: start; align-items: center; padding: 2px 5px; }
        .art-group { display: flex; flex-direction: column; gap: 2px; border: 1px solid #444; padding: 3px; background: #000; }
        .art-item { display: flex; align-items: center; gap: 2px; }

        #skillRunemodal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a1f; border: 2px solid var(--gold); padding: 15px; z-index: 2000; width: 310px; max-height: 85vh; overflow-y: auto;}
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1999; }
        .v-line { border-left: 1px solid #555; height: 12px; margin: 0 8px; display: inline-block; vertical-align: middle; }
        
        .btn-char-lock { background: #b91c1c; color: white; padding: 4px; cursor: pointer; font-size: 11px; border:none; margin-bottom: 2px;}
        .btn-char-unlock { background: #444; color: white; padding: 4px; cursor: pointer; font-size: 11px; border:none; }
        .btn-active { border: 2px solid white !important; }

        .m-rune-name { width: 68px !important; } 
        .m-rune-lv { width: 48px !important; }    
        .m-rune-skillLv { width: 50px !important; } 
        .col-m-num { width: 30px; }

        .gakin-section { margin-top: 10px; border-top: 2px solid var(--gold); padding-top: 10px; }
        .gakin-title { color: var(--gold); font-weight: bold; font-size: 12px; margin-bottom: 5px; text-align: center; }
        .gakin-container { display: flex; gap: 5px; width: 100%; }
        .m-gakin-input-box { flex: 1; }
    </style>
</head>
<body>

<h2>ğŸ›¡ï¸ RPG í†µí•© ì¥ë¹„ ê´€ë¦¬ ì‹œìŠ¤í…œ</h2>

<div class="control-bar">
    <button class="btn-action" onclick="exportToJSON()">ğŸ“¤ JSON íŒŒì¼ ì €ì¥</button>
    <button class="btn-action" onclick="document.getElementById('fileInput').click()">ğŸ“¥ JSON íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <button class="btn-action btn-add" onclick="createCharacterTable()">â• ìºë¦­í„° ì¶”ê°€</button>
	<button class="btn-action" style="background:#0ea5e9;" onclick="openHistoryModal()">ğŸ“œ ê¸°ë¡</button>
    <input type="file" id="fileInput" style="display:none" accept=".json" onchange="importFromJSON(this)">
    <span id="statusMsg" class="status-msg"></span>
</div>

<div id="characterContainer"></div>

<div class="modal-overlay" id="modalOverlay" onclick="closeRuneModal()"></div>
<div id="skillRunemodal">
    <h3 style="color:var(--gold); margin-top:0;">ğŸ’ ìŠ¤í‚¬ë£¬ & ê°ì¸ ì„¤ì •</h3>
    <table style="width:100%; border-collapse: collapse; font-size:12px; border:1px solid #444;">
        <thead>
            <tr style="color:var(--gold);">
                <th class="col-m-num">ë²ˆí˜¸</th><th style="width:68px;">ìŠ¤í‚¬ë£¬ ì´ë¦„</th><th style="width:48px;">ë£¬ ë ˆë²¨</th><th style="width:50px;">ìŠ¤í‚¬ ë ˆë²¨</th>
            </tr>
        </thead>
        <tbody id="runeModalBody"></tbody>
    </table>
    <div class="gakin-section">
        <div class="gakin-title">ê°ì¸ ì„¤ì •</div>
        <div class="gakin-container">
            <div class="m-gakin-input-box"><input type="text" id="m-gakin1" placeholder="ë©”ì¸ ë¯¸í‘œì‹œ (50%)"></div>
            <div class="m-gakin-input-box"><input type="text" id="m-gakin2" placeholder="ë©”ì¸ í‘œì‹œ (50%)"></div>
        </div>
    </div>
    <div style="margin-top:15px; display:flex; gap:10px; justify-content:center; padding-bottom: 5px;">
        <button class="btn-action" style="background:#059669;" onclick="saveRuneData()">ì €ì¥</button>
        <button class="btn-action" style="background:#4b5563;" onclick="closeRuneModal()">ì·¨ì†Œ</button>
    </div>
</div>

<div id="historyModal" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #1a1a1f; border: 2px solid var(--gold); padding: 15px; z-index: 2000; width: 450px; max-height: 80vh; overflow-y: auto;">
    <h3 style="color:var(--gold); margin-top:0;">ğŸ“ ìµœê·¼ ë³€ê²½ ê¸°ë¡ (ìµœê·¼ 10ê°œ)</h3>
    <div id="historyList" style="font-size: 11px; color: #ccc; line-height: 1.6;"></div>
    <div style="margin-top:15px; text-align:center;">
        <button class="btn-action" style="background:#4b5563;" onclick="closeHistoryModal()">ë‹«ê¸°</button>
    </div>
</div>

<script>
    const STORAGE_KEY = 'dnfm_character_equipment_data';
    const slots = ["ë¬´ê¸°", "ìƒì˜", "ì–´ê¹¨", "í•˜ì˜", "ì‹ ë°œ", "ë²¨íŠ¸", "ëª©ê±¸ì´", "íŒ”ì°Œ", "ë°˜ì§€", "ë³´ì¡°ì¥ë¹„", "ê·€ê±¸ì´", "ë§ˆë²•ì„", "ì¹­í˜¸", "ì™¸í˜•ì¹­í˜¸", "ì˜¤ë¼", "ì•„ë°”íƒ€", "ìŠ¤í‚¬ë£¬", "í¬ë¦¬ì³"];
    const heavyBorderSlots = ["ë¬´ê¸°", "ë²¨íŠ¸", "ë°˜ì§€", "ë§ˆë²•ì„", "ì•„ë°”íƒ€", "ìŠ¤í‚¬ë£¬", "í¬ë¦¬ì³"];
    const prefixes = ["", "ì „ê²©", "í—ˆìƒ", "ì‘ì—´", "ì¹¨ì‹", "ìˆ˜í˜¸", "ì™œê³¡", "ììƒ", "ë§¹ë…", "ë³´í˜¸", "ì‡„ë„", "ì‹ ì†", "ì—°ê²©"];
    const tierPrefixes = ["", "T1", "T2", "T3", "T4", "T5", "T6", "T7"];
    const runeNames = ["", "ê°ì„±", "ê°€í˜¸", "ì™œê³¡", "ì§€í˜œ", "ìˆ˜í˜¸", "ë³´í˜¸", "ê°€ì†", "ê²í™”", "í˜¹í•œ", "ì„¬ê´‘", "ì•”ê²©", "ìˆ™ë ¨", "íšŒë³µ", "ëª…ìƒ", "íŒŒë©¸", "í—ˆìƒ", "ë§ˆë ¥", "ë¶ˆêµ´", "ì¬ë¬¼", "ê¸°êµ", "ê·€ë°±", "í˜¼ë°±", "ê²¬ê³ ", "ìƒì¡´", "ì‘ì—´", "ë§¹ë…", "ììƒ", "ì „ê²©", "ëª¨ë…", "ê¸°ë§Œ", "ê²½í™”", "ì†ë°•", "ë‚˜íƒœ", "ì¹ í‘", "ëª½í™˜", "ì¶©ê²©", "ê²°ë¹™", "ë¯¸ì§€"];
    const runeLevels = ["", "I", "II", "III", "IV"];
    const runeSkillLevels = ["", "0", "15", "20", "25", "30", "35", "40", "45", "50", "55", "60", "65"];
    const noSkillLvRunes = ["ê°€í˜¸", "ì™œê³¡", "ìˆ˜í˜¸", "ë³´í˜¸", "ê·€ë°±", "í˜¼ë°±"];
    const elementEmbList = ["", "ëª¨ì†ê°•", "í™”ì†ê°•", "ìˆ˜ì†ê°•", "ëª…ì†ê°•", "ì•”ì†ê°•"];

    const artOptions = {
        red: ["í˜", "ì§€ëŠ¥", "ì²´ë ¥", "ì •ì‹ ë ¥", "ì ì¤‘", "íšŒí”¼"],
        blue: ["HP MAX", "MP MAX", "ë¬¼ë¦¬ ê³µê²©ë ¥", "ë§ˆë²• ê³µê²©ë ¥", "ë¬¼ë¦¬ ë°©ì–´ë ¥", "ë§ˆë²• ë°©ì–´ë ¥"],
        green: ["ë¬¼ë¦¬ í¬ë¦¬í‹°ì»¬", "ë§ˆë²• í¬ë¦¬í‹°ì»¬", "ê³µê²©ì†ë„", "ìºìŠ¤íŒ…ì†ë„", "ì´ë™ì†ë„", "í™”ì†ì„± ê°•í™”", "ìˆ˜ì†ì„± ê°•í™”", "ëª…ì†ì„± ê°•í™”", "ì•”ì†ì„± ê°•í™”", "ëª¨ë“  ì†ì„± ê°•í™”"]
    };

    const mData = {
        weapon: { n1: ["", "ë°ë¯¸ì§€ ì¦ê°€", "ì¶”ê°€ ë°ë¯¸ì§€", "ëª¨ë“  ì§ì—… 50ë ˆë²¨ìŠ¤í‚¬", "í™”ì†ì„± ê°•í™”", "ìˆ˜ì†ì„± ê°•í™”", "ëª…ì†ì„± ê°•í™”", "ì•”ì†ì„± ê°•í™”", "í˜", "ì§€ëŠ¥", "ë¬¼ë¦¬ ê³µê²©ë ¥", "ë§ˆë²• ê³µê²©ë ¥"], n2: ["", "ë¬¼ë¦¬ ê³µê²©ë ¥", "ë§ˆë²• ê³µê²©ë ¥", "í˜", "ì§€ëŠ¥", "ì²´ë ¥", "ì •ì‹ ë ¥", "ê³µê²©ì†ë„", "ìºìŠ¤íŒ…ì†ë„", "ì´ë™ì†ë„", "ìµœëŒ€ HP ì¦ê°€", "ìµœëŒ€ MP ì¦ê°€", "ë¬¼ë¦¬ ë°©ì–´ë ¥", "ë§ˆë²• ë°©ì–´ë ¥", "ì ì¤‘", "íšŒí”¼"] },
        armor: { n1: ["", "í˜", "ì§€ëŠ¥", "ì²´ë ¥", "ì •ì‹ ë ¥", "ë¬¼ë¦¬ í¬ë¦¬í‹°ì»¬", "ë§ˆë²• í¬ë¦¬í‹°ì»¬"], n2: ["", "ë¬¼ë¦¬ í¬ë¦¬í‹°ì»¬", "ë§ˆë²• í¬ë¦¬í‹°ì»¬", "í˜", "ì§€ëŠ¥", "ì²´ë ¥", "ì •ì‹ ë ¥", "ê³µê²©ì†ë„", "ìºìŠ¤íŒ…ì†ë„", "ì´ë™ì†ë„", "ìµœëŒ€ HP ì¦ê°€", "ìµœëŒ€ MP ì¦ê°€", "ë¬¼ë¦¬ ë°©ì–´ë ¥", "ë§ˆë²• ë°©ì–´ë ¥", "ì ì¤‘", "íšŒí”¼"] },
        accessory: { n1: ["", "í™”ì†ì„± ê°•í™”", "ìˆ˜ì†ì„± ê°•í™”", "ëª…ì†ì„± ê°•í™”", "ì•”ì†ì„± ê°•í™”", "í˜", "ì§€ëŠ¥", "ì²´ë ¥", "ì •ì‹ ë ¥"], n2: ["", "í™”ì†ì„± ê°•í™”", "ìˆ˜ì†ì„± ê°•í™”", "ëª…ì†ì„± ê°•í™”", "ì•”ì†ì„± ê°•í™”", "í˜", "ì§€ëŠ¥", "ì²´ë ¥", "ì •ì‹ ë ¥", "ê³µê²©ì†ë„", "ìºìŠ¤íŒ…ì†ë„", "ì´ë™ì†ë„", "ìµœëŒ€ HP ì¦ê°€", "ìµœëŒ€ MP ì¦ê°€", "ë¬¼ë¦¬ ë°©ì–´ë ¥", "ë§ˆë²• ë°©ì–´ë ¥", "í™”ì†ì„± ì €í•­", "ìˆ˜ì†ì„± ì €í•­", "ëª…ì†ì„± ì €í•­", "ì•”ì†ì„± ì €í•­", "ì ì¤‘", "íšŒí”¼"] },
        special: { n1: ["", "ë¬¼ë¦¬ ê³µê²©ë ¥", "ë§ˆë²• ê³µê²©ë ¥", "í˜", "ì§€ëŠ¥", "ë¬¼ë¦¬ í¬ë¦¬í‹°ì»¬", "ë§ˆë²• í¬ë¦¬í‹°ì»¬", "ì ì¤‘", "íšŒí”¼"], n2: ["", "ë¬¼ë¦¬ ê³µê²©ë ¥", "ë§ˆë²• ê³µê²©ë ¥", "ë¬¼ë¦¬ í¬ë¦¬í‹°ì»¬", "ë§ˆë²• í¬ë¦¬í‹°ì»¬", "í˜", "ì§€ëŠ¥", "ì²´ë ¥", "ì •ì‹ ë ¥", "ê³µê²©ì†ë„", "ìºìŠ¤íŒ…ì†ë„", "ì´ë™ì†ë„", "ìµœëŒ€ HP ì¦ê°€", "ìµœëŒ€ MP ì¦ê°€", "ë¬¼ë¦¬ ë°©ì–´ë ¥", "ë§ˆë²• ë°©ì–´ë ¥", "ì ì¤‘", "íšŒí”¼"] }
    };

    let charRuneData = {}; 
    let currentEditingCharId = null;

    function createCharacterTable(savedData = null) {
        const charId = savedData && savedData.id ? savedData.id : "char_" + Date.now() + Math.random().toString(16).slice(2);
        const section = document.createElement('div');
        section.className = 'char-section';
        section.id = charId;

        charRuneData[charId] = (savedData && savedData.runeData) ? savedData.runeData : { runes: Array(20).fill().map(() => ({ name: '', lv: '', skillLv: '' })), gakin: ['', ''] };

        section.innerHTML = `
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th rowspan="2" class="col-char-info">ì§ì—…/ì´ë¦„</th>
                            <th rowspan="2" class="col-slot v-border-heavy">ìŠ¬ë¡¯</th>
                            <th rowspan="2" class="col-rarity">í¬ê·€ë„</th>
                            <th rowspan="2" class="col-exceed">ìµì‹œë“œ</th>
                            <th rowspan="2" class="col-prefix">ì ‘ë‘ì–´</th>
                            <th rowspan="2" style="min-width:120px;">ì•„ì´í…œì´ë¦„</th>
                            <th rowspan="2" class="col-val-short">ê°•í™”</th>
                            <th colspan="4" class="group-header">ë§ˆë²•ë´‰ì¸</th>
                            <th colspan="2" class="group-header">ì— ë¸”ë ˜</th>
                            <th colspan="2" class="group-header">ë§ˆë²•ë¶€ì—¬</th>
                            <th rowspan="2" style="min-width:230px;" class="v-border-heavy">ì„¤ëª…</th>
                        </tr>
                        <tr>
                            <th>ê³ ìœ  ì˜µì…˜</th><th class="col-val-short">ìˆ˜ì¹˜</th><th>ì¼ë°˜ ì˜µì…˜</th><th class="col-val-short">ìˆ˜ì¹˜</th>
                            <th class="col-emblem">ì— ë¸”ë ˜</th><th class="col-emblem">ì— ë¸”ë ˜</th>
                            <th class="col-enchant">ë§ˆë²•ë¶€ì—¬</th><th class="col-val-short">ìˆ˜ì¹˜</th>
                        </tr>
                    </thead>
                    <tbody class="tbody-content"></tbody>
                </table>
            </div>`;

        const tbody = section.querySelector('.tbody-content');
        slots.forEach((slot, index) => {
            const tr = document.createElement('tr');
            if (heavyBorderSlots.includes(slot)) tr.style.borderBottom = "2px solid var(--border-heavy)";
            if (index === 0) {
                tr.innerHTML += `<td rowspan="${slots.length}" style="background-color: #121216; vertical-align: top;"><div style="display:flex; flex-direction:column; gap:4px; padding:5px;"><input type="text" placeholder="ì§ì—…" data-key="info_job" oninput="autoSave()"><input type="text" placeholder="ì´ë¦„" data-key="info_name" oninput="autoSave()"><button onclick="toggleEdit('${charId}', true)" class="btn-char-lock lock-btn">ì ê¸ˆ</button><button onclick="toggleEdit('${charId}', false)" class="btn-char-unlock unlock-btn">í•´ì œ</button></div></td>`;
            }

            if (slot === "ìŠ¤í‚¬ë£¬") {
                tr.innerHTML += `<td class="col-slot v-border-heavy">ìŠ¤í‚¬ë£¬</td>
                    <td colspan="3"><button class="btn-action" onclick="openRuneModal('${charId}')" style="background:#059669; padding:2px 8px;">ìˆ˜ì •</button> <button class="btn-action" onclick="resetRuneData('${charId}')" style="background:#444; padding:2px 8px;">ì´ˆê¸°í™”</button></td>
                    <td colspan="10" id="${charId}_runeSummary" style="text-align:left; padding-left:10px; color:var(--gold); font-size:11px; font-weight:bold;">ì„¤ì •ëœ ë£¬ ì—†ìŒ</td>
                    <td class="v-border-heavy"><input type="text" data-key="${slot}_desc" oninput="autoSave()"></td>`;
            } else if (slot === "í¬ë¦¬ì³") {
                tr.innerHTML += `<td class="col-slot v-border-heavy">í¬ë¦¬ì³</td>
                    <td class="col-rarity"><select data-key="${slot}_rarity" onchange="updateStyle(this, 'rarity')" class="rare-ì—í”½"><option>ì—í”½</option><option>ìœ ë‹ˆí¬</option><option>ë ˆì–´</option><option>ì–¸ì»¤ë¨¼</option><option>ì»¤ë¨¼</option></select></td>
                    <td colspan="2"><input type="text" data-key="${slot}_name" placeholder="í¬ë¦¬ì³ ì´ë¦„" oninput="autoSave()"></td>
                    <td colspan="10">
                        <div class="artifact-main-wrapper">
                            ${['red', 'blue', 'green'].map((color, cIdx) => `
                                <div class="art-group">
                                    ${[1, 2].map(num => `<div class="art-item"><select data-key="${slot}_art_${color}_bg_${num}" class="art-color-select bg-ì—í”½" style="width:65px;" onchange="updateStyle(this, 'artBg')"><option>ì—í”½</option><option>ìœ ë‹ˆí¬</option><option>ë ˆì–´</option><option>ì–¸ì»¤ë¨¼</option><option>ì»¤ë¨¼</option></select><select data-key="${slot}_art_${color}_opt_${num}" class="art-opt-select bg-ì—í”½" style="width:110px;" onchange="autoSave()"><option value="">ì˜µì…˜ ì„ íƒ</option>${artOptions[color].map(o=>`<option>${o}</option>`).join('')}</select></div>`).join('')}
                                </div>`).join('')}
                        </div>
                    </td>
                    <td class="v-border-heavy"><input type="text" data-key="${slot}_desc" oninput="autoSave()"></td>`;
            } else {
                const isEq = index < 12; 
                const isExSlot = ['ìƒì˜', 'íŒ”ì°Œ', 'ê·€ê±¸ì´'].includes(slot);
                const hasEmb = !["ì™¸í˜•ì¹­í˜¸", "ì˜¤ë¼", "ì•„ë°”íƒ€", "í¬ë¦¬ì³"].includes(slot);
                const isElemSlot = ["ë³´ì¡°ì¥ë¹„", "ê·€ê±¸ì´", "ë§ˆë²•ì„", "ì¹­í˜¸"].includes(slot);
                let g = { n1: [], n2: [] };
                if(slot === "ë¬´ê¸°") g = mData.weapon;
                else if(index >= 1 && index <= 5) g = mData.armor; 
                else if(index >= 6 && index <= 8) g = mData.accessory; 
                else if(index >= 9 && index <= 11) g = mData.special;
                let embCls = (["ìƒì˜", "í•˜ì˜"].includes(slot)) ? "emb-bg-red" : (["ì–´ê¹¨", "ë²¨íŠ¸"].includes(slot)) ? "emb-bg-yellow" : (["ì‹ ë°œ", "íŒ”ì°Œ"].includes(slot)) ? "emb-bg-blue" : (["ëª©ê±¸ì´", "ë°˜ì§€"].includes(slot)) ? "emb-bg-green" : "emb-bg-gray";
                
                const tierSlots = ["ë¬´ê¸°", "ìƒì˜", "ì–´ê¹¨", "í•˜ì˜", "ì‹ ë°œ", "ë²¨íŠ¸", "ëª©ê±¸ì´", "íŒ”ì°Œ", "ë°˜ì§€", "ë³´ì¡°ì¥ë¹„"];
                const rarityOptions = tierSlots.includes(slot)
                    ? `<option>ì—í”½</option><option>ìœ ë‹ˆí¬</option><option>ë ˆì–´</option><option>ì–¸ì»¤ë¨¼</option><option>ì»¤ë¨¼</option><option>í‹°ì–´</option>`
                    : `<option>ì—í”½</option><option>ìœ ë‹ˆí¬</option><option>ë ˆì–´</option><option>ì–¸ì»¤ë¨¼</option><option>ì»¤ë¨¼</option>`;

                tr.innerHTML += `<td class="col-slot v-border-heavy">${slot}</td>
                    <td class="col-rarity"><select data-key="${slot}_rarity" data-slot="${slot}" onchange="updateStyle(this, 'rarity')" class="rare-ì—í”½">${rarityOptions}</select></td>
                    <td class="col-exceed">${isExSlot ? `<select data-key="${slot}_exceed" data-slot="${slot}" onchange="updateStyle(this,'exceed')"><option></option><option>ì´ìƒ</option><option>ì„ ë´‰</option><option>ì˜ì§€</option></select>` : '-'}</td>
                    <td class="col-prefix">${isEq ? `<select data-key="${slot}_prefix" data-slot="${slot}" onchange="updateStyle(this,'prefix')">${prefixes.map(p=>`<option>${p}</option>`).join('')}</select>` : '-'}</td>
                    <td><input type="text" data-key="${slot}_itemname" oninput="autoSave()"></td>
                    <td class="col-val-short">${isEq ? `<input type="text" data-key="${slot}_reinforce" oninput="autoSave()">` : '-'}</td>
                    <td>${isEq ? `<select data-key="${slot}_seal1" data-slot="${slot}" onchange="handleSealChange(this)">${g.n1.map(o=>`<option>${o}</option>`).join('')}</select>` : '-'}</td>
                    <td class="col-val-short">${isEq ? `<input type="text" data-key="${slot}_seal1_val" oninput="autoSave()">` : '-'}</td>
                    <td>${isEq ? `<select data-key="${slot}_seal2" data-slot="${slot}" onchange="handleSealChange(this)">${g.n2.map(o=>`<option>${o}</option>`).join('')}</select>` : '-'}</td>
                    <td class="col-val-short">${isEq ? `<input type="text" data-key="${slot}_seal2_val" oninput="autoSave()">` : '-'}</td>
                    <td class="col-emblem">
                        ${hasEmb ? (isElemSlot ? `<select data-key="${slot}_emb1" class="${embCls}" onchange="autoSave()">${elementEmbList.map(e=>`<option>${e}</option>`).join('')}</select>` : `<input type="text" data-key="${slot}_emb1" class="${embCls}" oninput="autoSave()">`) : '-'}
                    </td>
                    <td class="col-emblem">${hasEmb ? `<input type="text" data-key="${slot}_emb2" class="${embCls}" oninput="autoSave()">` : '-'}</td>
                    <td class="col-enchant">${index < 12 || slot === "ì¹­í˜¸" ? `<input type="text" data-key="${slot}_enchant" oninput="autoSave()">` : '-'}</td>
                    <td class="col-val-short">${index < 12 || slot === "ì¹­í˜¸" ? `<input type="text" data-key="${slot}_enchant_val" oninput="autoSave()">` : '-'}</td>
                    <td class="v-border-heavy"><input type="text" data-key="${slot}_desc" oninput="autoSave()"></td>`;
            }
            tbody.appendChild(tr);
        });

        document.getElementById('characterContainer').appendChild(section);
        updateRuneSummary(charId);

        if (savedData) {
            const inputs = section.querySelectorAll('input[data-key], select[data-key]');
            inputs.forEach(el => {
                const key = el.getAttribute('data-key');
                if (savedData.inputs && savedData.inputs[key]) {
                    el.value = savedData.inputs[key].val;
                    el.className = savedData.inputs[key].cls;
                    if (key.endsWith('_rarity')) updateStyle(el, 'rarity', true);
                }
            });
            toggleEdit(charId, savedData.locked);
        } else { toggleEdit(charId, true); }
    }

    function handleSealChange(el) {
        const key = el.getAttribute('data-key');
        const slot = el.getAttribute('data-slot');
        const row = el.closest('tr');
        const opt = el.value;
        const armors = ["ìƒì˜", "ì–´ê¹¨", "í•˜ì˜", "ì‹ ë°œ", "ë²¨íŠ¸"];
        const accs = ["ëª©ê±¸ì´", "íŒ”ì°Œ", "ë°˜ì§€"];
        const specials = ["ë³´ì¡°ì¥ë¹„", "ê·€ê±¸ì´", "ë§ˆë²•ì„"];

        const commonValTable = {
            "í˜": "46", "ì§€ëŠ¥": "46", "ì²´ë ¥": "46", "ì •ì‹ ë ¥": "46",
            "ê³µê²©ì†ë„": "1.6", "ìºìŠ¤íŒ…ì†ë„": "2", "ì´ë™ì†ë„": "1.6",
            "ìµœëŒ€ HP ì¦ê°€": "456", "ìµœëŒ€ MP ì¦ê°€": "270",
            "ë¬¼ë¦¬ ë°©ì–´ë ¥": "234", "ë§ˆë²• ë°©ì–´ë ¥": "178", "ì ì¤‘": "124", "íšŒí”¼": "70"
        };

        // ê³ ìœ  ì˜µì…˜ (seal1)
        if (key.includes("_seal1")) {
            const vIn = row.querySelector(`input[data-key="${slot}_seal1_val"]`);
            if (!vIn) return;

            if (slot === "ë¬´ê¸°") {
                const weaponTable = { "ë°ë¯¸ì§€ ì¦ê°€": "8", "ì¶”ê°€ ë°ë¯¸ì§€": "8", "ëª¨ë“  ì§ì—… 50ë ˆë²¨ìŠ¤í‚¬": "1", "í™”ì†ì„± ê°•í™”": "10", "ìˆ˜ì†ì„± ê°•í™”": "10", "ëª…ì†ì„± ê°•í™”": "10", "ì•”ì†ì„± ê°•í™”": "10", "í˜": "46", "ì§€ëŠ¥": "46", "ë¬¼ë¦¬ ê³µê²©ë ¥": "19", "ë§ˆë²• ê³µê²©ë ¥": "19" };
                if (weaponTable[opt]) vIn.value = weaponTable[opt];
            } else if (armors.includes(slot)) {
                const armorTable = { "í˜": "46", "ì§€ëŠ¥": "46", "ì²´ë ¥": "46", "ì •ì‹ ë ¥": "46", "ë¬¼ë¦¬ í¬ë¦¬í‹°ì»¬": "29", "ë§ˆë²• í¬ë¦¬í‹°ì»¬": "29" };
                if (armorTable[opt]) vIn.value = armorTable[opt];
            } else if (accs.includes(slot)) {
                const accTable = { "í™”ì†ì„± ê°•í™”": "10", "ìˆ˜ì†ì„± ê°•í™”": "10", "ëª…ì†ì„± ê°•í™”": "10", "ì•”ì†ì„± ê°•í™”": "10", "í˜": "46", "ì§€ëŠ¥": "46", "ì²´ë ¥": "46", "ì •ì‹ ë ¥": "46" };
                if (accTable[opt]) vIn.value = accTable[opt];
            } else if (specials.includes(slot)) {
                const specTable = { "ë¬¼ë¦¬ ê³µê²©ë ¥": "19", "ë§ˆë²• ê³µê²©ë ¥": "19", "í˜": "46", "ì§€ëŠ¥": "46", "ë¬¼ë¦¬ í¬ë¦¬í‹°ì»¬": "60", "ë§ˆë²• í¬ë¦¬í‹°ì»¬": "60", "ì ì¤‘": "75", "íšŒí”¼": "75" };
                if (specTable[opt]) vIn.value = specTable[opt];
            }
        }

        // ì¼ë°˜ ì˜µì…˜ (seal2)
        if (key.includes("_seal2")) {
            const vIn = row.querySelector(`input[data-key="${slot}_seal2_val"]`);
            if (!vIn) return;

            if (slot === "ë¬´ê¸°") {
                if (opt === "ë¬¼ë¦¬ ê³µê²©ë ¥" || opt === "ë§ˆë²• ê³µê²©ë ¥") vIn.value = "18";
                else if (commonValTable[opt]) vIn.value = commonValTable[opt];
            } else if (armors.includes(slot)) {
                if (opt === "ë¬¼ë¦¬ í¬ë¦¬í‹°ì»¬" || opt === "ë§ˆë²• í¬ë¦¬í‹°ì»¬") vIn.value = "30";
                else if (commonValTable[opt]) vIn.value = commonValTable[opt];
            } else if (accs.includes(slot)) {
                const resTable = { "í™”ì†ì„± ì €í•­": "8", "ìˆ˜ì†ì„± ì €í•­": "8", "ëª…ì†ì„± ì €í•­": "8", "ì•”ì†ì„± ì €í•­": "8", "í™”ì†ì„± ê°•í™”": "8", "ìˆ˜ì†ì„± ê°•í™”": "8", "ëª…ì†ì„± ê°•í™”": "8", "ì•”ì†ì„± ê°•í™”": "8" };
                if (resTable[opt]) vIn.value = resTable[opt];
                else if (commonValTable[opt]) vIn.value = commonValTable[opt];
            } else if (specials.includes(slot)) {
                if (opt === "ë¬¼ë¦¬ ê³µê²©ë ¥" || opt === "ë§ˆë²• ê³µê²©ë ¥") vIn.value = "18";
                else if (opt === "ë¬¼ë¦¬ í¬ë¦¬í‹°ì»¬" || opt === "ë§ˆë²• í¬ë¦¬í‹°ì»¬") vIn.value = "30";
                else if (commonValTable[opt]) vIn.value = commonValTable[opt];
            }
        }
        autoSave();
    }

    function updateStyle(el, type, isInitial = false) {
        const row = el.closest('tr');
        const slot = el.getAttribute('data-slot');
        el.className = Array.from(el.classList).filter(c => !c.startsWith('rare-') && !c.startsWith('ex-') && !c.startsWith('bg-') && c !== 'prefix-selected' && c !== 'prefix-tier').join(' ');
        
        if (el.value) {
            if (type === 'rarity') {
                el.classList.add('rare-' + el.value);
                
                const tierSlots = ["ë¬´ê¸°", "ìƒì˜", "ì–´ê¹¨", "í•˜ì˜", "ì‹ ë°œ", "ë²¨íŠ¸", "ëª©ê±¸ì´", "íŒ”ì°Œ", "ë°˜ì§€", "ë³´ì¡°ì¥ë¹„"];
                if (tierSlots.includes(slot)) {
                    const prefixSel = row.querySelector(`select[data-key="${slot}_prefix"]`);
                    const exceedSel = row.querySelector(`select[data-key="${slot}_exceed"]`);
                    
                    if (el.value === "í‹°ì–´") {
                        if (prefixSel) { 
                            prefixSel.innerHTML = tierPrefixes.map(p => `<option>${p}</option>`).join(''); 
                            prefixSel.className = 'prefix-tier'; 
                        }
                        if (exceedSel) { 
                            exceedSel.value = ""; 
                            exceedSel.disabled = true; 
                            exceedSel.parentElement.innerText = "-"; 
                        }
                    } else {
                        if (prefixSel) { 
                            prefixSel.innerHTML = prefixes.map(p => `<option>${p}</option>`).join(''); 
                            prefixSel.className = ''; 
                        }
                        const exTd = row.cells[3];
                        if (exTd && exTd.innerText === "-") {
                            const isExSlot = ['ìƒì˜', 'íŒ”ì°Œ', 'ê·€ê±¸ì´'].includes(slot);
                            exTd.innerHTML = isExSlot 
                                ? `<select data-key="${slot}_exceed" data-slot="${slot}" onchange="updateStyle(this,'exceed')"><option></option><option>ì´ìƒ</option><option>ì„ ë´‰</option><option>ì˜ì§€</option></select>`
                                : '-';
                        }
                    }
                }
            }
            else if (type === 'exceed') el.classList.add('ex-' + el.value);
            else if (type === 'prefix') { if (el.value.startsWith('T')) el.classList.add('prefix-tier'); else el.classList.add('prefix-selected'); }
            else if (type === 'artBg') {
                el.classList.add('bg-' + el.value);
                const optSelect = el.parentElement.querySelector('.art-opt-select');
                if(optSelect) optSelect.className = 'art-opt-select bg-' + el.value;
            }
        }
        if (!isInitial) autoSave();
    }

    function openRuneModal(charId) {
        currentEditingCharId = charId;
        const body = document.getElementById('runeModalBody');
        body.innerHTML = '';
        const data = charRuneData[charId];
        for(let i=0; i<20; i++) {
            const r = data.runes[i] || { name: '', lv: '', skillLv: '' };
            const tr = document.createElement('tr');
            tr.innerHTML = `<td class="col-m-num">${i+1}</td><td><select class="m-rune-name">${runeNames.map(n=>`<option ${r.name===n?'selected':''}>${n}</option>`).join('')}</select></td><td><select class="m-rune-lv">${runeLevels.map(n=>`<option ${r.lv===n?'selected':''}>${n}</option>`).join('')}</select></td><td><select class="m-rune-skillLv">${runeSkillLevels.map(n=>`<option ${r.skillLv===n?'selected':''}>${n}</option>`).join('')}</select></td>`;
            body.appendChild(tr);
        }
        document.getElementById('m-gakin1').value = data.gakin[0];
        document.getElementById('m-gakin2').value = data.gakin[1];
        document.getElementById('modalOverlay').style.display = 'block';
        document.getElementById('skillRunemodal').style.display = 'block';
    }
    function closeRuneModal() { document.getElementById('modalOverlay').style.display = 'none'; document.getElementById('skillRunemodal').style.display = 'none'; }
    function saveRuneData() {
        const body = document.getElementById('runeModalBody');
        const rows = body.querySelectorAll('tr');
        const newRunes = [];
        rows.forEach(row => { newRunes.push({ name: row.querySelector('.m-rune-name').value, lv: row.querySelector('.m-rune-lv').value, skillLv: row.querySelector('.m-rune-skillLv').value }); });
        charRuneData[currentEditingCharId] = { runes: newRunes, gakin: [document.getElementById('m-gakin1').value, document.getElementById('m-gakin2').value] };
        updateRuneSummary(currentEditingCharId); closeRuneModal(); autoSave();
    }
    function updateRuneSummary(charId) {
        const summaryEl = document.getElementById(`${charId}_runeSummary`);
        const data = charRuneData[charId];
        const activeRunes = data.runes.filter(r => r.name !== '');
        let runeStr = "ì„¤ì •ëœ ë£¬ ì—†ìŒ";
        if(activeRunes.length > 0) {
            const runeMap = new Map();
            activeRunes.forEach(r => {
                const effectiveSkillLv = noSkillLvRunes.includes(r.name) ? "" : r.skillLv;
                const key = `${r.name}|${r.lv}|${effectiveSkillLv}`;
                if(runeMap.has(key)) runeMap.get(key).count += 1; else runeMap.set(key, { ...r, count: 1 });
            });
            const summaryArray = [];
            runeMap.forEach((val) => {
                const skillLv = (noSkillLvRunes.includes(val.name) || !val.skillLv) ? "" : `[${val.skillLv}]`;
                summaryArray.push(`${val.name}${val.lv}${skillLv} ${val.count}ê°œ`);
            });
            runeStr = summaryArray.join(' / ');
        }
        let gakinContent = "";
        const g2 = data.gakin[1] || "";
        if (g2) { gakinContent = `<span class="v-line"></span> <span style="color:var(--gakin-2);">${g2}</span>`; }
        summaryEl.innerHTML = runeStr + gakinContent;
    }
    function resetRuneData(charId) { if(confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { charRuneData[charId] = { runes: Array(20).fill().map(() => ({ name: '', lv: '', skillLv: '' })), gakin: ['', ''] }; updateRuneSummary(charId); autoSave(); } }
    function toggleEdit(charId, isLock) {
        const section = document.getElementById(charId);
        section.querySelectorAll('input, select, button.btn-action').forEach(el => { if(!el.classList.contains('lock-btn') && !el.classList.contains('unlock-btn')) el.disabled = isLock; });
        const lBtn = section.querySelector('.lock-btn'); const uBtn = section.querySelector('.unlock-btn');
        if (isLock) { lBtn.classList.add('btn-active'); uBtn.classList.remove('btn-active'); } 
        else { uBtn.classList.add('btn-active'); lBtn.classList.remove('btn-active'); }
        autoSave();
    }
    function autoSave() {
        clearTimeout(window.sTime);
        window.sTime = setTimeout(() => {
            const allData = Array.from(document.querySelectorAll('.char-section')).map(sec => {
                const inputsObj = {};
                sec.querySelectorAll('input[data-key], select[data-key]').forEach(el => { inputsObj[el.getAttribute('data-key')] = { val: el.value, cls: el.className }; });
                return { id: sec.id, locked: sec.querySelector('.lock-btn').classList.contains('btn-active'), inputs: inputsObj, runeData: charRuneData[sec.id] };
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
            document.getElementById('statusMsg').innerText = "ğŸ’¾ ì €ì¥ë¨";
            setTimeout(() => document.getElementById('statusMsg').innerText = "", 1000);
        }, 800);
    }
    function exportToJSON() { const data = localStorage.getItem(STORAGE_KEY); if(!data) return alert("ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); const blob = new Blob([data], { type: "application/json" }); const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `dnfm_character_equipment_backup.json`; a.click(); }
    function importFromJSON(input) { 
        const reader = new FileReader(); 
        reader.onload = (e) => { try { const data = JSON.parse(e.target.result); document.getElementById('characterContainer').innerHTML = ""; charRuneData = {}; data.forEach(d => createCharacterTable(d)); autoSave(); } catch(err) { alert("ì˜¬ë°”ë¥¸ JSON íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤."); } }; 
        reader.readAsText(input.files[0]); 
    }
    window.onload = () => { const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); if (saved.length > 0) saved.forEach(d => createCharacterTable(d)); else createCharacterTable(); };
	
	// Tab í‚¤ ì…ë ¥ ì‹œ ì•„ë˜ ì¹¸ìœ¼ë¡œ ì´ë™í•˜ëŠ” ë¡œì§
document.addEventListener('keydown', function(e) {
    if (e.key === 'Tab') {
        const activeEx = document.activeElement;
        const key = activeEx.getAttribute('data-key');
        
        // data-keyê°€ ì—†ëŠ” ìš”ì†Œ(ì§ì—…/ì´ë¦„ ë“±)ëŠ” ê¸°ë³¸ ë™ì‘ ìœ ì§€
        if (!key) return;

        const section = activeEx.closest('.char-section');
        const currentSlot = activeEx.getAttribute('data-slot') || key.split('_')[0];
        const suffix = key.replace(currentSlot, ''); // ì˜ˆ: _itemname, _reinforce
        
        // í˜„ì¬ ìŠ¬ë¡¯ì˜ ìˆœì„œ í™•ì¸
        const currentIndex = slots.indexOf(currentSlot);
        if (currentIndex === -1) return;

        // ì´ë™í•  ë°©í–¥ ê²°ì • (Tabì€ ì•„ë˜ë¡œ, Shift+Tabì€ ìœ„ë¡œ)
        const nextIndex = e.shiftKey ? currentIndex - 1 : currentIndex + 1;
        
        if (nextIndex >= 0 && nextIndex < slots.length) {
            const nextSlot = slots[nextIndex];
            // ë‹¤ìŒ ìŠ¬ë¡¯ì—ì„œ ê°™ì€ suffixë¥¼ ê°€ì§„ ì…ë ¥ì°½ ì°¾ê¸°
            const targetInput = section.querySelector(`[data-key="${nextSlot}${suffix}"]`);

            if (targetInput && !targetInput.disabled) {
                e.preventDefault();
                targetInput.focus();
                // í…ìŠ¤íŠ¸ ì „ì²´ ì„ íƒ (í¸ì˜ì„±)
                if (targetInput.select) targetInput.select();
            }
        }
    }
});

let changeHistory = [];
let lastSnapshot = localStorage.getItem(STORAGE_KEY) ? JSON.parse(localStorage.getItem(STORAGE_KEY)) : [];

// ê¸°ë¡ ëª¨ë‹¬ ì—´ê¸°
function openHistoryModal() {
    const listEl = document.getElementById('historyList');
    if (changeHistory.length === 0) {
        listEl.innerHTML = "ë³€ê²½ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
    } else {
        listEl.innerHTML = changeHistory.map(h => 
            `<div style="border-bottom:1px solid #333; padding:5px 0;">
                <span style="color:var(--gold)">[${h.time}]</span> <b>${h.charName}</b> - ${h.slot}: <br>
                <span style="color:#ff5252;">${h.old}</span> â†’ <span style="color:#40c057;">${h.new}</span>
            </div>`
        ).join('');
    }
    document.getElementById('modalOverlay').style.display = 'block';
    document.getElementById('historyModal').style.display = 'block';
}

function closeHistoryModal() {
    document.getElementById('modalOverlay').style.display = 'none';
    document.getElementById('historyModal').style.display = 'none';
}

// ê¸°ì¡´ autoSave ë¡œì§ì— ê¸°ë¡ ê°ì§€ ì¶”ê°€ë¥¼ ìœ„í•´ ê°ì‹œ í•¨ìˆ˜ ìƒì„±
document.addEventListener('change', function(e) {
    const el = e.target;
    const key = el.getAttribute('data-key');
    
    // ê¸°ë¡ ëŒ€ìƒì´ ì•„ë‹Œ ìš”ì†ŒëŠ” ë¬´ì‹œ
    if (!key) return;

    const section = el.closest('.char-section');
    const charName = section.querySelector('[data-key="info_name"]').value || "ì´ë¦„ì—†ìŒ";
    
    // ìŠ¬ë¡¯ ì´ë¦„ ì¶”ì¶œ (ì˜ˆ: ë¬´ê¸°_itemname -> ë¬´ê¸°)
    const slot = key.split('_')[0];
    
    // ì´ì „ ìŠ¤ëƒ…ìƒ· ë°ì´í„°ì—ì„œ í•´ë‹¹ í‚¤ì˜ ì´ì „ ê°’ ì°¾ê¸°
    const prevChar = lastSnapshot.find(c => c.id === section.id);
    const oldVal = (prevChar && prevChar.inputs && prevChar.inputs[key]) ? prevChar.inputs[key].val : "";
    const newVal = el.value;

    // ê°’ì´ ì‹¤ì œë¡œ ë³€í–ˆì„ ë•Œë§Œ ê¸°ë¡ ìƒì„±
    if (oldVal !== newVal) {
        const now = new Date();
        const timeStr = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;
        
        changeHistory.unshift({
            time: timeStr,
            charName: charName,
            slot: slot,
            old: (oldVal === "" || oldVal === undefined) ? "(ë¹ˆì¹¸)" : oldVal,
            new: (newVal === "") ? "(ë¹ˆì¹¸)" : newVal
        });

        // ìµœê·¼ 10ê°œë§Œ ìœ ì§€
        if (changeHistory.length > 10) changeHistory.pop();
        
        // ìŠ¤ëƒ…ìƒ· ì—…ë°ì´íŠ¸: ë‹¤ìŒ ë³€ê²½ì„ ìœ„í•´ í˜„ì¬ ëª¨ë“  ê°’ì„ ìµœì‹ í™”
        lastSnapshot = Array.from(document.querySelectorAll('.char-section')).map(sec => {
            const inputsObj = {};
            sec.querySelectorAll('input[data-key], select[data-key]').forEach(i => {
                inputsObj[i.getAttribute('data-key')] = { val: i.value };
            });
            return { id: sec.id, inputs: inputsObj };
        });
    }
});
</script>
</body>
</html>